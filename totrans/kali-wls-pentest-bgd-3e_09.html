<html><head></head><body><div class="chapter" title="Chapter&#xA0;9.&#xA0;Attacking WPA-Enterprise and RADIUS"><div class="titlepage"><div><div><h1 class="title"><a id="ch09"/>Chapter 9. Attacking WPA-Enterprise and RADIUS</h1></div></div></div><div class="blockquote"><table border="0" cellpadding="0" cellspacing="0" class="blockquote" summary="Block quote" width="100%"><tr><td valign="top"> </td><td valign="top"><p>"The bigger they are, the harder they Fall."</p></td><td valign="top"> </td></tr><tr><td valign="top"> </td><td align="right" colspan="2" style="text-align: center" valign="top">--<span class="attribution"><span class="emphasis"><em>Popular Saying</em></span></span></td></tr></table></div><p>
<span class="emphasis"><em>WPA-Enterprise has always had an aura of unbreakable ability around it. Most network administrators think of it as a panacea for all their wireless security problems. In this chapter, we will see that nothing could be further from the truth.</em></span>
</p><p>In this chapter, we will learn how to attack WPA-Enterprise using different tools and techniques available on Kali.</p><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Setting up FreeRADIUS-WPE</li><li class="listitem" style="list-style-type: disc">Attacking PEAP on Windows clients</li><li class="listitem" style="list-style-type: disc">Security best practices for enterprises</li></ul></div><div class="section" title="Setting up FreeRADIUS-WPE"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec85"/>Setting up FreeRADIUS-WPE</h1></div></div></div><p>We will need <a class="indexterm" id="id275"/>a RADIUS server for orchestrating WPA-Enterprise attacks. The most widely used open source RADIUS server is FreeRADIUS. However, setting it up is difficult and configuring it for each attack can be tedious.</p><p>Joshua Wright, a well-known security researcher, created a patch for FreeRADIUS that makes it easier to<a class="indexterm" id="id276"/> set up and conduct attacks. This patch was released as the FreeRADIUS-WPE (<span class="strong"><strong>Wireless Pwnage Edition</strong></span>). Kali doesn't naturally come with FreeRADIUS-WPE, so you need to perform the following steps to set up FreeRADIUS-WPE:</p><p>Install FreeRADIUS-WPE with <code class="literal">apt-get install freeradius-wpe</code>. Now check your output to ensure it looks like the following screenshot:</p><div class="mediaobject"><img alt="Setting up FreeRADIUS-WPE" src="graphics/B09903_09_01.jpg"/></div><p>Let's now quickly<a class="indexterm" id="id277"/> set up the RADIUS server on Kali.</p></div></div>
<div class="section" title="Time for action &#x2013; setting up the AP with FreeRADIUS-WPE"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec86"/>Time for action – setting up the AP with FreeRADIUS-WPE</h1></div></div></div><p>Follow these instructions to get started:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Connect <a class="indexterm" id="id278"/>one of the LAN ports of the access point to the Ethernet port on your machine running Kali. In our case, the interface is <code class="literal">eth0</code>. Bring up the interface and get an IP address by running DHCP, as shown in the following screenshot:<div class="mediaobject"><img alt="Time for action – setting up the AP with FreeRADIUS-WPE" src="graphics/B09903_09_02.jpg"/></div></li><li class="listitem">Log in to<a class="indexterm" id="id279"/> the access point and set the security mode to <span class="strong"><strong>WPA/WPA2-Enterprise</strong></span>, set <span class="strong"><strong>Version</strong></span> to <span class="strong"><strong>WPA2</strong></span>, <span class="strong"><strong>Encryption</strong></span> to <span class="strong"><strong>AES</strong></span>. Then, under the EAP (802.1x) section, enter the <span class="strong"><strong>Radius Server IP</strong></span> address as your Kali build's IP address. The <span class="strong"><strong>Radius Password</strong></span> will be <code class="literal">test</code>, as shown in the following screenshot:<div class="mediaobject"><img alt="Time for action – setting up the AP with FreeRADIUS-WPE" src="graphics/B09903_09_03.jpg"/></div></li><li class="listitem">Let's now open a new terminal and go to the directory <code class="literal">/etc/freeradius-wpe/3.0</code>. This is where all the FreeRADIUS-WPE configuration files are.<div class="mediaobject"><img alt="Time for action – setting up the AP with FreeRADIUS-WPE" src="graphics/B09903_09_04.jpg"/></div></li><li class="listitem">Let's open <code class="literal">/mods-available/eap</code>. You will find that the <code class="literal">default_eap_type</code> command is<a class="indexterm" id="id280"/> set to <code class="literal">md5</code>.<div class="mediaobject"><img alt="Time for action – setting up the AP with FreeRADIUS-WPE" src="graphics/B09903_09_05.jpg"/></div></li><li class="listitem">Let's change this to <code class="literal">peap</code>:<div class="mediaobject"><img alt="Time for action – setting up the AP with FreeRADIUS-WPE" src="graphics/B09903_09_06.jpg"/></div></li><li class="listitem">Let's open <code class="literal">clients.conf</code>. This is where we define the allowed list of clients that can connect to <a class="indexterm" id="id281"/>our RADIUS server. Interestingly, if you browse right to the bottom, ignoring the example settings, the <code class="literal">secret</code> for clients defaults to <code class="literal">testing123</code>. We want to change this to <code class="literal">test</code> to match step 2:<div class="mediaobject"><img alt="Time for action – setting up the AP with FreeRADIUS-WPE" src="graphics/B09903_09_07.jpg"/></div></li><li class="listitem">We are now all set to start the RADIUS server with the <code class="literal">freeradius-wpe –s –X</code> command:<div class="mediaobject"><img alt="Time for action – setting up the AP with FreeRADIUS-WPE" src="graphics/B09903_09_08.jpg"/></div></li><li class="listitem">Once you<a class="indexterm" id="id282"/> run this, you will see a lot of debug messages on the screen, but eventually the server will settle down to listen for requests. Awesome! We are all set now to start our lab sessions in this chapter.</li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec77"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We have successfully set up FreeRADIUS-WPE. We will use this in the rest of the experiments that we will do in this chapter.</p></div><div class="section" title="Have a go hero – playing with RADIUS"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec78"/>Have a go hero – playing with RADIUS</h2></div></div></div><p>FreeRADIUS-WPE<a class="indexterm" id="id283"/> has tons of options. It may be a good idea to familiarize yourself with them. Most importantly, take time to check out the different configuration files and how they all work together.</p></div></div>
<div class="section" title="Attacking PEAP"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec87"/>Attacking PEAP</h1></div></div></div><p>
<span class="strong"><strong>Protected Extensible Authentication Protocol</strong></span> (<span class="strong"><strong>PEAP</strong></span>) is the most popular version of EAP in use. This is <a class="indexterm" id="id284"/>the EAP mechanism shipped natively with Windows.</p><p>PEAP has two versions:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">PEAPv0 with EAP-MSCHAPv2 (the most popular as this has native support on Windows)</li><li class="listitem" style="list-style-type: disc">PEAPv1 with EAP-GTC</li></ul></div><p>PEAP uses server-side certificates for validation of the RADIUS server. Almost all attacks on PEAP leverage misconfigurations in certificate validation.</p><p>In the next lab, we<a class="indexterm" id="id285"/> will take a look at how to crack PEAP when certificate validation is turned off on the client.</p></div>
<div class="section" title="Time for action &#x2013; cracking PEAP"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec88"/>Time for action – cracking PEAP</h1></div></div></div><p>Follow the given<a class="indexterm" id="id286"/> instructions to get started:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We double-check the <code class="literal">eap.conf</code> file to ensure that PEAP is enabled:<div class="mediaobject"><img alt="Time for action – cracking PEAP" src="graphics/B09903_09_09.jpg"/></div></li><li class="listitem">We then restart the RADIUS server with <code class="literal">freeradius-wpe –s –X</code>:<div class="mediaobject"><img alt="Time for action – cracking PEAP" src="graphics/B09903_09_10.jpg"/></div></li><li class="listitem">We monitor the log file created by FreeRADIUS-WPE:<div class="mediaobject"><img alt="Time for action – cracking PEAP" src="graphics/B09903_09_11.jpg"/></div></li><li class="listitem">Windows<a class="indexterm" id="id287"/> has native support for PEAP. Let's ensure that certificate verification has been turned off:<div class="mediaobject"><img alt="Time for action – cracking PEAP" src="graphics/B09903_09_12.jpg"/></div></li><li class="listitem">We need to <a class="indexterm" id="id288"/>click on the <span class="strong"><strong>Configure</strong></span> tab that is next to <span class="strong"><strong>Secured password (EAP-MSCHAP v2)</strong></span> and tell Windows not to automatically use our Windows logon name and password:<div class="mediaobject"><img alt="Time for action – cracking PEAP" src="graphics/B09903_09_13.jpg"/></div></li><li class="listitem">We will <a class="indexterm" id="id289"/>also have to force it to select <span class="strong"><strong>User authentication</strong></span> in the <span class="strong"><strong>Advanced Settings</strong></span> dialog box:<div class="mediaobject"><img alt="Time for action – cracking PEAP" src="graphics/B09903_09_14.jpg"/></div></li><li class="listitem">Once the<a class="indexterm" id="id290"/> client connects to the access point, the client is prompted for a username and password. We use <code class="literal">Monster</code> as the username and <code class="literal">abcdefghi</code> as the password:<div class="mediaobject"><img alt="Time for action – cracking PEAP" src="graphics/B09903_09_15.jpg"/></div></li><li class="listitem">As soon as we do this, you should be able to see the MSCHAP-v2 challenge response appear in the log file.</li><li class="listitem">We now<a class="indexterm" id="id291"/> use <code class="literal">asleap</code> to crack this using a password list file that contains the password <code class="literal">abcdefghi</code>, and we are able to crack the password!</li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec79"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We set up our Honeypot using FreeRADIUS-WPE. The enterprise client is misconfigured to not use certificate validation with PEAP. This allows us to present our own fake certificate to the client, which it gladly accepts. Once this happens, MSCHAP-v2, the inner authentication protocol, kicks in. As the client uses our fake certificate to encrypt the data, we are easily able to recover the username, challenge, and response tuples.</p><p>MSCHAP-v2 is prone to dictionary attacks. We use <code class="literal">asleap</code> to crack the challenge and response pair, as it seems to be based on a dictionary word.</p></div><div class="section" title="Have a go hero – attack variations on PEAP"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec80"/>Have a go hero – attack variations on PEAP</h2></div></div></div><p>PEAP can be<a class="indexterm" id="id292"/> misconfigured in multiple ways. Even with certificate validation enabled, if the administrator does not mention the authentic servers in connect to these servers list, the attacker can obtain a real certificate for another domain from any of the listed certifying authorities. This will still be accepted by the client. Other variations of this attack are possible as well.</p><p>We will encourage you to explore the different possibilities in this section.</p></div></div>
<div class="section" title="EAP-TTLS"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec89"/>EAP-TTLS</h1></div></div></div><p>We encourage you to try<a class="indexterm" id="id293"/> attacks similar to those we have suggested for PEAP against EAP-TTLS.</p></div>
<div class="section" title="Security best practices for enterprises"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec90"/>Security best practices for enterprises</h1></div></div></div><p>We have seen a ton<a class="indexterm" id="id294"/> of attacks against WPA/WPA2, both Personal and Enterprise. Based on our experience, we recommend the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For SOHOs and <a class="indexterm" id="id295"/>medium-sized businesses, use WPA2-PSK with a strong passphrase. You have up to 63 characters at your disposal. Make use of them.</li><li class="listitem" style="list-style-type: disc">For large enterprises, use WPA2-Enterprise with EAP-TLS. This uses both the client- and server-side certificates for authentication, and currently is unbreakable.</li><li class="listitem" style="list-style-type: disc">If you have to use PEAP or EAP-TTLS with WPA2-Enterprise, then ensure that certificate validation is turned on, the right certifying authorities are chosen, RADIUS servers that are authorized are used, and finally, that any setting that allows users to accept new RADIUS servers, certificates, or certifying authorities is turned off.</li></ul></div><div class="section" title="Pop quiz – attacking WPA-Enterprise and RADIUS"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec81"/>Pop quiz – attacking WPA-Enterprise and RADIUS</h2></div></div></div><p>Q1. Which of the following is FreeRADIUS-WPE?</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">A RADIUS server written from scratch</li><li class="listitem">A patch to the FreeRADIUS server</li><li class="listitem">Ships by default on all Linuxes</li><li class="listitem">None of the above</li></ol></div><p>Q2. Which of the following can be used to attack PEAP?</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Fake credentials</li><li class="listitem">Fake certificates</li><li class="listitem">Using WPA-PSK</li><li class="listitem">All of the above</li></ol></div><p>Q3. What does EAP-TLS use?</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Client-side certificates</li><li class="listitem">Server-side certificates</li><li class="listitem">Either 1 or 2</li><li class="listitem">Both 1 and 2</li></ol></div><p>Q4. What does EAP-TTLS use?</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Client-side certificates only</li><li class="listitem">Server-side certificates</li><li class="listitem">Password-based authentication</li><li class="listitem">LEAP</li></ol></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec91"/>Summary</h1></div></div></div><p>In this chapter, we saw how we could compromise the security of a WPA-Enterprise network running PEAP or EAP-TTLS, the two most common authentication mechanisms used in enterprises.</p><p>In the next chapter, we will take a look at how to put all that we have learned into use during an actual penetration test.</p></div></body></html>