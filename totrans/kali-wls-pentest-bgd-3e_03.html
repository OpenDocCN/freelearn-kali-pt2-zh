<html><head></head><body><div class="chapter" title="Chapter&#xA0;3.&#xA0;Bypassing WLAN Authentication"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Bypassing WLAN Authentication</h1></div></div></div><div class="blockquote"><table border="0" cellpadding="0" cellspacing="0" class="blockquote" summary="Block quote" width="100%"><tr><td valign="top"> </td><td valign="top"><p><span class="emphasis"><em>"A false sense of security is worse than being unsure."</em></span></p></td><td valign="top"> </td></tr><tr><td valign="top"> </td><td align="right" colspan="2" style="text-align: center" valign="top">--<span class="attribution"><span class="emphasis"><em>Anonymous</em></span></span></td></tr></table></div><p>
<span class="emphasis"><em>A false sense of security is worse than being insecure, as you may not be prepared to face the eventuality of being hacked.</em></span>
</p><p>
<span class="emphasis"><em>WLANs can have weak authentication schemas that can be easily broken and bypassed. In this chapter, we will take a look at the various basic authentication schemas used in WLANs and learn how to beat them.</em></span>
</p><p>In this chapter, we will take a look at the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Uncovering hidden SSIDs</li><li class="listitem" style="list-style-type: disc">Beating MAC filters</li><li class="listitem" style="list-style-type: disc">Bypassing <a class="indexterm" id="id79"/>Open Authentication</li><li class="listitem" style="list-style-type: disc">Bypassing <span class="strong"><strong>Shared Key Authentication</strong></span> (<span class="strong"><strong>SKA</strong></span>)</li></ul></div><div class="section" title="Hidden SSIDs"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec30"/>Hidden SSIDs</h1></div></div></div><p>In the default<a class="indexterm" id="id80"/> configuration mode, all access points send out their SSIDs in beacon frames. This allows clients in the vicinity to discover them easily. Hidden SSIDs is a configuration where the access point does not broadcast its SSID in beacon frames. Thus, only clients that know the SSID of the access point can connect to it.</p><p>Unfortunately, this measure does not provide robust security, but most network administrators think it does. Hidden SSIDs should not be considered a security measure by any stretch of the imagination. We will now take a look at how to uncover hidden SSIDs.</p></div></div>
<div class="section" title="Time for action &#x2013; uncovering hidden SSIDs"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec31"/>Time for action – uncovering hidden SSIDs</h1></div></div></div><p>Perform the<a class="indexterm" id="id81"/> following instructions to get started:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Using Wireshark, if we monitor beacon frames in the Wireless Lab network, we are able to see the SSID in plain text. You should see beacon frames, as shown in the following screenshot:<div class="mediaobject"><img alt="Time for action – uncovering hidden SSIDs" src="graphics/B09903_03_01.jpg"/></div></li><li class="listitem">Configure your access point to set the <code class="literal">Wireless Lab</code> network as a hidden SSID. The configuration option to do this may differ across access points. In my case, I need to check the <code class="literal">Invisible</code> option in the <span class="strong"><strong>Visibility Status</strong></span> option, as shown in the following screenshot:<div class="mediaobject"><img alt="Time for action – uncovering hidden SSIDs" src="graphics/B09903_03_02.jpg"/></div></li><li class="listitem">Now if you<a class="indexterm" id="id82"/> take a look at the Wireshark trace, you will find that the SSID <code class="literal">Wireless Lab</code> has disappeared from the beacon frames. This is what hidden SSIDs are all about:<div class="mediaobject"><img alt="Time for action – uncovering hidden SSIDs" src="graphics/B09903_03_03.jpg"/></div></li><li class="listitem">In order to <a class="indexterm" id="id83"/>bypass beacon frames, we will first use the passive technique of waiting for a legitimate client to connect to the access point. This will generate probe request and probe response packets that will contain the SSID of the network, thus revealing its presence:<div class="mediaobject"><img alt="Time for action – uncovering hidden SSIDs" src="graphics/B09903_03_04.jpg"/></div></li><li class="listitem">Alternatively, you<a class="indexterm" id="id84"/> can use the <code class="literal">aireplay-ng</code> utility to send deauthentication packets to all stations on behalf of the <code class="literal">Wireless Lab</code> access point by typing <code class="literal">aireplay-ng -0 5 -a &lt;mac&gt;  --ignore-negative wlan0mon</code>, where <code class="literal">&lt;mac&gt;</code> is the MAC address of the router. The <code class="literal">-0</code> option is used to choose a deauthentication attack, and <code class="literal">5</code> is the number of deauthentication packets to send. Finally, <code class="literal">-a</code> specifies the MAC address of the access point you are targeting:<div class="mediaobject"><img alt="Time for action – uncovering hidden SSIDs" src="graphics/B09903_03_05.jpg"/></div></li><li class="listitem">The preceding<a class="indexterm" id="id85"/> deauthentication packets will force all legitimate clients to disconnect and reconnect. It would be a good idea to add a filter for deauthentication packets to view them in an isolated way, which we can do with <code class="literal">wlan.fc.type_subtype == 0x0c</code>:<div class="mediaobject"><img alt="Time for action – uncovering hidden SSIDs" src="graphics/B09903_03_06.jpg"/></div></li><li class="listitem">The<a class="indexterm" id="id86"/> probe responses from the access point will end up revealing its hidden SSID. These packets will show up on Wireshark as shown in the following screenshot. Once the legitimate clients connect back, we can see the hidden SSID using the probe request and probe response frames. You can use the filter <code class="literal">(wlan.bssid == &lt;the AP MAC&gt;) &amp;&amp; !(wlan.fc.type_subtype == 0x08)</code> to monitor all non-beacon packets to and fro from the access point. The <code class="literal">&amp;&amp;</code> sign stands for the logical AND operator and the <code class="literal">!</code> sign stands for the logical NOT operator:<div class="mediaobject"><img alt="Time for action – uncovering hidden SSIDs" src="graphics/B09903_03_07.jpg"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec31"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>Even though the <a class="indexterm" id="id87"/>SSID is hidden and not broadcasted, whenever a legitimate client tries to connect to the access point, they exchange probe request and probe response packets. These packets contain the SSID of the access point. As these packets are not encrypted, they can be very easily sniffed from the air and the SSID can be found.</p><p>We will cover using probe requests for other purposes such as tracking in a later chapter.</p><p>In many cases, all clients may be already connected to the access point and there may be no probe request/response packets available in the Wireshark trace. Here, we can forcibly disconnect the clients from the access point by sending forged deauthentication packets on the air. These packets will force the clients to reconnect back to the access point, thus revealing the SSID.</p></div><div class="section" title="Have a go hero – selecting deauthentication"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec32"/>Have a go hero – selecting deauthentication</h2></div></div></div><p>In the previous<a class="indexterm" id="id88"/> exercise, we sent broadcast deauthentication packets to force reconnection of all wireless clients. Try to verify how you can selectively target individual clients using the <code class="literal">aireplay-ng</code> utility.</p><p>It is important to note that, even though we are illustrating many of these concepts using Wireshark, it is possible to orchestrate these attacks with other tools, such as the <code class="literal">aircrack-ng</code> suite as well. We encourage you to explore the entire <code class="literal">aircrack-ng</code> suite of tools and other documentation located on their website at <a class="ulink" href="http://www.aircrack-ng.org">http://www.aircrack-ng.org</a>.</p></div></div>
<div class="section" title="MAC filters"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec32"/>MAC filters</h1></div></div></div><p>MAC filters <a class="indexterm" id="id89"/>are an age-old technique used for authentication and authorization and have their roots in the wired world. Unfortunately, they fail miserably in the wireless world.</p><p>The basic idea is to authenticate based on the MAC address of the client. The MAC filter is an identification code assigned to a network interface; a router will be able to check this code and compare it to a list of approved MACs. This list of allowed MAC addresses will be maintained by the network administrator and will be fed into the access point. We will now take a look at how easy it is to bypass MAC filters.</p></div>
<div class="section" title="Time for action &#x2013; beating MAC filters"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec33"/>Time for action – beating MAC filters</h1></div></div></div><p>Let's follow the instructions to get started:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's first configure<a class="indexterm" id="id90"/> our access point to use MAC filtering and then add the client MAC address of the victim laptop. The settings pages on my router looks as follows:<div class="mediaobject"><img alt="Time for action – beating MAC filters" src="graphics/B09903_03_08.jpg"/></div></li><li class="listitem">Once MAC filtering is enabled, only the allowed MAC address will be able to successfully authenticate with the access point. If we try to connect to the access point from a machine with a non-whitelisted MAC address, the connection <a class="indexterm" id="id91"/>will fail.</li><li class="listitem">Behind the scenes, the access point is sending authentication failure messages to the client. The packet trace resembles the following:<div class="mediaobject"><img alt="Time for action – beating MAC filters" src="graphics/B09903_03_09.jpg"/></div></li><li class="listitem">In order to<a class="indexterm" id="id92"/> beat MAC filters, we can use <code class="literal">airodump-ng</code> to find the MAC addresses of clients connected to the access point. We can do this by issuing the <code class="literal">airodump-ng -c 10 -a --bssid &lt;mac&gt; wlan0mon</code> command. By specifying the <code class="literal">bssid</code> command, we will only monitor the access point, which is of interest to us. The <code class="literal">-c 10</code> command sets the channel to <code class="literal">10</code>, where the access point is. The <code class="literal">-a</code> command ensures that, in the client section of the <code class="literal">airodump-ng</code> output, only clients associated and connected to an access point are shown. This will show us all the client MAC addresses associated with the access point:<div class="mediaobject"><img alt="Time for action – beating MAC filters" src="graphics/B09903_03_10.jpg"/></div></li><li class="listitem">Once we find a whitelisted client's MAC address, we can spoof the MAC address of the <a class="indexterm" id="id93"/>client using the <code class="literal">macchanger</code> utility, which ships with Kali. You can use the <code class="literal">macchanger –m &lt;mac&gt; wlan0mon</code> command to get this done. The MAC address you specify with the <code class="literal">-m</code> command option is the new spoofed MAC address for the <code class="literal">wlan0mon</code> interface:<div class="mediaobject"><img alt="Time for action – beating MAC filters" src="graphics/B09903_03_11.jpg"/></div></li><li class="listitem">As you can clearly see, we are now able to connect to the access point after spoofing the MAC address of a whitelisted client.</li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec33"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We monitored the<a class="indexterm" id="id94"/> air using <code class="literal">airodump-ng</code> and found the MAC address of legitimate clients connected to the wireless network. We then used the <code class="literal">macchanger</code> utility to change our wireless card's MAC address to match the client's. This fooled the access point into believing that we were the legitimate client, and it allowed us access to its wireless network.</p><p>You are encouraged to explore the different options of the <code class="literal">airodump-ng</code> utility by going through the documentation on their website at <a class="ulink" href="http://www.aircrack-ng.org/doku.php?id=airodump-ng">http://www.aircrack-ng.org/doku.php?id=airodump-ng</a>.</p></div></div>
<div class="section" title="Open Authentication"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec34"/>Open Authentication</h1></div></div></div><p>The term Open<a class="indexterm" id="id95"/> Authentication is almost a misnomer, as it actually provides no authentication at all. When an access point is configured to use Open Authentication, it will successfully authenticate all clients that connect to it.</p><p>We will now do an exercise to authenticate and connect to an access point using Open Authentication.</p></div>
<div class="section" title="Time for action &#x2013; bypassing Open Authentication"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec35"/>Time for action – bypassing Open Authentication</h1></div></div></div><p>Let's now take a look <a class="indexterm" id="id96"/>at how to bypass Open Authentication:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We will first set our lab access point Wireless Lab to use Open Authentication. On my access point, this is simply done by setting <span class="strong"><strong>Security Mode</strong></span> to <span class="strong"><strong>Disable Security</strong></span>:<div class="mediaobject"><img alt="Time for action – bypassing Open Authentication" src="graphics/B09903_03_12.jpg"/></div></li><li class="listitem">We then connect to<a class="indexterm" id="id97"/> this access point using the <code class="literal">iwconfig wlan0 essid Wireless Lab</code> command and verify that the connection has succeeded and that we are connected to the access point.</li><li class="listitem">Note that we did not have to supply any username/password/passphrase to get through Open Authentication.</li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec34"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>This is probably the simplest exercise so far. As you saw, there is no barrier to connecting to an Open Authentication network and connecting to the access point.</p></div></div>
<div class="section" title="Shared Key Authentication"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec36"/>Shared Key Authentication</h1></div></div></div><p>SKA uses a shared secret such <a class="indexterm" id="id98"/>as the WEP key to authenticate the client. The exact exchange of information is illustrated in the following screenshot (taken from <a class="ulink" href="http://www.netgear.com">www.netgear.com</a>):</p><div class="mediaobject"><img alt="Shared Key Authentication" src="graphics/B09903_03_13.jpg"/></div><p>The wireless client sends <a class="indexterm" id="id99"/>an authentication request to the access point, which responds back with a challenge. The client now needs to encrypt this challenge with the shared key and send it back to the access point, which decrypts this to check whether it can recover the original challenge text. If it succeeds, the client successfully authenticates; if not, it sends an authentication failed message.</p><p>The security problem here is that an attacker passively listening to this entire communication by sniffing the air has access to both the plain text challenge and the encrypted challenge. He can apply the XOR operation to retrieve the keystream. This keystream can be used to encrypt any future challenge sent by the access point without needing to know the actual key.</p><p>The most common form of shared <a class="indexterm" id="id100"/>authentication is known as <span class="strong"><strong>Wired Equivalent Privacy</strong></span> (<span class="strong"><strong>WEP</strong></span>). It is easy to break, and numerous tools have been created over time to facilitate the cracking of WEP networks.</p><p>In this exercise, we will learn how to sniff the air to retrieve the challenge and the encrypted challenge, retrieve the keystream, and use it to authenticate to the access point without needing the shared key.</p></div>
<div class="section" title="Time for action &#x2013; bypassing shared authentication"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec37"/>Time for action – bypassing shared authentication</h1></div></div></div><p>Bypassing shared <a class="indexterm" id="id101"/>authentication is a bit more challenging than the previous exercises, so follow the steps carefully:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's first set up shared authentication for our Wireless Lab network. I have done this on my access point by setting the security mode as <span class="strong"><strong>WEP</strong></span> and <span class="strong"><strong>Authentication</strong></span> as <span class="strong"><strong>Shared Key</strong></span>:<div class="mediaobject"><img alt="Time for action – bypassing shared authentication" src="graphics/B09903_03_14.jpg"/></div></li><li class="listitem">Let's now connect a legitimate client to this network using the shared key we have set in step 1.</li><li class="listitem">In order to bypass SKA, we will first start sniffing packets between the access point and its clients. However, we would also like to log the entire shared authentication exchange. To do this, we use the <code class="literal">airodump-ng</code> utility using the <code class="literal">airodump-ng wlan0mon -c 11 --bssid &lt;mac&gt; -w keystream</code> command. The <code class="literal">-w</code> option, which is new here, requests <code class="literal">airodump-ng</code> to store the packets in a file whose name is prefixed with the word <code class="literal">keystream</code>. Incidentally, it might be a good idea to store different sessions of packet captures in different files. This allows you to analyze them long after the trace has been collected:<div class="mediaobject"><img alt="Time for action – bypassing shared authentication" src="graphics/B09903_03_15.jpg"/></div></li><li class="listitem">We can either wait<a class="indexterm" id="id102"/> for a legitimate client to connect to the access point or force a reconnect using the deauthentication technique used previously. Once a client connects and the SKA succeeds, <code class="literal">airodump-ng</code> will capture this exchange automatically by sniffing the air. An indication that the capture has succeeded is when the <code class="literal">AUTH</code> column reads WEP.</li><li class="listitem">The captured keystream is stored in a file prefixed with the word <code class="literal">keystream</code> in the current directory. In my case, the name of the file is <code class="literal">keystream-01-00-21-91-D2-8E-25.xor</code>.</li><li class="listitem">If this doesn't work, you can use <code class="literal">aireplay-ng -4 -h &lt;Connected Device MAC&gt; -a &lt;AP BSSID&gt; wlan0mon</code> to generate an <code class="literal">.xor</code> file. This requires a connected device to be on the target WEP protected network and will generate packets spoofing their MAC address to identify the XOR stream and key.<div class="mediaobject"><img alt="Time for action – bypassing shared authentication" src="graphics/B09903_03_16.jpg"/></div></li><li class="listitem">In order to<a class="indexterm" id="id103"/> fake a SKA, we will use the <code class="literal">aireplay-ng</code> tool. We run the <code class="literal">aireplay-ng -1 0 -e "Wireless Lab" -y keystream-01-00-21-91-D2-8E-25.xor -a &lt;mac&gt; -h AA:AA:AA:AA:AA:AA wlan0mon</code> command. This <code class="literal">aireplay-ng</code> command uses the keystream we just retrieved and tries to authenticate with the access point with the SSID, <code class="literal">Wireless Lab</code> and the MAC address, <code class="literal">00:21:91:D2:8E:25</code>, and uses an arbitrary client MAC address, <code class="literal">AA:AA:AA:AA:AA:AA.</code></li><li class="listitem">Fire up Wireshark and sniff all packets of interest by applying a <code class="literal">wlan.addr == AA:AA:AA:AA:AA:AA</code> filter. We can verify this using Wireshark. You should see a trace on the Wireshark screen, as shown in the following screenshot:<div class="mediaobject"><img alt="Time for action – bypassing shared authentication" src="graphics/B09903_03_17.jpg"/></div></li><li class="listitem">The first <a class="indexterm" id="id104"/>packet is the authentication request sent by the <code class="literal">aireplay-ng</code> tool to the access point:<div class="mediaobject"><img alt="Time for action – bypassing shared authentication" src="graphics/B09903_03_18.jpg"/></div></li><li class="listitem">The second <a class="indexterm" id="id105"/>packet consists of the access point sending the client challenge text, as shown in the following screenshot:<div class="mediaobject"><img alt="Time for action – bypassing shared authentication" src="graphics/B09903_03_19.jpg"/></div></li><li class="listitem">In the<a class="indexterm" id="id106"/> third packet, the tool sends the encrypted challenge to the access point:<div class="mediaobject"><img alt="Time for action – bypassing shared authentication" src="graphics/B09903_03_20.jpg"/></div></li><li class="listitem">As the <code class="literal">aireplay-ng</code> tool used the derived keystream for encryption, the authentication<a class="indexterm" id="id107"/> succeeds and the access point sends a success message in the fourth packet:<div class="mediaobject"><img alt="Time for action – bypassing shared authentication" src="graphics/B09903_03_21.jpg"/></div></li><li class="listitem">After the authentication succeeds, the tool fakes an association with the access point, which succeeds as well. If you check the wireless logs in your access point's administrative interface, you should now see a wireless client with the MAC address, <code class="literal">AA:AA:AA:AA:AA:AA</code> connected:<div class="mediaobject"><img alt="Time for action – bypassing shared authentication" src="graphics/B09903_03_22.jpg"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec35"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We were successful in deriving the keystream from a shared authentication exchange, and we used it to fake an authentication to the access point.</p></div><div class="section" title="Have a go hero – filling up the access point's tables"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec36"/>Have a go hero – filling up the access point's tables</h2></div></div></div><p>Access points have a maximum<a class="indexterm" id="id108"/> client count after which they start refusing connections. By writing a simple wrapper over <code class="literal">aireplay-ng</code>, it is possible to automate and send hundreds of connection requests from random MAC addresses to the access point. This will end up filling the internal tables and once the maximum client count is reached, the access point will stop accepting new connections. This is<a class="indexterm" id="id109"/> typically what is called a <span class="strong"><strong>Denial of Service</strong></span> (<span class="strong"><strong>DoS</strong></span>) attack and can force the router to reboot or make it dysfunctional. This can lead to all the wireless clients being disconnected and being unable to use the authorized network.</p><p>Check whether you can verify this in your lab!</p></div><div class="section" title="Pop quiz – WLAN authentication"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec37"/>Pop quiz – WLAN authentication</h2></div></div></div><p>Q1. How can you force a wireless client to reconnect to the access point?</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">By sending a deauthentication packet</li><li class="listitem">By rebooting the client</li><li class="listitem">By rebooting the access point</li><li class="listitem">All of the above</li></ol></div><p>Q2. What does Open Authentication do?</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">It provides decent security</li><li class="listitem">It provides no security</li><li class="listitem">It requires the use of encryption</li><li class="listitem">None of the above</li></ol></div><p>Q3. How does breaking SKA work?</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">By deriving the keystream from the packets</li><li class="listitem">By deriving the encryption key</li><li class="listitem">By sending deauthentication packets to the access point</li><li class="listitem">By rebooting the access point</li></ol></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec38"/>Summary</h1></div></div></div><p>In this chapter, we learnt about WLAN authentication. Hidden SSIDs are a security-through-obscurity feature and are relatively simple to beat. MAC address filters do not provide any security, as MAC addresses can be sniffed from the air from the wireless packets. This is possible because the MAC addresses are unencrypted in the packet. Open Authentication provides no real authentication at all. SKA is a bit tricky to beat but, with the help of the right tools, we can derive the store and the keystream, using which it is possible to answer all future challenges sent by the access point. The result is that we can authenticate without needing to know the actual key.</p><p>In the next chapter, we will take a look at different WLAN encryption mechanisms—WEP, WPA, and WPA2—and look at the insecurities that plague them.</p></div></body></html>