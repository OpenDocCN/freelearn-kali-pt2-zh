<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer075">
<h1 class="chapter-number" id="_idParaDest-74"><a id="_idTextAnchor076"/>4</h1>
<h1 id="_idParaDest-75"><a id="_idTextAnchor077"/>Configuring the ELK Stack</h1>
<p>In the previous chapter, you learned how to install Kali Linux on a device – which is only half the toolset of Kali Purple. This<a id="_idIndexMarker413"/> chapter will help you grasp the other half, the <strong class="bold">ELK stack</strong>. Now that Kali Linux is installed, you will use the command line to install and configure Elasticsearch, Logstash, and Kibana so that you can begin developing a fully functioning robust <em class="italic">Purple</em> <span class="No-Break">cybersecurity system.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">We will break the tide a tiny bit as we’ll install these utilities in an order that is different from how we mention them. Elasticsearch will come first. However, to fully appreciate and utilize this utility from a beginner standpoint, we are going to install Kibana right afterward and integrate the two. Logstash will be last. You will understand why as we negotiate the process. So, you might say the ELK stack is the EKL stack! It doesn’t matter what we call it, so long as we get them all up and <span class="No-Break">running properly.</span></p>
<p>As we did in <a href="B21223_03.xhtml#_idTextAnchor052"><span class="No-Break"><em class="italic">Chapter 3</em></span></a>, we’re going to inject a generous dose of troubleshooting and solutions for issues that users commonly encounter while configuring the ELK stack. It is impossible to account for every possible issue because of product changes and improvements that are longstanding and will continue to occur long after this book is published. For that reason, we encourage you to read the troubleshooting scenarios even if they don’t apply to you because that will help mold and enhance your thinking into that of an <span class="No-Break">analyst’s mindset.</span></p>
<p>By the end of this chapter, you’ll have set up a barebones SIEM technology. You’ll have also gained an understanding of how basic SIEM technologies manage data on the analyst side of things and how that data flows and <span class="No-Break">is stored.</span></p>
<p>In this chapter, you will do <span class="No-Break">the following:</span></p>
<ul>
<li><span class="No-Break">Install Elasticsearch</span></li>
<li>Install Kibana and integrate it <span class="No-Break">with Elasticsearch</span></li>
<li>Install and <span class="No-Break">integrate Logstash</span></li>
</ul>
<h1 id="_idParaDest-76"><a id="_idTextAnchor078"/>Technical requirements</h1>
<p>You should be using the same device that you completed <a href="B21223_03.xhtml#_idTextAnchor052"><span class="No-Break"><em class="italic">Chapter 3</em></span></a> with. However, the demands for Elasticsearch are more stringent. You can work with less RAM than stated here, but it will be sluggish. Here are <span class="No-Break">the requirements:</span></p>
<ul>
<li><strong class="bold">Minimum requirements</strong>: A computing device with either the <em class="italic">amd64 (x86_64/64-bit)</em> or <em class="italic">i386 (x86/32-bit)</em> architecture. It should contain at least <em class="italic">8 GB of RAM</em> and an additional <em class="italic">10 GB</em> of disk space. Note that these minimum requirements are known to cause significant performance issues, so you should aim to meet or exceed the recommended requirements for a <span class="No-Break">stress-free experience.</span></li>
<li><strong class="bold">Recommended requirements</strong>: Based on feedback from cybersecurity field practitioners, aim for the <em class="italic">amd64 (x86_64/64-bit)</em> architecture with <em class="italic">16 GB of RAM</em> – more is better – and up to <em class="italic">64 GB</em> of additional <span class="No-Break">disk space.</span></li>
</ul>
<h1 id="_idParaDest-77"><a id="_idTextAnchor079"/>Elasticsearch</h1>
<p>We learned a lot about the functionality of Elasticsearch in <a href="B21223_02.xhtml#_idTextAnchor039"><span class="No-Break"><em class="italic">Chapter 2</em></span></a>. Namely, we discovered that it’s an enhanced type of database for enriched SIEM information. Now that we’ve set up our Kali Purple operating<a id="_idIndexMarker414"/> system within a <strong class="bold">virtual machine</strong> (<strong class="bold">VM</strong>), what do you say we go out and grab ourselves a real copy of this famed Elasticsearch, and then install<a id="_idIndexMarker415"/> and configure it so that we can play <span class="No-Break">with it?</span></p>
<p>Feel free to go back to <a href="B21223_03.xhtml#_idTextAnchor052"><span class="No-Break"><em class="italic">Chapter 3</em></span></a> if you need a refresher on how to get up and running, as well as log in. Otherwise, start by opening VirtualBox and selecting the Kali Purple VM we’ve created. Assuming you’ve done no renegade independent adjustments on your own since then, that should be the only VM you have available to select at this time. Highlight it and click the <strong class="bold">Start</strong> button near the top-right of the window. Enter the credentials you created in <a href="B21223_03.xhtml#_idTextAnchor052"><span class="No-Break"><em class="italic">Chapter 3</em></span></a> for your non-administrative account and click <strong class="bold">Log In</strong> to get yourself into the Kali Purple environment. Once there, select the small black square/rectangle on the top navigation pane to bring up a terminal window. You should now have a command prompt that includes your username to <span class="No-Break">work with.</span></p>
<p>Begin by typing <strong class="source-inline">sudo apt update</strong> and take note of the number of packages the terminal says you have available for upgrading. You must do this because after taking the next step, you will run this command again as a measure of quality control to ensure your upgrades are successful. The second time, that number should be significantly lower and possibly <span class="No-Break">even zero.</span></p>
<p>It is best practice to update <a id="_idIndexMarker416"/>and upgrade packages with each <span class="No-Break">Linux boot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer064">
<img alt="Figure 4.1 – sudo apt update" height="189" src="image/B21223_04_1.jpg" width="742"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.1 – sudo apt update</p>
<p>Bear in mind that this command doesn’t update your packages. It only fetches a list of available updates. It is good form to follow this command by updating the available packages. To perform the actual update, you must type <strong class="source-inline">sudo apt upgrade</strong>. However, make sure you do this after you run the update command; otherwise, any new packages will not be found and updated! The very first time you perform this action, it could take a significant amount of time, depending on the number of packages you have to upgrade. As shown in <span class="No-Break"><em class="italic">Figure 4</em></span><em class="italic">.1</em>, there were over 800 packages with <span class="No-Break">upgrades available!</span></p>
<p>Once the upgrade is complete, you will want to run the original <strong class="source-inline">sudo apt update</strong> command again. There may still be some packages with upgrades available, especially after your very first time doing this. This is because of the way some software teams develop improvements for their product. Sometimes, software teams will push out an update that only builds upon the previous update and is not an all-inclusive upgrade. This means that you must install a previous update first before installing the most recent update. Some software teams will ensure that every upgrade is standalone and can be applied after the initial installation. There’s no rhyme or reason to this other than the development and packaging methodology that’s used by any organization’s <span class="No-Break">software team.</span></p>
<p>Lather. Rinse. Repeat. When you are satisfied with your total package upgrades, you will want to ensure any configuration or other changes made by any of those applications are recognized by your system. So, type <span class="No-Break"><strong class="source-inline">systemctl daemon-reload</strong></span><span class="No-Break">.</span></p>
<p>This command causes systemd to re-read its configuration files and reload the unit files. <strong class="bold">Systemd</strong> is a system and service manager for Linux operating systems that is responsible for controlling and managing the operating system, including processes, services, and attached devices. Any time you modify any configuration or unit files, you will want to run the <a id="_idIndexMarker417"/>preceding <strong class="source-inline">daemon-reload</strong> command to cause those modifications to be applied. In short, the command makes systemd aware that those changes were made. It’s a good habit to run this command after each major step of installing and/or configuring a new application or application suite. Doing so can prevent the frustrations of troubleshooting conflict resolution or why certain expected results <span class="No-Break">aren’t happening.</span></p>
<p>Elasticsearch may already be installed by default, depending on what level of experimenter you are or have been in the past. If so, it just needs to make some configuration changes. In the odd chance it isn’t, you can type <strong class="source-inline">sudo apt install elasticsearch</strong>. However, try the following commands to see if it’s already installed. If they execute, then that means <span class="No-Break">it was.</span></p>
<p>To enable Elasticsearch to start up upon booting, type <strong class="source-inline">sudo systemctl </strong><span class="No-Break"><strong class="source-inline">enable elasticsearch</strong></span><span class="No-Break">.</span></p>
<p>The benefit of not having this service automatically start upon booting, as you might have guessed, is performance and potentially quicker loading of the environment. Just remember that if you choose not to enable Elasticsearch, you will have to manually start it each time you boot your Kali Purple instance. You can do that by running the <strong class="source-inline">sudo systemctl start </strong><span class="No-Break"><strong class="source-inline">elasticsearch</strong></span><span class="No-Break"> command/</span></p>
<p>Record the initial password and note the password reset and token <span class="No-Break">generation commands:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer065">
<img alt="Figure 4.2 – Initial Elasticsearch configuration" height="453" src="image/B21223_04_2.jpg" width="824"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.2 – Initial Elasticsearch configuration</p>
<p>If you haven’t started Elasticsearch in this instance, go ahead and do that now before proceeding to the next step. As highlighted in <span class="No-Break"><em class="italic">Figure 4</em></span><em class="italic">.2</em>, you will want to take note of the default password because this is the only time it will be provided to you. Also, record the commands that <a id="_idIndexMarker418"/>are needed to change the password, if you so choose, and grab tokens for integrating Kibana <span class="No-Break">with Elasticsearch.</span></p>
<p>Type <strong class="source-inline">sudo systemctl status elasticsearch</strong> to view the status <span class="No-Break">of Elasticsearch.</span></p>
<p>Its status will show as <strong class="bold">Active</strong> if it’s running. You can press <em class="italic">Ctrl</em> + <em class="italic">Z</em> to break out of the status screen <span class="No-Break">if needed:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer066">
<img alt="Figure 4.3 – Status of Elasticsearch" height="255" src="image/B21223_04_3.jpg" width="758"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.3 – Status of Elasticsearch</p>
<p>Elasticsearch will bind to localhost (IP address <strong class="source-inline">127.0.0.1</strong>) by default. If you want to access it remotely, you’ll want to configure it so that it binds to a different IP address. Do this by opening the configuration file using the nano text editor. Type <strong class="source-inline">sudo nano /etc/elasticsearch/elasticsearch.yml</strong> and look for the line that starts with <strong class="source-inline">network.host</strong> so that you can uncomment it by removing <strong class="source-inline">#</strong> at the beginning. You can use the arrow keys on your keyboard to physically navigate any file opened with the nano file editor. Even though the localhost IP of <strong class="source-inline">127.0.0.1</strong> that we are using for our example is a default, it’s good practice to still manually type that address in the <strong class="source-inline">network.host</strong> setting and<a id="_idIndexMarker419"/> uncomment it. That will establish a good habit of making sure you know where to go and adjust the setting. If you want that setting to bind to all interfaces, set it to <strong class="source-inline">network.host: 0.0.0.0</strong>, then save the changes before exiting the editor. This is virtually automatic since nano prompts you to save when you press <em class="italic">Ctrl</em> + <em class="italic">X</em> to leave the editor. Since adjusting this line created a new configuration change, you must type <strong class="source-inline">sudo systemctl </strong><span class="No-Break"><strong class="source-inline">restart elasticsearch</strong></span><span class="No-Break">.</span></p>
<p>Open a web browser and point it to <a href="https://localhost:9200">https://localhost:9200</a> while paying particular attention to the <em class="italic">s</em> after <em class="italic">http</em>. You can find an icon for the Firefox web browser in the top-left menu. It is critical to notice this detail because when you load Elasticsearch through the Kibana interface later, you will not include the <em class="italic">s</em>. The <em class="italic">s</em> stands for secure and it is there because all Elasticsearch versions after 8.0 distributed with security toggled on as a default setting. In this case, that means <strong class="bold">Secure Socket Layer</strong> (<strong class="bold">SSL</strong>) and <strong class="bold">Transport Security Layer</strong> (<strong class="bold">TLS</strong>) will be required for any HTTP protocol – browser – communications. While you certainly could turn security off, we’ll skip that walkthrough here because it’s simply not necessary for what we’re doing, not to <span class="No-Break">mention discouraged.</span></p>
<p>If you provide the proper URL, your browser will initially display a security error, as shown in <span class="No-Break"><em class="italic">Figure 4</em></span><em class="italic">.4</em>; that is a result of security being toggled on. There will either be a blue <strong class="bold">Learn more…</strong> link at the bottom left, an <strong class="bold">Advanced...</strong> button at the bottom right, or both. You should be able to select either one of those and be presented with an option to <strong class="bold">Accept the Risk and Continue</strong>. If one doesn’t give you that option, then the other will. It is perfectly okay to accept the risk in this instance because you’re attempting to connect to your own self and unless you have a hidden personality lurking somewhere inside your brain, you should be acutely aware that you’re not a threat <span class="No-Break">to yourself.</span></p>
<p>Select <strong class="bold">Learn more…</strong> or <strong class="bold">Advanced…</strong> and then <strong class="bold">Accept the Risk and Continue</strong>. A login popup <span class="No-Break">will appear:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer067">
<img alt="Figure 4.4 – Elasticsearch – initial web access" height="760" src="image/B21223_04_4.jpg" width="1400"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.4 – Elasticsearch – initial web access</p>
<p>Once you accept the risk, the browser will display a popup where you can enter the Elasticsearch superuser – which is simply the word <strong class="source-inline">elastic</strong> and the default password that you recorded earlier <a id="_idIndexMarker420"/>when you ran Elasticsearch for the first time. If for some reason you forgot to record that password, you can return to the command-line terminal and request a new one by typing <strong class="source-inline">sudo /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic</strong>, where <strong class="source-inline">-u</strong> identifies the next word in the command as the username and <strong class="source-inline">elastic</strong> is the username of the superuser. You will be asked for your sudo password before it issues you a new Elasticsearch password. Make sure you are in the default home directory when you type that command. You can type <strong class="source-inline">cd</strong> to return home if you aren’t. You can type <strong class="source-inline">pwd</strong> to see where in the default filesystem you are located. It should return something like <strong class="source-inline">/home/&lt;username&gt;</strong>, where <strong class="source-inline">username</strong> is the account name you created for your non-administrative Kali Purple account. If it doesn’t, you aren’t in the home directory. Alternatively, you can navigate directly to the <strong class="source-inline">/usr/share/elasticsearch/bin/</strong> directory using the <strong class="source-inline">cd</strong> command. Once there, you only need to type <strong class="source-inline">elasticsearch-reset-password -u elastic</strong> to reset <span class="No-Break">your password.</span></p>
<p>Now, be prepared to be underwhelmed. If you’ve entered the correct credentials, a simple web page will load, showing your default Elasticsearch cluster in JSON format. If you look closely at the top left of this new display, you will see additional tabs to display the same data in raw format or to peek at the <span class="No-Break">page header.</span></p>
<p>So, why on Earth did we put you through all this torturous effort just to show a few lines of text on your screen? There are <span class="No-Break">three reasons:</span></p>
<ul>
<li>Rumor has it that pulling you apart at the rack is <span class="No-Break">now illegal</span></li>
<li>You get a visual confirmation that your Elasticsearch installation <span class="No-Break">was successful</span></li>
<li>You’ll appreciate the Kibana graphic interface that much more once we <span class="No-Break">install it</span></li>
</ul>
<p>With that, you now<a id="_idIndexMarker421"/> understand why we are going to install the ELK stack as an EKL stack. We are going to completely disrespect the ELK acronym and do this our own rebellious way. Installing and configuring Elasticsearch first is the only true necessary order of precedence but installing these items the way we are going to covers the dependencies each product has on others. So, there is a method to <span class="No-Break">our madness.</span></p>
<p>If you’re the gambling type and decide to install your items in an order we don’t present here, be prepared to encounter additional errors and challenges. That’s not an instruction for you not to do so, however. Some engineering personality types will purposely do things that way for the sheer enjoyment of learning by creating problems to solve. Others will do it because they are non-conformists by nature and simply don’t like to be told what to do. Both types are loved and welcomed in the Kali Purple community! If either of these apply to you, we hereby validate your feelings. It’s folks like you who help others learn. Please share your lessons in community forums. It will help and empower others to discover and process the <span class="No-Break">finer details.</span></p>
<p>Nevertheless, this is an introductory process and because this is introductory, you shouldn’t need to concern yourself with those finer details at this point if you don’t wish to. It’s something you will still discover as time goes on and you become more adept at using these products. Onward <span class="No-Break">to Kibana!</span></p>
<h1 id="_idParaDest-78"><a id="_idTextAnchor080"/>Kibana</h1>
<p>For Kibana to have any real <a id="_idIndexMarker422"/>value here, it’s mission-critical that you have first installed Elasticsearch. As we have already discussed, that’s the most important order of operations for installing and configuring the ELK stack. Assuming you’ve done that, we’ll proceed with the best practice of updating the <span class="No-Break">package index.</span></p>
<p>Begin by typing <strong class="source-inline">sudo apt update</strong> to get a list of packages that have updates available. Whether you choose to perform the update or not is up to you. It’s good form to do so but certainly not required. To perform the update, you must type <strong class="source-inline">sudo apt upgrade</strong> after the previous command has <span class="No-Break">finished executing.</span></p>
<p>Then, as a best practice, you will also want to type <strong class="source-inline">systemctl daemon-reload</strong> just to develop the habit of doing so. This will ensure any configuration changes you’ve made that you might have forgotten about are first recognized by systemd before restarting the services. Then, you will want to restart the services you’ve used since your last package to apply any such<a id="_idIndexMarker423"/> changes to the service. In this case, the only service we’ve worked with so far is Elasticsearch. So, the command you seek is <strong class="source-inline">sudo systemctl restart elasticsearch</strong>. Don’t forget to type <strong class="source-inline">sudo systemctl status elasticsearch</strong> after the command prompt returns to verify that Elasticsearch did, indeed, start and <span class="No-Break">is active.</span></p>
<p>Now, we can grab Kibana by typing <strong class="source-inline">sudo apt install kibana</strong>. As we did with Elasticsearch, we can enable Kibana to automatically start up upon booting by typing <strong class="source-inline">sudo systemctl </strong><span class="No-Break"><strong class="source-inline">enable kibana</strong></span><span class="No-Break">.</span></p>
<p>To start Kibana, type <strong class="source-inline">sudo systemctl </strong><span class="No-Break"><strong class="source-inline">start kibana</strong></span><span class="No-Break">.</span></p>
<p>To verify the status and ensure Kibana is successfully running, type <strong class="source-inline">sudo systemctl </strong><span class="No-Break"><strong class="source-inline">status kibana</strong></span><span class="No-Break">.</span></p>
<p>Kibana will show as active if it’s been installed and <span class="No-Break">started correctly:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer068">
<img alt="Figure 4.5 – Kibana status with the initial login URL and verification code" height="388" src="image/B21223_04_5.jpg" width="716"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.5 – Kibana status with the initial login URL and verification code</p>
<p>If the status does not return to the command prompt promptly, you can hold down <em class="italic">Ctrl</em> + <em class="italic">Z</em> to forcefully break out of the status screen. The next step, as suggested near the bottom of <span class="No-Break"><em class="italic">Figure 4</em></span><em class="italic">.5</em>, is to load a browser, as we did with Elasticsearch. However, this time, we’re using a different port number and we’re also leaving the <em class="italic">s</em> off the end <span class="No-Break">of http.</span></p>
<p>While best practices suggest that Kibana should also use the secure HTTPS protocol, it is configured to use the HTTP protocol by default for performance reasons. Kibana, being a visual utility, is heavy on<a id="_idIndexMarker424"/> CPU resources by default. For the data to be compromised, it would have to be intercepted between Kibana and Elasticsearch, which are usually both located within the same internal network. Elasticsearch, in contrast, can be receiving data externally, from data shippers and agents outside of your network, so the data is far more vulnerable, making a default security-on approach more practical <span class="No-Break">and necessary.</span></p>
<p>This subtle discrepancy often tends to cause confusion among first-time ELK stack users/installers. Just remember that for any part of this process, if you get hung up or if you’re simply the experimental type and like to color outside the lines by doing things we haven’t talked about, you can inspect any error messages regarding Elasticsearch, Kibana, or Logstash by using the change directory command. To do so, navigate to the file by typing <strong class="source-inline">cd /var/log/</strong>; then, once in the directory, type <strong class="source-inline">ls</strong> to view the available log file options. Each application that you have installed up to that point should have a file listed in that directory. To view any particular file, type <strong class="source-inline">cat &lt;filename&gt;</strong>. So, to view Kibana logs, you would type <strong class="source-inline">cat Kibana</strong>. Replace the word <strong class="source-inline">Kibana</strong> with the filename of whichever log you’d like to view out of the options presented when you <span class="No-Break">typed </span><span class="No-Break"><strong class="source-inline">ls</strong></span><span class="No-Break">.</span></p>
<p>The verification code shown at the bottom of <span class="No-Break"><em class="italic">Figure 4</em></span><em class="italic">.5</em> will not be shown on that screen if you haven’t yet loaded the Kibana interface in a web browser and entered the enrollment token. That token may have been provided to you during Elasticsearch’s and/or Kibana’s initial startup. However, if you missed it, you can create a new one by going into the command line and typing <strong class="source-inline">sudo /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana</strong>. A very long and obscure alphanumeric code will print to your terminal screen. Select and copy that code before pasting it into the <strong class="bold">Enrollment token</strong> box that appears in your browser the first time you load Kibana, as seen in <span class="No-Break"><em class="italic">Figure 4</em></span><span class="No-Break"><em class="italic">.6</em></span><span class="No-Break">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer069">
<img alt="Figure 4.6 – First Kibana browser instance asking for the enrollment token" height="511" src="image/B21223_04_6.jpg" width="598"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.6 – First Kibana browser instance asking for the enrollment token</p>
<p>Load your browser and either point it to http://localhost:5601/?code=&lt;VERIFICATION_CODE&gt;, where <strong class="source-inline">VERIFICATION_CODE</strong> is what your screen shows instead of <strong class="source-inline">754098</strong>, which is shown in <span class="No-Break"><em class="italic">Figure 4</em></span><em class="italic">.5</em>, or point it to the simpler <a href="http://localhost:5601">http://localhost:5601</a>; the browser will prompt you to enter the code<a id="_idIndexMarker425"/> manually. Either way, you’ll get the same result. If you forget the verification code, you can type <strong class="source-inline">sudo systemctl status kibana</strong> to view it again at the bottom of <span class="No-Break">the output.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">When you first launch a browser session after installing and starting Kibana, you will likely get your first test of computing resources. If at this point or any point hereafter you find that your VM’s performance is sluggish, you’ll be happy to know that you can adjust the memory, CPU, and other resources you allocated to the VM when you first <span class="No-Break">created it.</span></p>
<p class="callout">In VirtualBox, this can be done by powering down your VM and selecting <strong class="bold">Settings</strong> from the Oracle VM VirtualBox Manager lobby screen (the first screen that loads when you launch VirtualBox). Keep in mind that the <strong class="bold">Settings</strong> button will address whichever VM you have selected, should you have more than one VM. Alternatively, you can right-click on your desired VM and select <strong class="bold">Settings</strong> from <span class="No-Break">that angle.</span></p>
<p class="callout">The two tabs in the resulting left column that are most likely pertinent to your performance are <strong class="bold">System</strong> and <strong class="bold">Display</strong>. From within those two areas, you can adjust your processing power, RAM, video RAM, and more. It is paramount that you do not try to allocate more resources to your VM than your host machine has available, considering other applications outside of your <span class="No-Break">virtualization software.</span></p>
<p class="callout">We provided instructions for VirtualBox because that’s what we’ll be using in this book. However, nearly any virtualization software will have the same options available. It would be impractical for us to provide instructions for each of the virtualization applications on the market. However, the skill of independent research is expected of a security professional. A simple Google or other search engine inquiry asking how to adjust resource allocation with your brand of virtualization software should more <span class="No-Break">than suffice.</span></p>
<p>Once you’ve confirmed <a id="_idIndexMarker426"/>your verification code, addressed any performance and/or VM settings, and logged in to the Kibana interface using the same Elastic credentials you used for Elasticsearch, you will be presented with a screen giving you the option to <strong class="bold">Add integrations</strong> or <strong class="bold">Explore on my own</strong>. Go ahead and select the <strong class="bold">Add integrations</strong> button and prepare to feel like a rich kid in an overstocked <span class="No-Break">candy store:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer070">
<img alt="Figure 4.7 – Kibana’s visual lobby upon logging in to Elasticsearch" height="710" src="image/B21223_04_7.jpg" width="600"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.7 – Kibana’s visual lobby upon logging in to Elasticsearch</p>
<p>You will be presented with over 350 options of potential Kibana integrations. Just above the <strong class="bold">All categories</strong> column on the left, you’ll see the option to <strong class="bold">Browse integrations</strong>. This should be highlighted in<a id="_idIndexMarker427"/> blue to indicate you are currently at that location. Just to the right of that, you will see a black <strong class="bold">Installed integrations</strong> option, which is meant to catalog any integrations you might have already installed. Go ahead and click <span class="No-Break"><strong class="bold">Installed integrations</strong></span><span class="No-Break">.</span></p>
<p>Kibana offers 350+ stable integrations – approximately 400 if you select the <strong class="bold">Display beta </strong><span class="No-Break"><strong class="bold">integrations</strong></span><span class="No-Break"> button:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer071">
<img alt="Figure 4.8 – Kibana’s Integrations page" height="802" src="image/B21223_04_8.jpg" width="1285"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.8 – Kibana’s Integrations page</p>
<p>You will see that you already <a id="_idIndexMarker428"/>have an item installed called <strong class="bold">Elastic Synthetics</strong>. This is the core Elastic agent that is<a id="_idIndexMarker429"/> installed by default. Each time you add a new integration, it will appear in this list. Return to <strong class="bold">Browse integrations</strong> and take some time to play around with<a id="_idIndexMarker430"/> some or all <span class="No-Break">those options.</span></p>
<p>If for some reason you back yourself into a corner, you can utilize the following command sequence to <span class="No-Break">remove Kibana:</span></p>
<ol>
<li>Type <strong class="source-inline">sudo systemctl </strong><span class="No-Break"><strong class="source-inline">stop kibana</strong></span><span class="No-Break">.</span></li>
<li>Type <strong class="source-inline">sudo systemctl </strong><span class="No-Break"><strong class="source-inline">disable kibana</strong></span><span class="No-Break">.</span></li>
<li>Type <strong class="source-inline">sudo apt </strong><span class="No-Break"><strong class="source-inline">remove kibana</strong></span><span class="No-Break">.</span></li>
<li>Type <strong class="source-inline">sudo apt </strong><span class="No-Break"><strong class="source-inline">purge kibana</strong></span><span class="No-Break">.</span></li>
</ol>
<p>Purging will attempt to clean up any residual configuration files so that you don’t have unexpected discrepancies on any <span class="No-Break">future installations.</span></p>
<p>This same process works for Elasticsearch and Logstash as well, should you decide to start over on any of these utilities. You can simply substitute the names of those applications with <strong class="source-inline">kibana</strong> in the commands listed earlier. Should you feel confident and playful, it might not be a bad idea to install and uninstall some of these items several times anyway just to get a feel for the process. Repetition is the mother of all learning and practical application is the father. Here, you’re <span class="No-Break">getting both.</span></p>
<p>Amid your well-deserved gloating of having successfully installed Elasticsearch and Kibana, you might have noticed that, in the <strong class="bold">Browse integrations</strong> section, you have the option to install Logstash from within the Kibana environment. We’ll cover that in the next chapter, which focuses on acquiring the data we will be running through the ELK stack. Graphically adding Logstash comes with the option of adding the Elastic agent – an alternative to Beats. For<a id="_idIndexMarker431"/> the sake of consistency and developing a necessary skill regarding command-line work, we are going to install Logstash from the command line in the next section. We’re on a roll! So, let’s charge forward <span class="No-Break">with Logstash.</span></p>
<h1 id="_idParaDest-79"><a id="_idTextAnchor081"/>Logstash</h1>
<p>You may have already done so but since we don’t know when you will take a break from reading this, we will continue to develop<a id="_idIndexMarker432"/> the best practice habit of updating your package lists before every single new installation, just like we did when we transitioned from Elasticsearch <span class="No-Break">to Kibana.</span></p>
<p>Begin by typing <strong class="source-inline">sudo apt update</strong>. If you’re new to working within a Linux environment, you might have noticed by now that even with the frequency of us utilizing this command, there is an almost constant stream of new updates for one thing or another. If you haven’t experienced this yet, then that just means you’re working at a quick pace and covering a lot of ground at once. There’s nothing wrong with that but don’t let it fool you. The first time you step away for a day or two, you’ll come back and run this command to find there are new package updates available. That’s why we will make a habit of running it after every package installation and every time we log on to our Kali <span class="No-Break">Purple system.</span></p>
<p>Go ahead and plop a <strong class="source-inline">sudo apt update</strong> command in there, followed by <strong class="source-inline">sudo apt upgrade</strong> to update your packages if you’re willing. Then, type <strong class="source-inline">systemctl daemon-reload</strong>. This isn’t something you necessarily need to do with every logon but it should be a habit when you’re in the midst of a project that involves having to install and configure a lot of new packages – as we <span class="No-Break">are now.</span></p>
<p>Logstash is one of the applications we spoke of in <a href="B21223_03.xhtml#_idTextAnchor052"><span class="No-Break"><em class="italic">Chapter 3</em></span></a> that requires the <strong class="bold">Java Development Kit</strong> (<strong class="bold">JDK</strong>). If you followed<a id="_idIndexMarker433"/> the directions in that chapter, then you already have it installed. Otherwise, you might wish to peek back near the end of that chapter and get it taken care of. It’s quick <span class="No-Break">and painless.</span></p>
<p>Begin installing Logstash by typing <strong class="source-inline">sudo apt </strong><span class="No-Break"><strong class="source-inline">install logstash</strong></span><span class="No-Break">.</span></p>
<p>Set Logstash to automatically start upon system boot by typing <strong class="source-inline">sudo systemctl enable logstash</strong>. If you ever wish to adjust this setting for any of the applications you’ve set to automatically start thus far, you can simply type <strong class="source-inline">sudo systemctl disable logstash</strong> – a command you were briefly introduced to at the end of the previous section – to set it to manually start. This means you will have to manually turn it on every time you boot your<a id="_idIndexMarker434"/> system by running the <span class="No-Break">start command.</span></p>
<p>Start the Logstash service by typing <strong class="source-inline">sudo service logstash start</strong>. Next, you will want to verify the status and ensure Logstash is successfully running by typing <strong class="source-inline">sudo systemctl status logstash</strong>. When ready and if needed, press <em class="italic">Ctrl</em> + <em class="italic">Z</em> to break out of the <span class="No-Break">status screen.</span></p>
<p>Now, because one of Logstash’s primary functions is dependent upon moving data, we need to test it out and make sure the pipeline for doing so is functioning as expected. We will do that by going into Logstash itself, creating a basic pipeline, typing a command, and examining whether that command was taken and processed by Logstash. It’s simpler <a id="_idIndexMarker435"/>than it sounds. Using the <strong class="bold">change directory</strong> (<strong class="bold">cd</strong>) command, navigate to the Logstash installation. To get there, type <span class="No-Break"><strong class="source-inline">cd /usr/share/logstash</strong></span><span class="No-Break">.</span></p>
<p>If you’re uncertain of yourself, you can <a id="_idIndexMarker436"/>use the <strong class="bold">print working directory</strong> (<strong class="bold">pwd</strong>) command after you type the preceding command to verify your location. Type <strong class="source-inline">pwd</strong>; it should return <strong class="source-inline">/usr/share/logstash</strong>. Before you attempt to open the pipeline, you will want to ensure you and any other applications trying to access Logstash have the ability and permissions to do so. Type <strong class="source-inline">sudo chmod -R 777 /usr/share/logstash/data</strong> to set the correct permissions for the entire file path. From that location, open a pipeline within the Logstash application by typing <strong class="source-inline">bin/logstash -e 'input { stdin {} } output { stdout {} }'</strong> while paying particular attention to the single quote and braces instead of parenthesis. Wait a few moments for the pipeline to open. You’ll know this was successful when your terminal delivers some text stating that the main pipeline or Java pipeline has started, as seen in <span class="No-Break"><em class="italic">Figure 4</em></span><span class="No-Break"><em class="italic">.9</em></span><span class="No-Break">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer072">
<img alt="Figure 4.9 – Logstash – basic Java pipeline" height="127" src="image/B21223_04_9.jpg" width="827"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.9 – Logstash – basic Java pipeline</p>
<p class="callout-heading">Note</p>
<p class="callout">During this process, you may notice some warnings. You can safely ignore these if you followed our lead exactly. Those warnings are there with a valid purpose, but the machine has no way of knowing that we are installing and configuring these applications for the first time. They should go away after the ELK stack has been fully configured and <span class="No-Break">is functional.</span></p>
<p>The exact text that’s returned to you might vary depending on which version of Logstash you have installed since the<a id="_idIndexMarker437"/> product is actively updated and will continue to be long after this book goes to press. Sometimes, this process takes a while to set itself up in the background properly. If you encounter an error, wait a few minutes and type the command again. It has been reported by testers that simply having to wait and re-enter the command has been necessary. In the previous command, everything after <strong class="source-inline">-e</strong> is the command to open the pipeline. This <strong class="source-inline">-e</strong> tells Kali that it’s okay for us to attach this command to Logstash and execute it in one statement at the command line. Programmers and software engineers, especially those of you who’ve worked with the C family of languages, will recognize <strong class="bold">stdin</strong> and <strong class="bold">stdout</strong> as core functions for managing input <a id="_idIndexMarker438"/>and output. They stand for <strong class="bold">standard input</strong> and <strong class="bold">standard output</strong>, respectively. The <a id="_idIndexMarker439"/>command is more or less telling Logstash to take the input it is about to receive and process it <span class="No-Break">as output.</span></p>
<p>Now, let’s test this new pipeline we’ve opened within Logstash by typing <strong class="source-inline">I love Kali Purple</strong> within our terminal window. If Logstash was installed correctly, started without error, and the pipeline from the previous step was set up correctly, then you should see that a timestamp has been added and the output has been returned to you, as seen in <span class="No-Break"><em class="italic">Figure 4</em></span><span class="No-Break"><em class="italic">.10</em></span><span class="No-Break">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer073">
<img alt="Figure 4.10 – Logstash’s successful input/output processing" height="233" src="image/B21223_04_10.jpg" width="444"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.10 – Logstash’s successful input/output processing</p>
<p>Press <em class="italic">Ctrl</em> + <em class="italic">D</em> to break out of Logstash and return to your command prompt. One last task you must complete is to configure Logstash so that it can index your data <span class="No-Break">within Elasticsearch.</span></p>
<p><em class="italic">“But Karl, I have no data!”</em> I hear ya. I feel the same way every morning until about my second or third cup of coffee. In the next chapter, we will focus on acquiring the data and passing it through the ELK<a id="_idIndexMarker440"/> stack using Beats and sample datasets. For now, though, we are simply setting the tools up <span class="No-Break">for use.</span></p>
<p>To configure Logstash to index your data within Elasticsearch, you will want to use the <strong class="source-inline">cd</strong> function to navigate to the Logstash home folder. To do that, type <strong class="source-inline">cd /etc/logstash</strong>. There are many ways to accomplish this Elasticsearch indexing goal, but we don’t know what future iterations of these applications will be. We also have no clue whether you leave your Kali Purple instance completely exposed while you walk your dog so that prankster teenagers can delete your files. Therefore, we are going to show you the bare-bones, from-scratch, effort-exerting, sweat-producing <span class="No-Break">method first.</span></p>
<p>To do so, you need to create a pipeline file; within that file, you must identify where your input is coming from, any special filters (both in the next chapter), and where your output is going. Type <strong class="source-inline">sudo touch learning-purple.conf</strong> to create the file and then use the list command – <strong class="source-inline">ls</strong> – to verify that your file exists in the directory. If it isn’t, it’s likely the result of a typo, so <span class="No-Break">try again.</span></p>
<p>Once it’s been created, we can edit the file with nano. Type <strong class="source-inline">sudo nano learning-purple.conf</strong> while in the same directory to open the newly created and completely blank file. If you’re no longer in the directory, either navigate to it or prepend the previous command with the <strong class="source-inline">/etc/logstash/</strong> filepath. If you’re unfamiliar with that term, think of the word append. If you’re appending something, you’re adding to the end of it. An appendix in a book, for example, means you’re adding an index at the end. In this case, prepend means you’re adding to the beginning of something – you’re adding the file before the previous command: <strong class="source-inline">sudo nano /etc/logstash/learning-purple.conf</strong>. That’s a free bonus lesson that has nothing to do with Kali<a id="_idIndexMarker441"/> Purple or the ELK stack because you’ll likely encounter that term again throughout your cybersecurity career. Once the file is open, insert the <span class="No-Break">following code:</span></p>
<pre class="source-code">
input {
   # We will use input to accept data from Beats
   # We will learn about Beats in Chapter 5
}
filter {
   # We will learn about filters in Chapter 5
   # Filters are a form of data enrichment
}
output {
    elasticsearch {
       hosts =&gt; ["localhost:9200"]
       user =&gt; "elastic"
       password =&gt; "ElasticSuperUserPassword"
    }
}</pre> <p>In the preceding scenario, make sure you substitute <strong class="source-inline">ElasticSuperUserPassword</strong> with the password you received and/or created when you launched Elasticsearch for the very first time. This will be the same password you used to log in to Kibana for the first time, helping Kibana to integrate <span class="No-Break">with Elasticsearch.</span></p>
<p>Keep in mind that if you change this password at any time, you will have to go through each application that is integrated with Elasticsearch manually and update their configuration files, lest they <a id="_idIndexMarker442"/>no longer be able to access Elasticsearch to do <span class="No-Break">their job!</span></p>
<p class="callout-heading">Note</p>
<p class="callout">This type of non-human authentication is what is generally referred to as a <strong class="bold">service account</strong> in the world of technology. You will want to<a id="_idIndexMarker443"/> study more about service accounts, especially well-known service accounts, as a cybersecurity analyst because having that knowledge may help you to examine security alerts to determine what’s occurring. One popular service account you are likely to see frequently is called <strong class="bold">NT AUTHORITY\SYSTEM</strong>. This is a built-in Windows user account that contains the absolute highest level of system privileges on a Windows operating system. It is created during the initial installation of a Windows operating system and is used to integrate services and processes within. That makes it a ripe target for bad actors and why its presence in a security alert justifies a <span class="No-Break">deeper analysis.</span></p>
<p>Press <em class="italic">Ctrl</em> + <em class="italic">X</em> and select <em class="italic">Y</em> if prompted to save and close the file we just created. Now, our job isn’t done quite yet. We want to perform a configuration validation and syntax check of our newly created file. With the following command, make sure you use two tack symbols (minus signs) before the term <strong class="source-inline">--path.config</strong> but elsewhere leave only one. Enter the following behemoth of a command into your terminal all on <span class="No-Break">one line:</span></p>
<pre class="console">
sudo /usr/share/logstash/bin/logstash –path.settings /etc/logstash -–path.config /etc/logstash -t -f /etc/logstash/learning-purple.conf</pre> <p>Be patient. This may take a minute or two <span class="No-Break">to complete.</span></p>
<p>Logstash has a built-in configuration file validator and <span class="No-Break">syntax checker:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer074">
<img alt="Figure 4.11 – The configuration file passes validation" height="325" src="image/B21223_04_11.jpg" width="1147"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.11 – The configuration file passes validation</p>
<p>Another method of setting up Logstash to report its data to Elasticsearch for indexing would be to edit <strong class="source-inline">logstash-sample.conf</strong> if you have one in your version of the product. It can be found in the same directory where we created <strong class="source-inline">learning-purple.conf</strong>. It is a best practice, however, not to edit default sample files in any technology but rather make a copy <a id="_idIndexMarker444"/>of them and edit the copy. That way, you always have a fresh unaltered original to work from if you make <span class="No-Break">a mistake.</span></p>
<p>The format of the command to copy a file is <strong class="source-inline">sudo cp &lt;originalFile&gt;&lt;newFileCopy&gt;</strong> if you’re in the same directory. For example,  <strong class="source-inline">sudo cp logstash-sample.conf logstash-sample-two.conf</strong> will create a new file named <strong class="source-inline">logstash-sample-two.conf</strong> that will have identical contents to <strong class="source-inline">logstash-sample.conf</strong>. If you aren’t inside that directory, then you must prepend the file path for each file within the command – for example, <strong class="source-inline">sudo cp /etc/logstash/logstash-sample.conf /etc/logstash/logstash-sample-two.conf</strong>. You should do this even if you want the file copy to reside in the same directory as the original (otherwise, the copy will be placed inside the directory where you’re <span class="No-Break">currently residing).</span></p>
<p>Keep in mind that you still need to edit the new file and add the credentials for the Elastic service account. You will also want to ensure you remove any <strong class="source-inline">#</strong> symbols in front of the lines for the user and password so that the file can be read. Otherwise, the <strong class="source-inline">#</strong> symbols tell Logstash to ignore everything that comes after it on the line because whatever information might be there is meant for humans only, not machines. This convention allows developers and users of the application to read the files and understand what’s going on. The addition of such comments is considered a best practice for coding and/or scripting and is <span class="No-Break">highly encouraged.</span></p>
<p>The ELK stack is not exclusive to Kali Purple. It is cross-platform-compatible and available in many different formats, including cloud-hosted. However, this book is about Kali Purple and our focus with the ELK stack is going to be how it relates to Kali Purple. Keep in mind that this is only one small piece of the overall Purple puzzle. Once we’ve finished configuring the ELK stack and have it running by the end of the next chapter, we will transition to other Kali <a id="_idIndexMarker445"/>Purple tools in future chapters. Those tools will integrate with the ELK stack and provide us with our full <span class="No-Break">SOC solution.</span></p>
<h1 id="_idParaDest-80"><a id="_idTextAnchor082"/>Summary</h1>
<p>In this chapter, we covered how to install and configure the three key components of the ELK stack. These components work together to receive, enrich, index, and display what data analysts need to do their jobs. Along the way, we learned about a bunch of related useful information that is likely to be seen again and again as you progress through your <span class="No-Break">cybersecurity career.</span></p>
<p>Then, we learned about some best practices, such as updating and upgrading after each new system boot and adding human-readable comments to code and configuration files. We also covered how to view the status of the applications after we start them, along with a bunch of commands to manipulate them, such as setting them to autostart upon boot and how to stop, disable, and remove them <span class="No-Break">if needed.</span></p>
<p>These tasks provided us with a robust skill set to manipulate the ELK stack’s components so that they fit our needs. That includes our experiences testing our configurations and how to integrate the components using a <span class="No-Break">service account.</span></p>
<p>In the next chapter, we’re going to take this a step further and learn about some additional components of the ELK stack that are meant to collect the data we need and ship it to us. We’ll learn how to deploy these endpoint agents and set up a Logstash filter for data enrichment. We will also grab a sample set of data to run through our new SIEM system and finally begin to see it working as a <span class="No-Break">full unit!</span></p>
<h1 id="_idParaDest-81"><a id="_idTextAnchor083"/>Questions</h1>
<p>Answer the following questions to test your knowledge of <span class="No-Break">this chapter:</span></p>
<ol>
<li>Which ELK stack component covered in this chapter relies on the JDK <span class="No-Break">we installed?</span><ol><li class="Alphabets"><span class="No-Break">Kibana</span></li><li class="Alphabets"><span class="No-Break">Elasticsearch</span></li><li class="Alphabets"><span class="No-Break">Logstash</span></li></ol></li>
<li>True or false: Logstash can be installed through the <span class="No-Break">Kibana GUI.</span><ol><li class="Alphabets"><span class="No-Break">True</span></li><li class="Alphabets"><span class="No-Break">False</span></li></ol></li>
<li>What is the significance of the password that’s provided during the very first <span class="No-Break">Elasticsearch run?</span><ol><li class="Alphabets">It is a service account password that’s used to integrate the ELK <span class="No-Break">stack components</span></li><li class="Alphabets">It can never <span class="No-Break">be changed</span></li><li class="Alphabets">It’s used to integrate the ELK stack components but is not technically a <span class="No-Break">service account</span></li><li class="Alphabets">It can be changed a maximum of <span class="No-Break">four times.</span></li></ol></li>
<li>What is the primary function of a <span class="No-Break">service account?</span><ol><li class="Alphabets">It manages running <span class="No-Break">background services</span></li><li class="Alphabets">It’s a non-human account to assist applications integrating with <span class="No-Break">each other</span></li><li class="Alphabets">It holds services accountable for <span class="No-Break">their actions</span></li><li class="Alphabets">It sends you an automated text to notify you when your car is due for an <span class="No-Break">oil change</span></li></ol></li>
<li>What is the default port Elasticsearch <span class="No-Break">binds to?</span><ol><li class="Alphabets"><span class="No-Break"><strong class="source-inline">5601</strong></span></li><li class="Alphabets"><span class="No-Break"><strong class="source-inline">5400</strong></span></li><li class="Alphabets"><span class="No-Break"><strong class="source-inline">9201</strong></span></li><li class="Alphabets"><span class="No-Break"><strong class="source-inline">9200</strong></span></li></ol></li>
<li>Which of the following commands cleans up residual <span class="No-Break">configuration files?</span><ol><li class="Alphabets"><strong class="source-inline">sudo apt </strong><span class="No-Break"><strong class="source-inline">purge &lt;package&gt;</strong></span></li><li class="Alphabets"><strong class="source-inline">sudo apt </strong><span class="No-Break"><strong class="source-inline">remove &lt;package&gt;</strong></span></li><li class="Alphabets"><strong class="source-inline">sudo apt </strong><span class="No-Break"><strong class="source-inline">disable &lt;package&gt;</strong></span></li><li class="Alphabets"><strong class="source-inline">sudo apt </strong><span class="No-Break"><strong class="source-inline">disintegrate &lt;package&gt;</strong></span></li></ol></li>
</ol>
<h1 id="_idParaDest-82"><a id="_idTextAnchor084"/>Further reading</h1>
<p>To learn more about the topics that were covered in this chapter, take a look at the <span class="No-Break">following resources:</span></p>
<ul>
<li><strong class="bold">Elasticsearch </strong><span class="No-Break"><strong class="bold">guide</strong></span><span class="No-Break">: </span><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.xhtml"><span class="No-Break">https://www.elastic.co/guide/en/elasticsearch/reference/current/index.xhtml</span></a></li>
<li><strong class="bold">Kibana </strong><span class="No-Break"><strong class="bold">guide</strong></span><span class="No-Break">: </span><a href="https://www.elastic.co/guide/en/kibana/current/index.xhtml"><span class="No-Break">https://www.elastic.co/guide/en/kibana/current/index.xhtml</span></a></li>
<li><strong class="bold">Logstash </strong><span class="No-Break"><strong class="bold">guide</strong></span><span class="No-Break">: </span><a href="https://www.elastic.co/guide/en/logstash/current/index.xhtml"><span class="No-Break">https://www.elastic.co/guide/en/logstash/current/index.xhtml</span></a></li>
</ul>
</div>
</div></body></html>