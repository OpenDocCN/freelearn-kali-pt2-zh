<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer094">
<h1 class="chapter-number" id="_idParaDest-83"><a id="_idTextAnchor085"/>5</h1>
<h1 id="_idParaDest-84"><a id="_idTextAnchor086"/>Sending Data to the ELK Stack</h1>
<p>We devoted the<a id="_idIndexMarker446"/> previous chapter to setting up the three primary components of the <strong class="bold">ELK stack</strong>. That’s great but, without data, those components are useless! This chapter aims to resolve that issue. There are multiple means of acquiring data for the ELK stack and exploring some of them can end up being rather advanced. Since this is an introductory manual, we are going to stick with the simpler methods – in this case, <strong class="bold">Beats</strong> – but<a id="_idIndexMarker447"/> still provide an overview of some of the more advanced methods. This will allow those who thirst for knowledge, who love to independently study, to do a deeper dig if they wish, while still providing actionable tools for those of you who prefer to take it a <span class="No-Break">bit slower.</span></p>
<p>The process of <a id="_idIndexMarker448"/>acquiring data involves transporting data. This is sometimes referred to as <strong class="bold">data shipping</strong>. Throughout this chapter, when we use the term data shipping, it should be assumed to mean that we are talking about transporting data. Another assumption that is safe for you to make is that we are always including Logstash within our data shipping ecosystem. So, when we talk about sending data to Elasticsearch, it means we either have Logstash ready to quickly swap to or that it should be considered in a commercial setup, but we are simply sending it to Elasticsearch to move the example along efficiently. In most production scenarios, you would send it to Logstash first. If at any point we meant to skip Logstash and send the data directly to Elasticsearch – which is entirely possible – we would explicitly state <span class="No-Break">as much.</span></p>
<p>The information that you’ll glean from this chapter will help you understand how a typical SIEM operation functions. While we are using the ELK stack for our hands-on training and examples, the experience and knowledge you’ll gain here can generally be transferred to other SIEM setups. This chapter will serve as the conclusion of the first section of this book. After this, we will be moving on from working directly with the ELK stack. However, as we learn about additional tools available in the Kali Purple distribution, you will discover that they are supplementary to the ELK stack and will integrate with it. As the layers slowly build, you’ll begin to see your full SOC taking shape, all based around the centerpiece of what you’ve accomplished up to, and including, this chapter. So, take special care here and make sure you don’t leave this chapter without a solid understanding of the <span class="No-Break">concepts within.</span></p>
<p>This chapter covers the <span class="No-Break">following topics:</span></p>
<ul>
<li>Understanding the flow <span class="No-Break">of data</span></li>
<li><span class="No-Break">Filebeat</span></li>
<li>Types <span class="No-Break">of Beats</span></li>
<li><span class="No-Break">Elastic agent</span></li>
<li>Logstash <span class="No-Break">and filters</span></li>
</ul>
<h1 id="_idParaDest-85"><a id="_idTextAnchor087"/>Technical requirements</h1>
<p>For this chapter, you’ll require <span class="No-Break">the following:</span></p>
<ul>
<li><strong class="bold">Minimum requirements</strong>: A computing device with either the <em class="italic">amd64 (x86_64/64-bit)</em> or <em class="italic">i386 (x86/32-bit)</em> architecture. It should contain at least <em class="italic">8 GB</em> <span class="No-Break">of RAM.</span></li>
<li><strong class="bold">Recommended requirements</strong>: Based on feedback from cybersecurity field practitioners, aim for the <em class="italic">amd64 (x86_64/64-bit)</em> architecture with <em class="italic">16 GB</em> of RAM – more is better – and up to <em class="italic">64 GB</em> of additional <span class="No-Break">disk space.</span></li>
</ul>
<h1 id="_idParaDest-86"><a id="_idTextAnchor088"/>Understanding the data flow</h1>
<p>You <a id="_idIndexMarker449"/>might recall from <a href="B21223_01.xhtml#_idTextAnchor013"><span class="No-Break"><em class="italic">Chapter 1</em></span></a> that we discussed one of the magical phenomena surrounding Kali Purple – folks who’ve never used Linux before are finally deciding to give it a shot. The field of cybersecurity has evolved to such a state that many roles exist within it where no specific type of technological experience is required in advance. While having such experience certainly helps and will give you an advantage, many organizations are beginning to focus more on their ability to problem solve, operate under pressure, or tackle challenges where no previous answer exists. Some organizations are willing to teach people the technology skills they need if they possess those abilities and can show a strong work ethic with the ability to be a good student. This goes beyond Linux, programming, or other experience. One area where some folks are short on experience as they come into the field of cybersecurity is networking. By networking, we don’t mean the ability to create a robust circle of friends and acquaintances. We mean cables, connections, and the flow of data <span class="No-Break">between machines.</span></p>
<p>In this chapter, we will be<a id="_idIndexMarker450"/> migrating into the data flow as we address how the ELK stack gets its information. Before doing so, however, we need to prepare our connections and flow of data. Since there are an infinite number of potential setups and we don’t know which tools and OS(s) you might be working with, we are going to stick with our base example setup using VirtualBox on a Windows host. However, the principle behind it all is the same. If you are using a different virtualization tool or host OS, you should still be able to glean the necessary <span class="No-Break">information here.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">Because we don’t know everyone’s financial situation and part of the magic of Kali Purple is that the entire suite is free and open source, we are developing this content in the simplest terms possible while still retaining proof-of-concept. In fact, throughout this book, we are exploring Kali Purple from the perspective of a single device. As we walk through the content, we are replicating it on a tiny laptop with 32 GB of RAM and a 13-inch screen (yes, really). We want everybody to enjoy the pleasures of <span class="No-Break">Kali Purple.</span></p>
<p class="callout">That said, you should know that there are many ways to set up and deploy the ELK stack even outside of Kali Purple so that it includes a cloud-based deployment. We could write an entire book – more likely a series of books – just on the ELK stack alone. However, this title isn’t about the ELK stack. It’s about Kali Purple and we are going to keep it aligned with Kali Purple. Stick with us and by the end, you will have a very robust understanding of Kali Purple that you can later spread your wings to enhance in whichever ways <span class="No-Break">you like.</span></p>
<p>With our base example, the first<a id="_idIndexMarker451"/> networking consideration is understanding our <strong class="bold">virtual machine</strong> (<strong class="bold">VM</strong>) versus the host OS. Simply put, it is the same as having two separate independently functioning personal computers. They are simply sharing the same physical hardware to function. That’s the only difference between our setup and having two unique devices. Therefore, we can place our endpoint tools, such as a Beats data shipper or Elastic Agent, on the host machine and have them report to the ELK stack hosted on Kali Purple within our VM instance. Doing so will accurately simulate the process of having a customer’s devices report to the tools within your company’s SOC. Adding to this complexity, we want to protect the VM from outside interference from bad actors as much as possible. We will do this by utilizing some networking concepts that allow data shippers to report to the SIEM setup by only connecting to the host machine and having the host machine pass the information along to the VM instance. While we do not need external devices for Kali Purple proof-of-concept, we’ll still touch on that aspect to support those of you who might want to experiment in that fashion. This all has the added benefit of you only needing a single device, giving educators and training managers an additional avenue for training <span class="No-Break">their analysts.</span></p>
<p>To have our <a id="_idIndexMarker452"/>networking properly established, we will need to cover two general areas: we need to ensure your host device and VM can communicate with each other. This requires you to either have a static IP address for your host machine, or a willingness to edit your port forwarding rules within your virtualization software for your Kali Purple VM instance each time your host machine updates its IP address. That may or may not be tedious, depending on the business rules and operations of your internet provider. That brings us to the second general area. Although we are developing this content on the basis that you can do everything on a single device, if you were ever to put your homemade Kali Purple SOC to legitimate use, your host device will most assuredly need to be accessible to the outside world. Otherwise, how would your data shippers know where to send <span class="No-Break">the data?</span></p>
<p>First things first: let’s see what kind of IP addresses you’re dealing with. Open a command prompt on the host and type <strong class="source-inline">ipconfig /all</strong> to get a detailed listing. As you examine the different network interfaces, you’ll notice an Ethernet interface, which is code for <em class="italic">good ‘old-fashioned physical cable plugged into my device</em>. That should be your virtualization software. Since some folks still use phones with cords, believe Elvis is alive, and access computer networks through ethernet connections, you will want to confirm this is your virtualization by looking for a <strong class="source-inline">Description</strong> field. The value for that field should be text of something referencing your virtualization software. In our example case, it is <strong class="source-inline">VirtualBox Host-Only Ethernet Adapter</strong>. You should also notice a <strong class="source-inline">DHCP Enabled</strong> row, which should have a value of <strong class="source-inline">No</strong> – that is a good thing. It means your virtualization software has set its IP address statically. In other words, the address will not change. In the same section, you will find an <strong class="source-inline">IPv4 Address</strong> field. Record that value as you will want to insert it into the port forwarding rules we will create in a few minutes. There may be other fields within these results with an <strong class="source-inline">IPv4 Address</strong> field. Find the one that refers to your VM and record the IPv4 value from that entry. It will likely be one of the first entries. You may see a reference to your VM in the description, as shown in <span class="No-Break"><em class="italic">Figure 5</em></span><em class="italic">.1</em>. Record that value as the IP address of your host machine. Within that same section, look for the <strong class="source-inline">DHCP Enabled</strong> field. This value may say <strong class="source-inline">Yes</strong>, which honestly is a real bummer. This means your internet provider periodically renews/changes your IP address. This will be reinforced with additional data in the left column of the section talking about <strong class="source-inline">Lease Obtained</strong> and <strong class="source-inline">Lease Expired</strong>. If for some reason the <strong class="source-inline">DHCP Enabled</strong> value says <strong class="source-inline">No</strong> like it did for your virtualization interface, then chances are you already knew. You would’ve figured it out when you opened the last bill from your internet provider and saw one too many zeroes tacked on to the <span class="No-Break">amount due.</span></p>
<p>Look for an Ethernet<a id="_idIndexMarker453"/> interface with a description matching your <span class="No-Break">virtualization software:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer076">
<img alt="Figure 5.1 – ipconfig /all" height="287" src="image/B21223_05_1.jpg" width="778"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.1 – ipconfig /all</p>
<p>If that’s the case, you’re good. You could set up a fully functioning Kali Purple SOC, distribute data shippers to remote devices, and have them report back to your applications once you complete port forwarding in the next step. If that’s not the case, it means you have IP addresses that change, known as dynamic IPs. You will have some independent study cut out for you before you can operate a SOC as we just described. The reason we cannot do that for you is due to the unlimited number of internet providers in the world, combined with what seems like an unlimited variety of router/switch brands. The solution you need is to get a static IP address on the device that is hosting your Kali <span class="No-Break">Purple instance.</span></p>
<p>There are technically a variety of other alternative ways to address this because the world of computer networking is vastly complex. However, folks who already know all of that are highly unlikely to be reading this. What we can do is point you in the right direction if you wish to set up your SOC in this manner. Before you run off on that tangent though, first <a id="_idIndexMarker454"/>consider what your immediate needs are. If you are simply looking to learn and/or enhance your Kali Purple knowledge, it might be advisable to stick with only keeping your host machine and VM networked. Depending on your virtualization type and setup, a host IP may not even be required for the two to work with each other. Otherwise, we recommend checking your internet provider and router/switch brands’ websites for information to see if you’re allowed to set a static IP for a device, if they have resources to help you do so, and if you will need additional port forwarding between your gateway device and the <span class="No-Break">host machine.</span></p>
<p>Once you have decided how you want to move forward and have addressed any IP issues with your host device, you will want to network your VM with your host machine. Remember a VM is the same thing as a separate physical computing device. If we want it to communicate with our host device, we need to configure it to <span class="No-Break">do so.</span></p>
<p>Let’s get our host machine and VM instance connected so that we can simulate data shipping to our ELK stack setup. There are several possibilities to get your host machine and virtualization software to communicate with each other. We are going to utilize a concept known <a id="_idIndexMarker455"/>as <strong class="bold">port forwarding</strong>. If you are not experienced with networking, think of a port as one of the wall <em class="italic">outlets/plugins</em> in your home. Your home symbolizes your device. When your computer accesses the internet, it’s like the electricity running through the wires in your home reaching outside and traveling along the wires attached to the poles along roadways. When whatever server or computing device you are accessing on the internet replies to your computer with the information it is requesting – even if it’s as simple as displaying a web page – it’s like that electricity coming back into your home through those <span class="No-Break">same wires.</span></p>
<p>Have you ever wondered how your computer knows where that information that is coming back – that is incoming – should be sent to? How does it know that the incoming data belongs to an email client, your web browser, a game, or any other application you are using? It knows this by using ports. Different applications on your device will have different port numbers they operate from. Your web browser, for example, will operate by connecting to port <strong class="source-inline">80</strong> for normal traffic or port <strong class="source-inline">443</strong> for secured traffic on a remote web server device. In the process, it will select a random open port on your device and reserve it for when the remote device sends a reply. It sends that information, including the port number it reserved for replies, to the remote device. That way, when the remote device sends a reply, it can tell your computer where to send it. Your device, upon receiving this reply, will then know which <em class="italic">outlet/plugin</em> to use. Therefore, it will know that any information coming from the original remote port <strong class="source-inline">80</strong> or <strong class="source-inline">443</strong> web server activity is related to your web browser and should be <span class="No-Break">sent there.</span></p>
<p>A port in your computer – also sometimes <a id="_idIndexMarker456"/>called a <strong class="bold">plugin</strong> – is like the electricity coming into your house and going to a very specific <em class="italic">outlet</em>. Your home identifies the plugins by the wiring that’s sent to the electrical panel, where there are circuit breakers that should be labeled. If you go to the electrical panel in your home and flip the switch that says <em class="italic">kitchen</em>, then in theory, the power in your kitchen, and only your kitchen, should be turned off. It turns off all the electrical <em class="italic">outlets</em> in your kitchen, not just one. A port on your computer is like a single <em class="italic">outlet</em> in your kitchen. Port forwarding and mirroring are both kind of like the circuit breaker switch in the control panel. You’re taking multiple <em class="italic">plugins</em> and wiring them to the same control panel to be operated and controlled with a single switch. When you create a rule in your device(s) to share or forward ports, it’s like you’re <a id="_idIndexMarker457"/>rewiring them so that they work from the same toggle, the same switch… a <strong class="bold">virtual circuit breaker</strong> if <span class="No-Break">you will.</span></p>
<p>To get our host machine and VM on the same circuit breaker, we will use port forwarding within VirtualBox. To do that, make sure the Kali Purple VM is turned off. If you have it running, you will need to shut it down before you can access the port forwarding feature for that VM. Once it’s off, open your VirtualBox and select the VM where you had Kali <a id="_idIndexMarker458"/>Purple running. Next, click the large gear image/icon across the top that is labeled <strong class="bold">Settings</strong>. When the settings window opens, find and select the <strong class="bold">Networking</strong> tab in the <span class="No-Break">left column.</span></p>
<p>While there are several ways to perform this next step, we are going to stick with something called <strong class="bold">Network Address Translation</strong> (<strong class="bold">NAT</strong>). We need to find an available network adapter. Across<a id="_idIndexMarker459"/> the top of the main window pane, there should be four tabs with adapter labels on them. In most cases, the first tab will already be partially set up with the following information. If you see that the <strong class="bold">Enable Network Adapter</strong> box is checked and <strong class="bold">NAT</strong> from the scroll menu to the right of <strong class="bold">Attached to:</strong> has already been selected, you can continue using this active tab. Otherwise, you will want to work through the tabs at the top of the window pane until you find an available network adapter. You could consider it available if <strong class="bold">Enable Network Adapter</strong> is not selected. You can read more about NAT as well as the static and dynamic IPs previously discussed in the <em class="italic">Further reading</em> section at the end of this chapter. If any of these options are not available or are grayed out, it likely means you forgot to turn off the VM first. Double-check and make sure you turned off the correct VM and then try again. You might need to close and relaunch the <span class="No-Break">VirtualBox VM.</span></p>
<p>If you forget to turn the <a id="_idIndexMarker460"/>VM off, some settings might be grayed out, <span class="No-Break">as follows:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer077">
<img alt="Figure 5.2 – The Settings panel" height="449" src="image/B21223_05_2.jpg" width="618"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.2 – The Settings panel</p>
<p>When you’re satisfied, click the triangle next to <strong class="bold">Advanced</strong>. You should see another drop-down menu labeled <strong class="bold">Adapter Type:</strong>. Set this to <strong class="bold">Paravirtualized </strong><span class="No-Break"><strong class="bold">Network (virtio-net)</strong></span><span class="No-Break">.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">The preceding step is of paramount importance. It is the cause of frustration for many users within the virtualization community so, please make absolutely, positively, certain that you don’t skip it. If you are using a virtualization product other than VirtualBox, there may be subtle differences in how it is labeled. Nevertheless, you should be able to figure it out using deductive reasoning. If you’re not comfortable with that, you can search for terms about your virtualization brand along with the <span class="No-Break">word paravirtualization.</span></p>
<p>A few lines<a id="_idIndexMarker461"/> afterward, you should also see a button to access the <strong class="bold">Port Forwarding</strong> feature. Go ahead and click on that button to open the <strong class="bold">Port Forwarding Rules</strong> window. The next few pages will provide you with some further details and a visual – as shown in <span class="No-Break"><em class="italic">Figure 5</em></span><em class="italic">.3</em> – about port forwarding. Feel free to resize that annoyingly small window so that you can see all the columns. If you’re using a different virtualization product or host OS, you can simply try searching for how to get your brands of virtualization and OS to network with each other. You might also include the term <em class="italic">port forwarding</em> in your query. However, if you follow this sequence of events here, it might be enough of a lead to assist you even in working with other products. So, we recommend reading this section even if you aren’t <span class="No-Break">using VirtualBox.</span></p>
<p>Now that we’re here, let’s set up port forwarding for each component of the ELK stack. While Elasticsearch and Kibana both primarily use <strong class="bold">Transmission Control Protocol</strong> (<strong class="bold">TCP</strong>) network <a id="_idIndexMarker462"/>traffic, Logstash works with both TCP <a id="_idIndexMarker463"/>and <strong class="bold">User Datagram Protocol</strong> (<strong class="bold">UDP</strong>). Elasticsearch also has an additional port it uses to receive information from the pipeline. We might configure that one twice, once for each protocol. Honestly, there is no harm in setting up each component for both TCP and UDP as good practice since we don’t know what the future holds for our SOC/SIEM solution. Check the <em class="italic">Further reading</em> section at the end of this chapter for a link to study more about these protocols if <span class="No-Break">you’re interested.</span></p>
<p>In the top-right corner of the window that opens after you click the <strong class="bold">Port Forwarding</strong> button, there should be a small icon with a green plus symbol on it. You might need to double-click a field to gain access for input or editing the values. You will create multiple port forwarding rules at this time. Click on the icon with the green plus symbol to create your first port forwarding rule. In the <strong class="bold">Name</strong> column, type <strong class="source-inline">Elasticsearch - Localhost</strong>, and in the protocol column to the right, type <strong class="source-inline">TCP</strong>. In the <strong class="bold">Host IP</strong> column, you will be asked for the IP address of the source you want to connect to your VM, which in our case is the host machine itself. Type <strong class="source-inline">127.0.0.1</strong>, which represents the local host of your host machine. Elasticsearch binds with Kibana on port <strong class="source-inline">9200</strong> and since this rule is to cause both the host and guest to share the same port, you must input <strong class="source-inline">9200</strong> into both the <strong class="bold">Host Port</strong> and <strong class="bold">Guest Port</strong> columns. For each port forwarding rule you are making, input the IP you recorded earlier from your VM interface – the Ethernet section when you typed <strong class="source-inline">ipconfig /all</strong> – in the <strong class="bold">Guest IP</strong> column. In our case, it was <strong class="source-inline">192.168.56.1</strong> if you refer to <span class="No-Break"><em class="italic">Figure 5</em></span><em class="italic">.1</em>. We’re having you input that IP as a best practice since not all port forwarding scenarios you will encounter in your career will involve a simple <span class="No-Break">Host-VM union.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">You can technically leave the <strong class="bold">Guest IP</strong> column blank. Some users have reported issues with having an entry for the guest IP when the other endpoint is the local host. If you encounter any issues, go ahead and remove that IP. It is a great troubleshooting habit with any form of technology to remove all of the optional settings and inputs. Then, confirm the technology works as expected minus those items and slowly reintegrate them, one single item at a time, testing after each step. If you develop a habit of troubleshooting in that manner, you will quickly discover that most of the time, it’s one of those optional items that caused the problem/issue in the <span class="No-Break">first place.</span></p>
<p>Once you’ve finished setting up your first <a id="_idIndexMarker464"/>port forward, select <strong class="bold">OK</strong> to save the rule and then repeat this step once for each of the following rules using the same IPs for both the host <span class="No-Break">and guest:</span></p>
<ul>
<li>Elasticsearch – App Data with TCP on <span class="No-Break">port </span><span class="No-Break"><strong class="source-inline">9300</strong></span></li>
<li>Kibana with TCP on <span class="No-Break">port </span><span class="No-Break"><strong class="source-inline">5601</strong></span></li>
<li>Logstash with TCP on <span class="No-Break">port </span><span class="No-Break"><strong class="source-inline">5044</strong></span></li>
<li>Logstash with UDP on <span class="No-Break">port </span><span class="No-Break"><strong class="source-inline">5044</strong></span></li>
</ul>
<p>The rule for setting Elasticsearch – App Data isn’t going to be used by us. It’s a port that is used by Elasticsearch to communicate and transfer data between nodes. However, we had you set it up as a good habit. As you grow, learn, and expand your capabilities, you might decide to study and experiment with using multiple Elasticsearch nodes. Now, you’ve programmed your brain to remember this port exists to help. Once you’ve finished setting up your port forwarding rules, they should somewhat resemble what you can see in <span class="No-Break"><em class="italic">Figure 5</em></span><em class="italic">.3</em>, which is a screen capture of the rules we have set up for running our <span class="No-Break">lab example:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer078">
<img alt="Figure 5.3 – Port Forwarding Rules" height="263" src="image/B21223_05_3.jpg" width="762"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.3 – Port Forwarding Rules</p>
<p>One final step in configuring our network for data transfer is to test our setup. We will do this by trying to connect to Elasticsearch and Kibana from our host machine. First, we must do some housekeeping. Click <strong class="bold">OK</strong> to close the <strong class="bold">Port Forwarding Rules</strong> window and click <strong class="bold">OK</strong> again to close the <strong class="bold">Settings</strong> window. Now, start up your Kali Purple VM and give it a few minutes to boot. One thing we want to avoid is trying to connect prematurely or without verifying that Elasticsearch and Kibana were started correctly when we booted our VM. Also, if you didn’t select the option to enable these services when you installed them in <a href="B21223_04.xhtml#_idTextAnchor076"><span class="No-Break"><em class="italic">Chapter 4</em></span></a>, you will need to start them up manually. If we don’t start them, we certainly won’t be able to connect to them from our host machine even if we did our port forwarding correctly. After your Kali Purple VM boots, log in to your instance and open a command-line Terminal window. Do you remember our best practices from when we installed<a id="_idIndexMarker465"/> these services in <a href="B21223_04.xhtml#_idTextAnchor076"><span class="No-Break"><em class="italic">Chapter 4</em></span></a><span class="No-Break">?</span></p>
<p>If not, they are to type the <span class="No-Break">following commands:</span></p>
<ul>
<li><strong class="source-inline">sudo </strong><span class="No-Break"><strong class="source-inline">apt update</strong></span></li>
<li><strong class="source-inline">sudo apt upgrade</strong> if you wish to upgrade any of the options presented in <span class="No-Break">the update</span></li>
<li><strong class="source-inline">sudo systemctl daemon-reload</strong> to load any forgotten <span class="No-Break">configuration changes</span></li>
<li><strong class="source-inline">sudo systemctl status elasticsearch</strong> – it will say <strong class="source-inline">Active</strong> if <span class="No-Break">it’s running</span></li>
<li><strong class="source-inline">sudo systemctl status kibana</strong> – it also will say <strong class="source-inline">Active</strong> if <span class="No-Break">it’s running</span></li>
<li>Press <em class="italic">Ctrl</em> + <em class="italic">Z</em> to break out the status screens <span class="No-Break">when needed</span></li>
</ul>
<p>In this case, you <a id="_idIndexMarker466"/>will want to ensure you do the upgrade if any of the options returned from the update are related to the Elastic suite of products. The reason is that you will acquire <strong class="bold">Filebeat</strong> in the <a id="_idIndexMarker467"/>next section directly from Elastic and if the version you acquire is newer than your Elastic installation, you will likely have issues setting <span class="No-Break">it up.</span></p>
<p>Once your Kali Purple and ELK instances are confirmed to be up and running, return to your host machine to test the port forwarding rules we created. On your host machine, open a web browser of your choosing. As you may recall from <a href="B21223_04.xhtml#_idTextAnchor076"><span class="No-Break"><em class="italic">Chapter 4</em></span></a>, we tested our Elasticsearch setup this same way by connecting directly to it. In practice, we will only access Elasticsearch through the Kibana interface. This is just to test and make sure our port forwarding rule worked as expected! In the address bar of the browser you opened, enter <a href="https://localhost:9200">https://localhost:9200</a>, paying particular attention to the <em class="italic">s</em> after <em class="italic">http</em>. If your port forwarding worked as expected, you will be presented with an option to enter Elasticsearch login credentials. These are the same credentials you use when you log in to Elasticsearch from within the Kali Purple environment because this is the same Elasticsearch! If you are presented with a web page showing your default Elasticsearch cluster in JSON format, that’s a victory for you! Your <strong class="source-inline">9200</strong> port forwarding rule worked. Let’s do the same thing for Kibana now. This time, skip the <em class="italic">s</em> after <em class="italic">http</em> and enter http://localhost:5601 in your browser. You should be presented with the same Kibana page you get when you log in through the VM. Since we don’t connect to Logstash directly, we could probably safely assume that all your port forwards were successful at <span class="No-Break">this point.</span></p>
<p>Congratulations! You’ve already won more than half the battle of data transfer. Getting your network set up is the core of all data transfer – that’s why we have the internet, right? In the next section, we are going to get Beats installed and configured so that it can use this networking scheme to report from its installation device back to our ELK stack <span class="No-Break">SIEM solution.</span></p>
<h1 id="_idParaDest-87"><a id="_idTextAnchor089"/>Filebeat</h1>
<p>Many folks will consider Beats<a id="_idIndexMarker468"/> part of the ELK stack because of the heavy dependence the three primary ELK components used to have on it. However, with the continued improvement of the Elastic agent and outside vendors developing compatibility within their independent products to send data to Elasticsearch, the inclusion of Beats is becoming less and less of an automatic assumption. We will explore the Elastic agent also. However, Beats remains simple and lightweight. Therefore, it is a very natural progression for us to <span class="No-Break">transition into.</span></p>
<p>Aside from sample datasets, which are groups of fake data that have been set up to test systems such as the ELK stack before deployment, the next simplest manner of data acquisition is through a family of agents, known as data shippers, collectively referred to as Beats. Beats is not a singular agent or software application. Rather, it is a family of applications. By separating the data collection into independent agents, each with an area of emphasis or theme, Beats can deploy only what is necessary and relevant to a particular endpoint. This helps to weed out unnecessary processing and overhead. For this reason, Beats is considered a lightweight solution for <span class="No-Break">data shipping.</span></p>
<p>Instead of looking at all the different types of Beats available, let’s select just one to delve into so that we can gain the experience of setting one up and therefore an understanding of what exactly a Beat is and how it works. We will use the popular Filebeat as an example. There may be other beats that you might find more useful for the Windows host we are using as our example. However, Filebeat is one of the most universal and is, by far, the most used beat within the total Beats ecosystem. Additionally, Filebeat is a very popular data shipper to be used on server devices due to its focus on log collection. If you were to deploy Beats within a commercial setting, odds are Filebeat will be one of the most frequently used Beats you will be expected to <span class="No-Break">work with.</span></p>
<p>Let’s simulate installing the beat on a remote endpoint by installing it on our host machine instead. At this point, you should’ve already configured the networking portion that’s required for us to make this happen. After installing, we will have it report to the ELK stack we have running within our Kali Purple VM instance. Although it’s one physical device, the process is the same as if it were two separate devices. That’s the beauty of a VM. Another benefit to doing it this way is that you shouldn’t need to take on any additional costs since no additional hardware is needed and Beats is free open <span class="No-Break">source software.</span></p>
<p>On your host machine, enter the following into the address bar of your <span class="No-Break">browser: </span><a href="https://www.elastic.co/downloads/beats/filebeat"><span class="No-Break">https://www.elastic.co/downloads/beats/filebeat</span></a><span class="No-Break">.</span></p>
<p>When the page loads, select the appropriate platform package from the <strong class="bold">Choose platform:</strong> download menu but do <em class="italic">not</em> download it yet. First, you need to select the package to get the appropriate file hash. In the case of a Windows OS, there are multiple options. You want to select the non-BETA option – the one with ZIP in the title. The package you select from the menu should now be duplicated in a blue download link underneath the menu. Once you visually confirm you have the correct package, you will want to acquire the hash value – reminiscent of what you did in <a href="B21223_03.xhtml#_idTextAnchor052"><span class="No-Break"><em class="italic">Chapter 3</em></span></a>. If you look just to the right of the blue download box, you should see the word <strong class="bold">sha</strong> pre-pended with the international symbol for download, as highlighted in <span class="No-Break"><em class="italic">Figure 5</em></span><em class="italic">.4</em>. Select that link and observe that the hash is sent in the form of a download. If the browser you are using allows you to<a id="_idIndexMarker469"/> open the download directly, do that. Otherwise, navigate to the <strong class="bold">Downloads</strong> folder on your device and open the hash. Record it somewhere so that you can compare it to the <span class="No-Break">final download:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer079">
<img alt="Figure 5.4 – Filebeat version selection and hash download" height="370" src="image/B21223_05_4.jpg" width="509"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.4 – Filebeat version selection and hash download</p>
<p>When the download is complete, do <span class="No-Break">the following:</span></p>
<ol>
<li>Open Windows File Explorer and navigate to your <span class="No-Break"><strong class="bold">Downloads</strong></span><span class="No-Break"> folder.</span></li>
<li>Type <strong class="source-inline">Get-FileHash -Path &lt;your downloaded filename&gt;</strong> to grab the <span class="No-Break">file hash.</span></li>
<li>Type <strong class="source-inline">shasum -a 512 &lt;your downloaded filename&gt;</strong> if you’re on <span class="No-Break">a Mac.</span></li>
<li>Type <strong class="source-inline">sha512sum &lt;your downloaded filename&gt;</strong> if you’re one of the cool kids on the block and <span class="No-Break">using Linux.</span></li>
<li>Right-click and select <span class="No-Break"><strong class="bold">Extract All</strong></span><span class="No-Break">.</span></li>
<li>In the <strong class="bold">Files will be extracted to this folder:</strong> section, delete the <span class="No-Break">default entry.</span></li>
<li>Type <strong class="source-inline">C:\Program Files</strong>, then <span class="No-Break">select </span><span class="No-Break"><strong class="bold">Extract</strong></span><span class="No-Break">.</span></li>
<li>Navigate to the <strong class="source-inline">C:\Program Files</strong> directory when the <span class="No-Break">extraction completes.</span></li>
<li>Right-click the directory and either press <em class="italic">F2</em> or select the rename icon at the bottom of the dropdown. That will be the image with the <span class="No-Break">letter A.</span></li>
<li>For simplicity’s sake, rename the installation to something simple and easy to remember. Elastic recommends that you just rename it <em class="italic">Filebeat</em>. You’ll appreciate this subtle maneuver later when you’re typing commands to access <span class="No-Break">the directory.</span></li>
<li>Select the Filebeat <a id="_idIndexMarker470"/>download and extract it to <span class="No-Break"><strong class="source-inline">C:\Program Files</strong></span><span class="No-Break">:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer080">
<img alt="Figure 5.5 – Filebeat download" height="115" src="image/B21223_05_5.jpg" width="619"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.5 – Filebeat download</p>
<p>Now, go to the Windows Start menu and, in the search bar, type <strong class="source-inline">PowerShell</strong> to access PowerShell. You might already have the icon to access it pinned from previous usage. Right-click the PowerShell icon and choose <strong class="bold">Run as Administrator</strong>. Select <strong class="bold">Yes</strong> via the popup to give PowerShell the permissions it needs. You can tell if you’re running as an administrator based on the background color of the terminal window. If it’s black, you are running normally. If you are running it as an administrator, the background will be blue. We will provide examples of both in a <span class="No-Break">little bit.</span></p>
<p>We are going to install <a id="_idIndexMarker471"/>Filebeat as a Windows service. There are several reasons we want to <span class="No-Break">do this:</span></p>
<ul>
<li>It ensures Filebeat starts automatically when the <span class="No-Break">system boots</span></li>
<li>It ensures immediate log collection from the boot process and throughout any <span class="No-Break">system failures</span></li>
<li>It allows Filebeat to be managed using standard Windows service <span class="No-Break">management utilities</span></li>
<li>It provides a smoother integration with the Windows OS as it relates to security <span class="No-Break">and permissions</span></li>
</ul>
<p>To install Filebeat as a service, you’ll want to navigate to the directory where you renamed the installation from the PowerShell command line. Navigate to the <strong class="bold">Program Files</strong> directory. Note the space in the directory’s name. Windows likes to do that to us and most command-line utilities like to complain about it. If you type it as you see it, you may get an error. To get around that, type <strong class="source-inline">cd c:\</strong> first; then, without hitting the space bar, press the <em class="italic">Tab</em> key on your keyboard. You’ll see the balance of the file path autocompleted for you. <em class="italic">Without</em> pressing <em class="italic">Enter</em>, continue to press the <em class="italic">Tab</em> key until the <strong class="bold">Program Files</strong> directory shows up. When it does, press <em class="italic">Enter</em>. At this point, you can type <strong class="source-inline">ls</strong> to make sure you’re in the right place and your newly named Filebeat installation is present. Continue to <strong class="source-inline">cd</strong> into <span class="No-Break">that directory.</span></p>
<p>Assuming your terminal does not complain about the space in the directory path, type <strong class="source-inline">cd 'C:\Program Files\&lt;new_name_you_picked&gt;'</strong> to get there. So, if you renamed the file to <strong class="source-inline">Filebeat</strong>, as Elastic recommends, you would type <strong class="source-inline">cd 'C:\Program Files\Filebeat'</strong>. From this point, you can install Filebeat as a service by typing <strong class="source-inline">.\install-service-filebeat.ps1</strong>. However, there’s a fair chance that you might get an error that script execution is disabled on your system. So, in the interest of best practices, we recommend setting the PowerShell execution policy from the get-go by combining the commands to set the policy and install Filebeat into one. Type <strong class="source-inline">PowerShell.exe – ExecutionPolicy UnRestricted -File .\install-service-filebeat.ps1</strong>; this should invoke a security warning. That’s expected and okay. We recommend that you type <strong class="source-inline">R</strong> to <em class="italic">Run once</em> and then press <em class="italic">Enter</em>. You should get confirmation that<a id="_idIndexMarker472"/> Filebeat is now installed but is turned off by default, as shown in <span class="No-Break"><em class="italic">Figure 5</em></span><span class="No-Break"><em class="italic">.6</em></span><span class="No-Break">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer081">
<img alt="Figure 5.6 – Filebeat installed as a Windows service through regular PowerShell" height="388" src="image/B21223_05_6.jpg" width="969"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.6 – Filebeat installed as a Windows service through regular PowerShell</p>
<p>Since we’ve installed Filebeat as a service, we have some cool tricks we can use to manage it. Here are the first couple of examples: to start Filebeat from within the same PowerShell instance we’re already in, simply type <strong class="source-inline">Start-Service -Name Filebeat</strong> and wait a few moments until your command prompt returns. When it does, there’s unfortunately no feedback to tell us if we started it successfully. However, we can check its status by typing <strong class="source-inline">Get-Service -Name Filebeat</strong> It should now say <strong class="bold">Running</strong> in the left column where it previously said <strong class="bold">Stopped</strong>. Sounds kind of familiar, doesn’t it? By installing Filebeat as a Windows service, we can now use PowerShell to manage the application in the same manner that we used the Linux command line within Kali to manage the other components of the <span class="No-Break">ELK stack.</span></p>
<h2 id="_idParaDest-88"><a id="_idTextAnchor090"/>Linux and macOS download and installation</h2>
<p>Before<a id="_idIndexMarker473"/> editing the configuration file, let’s make sure our friends on Linux and macOS can download and install the product. Both systems have auto-hash checking built in to save you <span class="No-Break">some work.</span></p>
<p>Linux users can skip the browser-based download and use the command-line utility’s automatic hash-checking, which is built into it. Type <strong class="source-inline">sudo apt-get install filebeat</strong> or <strong class="source-inline">sudo yum install filebeat</strong> and then navigate to the <strong class="source-inline">/etc/filebeat</strong> folder, where you can type <strong class="source-inline">ls</strong> to confirm that the <strong class="source-inline">.yml</strong> file is present. Use your favorite editor to edit <strong class="source-inline">filebeat.yml</strong> – for most people, it’s vim <span class="No-Break">or nano.</span></p>
<p>macOS users can use Homebrew by typing <strong class="source-inline">brew install elastic/tap/elastic-agent</strong> and then navigating to the <strong class="source-inline">/usr/local/etc/filebeat</strong> directory. Once there, they can type, look for and edit <strong class="source-inline">filebeat.yml</strong> using the same available tools found in Linux, such as vim <span class="No-Break">or nano.</span></p>
<p>Now that we have completed the process of downloading and installing, let’s adjust some settings for our Filebeat to work. After all, having Filebeat installed is only the beginning. If we want it to do its job properly, we need to configure it to connect to the ELK stack so that it knows where to send the information it’s gathering. We also need to give it a nudge to tell it where we want it to gather information from. There are a bunch of optional settings we can use to help parse the data it collects <span class="No-Break">and ships.</span></p>
<p>Type <strong class="source-inline">ls</strong> to list the contents of the directory you’re in. You should still be in the <strong class="source-inline">C:\Program Files\Filebeat</strong> directory. You’re looking for <strong class="source-inline">filebeat.yml</strong> because that is the document you will edit to send data to the ELK stack. To edit the file in PowerShell, type <strong class="source-inline">notepad filebeat.yml</strong>; on Linux or macOS, type <strong class="source-inline">sudo &lt;editor&gt; filebeat.yml</strong>, where <strong class="source-inline">editor</strong> is your editor of choice – usually, this is nano or vim. It should open in a text editor. In the odd chance that you do not have Notepad installed, you can substitute the word <strong class="source-inline">notepad</strong> for whichever text editor you do have on your system. Alternatively, you can minimize the Windows you are working with and then search for, download, and install Notepad. If you get a warning that you don’t have permission, take note of the color of your terminal window because that usually means you didn’t select <strong class="bold">Run as administrator</strong> when you first launched PowerShell. In that case, you can elevate your privilege from within PowerShell by typing <strong class="source-inline">Start-Process powershell -</strong><span class="No-Break"><strong class="source-inline">Verb Runas</strong></span><span class="No-Break">.</span></p>
<p>Once your<a id="_idIndexMarker474"/> privileges have been set and you have the file open in a text editor, you want to adjust several settings in this file before we get to reap the rewards of Filebeat. We must get these settings correct; otherwise, Filebeat will either not run correctly or will not report correctly to the ELK stack. Scroll down until you find the section labeled <strong class="bold">filebeat.inputs:</strong> surrounded by a bunch of equals signs, as shown in <span class="No-Break"><em class="italic">Figure 5</em></span><em class="italic">.7</em>. Find the field labeled <strong class="bold">enabled: false</strong> and change it to <span class="No-Break"><strong class="bold">enabled: true</strong></span><span class="No-Break">.</span></p>
<p>In the <strong class="bold">filebeat.inputs:</strong> section, remove the <strong class="source-inline">#</strong> symbol, whether you call it a hashtag, pound sign, or tic-tac-toe, from the <span class="No-Break">following fields:</span></p>
<ul>
<li><span class="No-Break"><strong class="source-inline">filebeat.inputs:</strong></span></li>
<li><strong class="source-inline">- </strong><span class="No-Break"><strong class="source-inline">type: filestream</strong></span></li>
<li><span class="No-Break"><strong class="source-inline">id: my-filestream-id</strong></span></li>
<li><span class="No-Break"><strong class="source-inline">enabled: true</strong></span></li>
<li><strong class="source-inline">- /</strong><span class="No-Break"><strong class="source-inline">var/log/*.log</strong></span></li>
</ul>
<p>This is referred to as uncommenting a field. It is an industry best practice to do anytime you are working within a text file that contains any sort of <span class="No-Break">programming code.</span></p>
<p>Adjust Filebeat’s inputs so that it knows where and what type of information <span class="No-Break">to grab:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer082">
<img alt="Figure 5.7 – filebeat.yml configuration in the filebeat.inputs: section" height="427" src="image/B21223_05_7.jpg" width="750"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.7 – filebeat.yml configuration in the filebeat.inputs: section</p>
<p>Now, scroll down<a id="_idIndexMarker475"/> to the next section labeled <strong class="bold">filebeat.config.modules:</strong>, find the field labeled <strong class="bold">reload.enabled: false</strong>, and change it to <span class="No-Break"><strong class="bold">reload.enabled: true</strong></span><span class="No-Break">.</span></p>
<p>Make sure the following fields <span class="No-Break">are uncommented:</span></p>
<ul>
<li><span class="No-Break"><strong class="source-inline">filebeat.config.modules:</strong></span></li>
<li><span class="No-Break"><strong class="source-inline">path: ${path.config}/modules.d/*.yml</strong></span></li>
<li><span class="No-Break"><strong class="source-inline">reload.enabled: true</strong></span></li>
</ul>
<p>Adjust the Filebeat modules so that they accommodate supplementary features we will <span class="No-Break">add later:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer083">
<img alt="Figure 5.8 – filebeat.yml configuration in the filebeat.config.modules: section" height="215" src="image/B21223_05_8.jpg" width="650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.8 – filebeat.yml configuration in the filebeat.config.modules: section</p>
<p>Continue <a id="_idIndexMarker476"/>scrolling through <strong class="source-inline">filebeat.yml</strong> until you reach the <strong class="bold">Dashboards</strong> section. Uncomment <strong class="source-inline">setup.dashboards.enabled: true</strong> and then move to the Kibana part after it. Here, you will uncomment <strong class="source-inline">setup.kibana:</strong> and set the host value to <strong class="source-inline">localhost:5601</strong>, ensuring that the line is <span class="No-Break">also uncommented.</span></p>
<p>Allow dashboard setup and configure Filebeat so that it <span class="No-Break">allows Kibana:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer084">
<img alt="Figure 5.9 – The filebeat.yml file’s configuration dashboard and Kibana sections" height="658" src="image/B21223_05_9.jpg" width="950"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.9 – The filebeat.yml file’s configuration dashboard and Kibana sections</p>
<p>In the <strong class="bold">Outputs</strong> section, you’ll see options for both Elasticsearch and Logstash. This is because Filebeat can report to either application. For fun, we will set up both but only use Elasticsearch at this time. Uncomment <strong class="bold">output.elasticsearch</strong> but leave it in front of <strong class="bold">output.logstash</strong>. Doing this will invoke Filebeat sending information to Elasticsearch but not Logstash. If you accidentally uncomment both applications, you will receive an error in the next step. <em class="italic">So, make sure the # values are in place for the Logstash option before you proceed to the </em><span class="No-Break"><em class="italic">next step.</em></span></p>
<p>Next, you need to tell Filebeat where those applications are at. Remove the symbol from the <strong class="bold">hosts</strong> field for each application and set the <strong class="bold">hosts</strong> values to localhost, leaving the port numbers in place. This is a neat little security hack that has Filebeat reporting to the ELK stack through the port forwarding feature we set up earlier. Doing it that way means any Beats you set up outside of the network your host machine is on can report their data to the ELK stack without ever having direct access to the VM you are hosting Kali Purple on! Uncomment the <strong class="source-inline">protocol: "https"</strong> field to maintain compatibility <span class="No-Break">with Elasticsearch.</span></p>
<p>We recommend taking some time to study and set up SSL and TLS if you ever intend to use the ELK stack for commercial purposes. However, because we are simply setting up a proof-of-concept scenario here, we will skip the complexities of SSL and TLS. To avoid configuration and starting errors, we need to add a line after the <strong class="bold">hosts</strong> field in Elasticsearch. Add <span class="No-Break"><strong class="source-inline">ssl.verification_mode: none</strong></span><span class="No-Break">.</span></p>
<p>Finally, for Filebeat to <a id="_idIndexMarker477"/>properly access the Elasticsearch instance, you will need to provide credentials. These are the same service account credentials we’ve been using to access Elasticsearch since we first installed it. Make sure you uncomment the username and password fields and add the necessary credentials. Refer to <span class="No-Break"><em class="italic">Figure 5</em></span><em class="italic">.10</em> for a working example of how this <span class="No-Break">all looks.</span></p>
<p>Adjust the outputs so that Filebeat knows where to send <span class="No-Break">its data:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer085">
<img alt="Figure 5.10 – filebeat.yml Elasticsearch and Logstash sections" height="750" src="image/B21223_05_10.jpg" width="850"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.10 – filebeat.yml Elasticsearch and Logstash sections</p>
<p>When you’re finished, save<a id="_idIndexMarker478"/> the file the same way you would any text file and return to the terminal to verify the changes. At the command line, type <strong class="source-inline">cat filebeat.yml</strong>. This will print the contents of <strong class="source-inline">filebeat.yml</strong> to your screen in a read-only format. Scroll up to view the text and verify that the changes you just made are showing on your PowerShell <span class="No-Break">terminal screen.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">As you navigate the process of configuring the various applications in this book or integrating them with other applications, you will notice many configurable options that we are not discussing. Many of those options are for advanced use of these applications and are generally outside the scope of this book. Rest assured, we are giving you enough of the information to remain reasonably practical and useful. The silver lining is the knowledge that if any specific application we cover is of greater interest to you, you have so much more information to explore where you can continually upskill yourself throughout <span class="No-Break">your career.</span></p>
<p>Reporting the <a id="_idIndexMarker479"/>data Filebeat collects to the ELK stack is only going to work if we have data to report, right? There is a very large rabbit hole we can go down here but for our use case’s proof of concept, we will stick to<a id="_idIndexMarker480"/> reviewing <strong class="bold">data collection modules</strong>. You can get a list of available data collection modules by typing <strong class="source-inline">.\filebeat.exe modules list</strong> in PowerShell or <strong class="source-inline">./filebeat modules list</strong> in Linux or macOS. If you get an output error, that means <em class="italic">you missed the earlier instruction to comment out the Logstash output</em> in <strong class="source-inline">filebeat.yml</strong> after you added the information. Go back and do that, then return to perform this step again. There is a link in the <em class="italic">Further reading</em> section that will take you to the Elastic website, where you can study and learn what each of the modules is on the list that the command line returns to you. We are going to enable three <span class="No-Break">of them.</span></p>
<p>Do that now by typing <span class="No-Break">the following:</span></p>
<ul>
<li><strong class="source-inline">.\filebeat.exe modules </strong><span class="No-Break"><strong class="source-inline">enable mysql</strong></span></li>
<li><strong class="source-inline">.\filebeat.exe modules </strong><span class="No-Break"><strong class="source-inline">enable threatintel</strong></span></li>
<li><strong class="source-inline">.\filebeat.exe </strong><span class="No-Break"><strong class="source-inline">modules microsoft</strong></span></li>
</ul>
<p>Next, we need to establish an authorized <em class="italic">less privileged user</em> for Filebeat to use. Elastic is very particular about this being done before we enable and start Filebeat. First, we will create a role for the user and then we will establish the actual user. Double-check and make sure you have Elasticsearch and Kibana running in your Kali Purple VM. Then, on your host machine, open a web browser and put the address for Kibana (<a href="http://localhost:5601">http://localhost:5601</a>) in the address bar, making sure there’s no <em class="italic">s</em> after <span class="No-Break">the </span><span class="No-Break"><em class="italic">http</em></span><span class="No-Break">.</span></p>
<p>The Kibana home page should load. It might take a minute or so, especially if you’ve recently started the Kibana and/or Elasticsearch service in your VM. The three horizontal lines in the top-left corner of the Kibana home page are what we call a hamburger menu (because the lines presumably resemble a burger between two buns). Click on the hamburger menu and scroll to the bottom. Click <strong class="bold">Stack Management</strong> and, once again, scroll down the left navigation until you reach the <strong class="bold">Security</strong> section. In that section, click on <strong class="bold">Roles</strong> to open the <strong class="bold">Roles</strong> page. In the top-right corner, you’ll see a blue box labeled <strong class="bold">Create role</strong>. Select that option; when the page loads, you’ll see an option to enter a name for the role under <span class="No-Break"><strong class="bold">Role name</strong></span><span class="No-Break">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer086">
<img alt="Figure 5.11 – Creating Filebeat roles using the Kibana interface" height="564" src="image/B21223_05_11.jpg" width="1324"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.11 – Creating Filebeat roles using the Kibana interface</p>
<p>Enter something <a id="_idIndexMarker481"/>self-explanatory. For our example, we’ll <span class="No-Break">put </span><span class="No-Break"><strong class="source-inline">FB-Default-Role</strong></span><span class="No-Break">.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">Because things change over time, your experience here may have subtle differences by the time you read this. Remember, search engines are <span class="No-Break">your friends.</span></p>
<p class="callout">One thing you might need to do if you are experiencing problems with Beats roles reporting to the Kibana interface is to navigate to the directory where <strong class="source-inline">kibana.yml</strong> is – it should be <strong class="source-inline">/etc/kibana/</strong> – and type <strong class="source-inline">sudo nano kibana.yml</strong> to edit that file. You would use the arrow keys on your keyboard to navigate the file until you find the <strong class="bold">elasticsearch output</strong> section. Make sure the username and password are set to <strong class="source-inline">elastic</strong> for both. This is for the applications to <span class="No-Break">properly integrate.</span></p>
<p class="callout">Another consideration would be to make sure your host and VM have ports <strong class="source-inline">80</strong> and <strong class="source-inline">443</strong> forwarded so that the web browser itself <span class="No-Break">can communicate.</span></p>
<p>Then, return here and, in the section right afterward, click the drop-down menu after <strong class="bold">Cluster privileges</strong>. In that field, type <strong class="source-inline">monitor</strong> and then press <em class="italic">Ctrl</em> + <em class="italic">K</em> to complete the entry while allowing you to add more entries. Add <strong class="source-inline">read_ilm</strong>, <strong class="source-inline">manage_ilm</strong>, <strong class="source-inline">manage_index_templates</strong>, and <strong class="source-inline">read_pipeline</strong> as additional entries, pressing <em class="italic">Ctrl</em> + <em class="italic">K</em> after each entry. If you want an enhanced experience, you can also add <strong class="source-inline">manage_pipeline</strong> and <strong class="source-inline">manage_ingest_pipelines</strong>. We don’t recommend starting with these if you’re setting up a production scenario, however. In that case, start small and add features one at a time. If you weren’t already aware, you can use the <em class="italic">Ctrl</em> + <em class="italic">K</em> to autocomplete fields when entering multiple email addresses or in most areas where you want to add multiple datasets while remaining in place. It’s a handy shortcut <span class="No-Break">to learn!</span></p>
<p>Next, go further down to the <strong class="bold">Index privileges</strong> section and click the <strong class="bold">Indices</strong> dropdown. If you don’t see it, start typing <strong class="source-inline">filebeat-*</strong> and enter that value for that field. Just to the right of that menu, there is another one called <strong class="bold">Privileges</strong>. Select that drop-down menu and select or type <strong class="source-inline">create_doc</strong> for the field. Repeat this process to add <strong class="source-inline">create_index</strong> and <strong class="source-inline">view_index_metadata</strong>. When all the entries are in place, scroll to the bottom and click on the blue <strong class="bold">Create role</strong> button. The page will return to the default <strong class="bold">Roles</strong> page, where you should now see your newly created role at the top of <span class="No-Break">the list!</span></p>
<p>Enter the<a id="_idIndexMarker482"/> appropriate fields, as displayed here, to create <span class="No-Break">the role:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer087">
<img alt="Figure 5.12 – Entering role attributes" height="714" src="image/B21223_05_12.jpg" width="1155"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.12 – Entering role attributes</p>
<p>Return to <strong class="bold">Stack Management</strong> | <strong class="bold">Security</strong> in the left navigation pane. However, instead of selecting roles, select <strong class="bold">Users</strong> this time. In a similar fashion to role creation, it will display a <strong class="bold">Users</strong> page with a blue <strong class="bold">Create User</strong> button at the top right of the page. Select that button and fill out the fields as appropriate. In our example, we will name our user <strong class="bold">FB-Default-User</strong> so that it matches the default role we created. You can put whatever name you like in the <strong class="bold">Full name</strong> section and make up any email you’d like. We’ll add <strong class="source-inline">tester@testing.te</strong> for our example email. In a production scenario, you’d want this to be a real authentic identity and email and you’d want to have a secure password. Since we’re testing and our example will be destroyed long before we go to press, we’ll just put <strong class="source-inline">filebeat</strong> in as our password. The fun part is that when you click on the <strong class="bold">Roles</strong> dropdown, you will see the role you just created as an option to select. Go ahead and<a id="_idIndexMarker483"/> select that role and then click the blue <strong class="bold">Create user</strong> button at <span class="No-Break">the bottom:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer088">
<img alt="Figure 5.13 – Entering user attributes" height="696" src="image/B21223_05_13.jpg" width="756"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.13 – Entering user attributes</p>
<p>You’ll be returned to the default <strong class="bold">Users</strong> page, where you should see the user you just created with the roles assigned to them that you also just created now listed at the top. You can return to the <strong class="source-inline">filebeat.yml</strong> text we edited earlier and replace the superuser credentials with those you just created, thereby putting your newly created account with fewer privileges <span class="No-Break">in place.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">There are far more secure methods of doing this. In production, you might wish to use the Filebeat keystore, which involves using an API key and environment variables instead of a username and password. As you learn and develop your ELK stack skillset, do pay attention to advanced <span class="No-Break">security methods.</span></p>
<p class="callout">That said, there is a common issue when setting up the keystore where the final step hangs during the setup. At the time of writing, there are no known official publicly released fixes or explanations from Elastic addressing this issue. However, community members have worked around this error by returning to the user profile you just created and adding editor privileges from the <strong class="bold">Roles</strong> drop-down menu within the <span class="No-Break">user profile.</span></p>
<p>We are nearing<a id="_idIndexMarker484"/> the end of the initial ELK stack portion of this book. However, if you find that you’ve developed a deep interest in this particular suite of cyber defense tools, we will add a plethora of valuable links in the <em class="italic">Further reading</em> section so that you can become an ELK scholar if you so choose. In the meantime, let’s get this beat up <span class="No-Break">and running!</span></p>
<p>There is one final step to complete this process. For it to work, make sure your Kali Purple VM is running along with your ELK stack components. Once you’ve confirmed they are all running, you can do the final setup of your Filebeat  assets by typing <strong class="source-inline">.\filebeat.exe setup -e</strong> (<strong class="source-inline">./filebeat setup -e</strong> for Linux and macOS) and then observe the terminal for confirmation. There are a couple of potential show-stopping errors you might <span class="No-Break">receive here.</span></p>
<p>If the setup stops with an error message that says something along the lines of <em class="italic">x509 Certificate error</em> or <em class="italic">x509 Certificate signed by unknown authority</em>, then that’s likely because you missed the earlier instruction to add <strong class="bold">ssl.verification_mode: none</strong> under the <strong class="bold">Output</strong> section <span class="No-Break">in </span><span class="No-Break"><strong class="source-inline">filebeat.yml</strong></span><span class="No-Break">.</span></p>
<p>If the setup stops with an error message that says it couldn’t connect to any of the configured Elasticsearch hosts, then you need to go into your VM and launch a command-line terminal to make a quick change to the <strong class="source-inline">elasticsearch.yml</strong> file. Type <strong class="source-inline">sudo nano /etc/elasticsearch/elasticsearch.yml</strong>. Once you’re in the file, scroll down until you find the <strong class="bold">Network</strong> section. Within that section, look for the line that begins with <strong class="source-inline">network.host</strong> Edit that line by setting the value to <strong class="source-inline">0.0.0.0</strong> and uncommenting the line. It should now state <strong class="source-inline">network.host: 0.0.0.0</strong>. This command directs Elasticsearch to accept all connections. Press <em class="italic">Ctrl</em> + <em class="italic">X</em> to save and select <em class="italic">Y</em> for yes. Once you’re out of the editor, you will need to restart Elasticsearch for the changes to take effect. Type <strong class="source-inline">sudo systemctl restart elasticsearch</strong> to do so. Then, return to the command line on your host machine and type <strong class="source-inline">.\filebeat.exe setup -e</strong> if you’re in PowerShell or <strong class="source-inline">./filebeat setup -e</strong> if you’re on Linux or macOS. Be patient – this setup process could take a while and PowerShell could hang occasionally, making you think it’s frozen. We assure you, it’s not. It’s working hard to set up Filebeat <span class="No-Break">for you.</span></p>
<p>When the auto-setup is done, your command prompt will return. You may already have it running if you’ve followed the instructions thus far but in case you haven’t, it’s time to start the motor. Type <strong class="source-inline">Start-Service -Name Filebeat</strong> in PowerShell or <strong class="source-inline">sudo systemct start filebeat</strong> if Linux or macOS and go to a web browser on your <span class="No-Break">host machine.</span></p>
<p>Return to the Kibana user<a id="_idIndexMarker485"/> interface. You should already be there but if you’re not, enter <a href="http://localhost:5601">http://localhost:5601</a> into your address bar. Click on the hamburger menu and scroll down to the <strong class="bold">Dashboards</strong> link under the <strong class="bold">Analytics</strong> section. Select <strong class="bold">Dashboards</strong>; if the page loads with any entries at all, then at least the Kibana dashboards portion of your Filebeat installation has <span class="No-Break">been successful!</span></p>
<p>Return to and select the hamburger menu again, scrolling back to the bottom, click on <strong class="bold">Stack Management</strong>, and then click <strong class="bold">Index Management</strong> in the new menu that loads. From there, look at the main window – you will see some tabs across the top. Click on <strong class="bold">Data Streams</strong>; you should see your Filebeat installation listed. It will be the only entry and have the word <em class="italic">filebeat</em> as part of its name. Jump ahead to <span class="No-Break"><em class="italic">Figure 5</em></span><em class="italic">.15</em> for a visualization that represents this same screen with Elastic agent data streams instead <span class="No-Break">of Filebeat.</span></p>
<p>As you can see, Filebeat takes a little bit of work to set up but they’re all simple steps. Filebeat is very efficient and doesn’t take any measurable amount of computing resources. This allows you to expand your network security efficiently, albeit with a little elbow grease. While it’s the most common beat of the ecosystem, it’s not the only one. A few others will be listed in the next section, along with the most common Beats alternative – the <span class="No-Break">Elastic Agent.</span></p>
<h1 id="_idParaDest-89"><a id="_idTextAnchor091"/>Types of Beats</h1>
<p>Other<a id="_idIndexMarker486"/> Beats include <strong class="bold">Metricbeat</strong>, which<a id="_idIndexMarker487"/> is used to capture infrastructure <a id="_idIndexMarker488"/>data, and <strong class="bold">Winlogbeat</strong>, which is used to capture Windows event logs. Winlogbeat<a id="_idIndexMarker489"/> would’ve <a id="_idIndexMarker490"/>been a more appropriate beat to use on our Windows host but we wanted to familiarize you with the beat you’re most likely to see when employed in the field and that is most definitely Filebeat. There is<a id="_idIndexMarker491"/> also <strong class="bold">Heartbeat</strong>, which is<a id="_idIndexMarker492"/> used to capture device uptime information, and <strong class="bold">Auditbeat</strong>, which <a id="_idIndexMarker493"/>focuses<a id="_idIndexMarker494"/> on audit types <span class="No-Break">of events.</span></p>
<p>Elastic is pushing hard for folks to move to their more inclusive – but heftier – Elastic Agent, which functions as sort of a universal beat. Nevertheless, you will encounter individual beats in the world for quite some time and should be familiarized with them. Before we install the Elastic agent, you will want to uninstall your Filebeat to prevent resource conflicts if you’re putting it on the same device. Honestly, you don’t need to do that. You can have fun with it and put it on the same device that’s hosting your ELK stack. You can even install it on your VM. There’s no harm in doing it that way. Just make sure you have your host IP correct because <em class="italic">localhost</em> won’t work in your configuration files if you do it that way. Instead, you will want to type <strong class="source-inline">ifconfig</strong> inside a terminal window and grab your eth0 IP address from there to put in your config files. It likely will be <strong class="source-inline">10.0.2.15</strong> if you’re using VirtualBox but check this to <span class="No-Break">be sure.</span></p>
<p>If you’re feeling adventurous, Elastic does offer a tutorial on upgrading an existing Beats package to the Elastic agent. We’ve added that information to the <em class="italic">Further reading</em> section for you. In the meantime, prepare to be stunned when you see how much quicker and easier it is to install the <span class="No-Break">Elastic agent!</span></p>
<h1 id="_idParaDest-90"><a id="_idTextAnchor092"/>Elastic Agent</h1>
<p>While the Beats lightweight data shipping ecosystem is great for small projects, they are quickly working their way into oblivion<a id="_idIndexMarker495"/> with the <a id="_idIndexMarker496"/>new <strong class="bold">Elastic Agent</strong> and <strong class="bold">Fleet Server</strong> combination. Because we are working with a single device, we will install the Elastic Agent as a standalone package and will not be working with the Fleet server. However, if you are looking to marry the Elastic Agent with the ELK stack in a production environment or wish to use multiple Elastic agents on several devices, we recommend examining a newer product Elastic has put out called the Fleet server. The Fleet server is not part of the native Kali Purple distribution as of this writing but it wouldn’t be surprising if a quick install package is added for package managers in the not-too-distant future. You can still set it up through the Kibana dashboard. We’ve added links to the <em class="italic">Further reading</em> section if you’d like to go the <span class="No-Break">extra mile.</span></p>
<p>Let’s grab the product itself by pointing our host machine’s web browser to https://www.elastic.co/downloads/elastic-agent to grab the most recent release of the product. A page will open that is nearly identical to the page we went to download Filebeat. In the same manner, select the appropriate OS of your host machine but don’t click <strong class="bold">Download</strong> yet. We are only selecting it, so the proper file hash presents itself in the SHA link to the right of the blue download box. Select the SHA link to grab and record the file hash. Then, select and click the blue box to begin downloading the <span class="No-Break">Elastic Agent.</span></p>
<p>Just as we did with Filebeat, wait for the download to complete and then open Windows File Explorer to navigate to the <strong class="source-inline">Downloads</strong> directory. Once you’re there and before we do anything else – including simplifying the filename – we need to grab the hash to compare it with the one we grabbed from Elastic’s website, just as we did the first time. Type <strong class="source-inline">Get-FileHash -Path &lt;your downloaded filename&gt;</strong>. We cannot tell you what that is because it will not be the same for you due to regular updates to the Elastic Agent. If you’re on a Mac, type <strong class="source-inline">shasum -a 512 &lt;your downloaded filename&gt;</strong>; if you’re one of the cool kids on the block and using Linux, type <strong class="source-inline">sha512sum &lt;your downloaded filename&gt;</strong>. Once the hash is confirmed, right-click and select <strong class="bold">Extract All</strong>. In the <strong class="bold">Files will be extracted to this folder:</strong> section, delete the default entry and type <span class="No-Break"><strong class="source-inline">C:\Program Files</strong></span><span class="No-Break">.</span></p>
<p>Select <strong class="bold">Extract</strong> and navigate to the <strong class="source-inline">C:\Program Files</strong> directory when the extraction completes. Once there, right-click the directory and either press <em class="italic">F2</em> or select the rename icon at the bottom of the dropdown. That will be the image with the letter A. For simplicity’s sake, rename the installation to something simple and easy to remember. Let’s go with <em class="italic">Elastic-Agent</em>. Open<a id="_idIndexMarker497"/> a PowerShell instance on your host machine, navigate to the <strong class="source-inline">C:\Program Files\Elastic-Agent</strong> directory, and then type <strong class="source-inline">notepad elastic-agent.yml</strong> to edit the configuration file. Remember, you need administrator privileges to edit this file. Type <strong class="source-inline">powershell Start-Process powershell -Verb Runas</strong> to get such <span class="No-Break">righteous power.</span></p>
<p>Before editing the configuration file, let’s make sure our friends on Linux and macOS can download and install the product. Both systems have auto-hash checking built in to save you <span class="No-Break">some work.</span></p>
<p>Linux users can skip the browser-based download and use the command-line utility’s automatic hash-checking, which is built in. Type <strong class="source-inline">sudo apt-get install elastic-agent</strong> or <strong class="source-inline">sudo yum install elastic-agent</strong> and then navigate to the <strong class="source-inline">/etc/elastic-agent</strong> folder, where you can type <strong class="source-inline">ls</strong> to confirm that the <strong class="source-inline">.yml</strong> file is present. Use your favorite editor to edit <strong class="source-inline">elastic-agent.yml</strong> – for most people, it’s vim <span class="No-Break">or nano.</span></p>
<p>macOS users can use Homebrew by typing <strong class="source-inline">brew install elastic/tap/elastic-agent</strong> and then navigating to the <strong class="source-inline">/Library/Elastic/Agent</strong> directory, where they can look for and edit <strong class="source-inline">elastic-agent.yml</strong> using the same available tools found in Linux, such as vim <span class="No-Break">or nano.</span></p>
<p>Whatever solution you are using, go ahead and open the <strong class="source-inline">elastic-agent.yml</strong> file for editing. In the interest of<a id="_idIndexMarker498"/> keeping our experience moving along, we are going to do a bare-bones configuration. Check <span class="No-Break">the following:</span></p>
<ul>
<li>The <strong class="source-inline">hosts</strong> field has the correct protocol – <strong class="source-inline">https</strong> instead <span class="No-Break">of </span><span class="No-Break"><strong class="source-inline">http</strong></span></li>
<li>The <strong class="source-inline">hosts</strong> field has the correct IP address and port – <strong class="source-inline">localhost</strong> for most of you <span class="No-Break">and </span><span class="No-Break"><strong class="source-inline">9200</strong></span></li>
<li>The <strong class="source-inline">hosts</strong> field has the correct format <span class="No-Break">hosts: </span><span class="No-Break"><strong class="source-inline">["IP:PORT"]</strong></span></li>
<li>The <strong class="source-inline">api_key</strong> field should be <span class="No-Break">commented out</span></li>
<li>The <strong class="source-inline">username</strong> and <strong class="source-inline">password</strong> fields should <span class="No-Break">be uncommented</span></li>
<li>Valid credentials should be listed after the username <span class="No-Break">and password</span></li>
<li>Add the following line after <strong class="source-inline">password</strong>: <span class="No-Break"><strong class="source-inline">ssl.verification_mode: none</strong></span><span class="No-Break">:</span></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer089">
<img alt="Figure 5.14 – elastic-agent.yml configuration settings if reporting to Elasticsearch" height="464" src="image/B21223_05_14.jpg" width="1149"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.14 – elastic-agent.yml configuration settings if reporting to Elasticsearch</p>
<p>The final line in the<a id="_idIndexMarker499"/> preceding step is to temporarily disable SSL security for training and proof-of-concept so that we can get a quick use case with results to see. Alternatively, if you used the Kibana graphical environment to install an Elastic Agent, which you can do by simply typing <strong class="source-inline">elastic agent</strong> in the search bar and following the prompts, it will give you <strong class="source-inline">ssl.ca_trusted_fingerprint</strong>, which you can add, as shown in <span class="No-Break"><em class="italic">Figure 5</em></span><span class="No-Break"><em class="italic">.15</em></span><span class="No-Break">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer090">
<img alt="Figure 5.15 – elastic-agent.yml configuration settings if installed from the Kibana GUI" height="491" src="image/B21223_05_15.jpg" width="850"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.15 – elastic-agent.yml configuration settings if installed from the Kibana GUI</p>
<p>It is of paramount <a id="_idIndexMarker500"/>importance that you use proper authentication and have your SSL properly set up if you are planning to deploy an Elastic Agent in a <span class="No-Break">production environment.</span></p>
<p>So, let’s install it by typing <strong class="source-inline">.\Elastic-Agent install</strong>, substituting <strong class="source-inline">Elastic-Agent</strong> for whatever other name you might have chosen if you are in PowerShell and <strong class="source-inline">sudo systemctl start elastic-agent</strong> if you are in a macOS or Linux terminal. Select <strong class="source-inline">Y</strong> when you’re asked if you want to continue and <strong class="source-inline">N</strong> when you’re asked if you want to enroll this agent <span class="No-Break">into Fleet.</span></p>
<p>Let’s see our hard work in action, shall we? After making sure Elasticsearch, Kibana, and your Elastic Agent are all turned on and running, open up a web browser and log in to Kibana. Return to and select our tasty hamburger menu again, scrolling back to the bottom before clicking <span class="No-Break"><strong class="bold">Stack Management</strong></span><span class="No-Break">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer091">
<img alt="Figure 5.16 – Stack Management" height="1018" src="image/B21223_05_16.jpg" width="300"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.16 – Stack Management</p>
<p>Then, click <strong class="bold">Index Management</strong> in the new menu that loads. From there, look at the main window pane; you <a id="_idIndexMarker501"/>will see some tabs across the top. Click on <strong class="bold">Data Streams</strong>. This is where your Filebeat installation was listed – maybe it still is if you installed the Elastic Agent on a different device without removing Filebeat first. Now, you will see a plethora of data that’s coming in from your Elastic Agent! This is proof that your installation <span class="No-Break">was successful:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer092">
<img alt="Figure 5.17 – Index Management | Data Streams" height="659" src="image/B21223_05_17.jpg" width="249"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.17 – Index Management | Data Streams</p>
<p>So, you can now see how<a id="_idIndexMarker502"/> incredibly simple the Elastic Agent is to install compared to Beats. However, there is a trade-off between the Elastic Agent and Beats. The Elastic Agent has pretty much everything from all of the different Beats combined, plus more, in just one endpoint agent. However, this comes at the cost of performance. There is more for your endpoint to work through. The Elastic Agent is just one piece of software. So, if you only need to report on logfiles, you still have to install the entire agent complete with features for measuring device uptime or infrastructure data. You will have unnecessary overhead. Maybe this is a non-issue for you. For many, it isn’t. If your equipment and network structure has the spare room, then it’s no big deal and the Elastic Agent will be the simplest version of data shipping <span class="No-Break">for you.</span></p>
<h1 id="_idParaDest-91"><a id="_idTextAnchor093"/>Logstash and filters</h1>
<p>One last item of business before we wrap up the ELK stack portion of Kali Purple. We’ve been reporting to Elasticsearch to provide you with a quick and easy use case. In reality, you are more likely to be setting your data shippers and endpoint agents to first run the data through<a id="_idIndexMarker503"/> Logstash, where it can be enriched for clearer analysis. We have two steps left to make <span class="No-Break">that work.</span></p>
<p>First, we need to return to whichever process we are using to collect data. In the most recent case, it’s the Elastic Agent, but it could be one of the Beats or some other agent we’ve integrated with the ELK stack on one of our endpoints. Edit the <strong class="source-inline">.yml</strong> or other configuration file for that process to comment out the sections regarding Elasticsearch and uncomment the sections for Logstash, as you might recall from earlier in this chapter. In the case of <strong class="source-inline">elastic-agent.yml</strong>, you would simply change the type to Logstash, edit the <strong class="bold">hosts</strong> field so that it’s <strong class="source-inline">http</strong> instead of <strong class="source-inline">https</strong>, and change the port number from <strong class="source-inline">9200</strong> to <strong class="source-inline">5044</strong>, as seen in <span class="No-Break"><em class="italic">Figure 5</em></span><em class="italic">.18</em>. In the case of other agents, you will want to comment out the <strong class="bold">Elasticsearch</strong> section and uncomment the <strong class="bold">Logstash</strong> section, making sure to set <strong class="source-inline">http</strong> instead of <strong class="source-inline">https</strong>, the port to <strong class="source-inline">5044</strong> instead of <strong class="source-inline">9200</strong>, and comment out the credentials since Logstash handles the authentication with Elasticsearch in the config file you will create in <span class="No-Break">a moment:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer093">
<img alt="Figure 5.18 – elastic-agent.yml configuration settings if reporting to Logstash" height="448" src="image/B21223_05_18.jpg" width="1104"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.18 – elastic-agent.yml configuration settings if reporting to Logstash</p>
<p>Secondly, do you remember how we set up the configuration file for Logstash in <a href="B21223_04.xhtml#_idTextAnchor076"><span class="No-Break"><em class="italic">Chapter 4</em></span></a> and had<a id="_idIndexMarker504"/> Logstash report its output to Elasticsearch? Now, we need to return to that file and configure it so that it receives data from whichever process we are using to send data to it. In our example, we will use the recent setup of the Elastic Agent. We will add that information while specifying the port in the input section of the configuration file. Within your Kali Purple environment, open a terminal window, navigate to <strong class="source-inline">/etc/logstash/conf.d</strong>, and type <strong class="source-inline">ls</strong> to see if <strong class="source-inline">logstash.conf</strong> is present. It might not be present if you haven’t used it. If a directory doesn’t allow you access along the way, remember the <strong class="source-inline">CHMOD</strong> commands we spoke of in <a href="B21223_03.xhtml#_idTextAnchor052"><span class="No-Break"><em class="italic">Chapter 3</em></span></a> – you can use these to adjust folder/directory permissions. You can use <strong class="source-inline">chmod 755 &lt;filename&gt;</strong> as a quick fix but that’s not the best of habits to get into. You don’t want to provide more freedom than is necessary. Take some time to review the CHMOD details that were provided <a href="B21223_03.xhtml#_idTextAnchor052"><span class="No-Break"><em class="italic">Chapter 3</em></span></a> and/or also do some independent research. That’s an area that is fairly easy to learn and worth the <span class="No-Break">skills gained.</span></p>
<p>In <a href="B21223_04.xhtml#_idTextAnchor076"><span class="No-Break"><em class="italic">Chapter 4</em></span></a>, you only created a sample configuration file. Here, you’re going to create a functioning Logstash <a id="_idIndexMarker505"/>configuration file. Navigate to the <strong class="source-inline">/etc/logstash/</strong> directory. If it’s present, use your favorite editor to open it; otherwise, type <strong class="source-inline">sudo nano logstash.conf</strong> to edit it. If it isn’t present, type <strong class="source-inline">touch logstash.conf</strong> to create it. Then, <strong class="source-inline">ls</strong> to verify it was created and go to your favorite editor or <strong class="source-inline">sudo nano logstash.conf</strong> to edit it. Input the <span class="No-Break">following information:</span></p>
<pre class="source-code">
input {
 elastic_agent {
   port =&gt; 5044
 }
}
filter {
 grok {
   match =&gt; {"message" =&gt; "%
      {TIMESTAMP_ISO8601:timestamp}%
      {LOGLEVEL:loglevel}\[%
      {DATA:component}\]%
      {GREEDYDATA:log_message}"}
     }
 }
}
output {
  elasticsearch {
   hosts =&gt; ["YOUR_ELASTICSEARCH_IP:9200"]
   user =&gt; "elastic"
   password =&gt; "ElasticSuperUserPassword"
  }</pre> <p>Once you’ve finished editing the file, press <em class="italic">Ctrl</em> + <em class="italic">X</em> to exit. Select <em class="italic">Y</em> when you’re prompted, then type <strong class="source-inline">sudo systemctl restart logstash</strong>, and give it a few minutes <span class="No-Break">to restart.</span></p>
<p>As before, you will want to place the IP address of where your Elasticsearch instance is being hosted in the <strong class="bold">hosts</strong> field instead of <strong class="source-inline">YOUR_ELASTICSEARCH_IP</strong> and your Elastic credentials instead of <strong class="source-inline">ElasticSuperUserPassword</strong> in the <span class="No-Break">password field.</span></p>
<p>You’ll notice <a id="_idIndexMarker506"/>some odd data that we placed in the filters section. This is a basic and very popular data enrichment filter that’s used with Logstash. It helps to identify the incoming data based on the time it was generated, and the importance and classification of the data before passing it on to Elasticsearch for more <span class="No-Break">efficient indexing.</span></p>
<p>As we did in <a href="B21223_04.xhtml#_idTextAnchor076"><span class="No-Break"><em class="italic">Chapter 4</em></span></a>, we will perform a configuration validation and syntax check of our newly created file. Type <span class="No-Break">the following:</span></p>
<pre class="console">
sudo /usr/share/logstash/bin/logstash –path.settings /etc/logstash -–path.config /etc/logstash -t -f /etc/logstash/logstash.conf</pre> <p>Be patient. As you may recall, this may take a minute or two <span class="No-Break">to complete.</span></p>
<h1 id="_idParaDest-92"><a id="_idTextAnchor094"/>Summary</h1>
<p>In this chapter, we dove into moving data from endpoint devices to the SIEM solution we created in previous chapters – to the ELK stack. We discovered that the process of moving such data has an enormous level of variable configurations and we learned that independent research will likely be required by anyone who wishes to set up such an environment. We created bare-bones use cases to show how the data flows and discover how to set up the data shipping agents so that they work with the <span class="No-Break">ELK stack.</span></p>
<p>We also took some time to explore the different types of data shippers, namely Beats. Here, instead of there being a single agent, many smaller agents can each be installed individually with greater efficiency, allowing the security team to only harness what is needed most. We compared this to the much easier-to-install but robust Elastic Agent, which contains more overhead to cover more potential security areas but will also be more dependent on a device’s resources, as well as the resources of the ELK stack. We learned how each of these agents shipped the data either directly to Elasticsearch or first to Logstash and then on to Elasticsearch. We provided an example of a filter, which provides data enrichment <span class="No-Break">through Logstash.</span></p>
<p>Now that we’ve discovered how to harvest and ship the data, in this next chapter, we’ll study the data that we’ll need to grab. There, we will examine the different types of data out there and the different types of formats it can be presented in. We’ll get a bigger understanding of how bad actors can sometimes obfuscate or otherwise maliciously alter this data to hide their activities or conduct bad deeds. We will also learn how to identify such anomalous behavior so that when it arrives in our SIEM environment, we will be able to respond to potential threats <span class="No-Break">more efficiently.</span></p>
<h1 id="_idParaDest-93"><a id="_idTextAnchor095"/>Questions</h1>
<p>Answer the following questions to test your knowledge of <span class="No-Break">this chapter:</span></p>
<ol>
<li>What is <span class="No-Break">port forwarding?</span><ol><li class="Alphabets">When a marine facility redirects incoming vessels to <span class="No-Break">another location</span></li><li class="Alphabets">A computer networking technique that redirects traffic from one machine to another based on <span class="No-Break">communication ports</span></li><li class="Alphabets">When a user physically removes the <strong class="bold">network interface card</strong> (<strong class="bold">NIC</strong>) and places it into <span class="No-Break">another device</span></li></ol></li>
<li>True or false: port forwarding must be the same port number on both sending and <span class="No-Break">receiving devices.</span><ol><li class="Alphabets"><span class="No-Break">True</span></li><li class="Alphabets">False, they must <span class="No-Break">be different</span></li><li class="Alphabets">False, but they may be <span class="No-Break">the same</span></li></ol></li>
<li>How many different Beats can a user have on a <span class="No-Break">single device?</span><ol><li class="Alphabets">As many as they like, so long as they aren’t colliding on ports or <span class="No-Break">other resources</span></li><li class="Alphabets">No more than one at a <span class="No-Break">time, ever</span></li><li class="Alphabets">Two, so long as they’re not the same <span class="No-Break">Beats type</span></li></ol></li>
<li>Pronounced <em class="italic">YAML</em>, the <strong class="source-inline">.yml</strong> files are used for what type <span class="No-Break">of operation?</span><ol><li class="Alphabets">They are used for developing hard-coded add-on instructions for <span class="No-Break">the application</span></li><li class="Alphabets">They provide recipes for a type of vegetable that is often served with <span class="No-Break">green eggs</span></li><li class="Alphabets">They are used to configure variable settings for the applications to which <span class="No-Break">they belong</span></li></ol></li>
<li>What is <span class="No-Break">a filter?</span><ol><li class="Alphabets">It’s a piece of code that’s designed to prevent your device from displaying <span class="No-Break">offensive language</span></li><li class="Alphabets">They keep the air flowing through your physical device, clean and free <span class="No-Break">of debris</span></li><li class="Alphabets">They provide additional tables to be applied to incoming data for parsing and enriching <span class="No-Break">the data</span></li><li class="Alphabets">An American grunge rock back from <span class="No-Break">the 1990s</span></li><li class="Alphabets">All of <span class="No-Break">the above</span></li></ol></li>
</ol>
<h1 id="_idParaDest-94"><a id="_idTextAnchor096"/>Further reading</h1>
<p>To learn more about the topics that were covered in this chapter, take a look at the <span class="No-Break">following resources:</span></p>
<ul>
<li><strong class="bold">Alternate Windows Filebeat </strong><span class="No-Break"><strong class="bold">installation</strong></span><span class="No-Break">: </span><a href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation-configuration.xhtml"><span class="No-Break">https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation-configuration.xhtml</span></a></li>
<li><strong class="bold">TCP and UDP Protocols – Explained in Plain </strong><span class="No-Break"><strong class="bold">English</strong></span><span class="No-Break">: </span><a href="https://www.freecodecamp.org/news/tcp-and-udp-protocols/"><span class="No-Break">https://www.freecodecamp.org/news/tcp-and-udp-protocols/</span></a></li>
<li><strong class="bold">What computer networks are and how to actually understand </strong><span class="No-Break"><strong class="bold">them</strong></span><span class="No-Break">: </span><a href="https://www.freecodecamp.org/news/computer-networks-and-how-to-actually-understand-them-c1401908172d/"><span class="No-Break">https://www.freecodecamp.org/news/computer-networks-and-how-to-actually-understand-them-c1401908172d/</span></a></li>
<li><strong class="bold">Filebeat listing of Data Collection </strong><span class="No-Break"><strong class="bold">modules</strong></span><span class="No-Break">: </span><a href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-modules.xhtml"><span class="No-Break">https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-modules.xhtml</span></a></li>
<li><strong class="bold">Adding a Fleet Server to manage your elastic </strong><span class="No-Break"><strong class="bold">agents</strong></span><span class="No-Break">: </span><a href="https://www.elastic.co/guide/en/fleet/current/add-fleet-server-on-prem.xhtml#add-fleet-server-on-prem-add-server"><span class="No-Break">https://www.elastic.co/guide/en/fleet/current/add-fleet-server-on-prem.xhtml#add-fleet-server-on-prem-add-server</span></a></li>
<li><span class="No-Break"><strong class="bold">Metricbeat</strong></span><span class="No-Break">: </span><a href="https://www.elastic.co/guide/en/beats/metricbeat/8.11/metricbeat-installation-configuration.xhtml"><span class="No-Break">https://www.elastic.co/guide/en/beats/metricbeat/8.11/metricbeat-installation-configuration.xhtml</span></a></li>
<li><span class="No-Break"><strong class="bold">Winlogbeat</strong></span><span class="No-Break">: </span><a href="https://www.elastic.co/guide/en/beats/winlogbeat/8.11/winlogbeat-installation-configuration.xhtml"><span class="No-Break">https://www.elastic.co/guide/en/beats/winlogbeat/8.11/winlogbeat-installation-configuration.xhtml</span></a></li>
<li><span class="No-Break"><strong class="bold">Heartbeat</strong></span><span class="No-Break">: </span><a href="https://www.elastic.co/guide/en/beats/heartbeat/8.11/heartbeat-installation-configuration.xhtml"><span class="No-Break">https://www.elastic.co/guide/en/beats/heartbeat/8.11/heartbeat-installation-configuration.xhtml</span></a></li>
<li><span class="No-Break"><strong class="bold">Auditbeat</strong></span><span class="No-Break">: </span><a href="https://www.elastic.co/guide/en/beats/auditbeat/8.11/auditbeat-installation-configuration.xhtml"><span class="No-Break">https://www.elastic.co/guide/en/beats/auditbeat/8.11/auditbeat-installation-configuration.xhtml</span></a></li>
<li><strong class="bold">Migrate from Beats to Elastic </strong><span class="No-Break"><strong class="bold">Agent</strong></span><span class="No-Break">: </span><a href="https://www.elastic.co/guide/en/fleet/current/migrate-beats-to-agent.xhtml"><span class="No-Break">https://www.elastic.co/guide/en/fleet/current/migrate-beats-to-agent.xhtml</span></a></li>
</ul>
</div>
</div></body></html>