- en: '3'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '3'
- en: Active Reconnaissance of External and Internal Networks
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 外部和内部网络的主动侦察
- en: Active reconnaissance is the art of collecting information directly from a target.
    The purpose of this phase is to collect and weaponize information about the target
    to the greatest degree possible to facilitate the exploitation phase of the kill
    chain methodology. We saw in the last chapter how to perform passive reconnaissance
    using OSINT, which is almost undetectable and can yield a significant amount of
    information about the target organization and its users. This phase builds on
    the results obtained from OSINT and passive reconnaissance and emphasizes more
    focused probing to identify the path to, and the attack surface of, a target.
    In general, complex systems have a greater attack surface, and each surface may
    be exploited and then leveraged to support additional attacks.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 主动侦察是直接从目标收集信息的艺术。这个阶段的目的是尽可能多地收集并武器化有关目标的信息，以促进“杀伤链”方法论的利用阶段。在上一章中，我们讨论了如何使用OSINT进行被动侦察，这几乎是不可被察觉的，并且能提供关于目标组织及其用户的大量信息。这个阶段建立在OSINT和被动侦察获得的结果基础上，强调更加集中的探测，以识别通往目标的路径以及攻击面。一般而言，复杂系统具有更大的攻击面，而每个攻击面都可能被利用，从而支持更多的攻击。
- en: 'Although active reconnaissance produces more useful information, interactions
    with the target system may be logged, triggering alarms by protective devices,
    such as firewalls, **Intrusion Detection Systems** (**IDSes**), **Intrusion Prevention
    Systems** (**IPSes**), and **Endpoint Detection Response** (**EDR**) **systems**.
    As the usefulness of the data to the attacker increases, so does the risk of detection;
    this is shown in *Figure 3.1*:'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管主动侦察能产生更有用的信息，但与目标系统的交互可能会被记录，从而触发保护设备（如防火墙、**入侵检测系统**（**IDSes**）、**入侵防御系统**（**IPSes**）和**终端检测响应**（**EDR**）**系统**）的警报。随着数据对攻击者的有用性增加，检测的风险也随之增加；这一点在*图
    3.1*中有所体现：
- en: '![](../Images/B17765_03_01.png)'
  id: totrans-4
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/B17765_03_01.png)'
- en: 'Figure 3.1: Usefulness of data and risk of detection for attackers'
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.1：数据的有用性与攻击者检测风险
- en: 'To improve the effectiveness of active reconnaissance in providing detailed
    information, our focus will be on using the stealthiest techniques, as these will
    be the most difficult to detect. In this chapter, you will learn about the following:'
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 为了提高主动侦察提供详细信息的效果，我们的重点将放在使用最隐蔽的技术上，因为这些技术最难被检测到。在本章中，你将学习以下内容：
- en: Stealth scanning techniques
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 隐蔽扫描技术
- en: External and internal infrastructure, host discovery, and enumeration
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 外部和内部基础设施、主机发现与枚举
- en: Comprehensive reconnaissance of applications, especially recon-ng
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 对应用程序进行全面侦察，特别是 recon-ng
- en: Enumeration of internal hosts using DHCP
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用DHCP枚举内部主机
- en: Enumerating services within the SaaS applications
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在SaaS应用程序中枚举服务
- en: Useful Microsoft Windows commands during penetration testing
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 渗透测试中有用的微软Windows命令
- en: Taking advantage of default configurations
  id: totrans-13
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 利用默认配置
- en: Enumeration of users using SNMP, SMB, and rpcclient
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用SNMP、SMB和rpcclient进行用户枚举
- en: Stealth scanning techniques
  id: totrans-15
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 隐蔽扫描技术
- en: The greatest risk of active reconnaissance is discovery by a target. Using the
    tester’s time and data stamps, the source IP address, and additional information,
    the target can identify the source of the incoming reconnaissance.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 主动侦察的最大风险是被目标发现。通过测试人员的时间和数据戳、源IP地址以及其他信息，目标可以识别侦察的来源。
- en: 'Therefore, stealth techniques are employed to minimize the chances of detection.
    When employing stealth to support reconnaissance, a tester mimicking the actions
    of a hacker will do the following:'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，采用隐蔽技术来最小化被检测的可能性。在支持侦察时，模拟黑客行为的测试人员将执行以下操作：
- en: Camouflage tool signatures to avoid detection and thereby trigger an alarm
  id: totrans-18
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 伪装工具签名以避免被检测，从而触发警报
- en: Hide the attack within legitimate traffic
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将攻击隐藏在合法流量中
- en: Modify the attack to hide the source and type of traffic
  id: totrans-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 修改攻击以隐藏流量的来源和类型
- en: Make the attack invisible using non-standard traffic types or encryption
  id: totrans-21
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用非标准流量类型或加密使攻击不可见
- en: 'Stealth scanning techniques can include some or all of the following:'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 隐蔽扫描技术可以包括以下部分或全部内容：
- en: Adjusting source IP stack and tool identification settings
  id: totrans-23
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 调整源IP栈和工具识别设置
- en: Modifying packet parameters (Nmap)
  id: totrans-24
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 修改数据包参数（Nmap）
- en: Using proxies with anonymity networks (ProxyChains and the Tor network)
  id: totrans-25
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用带有匿名网络的代理（ProxyChains和Tor网络）
- en: Adjusting source IP stack and tool identification settings
  id: totrans-26
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 调整源IP栈和工具识别设置
- en: Before the penetration tester (or the attacker) begins testing, we must ensure
    that all unnecessary services on Kali are disabled or turned off. This is to prevent
    detection. Say that the local DHCP daemon is enabled but is not required. It is
    possible for the DHCP to interact with the target system, which could then be
    logged and send alarms to the target’s administrators. Other services that require
    updating might establish network communication to the licensing server or bug
    reporting services, so it is better to disable all those services that are not
    required during the course of testing and enable only what is required to perform
    a given task.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 在渗透测试员（或攻击者）开始测试之前，我们必须确保Kali上所有不必要的服务都被禁用或关闭。这是为了防止被检测到。例如，本地的DHCP守护进程已启用但并不需要。DHCP有可能与目标系统交互，从而被记录并向目标管理员发送警报。其他需要更新的服务可能会与授权服务器或错误报告服务建立网络通信，因此最好在测试过程中禁用所有不需要的服务，只启用执行特定任务所必需的服务。
- en: Some commercial and open-source tools (for example, the Metasploit framework)
    tag their packets with an identifying sequence. Although this can be useful in
    a post-test analysis of a system’s event logs (where events initiated by a particular
    testing tool can be directly compared to a system’s event logs to determine how
    the network detected and responded to the attack), it can also trigger certain
    intrusion detection systems. Test your tools against a lab system to determine
    the packets that are tagged, and either change the tag or use the tool with caution.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 一些商业和开源工具（例如Metasploit框架）会在其数据包中标记一个标识序列。虽然这在测试后分析系统事件日志时非常有用（可以将由特定测试工具发起的事件与系统的事件日志直接比较，以确定网络如何检测和响应攻击），但它也可能触发某些入侵检测系统。在实验室系统中测试你的工具，确定哪些数据包被标记，并且可以选择更改标签或小心使用该工具。
- en: The easiest way to identify tagging is to apply the tool against a newly created
    virtual image as the target, and review system logs for the tool’s name. In addition,
    use Wireshark to capture traffic between the attacker and target virtual machines,
    and then search the **packet capture** (**pcap**) files for any keywords that
    can be attributed to the testing tool (name of the tool, vendor, license number,
    and so on).
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 识别标记的最简单方法是将工具应用于新创建的虚拟镜像作为目标，并查看系统日志中的工具名称。此外，使用Wireshark捕获攻击者和目标虚拟机之间的流量，然后在**数据包捕获**（**pcap**）文件中搜索任何可以归因于测试工具的关键词（工具名称、供应商、许可证号等）。
- en: '`useragent` in the Metasploit framework can be changed by modifying the `http_form_field`
    option. From the `msfconsole` prompt, select the option to use `auxiliary/fuzzers/http/http_form_field`
    and then set a new `useragent` header, as shown in *Figure 3.2*:'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 可以通过修改`http_form_field`选项来更改Metasploit框架中的`useragent`。在`msfconsole`提示符下，选择使用`auxiliary/fuzzers/http/http_form_field`选项，然后设置一个新的`useragent`头，如*图3.2*所示：
- en: '![](../Images/B17765_03_02.png)'
  id: totrans-31
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/B17765_03_02.png)'
- en: 'Figure 3.2: Changing the User agent in the Metasploit auxiliary'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 图3.2：在Metasploit辅助工具中更改User agent
- en: In this example, `useragent` was set to be Google’s indexing spider, `Googlebot-Image`.
    This is a common automated application that visits and indexes websites, and rarely
    attracts attention from the website’s owner.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个例子中，`useragent`被设置为Google的索引蜘蛛`Googlebot-Image`。这是一个常见的自动化应用程序，访问并索引网站，很少引起网站所有者的注意。
- en: 'Pentesters can also choose to use plugins such as Firefox’s user agent switcher:
    [https://addons.mozilla.org/en-GB/firefox/addon/uaswitcher/](https://addons.mozilla.org/en-GB/firefox/addon/uaswitcher/)'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 渗透测试人员还可以选择使用插件，如Firefox的User agent切换器：[https://addons.mozilla.org/en-GB/firefox/addon/uaswitcher/](https://addons.mozilla.org/en-GB/firefox/addon/uaswitcher/)
- en: 'Another alternative is Chrome’s user agent switcher:'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 另一种选择是使用Chrome的User agent切换器：
- en: '[https://chrome.google.com/webstore/detail/user-agent-switcher-for-c/djflhoibgkdhkhhcedjiklpkjnoahfmg](https://chrome.google.com/webstore/detail/user-agent-switcher-for-c/djflhoibgkdhkhhcedjiklpkjnoahfmg)'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://chrome.google.com/webstore/detail/user-agent-switcher-for-c/djflhoibgkdhkhhcedjiklpkjnoahfmg](https://chrome.google.com/webstore/detail/user-agent-switcher-for-c/djflhoibgkdhkhhcedjiklpkjnoahfmg)'
- en: 'To identify legitimate `useragent` headers, refer to the examples at:'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 要识别合法的`useragent`头，请参考以下示例：
- en: '[http://www.useragentstring.com/](http://www.useragentstring.com/)'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: '[http://www.useragentstring.com/](http://www.useragentstring.com/)'
- en: Modifying packet parameters
  id: totrans-39
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 修改数据包参数
- en: The most common approach to active reconnaissance is to conduct a scan against
    the target, send defined packets to it, and then use the returned packets to gain
    information. The most popular tool of this type is **Network Mapper** (**Nmap**).
    To use Nmap effectively, it must be run with root-level privileges. This is typical
    of applications that manipulate packets, hence we will be using `sudo` for all
    Nmap queries.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 最常见的主动侦察方法是对目标进行扫描，向其发送特定数据包，然后利用返回的数据包获取信息。这类工具中最受欢迎的是**网络映射工具**（**Nmap**）。要有效使用Nmap，必须以root权限运行。这是操作数据包的应用程序的常规要求，因此我们将在所有Nmap查询中使用`sudo`。
- en: 'When attempting to minimize detection, some stealth techniques include the
    following:'
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 在尝试减少被检测时，一些隐匿技术包括以下几种：
- en: Attackers approach the target with a goal in mind and send the minimum number
    of packets needed to determine the objective. For example, if you wish to confirm
    the presence of a web host, you first need to determine whether port `80` or `443`,
    the default ports for web-based services, are open.
  id: totrans-42
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 攻击者带着明确的目标接近目标，并仅发送足够数量的数据包来确定目标。例如，如果你想确认一个Web主机的存在，你首先需要确定`80`或`443`端口（Web服务的默认端口）是否开放。
- en: Avoid scans that may connect with the target system and leak data. Do not ping
    the target or use **synchronize** (**SYN**) and non-conventional packet scans,
    such as **acknowledge** (**ACK**), **finished** (**FIN**), and **reset** (**RST**).
  id: totrans-43
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 避免可能与目标系统建立连接并泄露数据的扫描。不要ping目标，或者使用**同步**（**SYN**）以及非常规数据包扫描，如**确认**（**ACK**）、**完成**（**FIN**）和**重置**（**RST**）。
- en: Randomize or spoof packet settings, such as the source IP and port address,
    and the MAC address.
  id: totrans-44
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 随机化或伪造数据包设置，例如源IP和端口地址，以及MAC地址。
- en: Adjust the timing to slow the arrival of packets at the target site.
  id: totrans-45
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 调整时间设置，减缓数据包到达目标站点的速度。
- en: Change the packet size by fragmenting packets or appending random data to confuse
    packet inspection devices.
  id: totrans-46
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过分片数据包或附加随机数据改变数据包大小，以混淆数据包检查设备。
- en: 'As an example, if you want to conduct a stealthy scan and minimize detection,
    the following `nmap` command could be used:'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 作为示例，如果你想进行隐匿扫描并尽量减少被检测，可以使用以下`nmap`命令：
- en: '[PRE0]'
  id: totrans-48
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: '*Table 3.1* details the previous command in detail:'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: '*表3.1* 详细说明了前述命令：'
- en: '| **Command** | **Rationale** |'
  id: totrans-50
  prefs: []
  type: TYPE_TB
  zh: '| **命令** | **原理** |'
- en: '| --- | --- |'
  id: totrans-51
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- |'
- en: '| `--spoof-mac-Cisco` | This spoofs the MAC address to match a Cisco product.
    Replacing Cisco with 0 will create a completely random MAC address. |'
  id: totrans-52
  prefs: []
  type: TYPE_TB
  zh: '| `--spoof-mac-Cisco` | 伪造MAC地址，使其与Cisco产品匹配。如果将Cisco替换为0，则会生成完全随机的MAC地址。 |'
- en: '| `--data-length 24` | This appends 24 random bytes to most packets that are
    sent. |'
  id: totrans-53
  prefs: []
  type: TYPE_TB
  zh: '| `--data-length 24` | 这会将24个随机字节附加到大多数发送的数据包中。 |'
- en: '| `-T paranoid` | This sets the time to the slowest setting: paranoid. |'
  id: totrans-54
  prefs: []
  type: TYPE_TB
  zh: '| `-T paranoid` | 将时间设置为最慢模式：paranoid。 |'
- en: '| `--max-hostgroup` | Limits the hosts that are scanned at any one time. |'
  id: totrans-55
  prefs: []
  type: TYPE_TB
  zh: '| `--max-hostgroup` | 限制同时扫描的主机数量。 |'
- en: '| `--max-parallelism` | Limits the number of outstanding probes that are sent
    out. You can also use the `--scan-delay` option to set a pause between the probes;
    however, this option is not compatible with the `--max_parallelism` option. |'
  id: totrans-56
  prefs: []
  type: TYPE_TB
  zh: '| `--max-parallelism` | 限制发送的未完成探测数。你还可以使用`--scan-delay`选项设置探测之间的暂停；然而，该选项与`--max_parallelism`选项不兼容。
    |'
- en: '| `-Pn` | This does not send a ping to identify active systems (as this can
    leak data). |'
  id: totrans-57
  prefs: []
  type: TYPE_TB
  zh: '| `-Pn` | 不发送ping以识别活动系统（因为这可能泄露数据）。 |'
- en: '| `-n` | No DNS resolution: internal or external DNS servers are not actively
    queried by Nmap for DNS information. Such queries are frequently logged, so the
    query function should be disabled. |'
  id: totrans-58
  prefs: []
  type: TYPE_TB
  zh: '| `-n` | 禁用DNS解析：Nmap不会主动查询内部或外部DNS服务器获取DNS信息。这类查询通常会被记录，因此应该禁用查询功能。 |'
- en: '| `-sS` | This conducts a stealth TCP SYN scan, which does not complete the
    TCP handshake. Other scan types (for example, null scans) can also be used; however,
    most of these will trigger detection devices. |'
  id: totrans-59
  prefs: []
  type: TYPE_TB
  zh: '| `-sS` | 进行隐匿的TCP SYN扫描，这种扫描不会完成TCP三次握手。其他扫描类型（例如，空扫描）也可以使用；然而，大多数此类扫描会触发检测设备。
    |'
- en: '| `-sV` | This enables version detection. |'
  id: totrans-60
  prefs: []
  type: TYPE_TB
  zh: '| `-sV` | 启用版本检测。 |'
- en: '| `-oA` | This outputs the results to all formats (XML, gnmap, and nmap). |'
  id: totrans-61
  prefs: []
  type: TYPE_TB
  zh: '| `-oA` | 该选项将结果输出为所有格式（XML、gnmap和nmap）。 |'
- en: '| `-p T:1-1024` | This specifies the TCP ports to be scanned. |'
  id: totrans-62
  prefs: []
  type: TYPE_TB
  zh: '| `-p T:1-1024` | 指定要扫描的TCP端口。 |'
- en: '| `--random-hosts` | This randomizes the target host order. |'
  id: totrans-63
  prefs: []
  type: TYPE_TB
  zh: '| `--random-hosts` | 随机化目标主机顺序。 |'
- en: 'Table 3.1: Breakdown of the previous Nmap command'
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 表3.1：对前述Nmap命令的详细解析
- en: Together, these options will create a very slow scan that hides the true identity
    of the source. However, if the packets are too unusual, complex modification may
    actually attract the attention of the target; therefore, many testers and attackers
    use anonymity networks to minimize detection.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 这些选项将共同创建一个非常缓慢的扫描，以隐藏源的真实身份。然而，如果数据包过于异常，复杂的修改实际上可能会引起目标的注意；因此，许多测试者和攻击者使用匿名网络来最小化被检测的风险。
- en: 'Attackers can also utilize the decoy or zombie method by running the following
    commands: `-D` is the switch, and the decoy can be any IP address; `RND:10` is
    any set of 10 random IP addresses that purport to be the source of the attack.
    When we use the `–sI` switch in Nmap, the target should receive the alerts from
    a zombie IP on the target:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 攻击者还可以通过运行以下命令利用诱饵或僵尸方法：`-D` 是开关，诱饵可以是任何 IP 地址；`RND:10` 是一组 10 个随机 IP 地址，伪装成攻击源。当我们在
    Nmap 中使用 `–sI` 开关时，目标应该会接收到来自僵尸 IP 的警报：
- en: '[PRE1]'
  id: totrans-67
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Using proxies with anonymity networks
  id: totrans-68
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用代理与匿名网络
- en: In this section, we will be exploring the two important tools that are utilized
    by attackers to maintain anonymity on the network. We will be focusing on Tor
    and Privoxy in this section.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，我们将探讨攻击者用来在网络上保持匿名的两个重要工具。我们将在本节中重点介绍 Tor 和 Privoxy。
- en: Tor ([www.torproject.org](http://www.torproject.org)) is an open source implementation
    of the third-generation onion routing that provides free access to an anonymous
    proxy network. Onion routing enables online anonymity by encrypting user traffic
    and then transmitting it through a series of onion routers. At each router, a
    layer of encryption is removed to obtain routing information, and the message
    is then transmitted to the next node. It has been likened to the process of gradually
    peeling an onion, hence the name. It protects against traffic analysis attacks
    by guarding the source and destination of a user’s IP traffic.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: Tor ([www.torproject.org](http://www.torproject.org)) 是一种开源的第三代洋葱路由实现，提供免费的匿名代理网络访问。洋葱路由通过加密用户流量并通过一系列洋葱路由器进行传输，从而实现在线匿名性。在每个路由器上，都会去除一层加密以获取路由信息，然后将消息传输到下一个节点。它被比作逐层剥洋葱的过程，因此得名。它通过保护用户
    IP 流量的源和目的地来防范流量分析攻击。
- en: In this example, Tor will be used with Privoxy, a noncaching web proxy that
    sits in the middle of an application that communicates with the internet and uses
    advanced filtering to ensure privacy and the removal of adverts, along with any
    potentially hostile data being sent to the tester.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 在此示例中，Tor 将与 Privoxy 一起使用，Privoxy 是一个不缓存的 Web 代理，位于与互联网通信的应用程序之间，并使用高级过滤确保隐私和去除广告，同时删除任何可能发送给测试者的潜在恶意数据。
- en: 'To install Tor, perform the following steps:'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 安装 Tor，请执行以下步骤：
- en: 'Issue the `apt-get update` and `apt-get upgrade` commands, and then use the
    following command:'
  id: totrans-73
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 执行 `apt-get update` 和 `apt-get upgrade` 命令，然后使用以下命令：
- en: '[PRE2]'
  id: totrans-74
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Once Tor is installed, edit the `proxychains4.conf` file located in the `/etc`
    directory. This file dictates the number and order of proxies that the test system
    will use on the way to the Tor network. Proxy servers may be down, or they may
    be experiencing a heavy load (causing slow or latent connections); if this occurs,
    a defined or strict ProxyChain will fail due to an expected link being missing.
    Therefore, disable the use of `strict_chain` and enable `dynamic_chain`, which
    ensures that the connection will be routed, as shown in *Figure 3.3*:![](../Images/B17765_03_03.png)
  id: totrans-75
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 一旦安装了 Tor，请编辑位于 `/etc` 目录中的 `proxychains4.conf` 文件。该文件规定了测试系统在访问 Tor 网络时将使用的代理的数量和顺序。代理服务器可能宕机，或者可能出现过载（导致连接缓慢或延迟）；如果发生这种情况，严格的
    ProxyChain 将由于缺少预期链接而失败。因此，禁用 `strict_chain` 并启用 `dynamic_chain`，这样可以确保连接按照*图
    3.3*所示进行路由：![](../Images/B17765_03_03.png)
- en: 'Figure 3.3: Enabling the dynamic chain in Proxychains4.conf'
  id: totrans-76
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 3.3：在 Proxychains4.conf 中启用动态链
- en: Edit the `[ProxyList]` section to ensure that the `socks5` proxy is present,
    as shown in *Figure 3.4*:![](../Images/B17765_03_04.png)
  id: totrans-77
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 编辑 `[ProxyList]` 部分，确保 `socks5` 代理存在，如*图 3.4*所示：![](../Images/B17765_03_04.png)
- en: 'Figure 3.4: Adding the proxy list to the proxychains4.conf'
  id: totrans-78
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 3.4：将代理列表添加到 proxychains4.conf 中
- en: Open proxies can easily be found online (an example would be [https://www.proxynova.com/proxy-server-list/](https://www.proxynova.com/proxy-server-list/))
    and added to the `proxychains.conf` file. Testers can take advantage of this to
    further obfuscate their identity. For example, if there are reports that a certain
    country or block of IP addresses has been responsible for recent online attacks,
    look for open proxies from that location and add them to your list or a separate
    configuration file.
  id: totrans-79
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'To start the Tor service from a terminal window, enter the following command:'
  id: totrans-80
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE3]'
  id: totrans-81
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Verify that Tor has started by using the following command:'
  id: totrans-82
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-83
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE4]'
- en: It is important to verify that the Tor network is working and providing anonymous
    connectivity.
  id: totrans-84
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Verify your source IP address first. From a terminal, enter the following command:'
  id: totrans-85
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-86
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE5]'
- en: This will start the Iceweasel browser and open it to a site that provides the
    source IP address connected with that web page.
  id: totrans-87
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Note the IP address, and then invoke Tor routing using the following ProxyChains
    command:'
  id: totrans-88
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE6]'
  id: totrans-89
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'In this particular instance, the IP address was identified as `xx.xx.xx.xx`.
    A `whois` lookup of that IP address from a terminal window indicates that the
    transmission is now exiting from a Tor exit node, as shown in *Figure 3.5*:'
  id: totrans-90
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '![](../Images/B17765_03_05.png)'
  id: totrans-91
  prefs:
  - PREF_IND
  type: TYPE_IMG
- en: 'Figure 3.5: whois details of your randomly assigned IP address'
  id: totrans-92
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: You can also verify that Tor is functioning properly by accessing
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
- en: '[https://check.torproject.org](https://check.torproject.org).'
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
- en: Although communications are now protected using the Tor network, it is possible
    for a DNS leak to occur, which occurs when your system makes a DNS request to
    provide your identity to an ISP. You can check for DNS leaks at [www.dnsleaktest.com](http://www.dnsleaktest.com).
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
- en: 'Most command lines can be run from the console using `proxychains` to access
    the Tor network. When using Tor, some considerations to be kept in mind are as
    follows:'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
- en: Tor provides an anonymizing service, but it does not guarantee privacy. Owners
    of the exit nodes are able to sniff traffic and may be able to access user credentials.
  id: totrans-97
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Vulnerabilities in the Tor browser bundle have reportedly been used by law enforcement
    to exploit systems and acquire user information.
  id: totrans-98
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: ProxyChains do not handle **User Datagram Protocol** (**UDP**) traffic.
  id: totrans-99
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Some applications and services cannot run over this environment—in particular,
    Metasploit and Nmap may break. The stealth SYN scan of Nmap breaks out of ProxyChains
    and the connect scan is invoked instead; this can leak information to the target.
  id: totrans-100
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Some browser applications (Flash/ActiveX or HTML5) can be used to obtain your
    IP address.
  id: totrans-101
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Attackers can also use random chaining. With this option, ProxyChains will randomly
    choose IP addresses from our list (local Ethernet IP, for example, `127.0.0.1`,
    `192.168.x.x` or `172.16.x.x`) and use them to create our ProxyChain. This means
    that each time we use ProxyChains, the chain of proxies will look different to
    the target, making it harder to track our traffic from its source.
  id: totrans-102
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 攻击者还可以使用随机链接。使用此选项时，ProxyChains 会从我们的列表中随机选择 IP 地址（例如本地以太网 IP，`127.0.0.1`，`192.168.x.x`
    或 `172.16.x.x`）并用它们来创建我们的 ProxyChain。这意味着每次使用 ProxyChains 时，代理链对目标看起来都不同，从而使追踪我们流量的来源变得更加困难。
- en: To do so, in a similar fashion, edit the `/etc/proxychains4.conf` file and comment
    out `dynamic chains` and uncomment `random_chain`, since we can only use one of
    these options at a time.
  id: totrans-103
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 为此，以类似的方式编辑 `/etc/proxychains4.conf` 文件，注释掉 `dynamic chains` 并取消注释 `random_chain`，因为我们一次只能使用其中一个选项。
- en: In addition, attackers can uncomment the line with `chain_len`, which will then
    determine the number of IP address in the chain while creating a random proxy
    chain.
  id: totrans-104
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 此外，攻击者可以取消注释 `chain_len` 所在的行，这样在创建随机代理链时，链中的 IP 地址数量将由其决定。
- en: This technique can be engaged by attackers to establish a qualified anonymity
    and then remain anonymous over the network.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 攻击者可以使用此技术来建立合格的匿名性，并在网络上保持匿名。
- en: DNS reconnaissance and route mapping
  id: totrans-106
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: DNS 侦察与路由映射
- en: Once a tester has identified the targets that have an online presence and contain
    items of interest, the next step is to identify the IP addresses and routes to
    the target. DNS reconnaissance is concerned with identifying who owns a particular
    domain or series of IP addresses (the sort of information gained with `whois`,
    although this has been completely changed with the **General Data Protection Regulation**
    (**GDPR**) enforcement across Europe from May 2018). The DNS information defines
    the actual domain names and IP addresses assigned to the target, and the route
    between the penetration tester—or the attacker—and the final target.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦测试者识别出具有在线存在并包含感兴趣项目的目标，下一步是识别目标的 IP 地址和路由。DNS 侦察关注的是识别谁拥有某个特定域名或一系列 IP 地址（这类信息可以通过
    `whois` 获得，尽管自 2018 年 5 月起，**通用数据保护条例**（**GDPR**）在欧洲生效后，这一过程已发生完全变化）。DNS 信息定义了分配给目标的实际域名和
    IP 地址，以及渗透测试者或攻击者与最终目标之间的路由。
- en: This information gathering is semi-active, as some of the information is available
    from freely available open sources such as [dnsdumpster.com](http://dnsdumpster.com),
    while other information is available from third parties such as DNS registrars.
    Although the registrar may collect IP addresses and data concerning requests made
    by the attacker, it is rarely provided to the end target. The information that
    could be directly monitored by the target, such as DNS server logs, is seldom
    reviewed or retained.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 这一信息收集是半主动的，因为有些信息来自如 [dnsdumpster.com](http://dnsdumpster.com) 等公开的免费开放源，而其他信息则来自第三方，如
    DNS 注册商。尽管注册商可能会收集与攻击者请求相关的 IP 地址和数据，但通常不会提供给最终目标。目标可以直接监控的信息，如 DNS 服务器日志，通常不会被审查或保留。
- en: Because the information needed can be queried using a defined systematic and
    methodical approach, its collection can be automated.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 由于所需的信息可以通过定义的系统化和有条理的方法查询，因此其收集可以实现自动化。
- en: Note that DNS information may contain stale or incorrect entries. To minimize
    inaccurate information, query different source servers and use different tools
    to cross-validate results. Review results and manually verify any suspect findings.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，DNS 信息可能包含过时或不准确的条目。为减少不准确信息的出现，可以查询不同的源服务器并使用不同的工具进行交叉验证。审查结果并手动验证任何可疑的发现。
- en: The whois command (post GDPR)
  id: totrans-111
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: whois 命令（GDPR 后）
- en: 'The `whois` command used to be the first step in identifying an IP address
    for many years until GDPR came into force. Formerly, the `whois` command was used
    to query databases that store information on the registered users of an internet
    resource, such as a domain name or IP address. Depending on the database that
    is queried, the response to a `whois` request will provide names, physical addresses,
    phone numbers, and email addresses (useful in facilitating social engineering
    attacks), as well as IP addresses and DNS server names. After May 25, 2018, there
    are no registrant details provided; however, attackers can understand which `whois`
    server responds, and it retrieves domain data that includes availability, ownership,
    creation, expiration details, and name servers. *Figure 3.6* shows the `whois`
    command run against the domain of `facebook.com`:'
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: '`whois` 命令曾是识别 IP 地址的第一步，持续了多年，直到 GDPR 生效为止。以前，`whois` 命令用于查询存储互联网资源注册用户信息的数据库，如域名或
    IP 地址。根据查询的数据库，`whois` 请求的响应将提供名称、物理地址、电话号码和电子邮件地址（有助于社交工程攻击），以及 IP 地址和 DNS 服务器名称。2018年5月25日后，不再提供注册人详细信息；然而，攻击者仍可以了解哪个
    `whois` 服务器响应，并且它会检索包括可用性、所有权、创建、到期详细信息和名称服务器在内的域名数据。*图 3.6* 显示了对 `facebook.com`
    域运行 `whois` 命令的情况：'
- en: '![](../Images/B17765_03_06.png)'
  id: totrans-113
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/B17765_03_06.png)'
- en: 'Figure 3.6: whois details on the facebook.com domain that includes Name Server
    details'
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.6：包含名称服务器详细信息的 facebook.com 域的 whois 信息
- en: Employing comprehensive reconnaissance applications
  id: totrans-115
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用全面的侦察应用程序
- en: Although Kali contains multiple tools to facilitate reconnaissance, many of
    the tools contain features that overlap, and importing data from one tool into
    another is usually a complex manual process. Most testers select a subset of tools
    and invoke them with a script.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然 Kali 包含多种工具来辅助侦察，但许多工具的功能重叠，并且将一个工具中的数据导入到另一个工具通常是一个复杂的手动过程。大多数测试人员选择一组子集工具，并通过脚本调用它们。
- en: Comprehensive tools focused on reconnaissance were originally command-line tools
    with a defined set of functions; one of the most commonly used was the **Deep
    Magic Information Gathering Tool** (**DMitry**). DMitry could perform `whois`
    lookups, retrieve [netcraft.com](http://netcraft.com) information, search for
    sub-domains and email addresses, and perform TCP scans. Unfortunately, it wasn’t
    extensible beyond these functions.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 专注于侦察的综合工具最初是命令行工具，具有一组定义的功能；其中最常用的是 **深度魔法信息收集工具**（**DMitry**）。DMitry 可以执行
    `whois` 查找，检索 [netcraft.com](http://netcraft.com) 信息，搜索子域和电子邮件地址，并执行 TCP 扫描。不幸的是，它在这些功能之外不可扩展。
- en: '*Figure 3.7* provides details on running DMitry on [www.cyberhia.com](http://www.cyberhia.com).
    The following command can be used to enumerate the reverse DNS to IP lookup, Whois,
    subdomain, email address, and open port details:'
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: '*图 3.7* 提供了运行 DMitry 对 [www.cyberhia.com](http://www.cyberhia.com) 的详细信息。可以使用以下命令来枚举反向
    DNS 到 IP 查找、Whois、子域、电子邮件地址和开放端口详细信息：'
- en: '[PRE7]'
  id: totrans-119
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: '![](../Images/B17765_03_07.png)'
  id: totrans-120
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/B17765_03_07.png)'
- en: 'Figure 3.7: Running DMitry to extract domain and whois information'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.7：运行 DMitry 提取域和 whois 信息
- en: Note that some information produced here might belong to a hosting company that
    provides DNS protection. An example is if our target is hosting the name servers
    from Cloudflare or AWS **Content Delivery Network** (**CDN**).
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，此处生成的一些信息可能属于提供 DNS 保护的托管公司。例如，如果我们的目标托管来自 Cloudflare 或 AWS **内容分发网络**（**CDN**）的名称服务器。
- en: Recent advances have created comprehensive framework applications that combine
    passive and active reconnaissance. In the following section, we will be looking
    more at recon-ng.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 最近的进展促成了综合框架应用程序的出现，这些应用程序结合了被动和主动侦察。在接下来的部分，我们将更多地了解 recon-ng。
- en: The recon-ng framework
  id: totrans-124
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: recon-ng 框架
- en: The recon-ng framework is an open-source framework for conducting reconnaissance
    (passive and active) that has recently added a complete new marketplace for plugins.
    The framework is similar to Metasploit and the **Social Engineer Toolkit** (**SET**);
    recon-ng uses a very modular framework. Each module is a customized command interpreter,
    preconfigured to perform a specific task.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: recon-ng 框架是一个开源框架，用于进行侦察（被动和主动），最近新增了一个完整的插件市场。该框架类似于 Metasploit 和 **Social
    Engineer Toolkit**（**SET**）；recon-ng 使用一个非常模块化的框架。每个模块都是一个定制的命令解释器，预配置用于执行特定任务。
- en: The recon-ng framework and its modules are written in Python, allowing penetration
    testers to easily build or alter modules to facilitate testing. The recon-ng tool
    also leverages third-party APIs to conduct some assessments; this additional flexibility
    means that some activities undertaken by recon-ng may be tracked by those parties.
    Users can specify a custom `useragent` string or proxy requests to minimize alerting
    the target network.
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: recon-ng框架及其模块是用Python编写的，使得渗透测试人员可以轻松构建或修改模块以促进测试。recon-ng工具还利用第三方API进行某些评估；这种额外的灵活性意味着recon-ng执行的一些活动可能会被这些第三方追踪。用户可以指定自定义`useragent`字符串或代理请求，以最小化对目标网络的警觉。
- en: recon-ng is installed by default in newer versions of Kali. All data collected
    by recon-ng is placed in a database, allowing you to create various reports against
    the stored data. The user can select one of the report modules to automatically
    create either a CVS report or an HTML report.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 在Kali的较新版本中，recon-ng默认已安装。recon-ng收集的所有数据都将存储在数据库中，允许你根据存储的数据创建各种报告。用户可以选择其中一个报告模块，自动生成CSV报告或HTML报告。
- en: 'To start the application, enter `recon-ng` at the prompt; to view the available
    modules, type `marketplace search` at the `recon-ng>` prompt, as shown in *Figure
    3.8*:'
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 要启动应用程序，请在提示符下输入`recon-ng`；要查看可用模块，请在`recon-ng>`提示符下输入`marketplace search`，如*图3.8*所示：
- en: '![](../Images/B17765_03_08.png)'
  id: totrans-129
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/B17765_03_08.png)'
- en: 'Figure 3.8: Marketplace search in recon-ng for all available modules'
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 图3.8：在recon-ng中进行市场搜索以查找所有可用模块
- en: To install any module, we will simply run `marketplace install modulename`,
    and to load a specific module, type `modules load` followed by the name of the
    module. Pressing the *Tab* key while typing will autocomplete the command. If
    the module has a unique name, you can type in the unique part of the name, and
    the module will be loaded without entering the full path.
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 要安装任何模块，我们只需运行`marketplace install modulename`，要加载特定模块，输入`modules load`后跟模块名。在输入时按*Tab*键会自动完成命令。如果模块有唯一的名称，你可以只输入名称的唯一部分，模块将被加载，而无需输入完整路径。
- en: 'Entering `info` will provide you with information on how the module works and
    where to obtain API keys if required. Once the module is loaded, use the `options
    set` command to set the options, and then enter `run` to execute, as shown in
    *Figure 3.9*:'
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 输入`info`将为你提供有关模块如何工作以及如何获取API密钥的信息（如果需要）。模块加载后，使用`options set`命令设置选项，然后输入`run`执行，如*图3.9*所示：
- en: '![](../Images/B17765_03_09.png)'
  id: totrans-133
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/B17765_03_09.png)'
- en: 'Figure 3.9: Loading the hackertarget module and setting the source as www.packtpub.com'
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 图3.9：加载hackertarget模块并将源设置为www.packtpub.com
- en: 'In general, testers rely on recon-ng to do the following:'
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 一般而言，测试人员依赖recon-ng进行以下操作：
- en: Harvest hosts and contacts using multiple sources, such as haveibeenpwned, mangle,
    mailtester, censys, and shodan.
  id: totrans-136
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 利用多个来源（如 haveibeenpwned、mangle、mailtester、censys 和 shodan）收集主机和联系人信息。
- en: Identify geographical locations of hosts and individuals using Flickr, Shodan,
    geocode, YouTube, and Twitter.
  id: totrans-137
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用Flickr、Shodan、geocode、YouTube和Twitter识别主机和个人的地理位置。
- en: Identify host information using `netcraft` and related modules.
  id: totrans-138
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用`netcraft`和相关模块识别主机信息。
- en: Identify account and password information that has previously been compromised
    and leaked onto the internet (the `pwnedlist` modules within the domains-credentials
    – `domain_ispwned`, `account_creds, domain_creds,` `leak_lookup`, and `leaks_dump`).
  id: totrans-139
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 识别以前已被泄露并暴露在互联网上的账户和密码信息（`pwnedlist`模块位于domains-credentials中——`domain_ispwned`、`account_creds`、`domain_creds`、`leak_lookup`
    和 `leaks_dump`）。
- en: IPv4
  id: totrans-140
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: IPv4
- en: 'The **Internet Protocol** (**IP**) address is a unique number used to identify
    devices that are connected to a private network or the public internet. Today,
    the internet is largely based on version 4, known as IPv4\. Kali includes several
    tools to facilitate DNS reconnaissance, as given in *Table 3.2*:'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: '**互联网协议**（**IP**）地址是用于标识连接到私人网络或公共互联网的设备的唯一编号。如今，互联网主要基于版本4，即IPv4。Kali包含若干工具以促进DNS侦察，如*表3.2*所示：'
- en: '| **Application** | **Description** |'
  id: totrans-142
  prefs: []
  type: TYPE_TB
  zh: '| **应用程序** | **描述** |'
- en: '| `dnsenum`, `dnsmap`, and `dnsrecon` | These are comprehensive DNS scanners—DNS
    record enumeration (A, MX, TXT, SOA, wildcard, and so on), subdomain brute-force
    attacks, Google lookup, reverse lookup, zone transfer, and zone walking. dsnrecon
    is usually the first choice—it is highly reliable, results are well parsed, and
    data can be directly imported into the Metasploit framework. |'
  id: totrans-143
  prefs: []
  type: TYPE_TB
- en: '| `dnswalk` | This DNS debugger checks specified domains for internal consistency
    and accuracy (this is not installed by default in the newer versions of Kali;
    hence, you have to run apt-get install dnswalk). |'
  id: totrans-144
  prefs: []
  type: TYPE_TB
- en: '| `fierce` | This locates non-contiguous IP space and hostnames against specified
    domains by attempting zone transfers and then attempting brute-force attacks to
    gain DNS information. |'
  id: totrans-145
  prefs: []
  type: TYPE_TB
- en: 'Table 3.2: Tools in Kali to facilitate DNS reconnaissance'
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
- en: During testing, most investigators run `fierce` to confirm that all possible
    targets have been identified, and then run at least two comprehensive tools (for
    example, `dnsenum` and `dnsrecon`) to generate the maximum amount of data and
    provide a degree of cross-validation.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
- en: 'In *Figure 3.10*, `dnsrecon` has been used to generate a standard DNS record
    search, and a search that is specific for SRV records. An excerpt of the results
    is shown for each case:'
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_03_10.png)'
  id: totrans-149
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.10: Running the dnsrecon tool on www.packtpub.com'
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
- en: '`dnsrecon` allows the penetration tester to obtain the SOA record, **Name Servers**
    (**NS**), **mail exchanger** (**MX**) hosts, servers sending emails using **Sender
    Policy Framework** (**SPF**), and the IP address ranges in use.'
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
- en: IPv6
  id: totrans-152
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Although IPv4 seems to permit a large address space, freely available IP addresses
    were exhausted several years ago, forcing the employment of NAT to increase the
    number of available addresses. A more permanent solution has been found in the
    adoption of an improved IP addressing scheme, IPv6\. Although it constitutes less
    than five percent of internet addresses, its usage is increasing, and penetration
    testers must be prepared to address the differences between IPv4 and IPv6.
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
- en: In IPv6, the source and destination addresses are 128-bits in length, yielding
    2,128 possible addresses—that is 340 undecillion addresses!
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
- en: The increased size of the addressable address space presents some problems to
    penetration testers, particularly when using scanners that step through the available
    address space looking for live servers. However, some features of the IPv6 protocol
    have simplified discovery, especially the use of ICMPv6 to identify active link-local
    addresses.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
- en: 'It is important to consider IPv6 when conducting initial scans for the following
    reasons:'
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
- en: There is uneven support for IPv6 functionality in testing tools, so the tester
    must ensure that each tool is validated to determine its performance and accuracy
    in IPv4, IPv6, and mixed networks.
  id: totrans-157
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Because IPv6 is a relatively new protocol, the target network may contain misconfigurations
    that leak important data; the tester must be prepared to recognize and use this
    information.
  id: totrans-158
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Older network controls (firewalls, IDS, and IPS) may not detect IPv6\. In such
    cases, penetration testers can use IPv6 tunnels to maintain covert communications
    with the network and exfiltrate the undetected data.
  id: totrans-159
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using IPv6-specific tools
  id: totrans-160
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Kali includes several tools developed to take advantage of IPv6 (most comprehensive
    scanners, such as Nmap, now support IPv6), some of which are detailed here. Tools
    that are particular to IPv6 were largely derived from the **THC-IPv6 Attack Toolkit**.
    This tool can be installed by running the following:'
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  id: totrans-162
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: '*Table 3.3* provides a list of tools that are utilized for the reconnaissance
    of IPv6:'
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
- en: '| **Application** | **Description** |'
  id: totrans-164
  prefs: []
  type: TYPE_TB
- en: '| `atk6-dnsdict6` | Enumerates sub-domains to obtain IPv4 and IPv6 addresses
    (if present) using a brute-force search based on a supplied dictionary file or
    its own internal list |'
  id: totrans-165
  prefs: []
  type: TYPE_TB
- en: '| `atk6-dnsrevenum6` | Performs reverse DNS enumeration given an IPv6 address
    |'
  id: totrans-166
  prefs: []
  type: TYPE_TB
- en: '| `atk6-covert_send6` | Sends the content of a file covertly to the target
    |'
  id: totrans-167
  prefs: []
  type: TYPE_TB
- en: '| `atk6-covert_send6d` | Writes covertly received content to a file |'
  id: totrans-168
  prefs: []
  type: TYPE_TB
- en: '| `atk6-denial6` | Performs various denial-of-service attacks on a target |'
  id: totrans-169
  prefs: []
  type: TYPE_TB
- en: '| `atk6-detect-new-ip6` | Detects new IPv6 addresses joining the local network
    |'
  id: totrans-170
  prefs: []
  type: TYPE_TB
- en: '| `atk6-detect_sniffer6` | Tests whether systems on the local LAN are sniffing
    |'
  id: totrans-171
  prefs: []
  type: TYPE_TB
- en: '| `atk6-exploit6` | Performs exploits of various CVE-known IPv6 vulnerabilities
    on the destination |'
  id: totrans-172
  prefs: []
  type: TYPE_TB
- en: '| `atk6-fake_dhcps6` | Fake DHCPv6 server |'
  id: totrans-173
  prefs: []
  type: TYPE_TB
- en: 'Table 3.3: Tools used in Kali to assess IPv6'
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
- en: 'Metasploit can also be utilized for IPv6 host discovery. The `auxiliary/scanner/discovery/ipv6_multicast_ping`
    module will discover all of the IPv6-enabled machines with the physical (MAC)
    address, as shown in *Figure 3.11*:'
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_03_11.png)'
  id: totrans-176
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.11: Discovery of IPv6 devices on the network using the Metasploit
    ipv6 scanner'
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
- en: 'The `sudo atk6-alive6` IPv6 suite will discover live addresses in the same
    segment, as shown in *Figure 3.12*:'
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_03_12.png)'
  id: totrans-179
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.12: Discovery of IPv6 live devices on the network using atk6-alive6'
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
- en: Mapping the route to the target
  id: totrans-181
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Route mapping was originally used as a diagnostic tool that allows you to view
    the route that an IP packet follows, from one host to the next.
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
- en: Using the **Time To Live** (**TTL**) field in an IP packet, each hop from one
    point to the next elicits an `ICMPTIME_EXCEEDED` message from the receiving router,
    decrementing the value in the `TTL` field by `1`.
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
- en: 'The packets count the number of hops and the route taken. From an attacker’s
    or penetration tester’s perspective, the `traceroute` data yields the following
    important data:'
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
- en: The exact path between the attacker and the target
  id: totrans-185
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Hints pertaining to the network’s external topology
  id: totrans-186
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Identification of accessing control devices (firewalls and packet-filtering
    routers) that may be filtering attack traffic
  id: totrans-187
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the network is misconfigured, it may be possible to identify internal addressing
  id: totrans-188
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using a web-based traceroute ([www.traceroute.org](http://www.traceroute.org)),
    it is possible to trace various geographic origin sites to the target network.
    These types of scans will frequently identify more than one different network
    connecting to the target, which is information that could be missed by conducting
    only a single traceroute command from a location close to the target. Web-based
    traceroute may also identify multi-homed hosts that connect two or more networks.
    These hosts are an important target for attackers because they drastically increase
    the attack surface leading to the target.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
- en: In Kali, `traceroute` is a command-line program that uses ICMP packets to map
    the route; in Windows, the program is `tracert`.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
- en: 'If you launch `traceroute` from Kali, you will likely see most hops filtered
    (the data is shown as: `* * *`). For example, `traceroute` from the author’s present
    location to [www.packtpub.com](http://www.packtpub.com) would yield the output
    shown in *Figure 3.13*:'
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_03_13.png)'
  id: totrans-192
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.13: Traceroute on www.packtpub.com'
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
- en: 'If the same request was run using `tracert` from the Windows command line,
    however, we would see the output shown in *Figure 3.14*:'
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_03_14.png)'
  id: totrans-195
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.14: Traceroute to www.packtpub.com using Windows tracert utility'
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
- en: Not only do we get the complete path, but we can also see that [www.google.com](http://www.google.com)
    is resolving to a slightly different IP address, indicating that load balancers
    are in effect (you can confirm this by using Kali’s `lbd` script; however, this
    activity may be logged by the target site).
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
- en: 'The reason for the different path data is that, by default, `traceroute` uses
    UDP datagrams, while Windows `tracert` utility uses ICMP echo request (ICMP type
    8). Therefore, when completing `traceroute` using Kali tools, it is important
    to use multiple protocols in order to obtain the most complete path, and to bypass
    packet-filtering devices. Kali provides a set of tools for completing route traces,
    as detailed in *Table 3.4*:'
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
- en: '| **Application** | **Description** |'
  id: totrans-199
  prefs: []
  type: TYPE_TB
- en: '| `hping3` | This is a TCP/IP packet assembler and analyzer. This supports
    TCP, UDP, ICMP, and raw-IP and uses a ping-like interface. |'
  id: totrans-200
  prefs: []
  type: TYPE_TB
- en: '| `intrace` | Newer versions of Kali do not have this tool pre-installed, so
    testers will have to run apt install intrace in the terminal to obtain it. This
    tool enables users to enumerate IP hops by exploiting existing TCP connections,
    both initiated from the local system or network, or from local hosts. This makes
    it very useful for bypassing external filters such as firewalls. intrace is a
    replacement for the less reliable 0trace program. |'
  id: totrans-201
  prefs: []
  type: TYPE_TB
- en: '| `atk6-trace6` | This is a traceroute program that uses ICMP6. |'
  id: totrans-202
  prefs: []
  type: TYPE_TB
- en: 'Table 3.4: Kali tools that can be used for the completion of trace routes'
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
- en: '`hping3` is one of the most useful tools because of the control it gives over
    the packet type, source packet, and destination packet. For example, Google does
    not allow ping requests. However, it is possible to ping the server if you send
    the packet as a TCP SYN request.'
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following example, the tester attempts to ping the target domain from
    the command line. No data is returned; the target domain is clearly blocking ICMP-based
    `ping` commands. However, the next command invokes `hping3`, instructing it to
    do the following:'
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
- en: Send a ping-like command to the target domain using TCP with the SYN flag set
    (`-S`)
  id: totrans-206
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Direct the packet to port 80; legitimate requests of this type are rarely blocked
    (`- p 80`)
  id: totrans-207
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Set a count of sending three packets to the target (`-c 3`)
  id: totrans-208
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'To execute the previous steps, use the commands shown in *Figure 3.15*:'
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_03_15.png)'
  id: totrans-210
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.15: Running hping3 on the target via port 80'
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
- en: The `hping3` command successfully identifies that the target is online and provides
    some basic routing information.
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
- en: Identifying the external network infrastructure
  id: totrans-213
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Once the tester’s identity is protected, identifying the devices on the internet-accessible
    portion of the network is the next critical step in scanning a network. Attackers
    and penetration testers use this information to do the following:'
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
- en: Identify devices that may confuse (load balancers) or eliminate (firewalls and
    packet inspection devices) test results
  id: totrans-215
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Identify devices with known vulnerabilities
  id: totrans-216
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Identify the requirement for continuing to implement stealthy scans
  id: totrans-217
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Gain an understanding of the target’s focus on secure architecture and security
    in general
  id: totrans-218
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`traceroute` provides basic information on packet filtering abilities; some
    other applications on Kali include the following:'
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
- en: '**Lbd**: Uses two DNS and HTTP-based techniques to detect load balancers (shown
    in *Figure 3.16*)'
  id: totrans-220
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Nmap**: Detects devices and determines the operating systems and version'
  id: totrans-221
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Shodan**: Web-based search engine that identifies devices connected to the
    internet, including those with default passwords, known misconfigurations, and
    vulnerabilities'
  id: totrans-222
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**censys.io** and **spyze**: Similar to the Shodan search that has already
    scanned the entire internet, with certificate details, technology information,
    misconfiguration, and known vulnerabilities.'
  id: totrans-223
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Figure 3.16* shows the results obtained on running the `lbd` script against
    a target domain; as you can see, the target uses both `DNS-Loadbalancing` and
    `HTTP-Loadbalancing` on its site. From a penetration tester’s perspective, this
    information could be used to explain why spurious results are obtained, as the
    load balancer shifts a particular tool’s activity from one server to another.
    *Figure 3.16* also displays the HTTP load balancing:'
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_03_16.png)'
  id: totrans-225
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.16: Running lbd to detect the load balancers'
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
- en: Mapping beyond the firewall
  id: totrans-227
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Attackers normally start network debugging using the `traceroute` utility,
    which attempts to map all of the hosts on a route to a specific destination host
    or system. Once the target is reached, the `TTL` field will be `0`, while the
    target will discard the datagram and generate an ICMP time exceeded packet back
    to its originator. A regular `traceroute` will be similar to that shown in *Figure
    3.17*:'
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_03_17.png)Figure 3.17: Running traceroute to identify
    packet filtering devices'
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
- en: As you see from the preceding example, we cannot go beyond a particular IP,
    which most probably means that there is a packet filtering device at hop `3`.
    Attackers would dig a little bit deeper to understand what is deployed on that
    IP.
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
- en: Deploying the default UDP datagram option will increase the port number every
    time it sends a UDP datagram. Hence, attackers will start pointing to a port number
    to reach the final target destination.
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
- en: IDS/IPS identification
  id: totrans-232
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Penetration testers can utilize `nmap` and `WAFW00F` to identify whether there
    are any detection or prevention mechanisms put in place, such as an **Intrusion
    Detection System** (**IDS**), **Intrusion Prevention System** (**IPS**), or a
    **Web Application Firewall** (**WAF**).
  id: totrans-233
  prefs: []
  type: TYPE_NORMAL
- en: 'Another tool that attackers utilize during active reconnaissance is `WAFW00F`;
    this tool is preinstalled in the latest version of Kali Linux. It is used to identify
    and fingerprint the WAF products. It also provides a list of well-known WAFs.
    The version of the WAF in use can be extracted by adding the `-l` switch to the
    command (for example, `wafw00f -l`). *Figure 3.18* shows the exact WAF running
    behind a web application:'
  id: totrans-234
  prefs: []
  type: TYPE_NORMAL
- en: '![Graphical user interface  Description automatically generated](../Images/B17765_03_18.png)'
  id: totrans-235
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.18: Running wafw00f to fingerprint a web application firewall'
  id: totrans-236
  prefs: []
  type: TYPE_NORMAL
- en: Enumerating hosts
  id: totrans-237
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Host enumeration is the process of gaining specific particulars regarding a
    defined host. It is not enough to know that a server or wireless access point
    is present; instead, we need to expand the attack surface by identifying open
    ports, the base operating system, services that are running, and supporting applications.
    This is highly intrusive and, unless care is taken, such activity will be detected
    and logged by the target organization.
  id: totrans-238
  prefs: []
  type: TYPE_NORMAL
- en: Live host discovery
  id: totrans-239
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The first step is to run network ping sweeps against a target address space
    and look for responses that indicate that a particular target is live and capable
    of responding. Historically, pinging is referred to as the use of ICMP; however,
    TCP, UDP, ICMP, and ARP traffic can also be used to identify live hosts.
  id: totrans-240
  prefs: []
  type: TYPE_NORMAL
- en: 'Various scanners can be run from remote locations across the internet to identify
    live hosts. Although the primary scanner is Nmap, Kali provides several other
    applications that are also useful, as shown in *Table 3.5*:'
  id: totrans-241
  prefs: []
  type: TYPE_NORMAL
- en: '| **Application** | **Description** |'
  id: totrans-242
  prefs: []
  type: TYPE_TB
- en: '| `atk6-alive6` and `atk6-detect-new-ip6` | This is for IPv6 host detection.
    `Atk6-detect-new-ip6` runs on a scripted basis and identifies new IPv6 devices
    when added. |'
  id: totrans-243
  prefs: []
  type: TYPE_TB
- en: '| `dnmap` and `nmap` | `nmap` is the standard network enumeration tool. `dnmap`
    is a distributed client-server implementation of the Nmap scanner. PBNJ (a suite
    of tools to monitor changes on a network over time) stores Nmap results in a database
    and then conducts historical analyses to identify new hosts. |'
  id: totrans-244
  prefs: []
  type: TYPE_TB
- en: '| `fping`, `hping2`, `hping3`, and `nping` | These are packet crafters that
    respond to targets in various ways to identify live hosts. |'
  id: totrans-245
  prefs: []
  type: TYPE_TB
- en: 'Table 3.5: Tools used to discover live hosts in Kali Linux'
  id: totrans-246
  prefs: []
  type: TYPE_NORMAL
- en: To the penetration tester or attacker, the data returned from live host discovery
    will identify the targets for attack.
  id: totrans-247
  prefs: []
  type: TYPE_NORMAL
- en: It is good practice to run multiple host discovery scans while conducting a
    penetration test, as certain devices may be time-dependent. During one penetration
    test, it was discovered that the system administrator set up a server to play
    games after regular business hours. Because it was not an approved business system,
    the administrator didn’t follow the normal process for securing the server; multiple
    vulnerable services were present, and it hadn’t received the necessary security
    patches. Testers were able to compromise this server and gain access to the underlying
    corporate network using vulnerabilities in the administrator’s server that was
    used to play games.
  id: totrans-248
  prefs: []
  type: TYPE_NORMAL
- en: Port, operating system, and service discovery
  id: totrans-249
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Kali provides several different tools useful for identifying open ports, operating
    systems, and installed services on remote hosts. The majority of these functions
    can be completed using Nmap. Although we will focus on examples using Nmap, the
    underlying principles apply to the other tools as well.
  id: totrans-250
  prefs: []
  type: TYPE_NORMAL
- en: Port scanning
  id: totrans-251
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Port scanning is the process of connecting to TCP and UDP ports to determine
    what services and applications are running on the target device. In TCP/IP, there
    are 65,535 ports each for both TCP and UDP on any computer. Some ports are known
    to be associated with particular services (for instance, TCP 20 and 21 are the
    usual ports for the **File Transfer Protocol** (**FTP**) service).
  id: totrans-252
  prefs: []
  type: TYPE_NORMAL
- en: The first 1,024 are the well-known ports, and most defined services run over
    ports in this range; accepted services and ports are maintained by IANA ([http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml](http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml)).
  id: totrans-253
  prefs: []
  type: TYPE_NORMAL
- en: Although there are accepted ports for particular services, such as port `80`
    for web-based traffic, services can be directed to use any port. This option is
    frequently used to hide particular services, especially if the service is known
    to be vulnerable to attack. However, if attackers complete a port scan and do
    not find an expected service, or find it using an unusual port, they will be prompted
    to investigate further.
  id: totrans-254
  prefs: []
  type: TYPE_NORMAL
- en: The universal port mapping tool, Nmap, relies on active stack fingerprinting.
    Specially crafted packets are sent to the target system, and the response of the
    OS to those packets allows Nmap to identify the OS. In order for Nmap to work,
    at least one listening port must be open, and the operating system must be known
    and fingerprinted, with a copy of that fingerprint stored in the local database.
  id: totrans-255
  prefs: []
  type: TYPE_NORMAL
- en: 'Using Nmap for port discovery is very noisy; it will be detected and logged
    by network security devices. Some points to remember are the following:'
  id: totrans-256
  prefs: []
  type: TYPE_NORMAL
- en: Attackers and penetration testers focused on stealth will only test the ports
    that impact the kill chain they are following to their specific target. If they
    are launching an attack that exploits vulnerabilities in a web server, they will
    search for targets with accessible ports `80` and `443` or ports `8080` and `8443`.
  id: totrans-257
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Most port scanners have default lists of ports that are scanned to ensure that
    you know what is on that list and what has been omitted. Consider both TCP and
    UDP ports.
  id: totrans-258
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Successful scanning requires a deep knowledge of TCP/IP and related protocols,
    networking, and how particular tools work. For example, SCTP is an increasingly
    common protocol on networks, but it is rarely tested on corporate networks.
  id: totrans-259
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Port scanning, even when done slowly, can impact a network. Some older network
    equipment and equipment from specific vendors will lock when receiving or transmitting
    a port scan, hence turning a scan into a denial-of-service attack.
  id: totrans-260
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Tools used to scan a port, particularly Nmap, are being extended with regard
    to functionalities. They can also be used to detect vulnerabilities and exploit
    simple security holes.
  id: totrans-261
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Writing your own port scanner using netcat
  id: totrans-262
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'While attackers utilize the proxying application and Tor network, it is also
    possible to write their own custom network port scanner. The following one-line
    command can be utilized during penetration testing to identify the list of open
    ports just by using netcat, as shown in *Figure 3.19*:'
  id: totrans-263
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  id: totrans-264
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: '![](../Images/B17765_03_19.png)'
  id: totrans-265
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.19: Running a one-line Bash script to do port scanning'
  id: totrans-266
  prefs: []
  type: TYPE_NORMAL
- en: 'The same script can be modified for more targeted attacks on a single IP, as
    follows:'
  id: totrans-267
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  id: totrans-268
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: The chances of getting alerted in any intrusion detection system using custom
    port scanners are high compared to other port scanners.
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
- en: Fingerprinting the operating system
  id: totrans-270
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Determining the OS of a remote system is conducted using two types of scans:'
  id: totrans-271
  prefs: []
  type: TYPE_NORMAL
- en: '**Active fingerprinting**: The attacker sends normal and malformed packets
    to the target and records its response pattern, referred to as the fingerprint.
    By comparing the fingerprint to a local database, the operating system can be
    determined.'
  id: totrans-272
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Passive fingerprinting**: The attacker sniffs—or records—and analyzes the
    packet stream to determine the characteristics of the packets.'
  id: totrans-273
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Active fingerprinting is faster and more accurate than passive fingerprinting;
    in Kali, the primary active tool is Nmap. The Nmap tool injects packets into the
    target network and analyzes the response that it receives. In *Figure 3.20*, the
    `-O` flag commands Nmap to determine the operating system:'
  id: totrans-274
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  id: totrans-275
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: '![](../Images/B17765_03_20.png)'
  id: totrans-276
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.20: Nmap scan to identify the operating system of the target'
  id: totrans-277
  prefs: []
  type: TYPE_NORMAL
- en: Note that it is simple for the target system to hide the true operating system.
    Since fingerprinting software relies on packet setting, such as time-to-live or
    the initial window’s size, changes to these values or other user-configurable
    settings can change the tool results. Some organizations actively change these
    values to make the final stages of reconnaissance more difficult.
  id: totrans-278
  prefs: []
  type: TYPE_NORMAL
- en: Determining active services
  id: totrans-279
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The final goal of the enumeration portion of reconnaissance is to identify
    the services and applications that are operational on the target system. If possible,
    the attacker will want to know the service type, vendor, and version to facilitate
    the identification of any vulnerability. The following are some of the techniques
    used to determine active services:'
  id: totrans-280
  prefs: []
  type: TYPE_NORMAL
- en: '**Identify default ports and services**: If the remote system is identified
    as having a Microsoft operating system with port `80` open (the WWW service),
    an attacker may assume that a default installation of Microsoft IIS is installed.
    Additional testing will be used to verify this assumption (using Nmap).'
  id: totrans-281
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Banner grabbing**: This is done using tools such as amap, netcat, Nmap, and
    Telnet.'
  id: totrans-282
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Review default web pages**: Some applications install with default administration,
    error, or other pages. If attackers access these, they will provide guidance on
    installed applications that may be vulnerable to attack. In *Figure 3.21*, the
    attacker can easily identify the version of Microsoft IIS that has been installed
    on the target system.'
  id: totrans-283
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Review source code**: Poorly configured web-based applications may respond
    to certain HTTP requests such as `HEAD` or `OPTIONS` with a response that includes
    the web server software version, and, possibly, the base operating system or the
    scripting environment in use. In *Figure 3.21*, `netcat` is launched from the
    command line and is used to send raw `HEAD` packets to a particular website. This
    request generates a success message (`200 OK`); however, it also identifies that
    the server is running Microsoft IIS 7.5 and powered by ASP.NET:'
  id: totrans-284
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE12]'
  id: totrans-285
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE12]'
- en: '![](../Images/B17765_03_21.png)'
  id: totrans-286
  prefs:
  - PREF_IND
  type: TYPE_IMG
- en: 'Figure 3.21: Using netcat to grab the banner of a target'
  id: totrans-287
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Large-scale scanning
  id: totrans-288
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In the case of testing bigger organizations with multiple class B/C IP ranges,
    large-scale scanning is engaged. For example, with a global company, often, a
    number of IP blocks exist as part of external internet facing. As mentioned earlier
    in *Chapter 2*, *Open-Source Intelligence and Passive Reconnaissance*, attackers
    do not have time limitations to scan, but penetration testers do. Pentesters can
    engage multiple tools to perform the activity; Masscan is one such tool that would
    be engaged to scan large-scale IP blocks to quickly analyze the live hosts in
    the target network. Masscan is installed in Kali by default.
  id: totrans-289
  prefs: []
  type: TYPE_NORMAL
- en: 'The biggest advantage of Masscan is the randomization of hosts, ports, speed,
    flexibility, and compatibility. *Figure 3.22* provides a Class C scanning network
    within a few seconds to complete and identify the available HTTP service on port
    `80` and services running on the target hosts:'
  id: totrans-290
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_03_22.png)Figure 3.22: Running masscan on the class-c
    IP range to discover TCP open port 80'
  id: totrans-291
  prefs: []
  type: TYPE_NORMAL
- en: DHCP information
  id: totrans-292
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The **Dynamic Host Configuration Protocol** (**DHCP**) is a service that dynamically
    assigns an IP address to the hosts on the network. This protocol operates at the
    MAC sub-layer of the Data Link layer of the TCP/IP protocol stack. Upon the selection
    of auto-configuration, a broadcast query will be sent to the DHCP servers and
    when a response is received from the DHCP server, a broadcast query is sent by
    the client to the DHCP server requesting required information. The server will
    now assign an IP address to the system, along with other configuration parameters
    such as the subnet mask, DNS, and the default gateway.
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
- en: 'Sniffing is a great way of collecting passive information once connected to
    a network. Attackers can start this by running the Wireshark utility and will
    be able to see a lot of broadcast traffic, as shown in *Figure 3.23*:'
  id: totrans-294
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_03_23.png)Figure 3.23: Broadcast network traffic in Wireshark'
  id: totrans-295
  prefs: []
  type: TYPE_NORMAL
- en: We will now see traffic on **DNS**, **NBNS**, **BROWSER**, and other protocols
    that might potentially reveal hostnames, **VLAN** information, domains, and active
    subnets in the network. We will be discussing more attacks specific to sniffing
    in *Chapter 11*, *Action on the Objective and Lateral Movement*.
  id: totrans-296
  prefs: []
  type: TYPE_NORMAL
- en: Identification and enumeration of internal network hosts
  id: totrans-297
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'If the attacker’s system is already configured with the DHCP, it will provide
    some information that is very useful to map the internal network. The DHCP information
    can be obtained by typing `ifconfig` in the Kali terminal, as shown in *Figure
    3.24*; you should be able to see the information detailed:'
  id: totrans-298
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_03_24.png)'
  id: totrans-299
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.24: Ifconfig details on the Ethernet adapters'
  id: totrans-300
  prefs: []
  type: TYPE_NORMAL
- en: '`inet`: The IP information obtained by the DHCP server should provide us with
    at least one active subnet, which can be utilized to identify the list of live
    systems and services through different scanning techniques.'
  id: totrans-301
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`netmask`: This information can be utilized to calculate the subnet ranges.
    From the previous screenshot, we have `255.255.255.0`, which means `CIDR` is `/24`,
    and we can probably expect 255 hosts on the same subnet.'
  id: totrans-302
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Default gateway**: The IP information of the gateway will provide the opportunity
    to ping other similar gateway IPs. For example, if your default gateway IP is
    10.10.10.1, by using ping scans, attackers may be able to enumerate other similar
    IP addresses, such as 10.10.20.1 and 10.10.20.1.'
  id: totrans-303
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Other IP address**: DNS information can be obtained by accessing the `/etc/resolv.conf`
    file. The IP addresses in this file are commonly addressed in all of the subnets,
    and domain information will also be automatically added during the DHCP process,
    which will also be available in the same file.'
  id: totrans-304
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Native MS Windows commands
  id: totrans-305
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '*Table 3.6* provides a list of useful commands during a penetration test or
    Red Team exercise, even when only having physical access to the system or having
    a remote shell to communicate to the target. This is not an exhaustive list, however:'
  id: totrans-306
  prefs: []
  type: TYPE_NORMAL
- en: '| **Command** | **Sample** | **Description** |'
  id: totrans-307
  prefs: []
  type: TYPE_TB
- en: '| `nslookup` | `nslookup``Server nameserever.google.com``Set type=any``ls -d
    anydomain.com` | `nslookup` is used to query the DNS. The sample command does
    DNS zone transfer using `nslookup`. |'
  id: totrans-308
  prefs: []
  type: TYPE_TB
- en: '| `net view` | `net view` | This displays a list of computers/domains and other
    shared resources. |'
  id: totrans-309
  prefs: []
  type: TYPE_TB
- en: '| `net share` | `net share list="c:"` | This manages the shared resources and
    displays all information about the shared resources on the local system. |'
  id: totrans-310
  prefs: []
  type: TYPE_TB
- en: '| `net use` | `net use \\[targetIP] [password] /u:[user]``net use \\[targetIP]\[sharename]
    [password] /u:[user]` | This connects to any system on the same network; it can
    also be used to retrieve a list of network connections. |'
  id: totrans-311
  prefs: []
  type: TYPE_TB
- en: '| `net user` | `net user [UserName [Password &#124; *] [options]] [/domain]``net
    user [UserName {Password &#124; *} /add [options] [/domain]]``net user [UserName
    [/delete] [/domain]]` | This displays information regarding users and performs
    activities related to user accounts. |'
  id: totrans-312
  prefs: []
  type: TYPE_TB
- en: '| `arp` | `arp /a``arp /a /n 10.0.0.99``arp /s 10.0.0.80 00-AA-00-4F-2A-9C`
    | This displays and modifies any entries in the ARP cache. |'
  id: totrans-313
  prefs: []
  type: TYPE_TB
- en: '| `route` | `route print``route print 10.*``route add 0.0.0.0 mask 0.0.0.0
    192.168.12.1``route delete 10.*` | Similar to ARP, `route` can be utilized to
    understand the local IP routing and modify this information. |'
  id: totrans-314
  prefs: []
  type: TYPE_TB
- en: '| `netstat` | `netstat -n -o` | This displays all active TCP connections and
    ports on the local system; that is to say, connections that are listening, established,
    and waiting on the network adapter IP address. |'
  id: totrans-315
  prefs: []
  type: TYPE_TB
- en: '| `nbtstat` | `nbtstat /R``nbtstat /S 5``nbtstat /a Ip` | This displays NETBIOS
    information, normally utilized to identify a particular MAC address of an IP,
    which can be utilized in MAC spoof attacks. |'
  id: totrans-316
  prefs: []
  type: TYPE_TB
- en: '| `wmic` | `wmic process get caption,executablepath,commandline``netsh wlan
    show profile "profilename" key=clear` | `wmic` is utilized for all typical diagnostics
    an attacker can perform; for example, a system’s Wi-Fi password can be extracted
    in a single command. |'
  id: totrans-317
  prefs: []
  type: TYPE_TB
- en: '| `reg` | `reg save HKLM\Security sec.hive reg save HKLM\System sys.hive reg
    save HKLM\SAM sam.hive reg add [\\TargetIPaddr\] [RegDomain][ \Key ]``reg export
    [RegDomain]\[Key] [FileName]reg import [FileName ]``reg query [\\TargetIPaddr\]
    [RegDomain]\[ Key ] /v [Valuename!]` | The `reg` command is used by most attackers
    to save registry hives to perform offline password attacks. |'
  id: totrans-318
  prefs: []
  type: TYPE_TB
- en: '| `for` | `for /L %i in (1,1,10) do echo %ii && ping -n 5 IP``for /F %i in
    (password.lst) do @echo %i& @net use \\[targetIP] %i /u:[Username] 2>nul&& pause
    && echo [Username] :%i>>done.txt` | The `for` loop can be utilized in Windows
    to create a port scanner or enumeration of accounts. |'
  id: totrans-319
  prefs: []
  type: TYPE_TB
- en: 'Table 3.6: Useful Windows commands during penetration testing activity'
  id: totrans-320
  prefs: []
  type: TYPE_NORMAL
- en: ARP broadcasting
  id: totrans-321
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: During internal network active reconnaissance, the entire local network can
    be scanned using `nmap` (`nmap -v -sn IPrange`) to sniff the ARP broadcasts. In
    addition, Kali has `arp-scan` (`arp-scan IP range`) to identify a list of hosts
    that are alive on the same network.
  id: totrans-322
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 3.25* is a screenshot of Wireshark that provides the traffic generated
    at the target when `arp-scan` is run against the entire subnet. This is considered
    to be a non-stealthy scan:'
  id: totrans-323
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_03_25.png)'
  id: totrans-324
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.25: ARP scanning network traffic on Wireshark'
  id: totrans-325
  prefs: []
  type: TYPE_NORMAL
- en: Ping sweep
  id: totrans-326
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'A ping sweep is the process of pinging an entire range of network IP addresses
    or individual IPs to find out whether they are alive and responding. An attacker’s
    first step in any large-scale scanning is to enumerate all of the hosts that are
    responding. Penetration testers can leverage `fping` or `nmap`, or even write
    custom Bash scripts to carry out the activity:'
  id: totrans-327
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  id: totrans-328
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'Sometimes, attackers can encounter a roadblock during the ping sweep due to
    a firewall that blocks all of the ICMP traffic. In the case of an ICMP block,
    we can utilize the following command to identify alive hosts by specifying a list
    of port numbers during the ping sweep:'
  id: totrans-329
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  id: totrans-330
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: '*Figure 3.26* shows all of the live hosts that were discovered using the `fping`
    tool:'
  id: totrans-331
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_03_26.png)'
  id: totrans-332
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.26: Output of gping on the class-c IP range'
  id: totrans-333
  prefs: []
  type: TYPE_NORMAL
- en: Using scripts to combine masscan and nmap scans
  id: totrans-334
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The speed and reliability of `masscan` and `nmap` to enumerate in detail is
    a great combination to use in our goal-based penetration testing strategy. In
    this section, we will write a piece of script that can save time and provide more
    accurate results than those that can be used during exploitation while identifying
    the right vulnerabilities:'
  id: totrans-335
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  id: totrans-336
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: Now, save the file into `anyname.sh` and then `chmod +x anyname.sh`. Next, run
    `./anyname.sh fileincludesipranges`.
  id: totrans-337
  prefs: []
  type: TYPE_NORMAL
- en: 'Upon executing the preceding script, you should be able to see the following,
    as shown in *Figure 3.27*:'
  id: totrans-338
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_03_27.png)'
  id: totrans-339
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.27: Running our custom script in Kali to scan the network'
  id: totrans-340
  prefs: []
  type: TYPE_NORMAL
- en: Taking advantage of SNMP
  id: totrans-341
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '**SNMP**, **Simple Network Management Protocol**, is traditionally used to
    collect information about the configuration of network devices such as printers,
    hubs, switches, routers on internet protocol, and servers. Attackers can potentially
    take advantage of SNMP that runs on UDP port `161` (by default) when it is poorly
    configured or left out, with the default configuration having a default community
    string.'
  id: totrans-342
  prefs: []
  type: TYPE_NORMAL
- en: 'SNMP was first introduced in 1987: version 1 had plain text passwords in transit;
    version 2c had improved performance, but still plain text passwords; and now the
    latest version 3 encrypts all of the traffic with message integrity. There are
    two types of community strings utilized in all versions of SNMP:'
  id: totrans-343
  prefs: []
  type: TYPE_NORMAL
- en: '**Public**: Community string is used for read-only access'
  id: totrans-344
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Private**: Community string is used for both read and write access'
  id: totrans-345
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The thing that attackers would look for is any identified network device on
    the internet and find out whether a public community string is enabled so that
    they can pull out all of the information specific to the network and draw a topology
    around it to create more focused attacks. These issues arise since, most of the
    time, IP-based **Access Control Lists** (**ACLs**) are often not implemented,
    or not used at all.
  id: totrans-346
  prefs: []
  type: TYPE_NORMAL
- en: 'Kali Linux provides multiple tools to perform the SNMP enumeration; attackers
    can utilize snmpwalk or onesixtyone to understand the complete information SNMP
    steps, as shown in *Figure 3.28*:'
  id: totrans-347
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  id: totrans-348
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: '![A picture containing text  Description automatically generated](../Images/B17765_03_28.png)'
  id: totrans-349
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.28: snmpwalk output on a device with a public community string'
  id: totrans-350
  prefs: []
  type: TYPE_NORMAL
- en: Attackers can also utilize Metasploit to perform SNMP enumeration, by using
    the `/auxiliary/scanner/snmp/snmpenum` module as shown in *Figure 3.29*.
  id: totrans-351
  prefs: []
  type: TYPE_NORMAL
- en: 'Some systems have SNMP installed, but that is completely ignored by the system
    administrators:'
  id: totrans-352
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_03_29.png)'
  id: totrans-353
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.29: SNMP enumeration using Metasploit through the SNMP protocol'
  id: totrans-354
  prefs: []
  type: TYPE_NORMAL
- en: 'Attackers will also be able to extract all of the user accounts by using account
    enumeration modules within Metasploit, as shown in *Figure 3.30*:'
  id: totrans-355
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_03_30.png)'
  id: totrans-356
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.30: Account enumeration using Metasploit through the SNMP protocol'
  id: totrans-357
  prefs: []
  type: TYPE_NORMAL
- en: Windows account information via SMB sessions
  id: totrans-358
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Traditionally, during internal network scanning, it is very likely that attackers
    exploit the internal **Server Message Block** (**SMB**) sessions that are most
    commonly used. In the case of external exploitation, attackers can engage `nmap`
    to perform the enumeration, but this scenario is very rare. The following `nmap`
    command will enumerate all of the remote users on the Windows machine. This information
    normally creates lots of entry points, much like brute force and password guessing
    attacks in later stages:'
  id: totrans-359
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  id: totrans-360
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'Attackers may also utilize the Metasploit module, `auxiliary/scanner/smb/smb_enumusers`,
    to perform the activity. *Figure 3.31* shows the successful enumeration of users
    on a Windows system running `Metasploitable3`:'
  id: totrans-361
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_03_31.png)'
  id: totrans-362
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.31: Enumeration of users in Metasploit using the SMB protocol'
  id: totrans-363
  prefs: []
  type: TYPE_NORMAL
- en: This can be achieved either by having a valid password guess to the system or
    by brute-forcing the SMB logins.
  id: totrans-364
  prefs: []
  type: TYPE_NORMAL
- en: Locating network shares
  id: totrans-365
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'One of the oldest attacks that penetration testers these days forget about
    is the NETBIOS null session, which will allow them to enumerate all of the network
    shares:'
  id: totrans-366
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  id: totrans-367
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: '`enum4linux` can also be utilized in a similar way to `enum.exe`, formerly
    from BindView, which has now been taken over by Symantec; this tool is normally
    used for enumerating information from Windows and Samba systems:'
  id: totrans-368
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  id: totrans-369
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'The options are the following (such as `enum`):'
  id: totrans-370
  prefs: []
  type: TYPE_NORMAL
- en: '`-U`: Get user list'
  id: totrans-371
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`-M`: Get machine list'
  id: totrans-372
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`-S`: Get share list'
  id: totrans-373
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`-P`: Get password policy information'
  id: totrans-374
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`-G`: Get group and member list'
  id: totrans-375
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`-d`: Be detailed; applies to `-U` and `-S`'
  id: totrans-376
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`-u user`: Specify the username to use (default `""`)'
  id: totrans-377
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`-p pass`: Specify the password to use (default `""`)'
  id: totrans-378
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'This tool is more aggressive in scanning and identifying the list of domains
    along with the domain SID, as shown in *Figure 3.32*:'
  id: totrans-379
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_03_32.png)'
  id: totrans-380
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.32: Enumerating the domain controller using enum4linux'
  id: totrans-381
  prefs: []
  type: TYPE_NORMAL
- en: Reconnaissance of active directory domain servers
  id: totrans-382
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Often during an internal penetration testing activity, penetration testers will
    be provided with a username and password. In real-world scenarios, the attackers
    are inside the network, and an attack scenario would be what they could do with
    normal user access and how they elevate the privileges to compromise the enterprise
    domain.
  id: totrans-383
  prefs: []
  type: TYPE_NORMAL
- en: 'Kali Linux provides `rpcclient` installed by default, which can be utilized
    to perform more active reconnaissance on an active directory environment. This
    tool provides multiple options to extract all of the details about the domain
    and other networking services, which we will be exploring in *Chapter 10*, *Exploitation*.
    One of the system internal tools, ADExplorer, can also be utilized to perform
    the AD enumeration. *Figure 3.33* shows the enumeration of lists of domains, users,
    and groups:'
  id: totrans-384
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_03_33.png)'
  id: totrans-385
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.33: Enumeration of domain and account details using rpcclient with
    valid credentials'
  id: totrans-386
  prefs: []
  type: TYPE_NORMAL
- en: Enumerating the Microsoft Azure environment
  id: totrans-387
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: During the pandemic, many organizations transformed themselves to be better
    integrated with cloud platforms, especially when there was a critical vulnerability
    on Microsoft Exchange Server that was released. In this section, we will discuss
    the various techniques utilized to perform information gathering from the Azure
    environment using Kali Linux.
  id: totrans-388
  prefs: []
  type: TYPE_NORMAL
- en: 'To interact with the Azure services, we will first need the client to be downloaded.
    This can be achieved by running the following commands in the terminal:'
  id: totrans-389
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  id: totrans-390
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'Upon successful installation of `azure-cli`, we should be able to log in using
    the `az` client from our Kali Linux by running `az login`; if there are no subscriptions,
    attackers can choose to log in without any subscription by adding `--no-subscriptions`,
    as shown in *Figure 3.34*:'
  id: totrans-391
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/B17765_03_34.png)'
  id: totrans-392
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.34: Logging in to a Microsoft 365 Azure account'
  id: totrans-393
  prefs: []
  type: TYPE_NORMAL
- en: 'Once logged in with a Microsoft 365 account, you should be able to successfully
    receive the cloud details; if the account has subscriptions, they will be displayed
    as shown in *Figure 3.35*:'
  id: totrans-394
  prefs: []
  type: TYPE_NORMAL
- en: '![A screenshot of a computer  Description automatically generated with medium
    confidence](../Images/B17765_03_35.png)'
  id: totrans-395
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.35: Portal details of the Azure that the user is authorized to view'
  id: totrans-396
  prefs: []
  type: TYPE_NORMAL
- en: '*Table 3.7* provides some of the useful commands that come in handy during
    the enumeration of Microsoft Azure cloud services:'
  id: totrans-397
  prefs: []
  type: TYPE_NORMAL
- en: '| **Command** | **Example** | **Description** |'
  id: totrans-398
  prefs: []
  type: TYPE_TB
- en: '| `az ad user list` | `az ad user list --output=table --query=''[].{Created:createdDateTime,UPN:userPrincipalName,Name:displayName,Title:jobTitle,Department:department,Email:mail,UserId:mailNickname,Phone:telephoneNumber,Mobile:mobile,Enabled:accountEnabled}''``az
    ad user list --output=json --query=''[].{Created:createdDateTime,UPN:userPrincipalName,Name:displayName,Title:jobTitle,Department:department,Email:mail,UserId:mailNickname,Phone:telephoneNumber,Mobile:mobile,Enabled:accountEnabled}''
    --upn=''<upn>''` | This command will provide a list of all users who are connected
    to this Azure AD |'
  id: totrans-399
  prefs: []
  type: TYPE_TB
- en: '| `az ad group list` | `az ad group list --output=json --query=''[].{Group:displayName,Description:description}''`
    | This will provide a full list of groups associated with the tenant |'
  id: totrans-400
  prefs: []
  type: TYPE_TB
- en: '| `az ad group member list` | `az ad group member list --output=json --query=''[].{Created:createdDateTime,UPN:userPrincipalName,Name:displayName,Title:jobTitle,Department:department,Email:mail,UserId:mailNickname,Phone:telephoneNumber,Mobile:mobile,Enabled:accountEnabled}''
    --group=''<group name>''` | This will provide a full list of members in a given
    group |'
  id: totrans-401
  prefs: []
  type: TYPE_TB
- en: '| `az ad app list` | `az ad app list --output=table --query=''[].{Name:displayName,URL:homepage}''``az
    ad app list --output=json --identifier-uri=''<uri>''` | This will provide us with
    a list of applications that are available within the Azure AD |'
  id: totrans-402
  prefs: []
  type: TYPE_TB
- en: '| `az ad sp list` | `az ad sp list --output=table --query=''[].{Name:displayName,Enabled:accountEnabled,URL:homepage,Publisher:publisherName,MetadataURL:samlMetadataUrl}''`
    | This will provide us with the service principal account details |'
  id: totrans-403
  prefs: []
  type: TYPE_TB
- en: 'Table 3.7: Commands to be used in the enumeration of Microsoft Azure cloud
    services'
  id: totrans-404
  prefs: []
  type: TYPE_NORMAL
- en: Using comprehensive tools (Legion)
  id: totrans-405
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The former security tool Sparta is no longer available in the latest version
    of Kali, but it has been complemented by another comprehensive tool called Legion,
    which is the same fork as Sparta. This tool can help to speed up the penetration
    tester’s goal of compromising a system that combines multiple tools, such as Nmap,
    and several other scripts and tools. This is a semi-automated tool that can be
    very handy when attackers wish to perform focused information gathering, based
    on the ports and services:'
  id: totrans-406
  prefs: []
  type: TYPE_NORMAL
- en: '`Hosts`: This will list down all the targets that are set by the pentesters'
  id: totrans-407
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`Services`: This is a list of services that need to be run during the automatic
    run; for example, if you configure to run Nmap and when port `80` is identified,
    it will automatically take the screenshot'
  id: totrans-408
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`Tools`: This will include all the tools that were run on a specific port,
    along with its relevant output'
  id: totrans-409
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Figure 3.36* shows Legion in action against a local subnet. By default, Legion
    performs an `nmap` full port scan, and also runs the respective Nmap scripts based
    on the services identified on the port and takes a screenshot, where possible:'
  id: totrans-410
  prefs: []
  type: TYPE_NORMAL
- en: '![Graphical user interface, text  Description automatically generated](../Images/B17765_03_36.png)'
  id: totrans-411
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.36: Port scanning output in Legion'
  id: totrans-412
  prefs: []
  type: TYPE_NORMAL
- en: Using machine learning for reconnaissance
  id: totrans-413
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Machine learning has become a vital technology in cybersecurity. It is the art
    of using data and algorithms to imitate the way we learn as humans. Machine learning
    is a branch of artificial intelligence. In this section, we will explore the GyoiThon
    tool, which you can leverage during large-scale pentesting or red team activities.
  id: totrans-414
  prefs: []
  type: TYPE_NORMAL
- en: 'There are four types of machine learning algorithms:'
  id: totrans-415
  prefs: []
  type: TYPE_NORMAL
- en: 'Supervised: These learning algorithms are provided with a set of known data
    (labeled) that includes the desired output. The goal of this type of learning
    is for the algorithm to achieve a high level of accuracy by learning from patterns
    in the data to make predictions.'
  id: totrans-416
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Unsupervised: These learning algorithms are trained with unlabeled data or
    datasets that do not include the desired output. The algorithm tries to interpret
    and organize the datasets.'
  id: totrans-417
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Semi-supervised: This is a mix of the preceding types.'
  id: totrans-418
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Reinforcement learning: These algorithms are based on regimented learning processes,
    where the algorithm is provided with a clear set of actions, factors, and desired
    outcomes. Most of the time, it is a trial-and-error method to explore different
    possibilities and options to determine which is best.'
  id: totrans-419
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'GyoiThon by gyoisamurai is a pentest tool based on the Naïve Bayes (supervised)
    deep learning method (deep learning is a subset of machine learning) and is written
    in Python 3\. It includes a software analysis engine, vulnerability identification
    engine, and report generation engine. To install the GyoiThon on our Kali Linux
    machine, run the following commands in the terminal:'
  id: totrans-420
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  id: totrans-421
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'Once the requirements are installed, run `sudo python3 gyoithon.py -h` from
    the terminal, you should see all the options, as seen in *Figure 3.37*:'
  id: totrans-422
  prefs: []
  type: TYPE_NORMAL
- en: '![Text  Description automatically generated](../Images/B17765_03_37.png)'
  id: totrans-423
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.37: Successfully running the GyoiThon tool'
  id: totrans-424
  prefs: []
  type: TYPE_NORMAL
- en: 'Before beginning the reconnaissance activity, you can edit the configuration
    file `config.ini` and enter the proxy details (if any), such as Censys and DomainTools
    API details. All the target information can be entered in the `host.txt` file,
    which is located in the same folder where the tool was cloned. The format to enter
    the target details is protocol (`http` or `https`), domain (`cyberhia.com`), port
    (`80` or `443`), and the root (`/` or `/admin/`). An example of using `host.txt`
    to perform reconnaissance on `cyberhia.com` is:'
  id: totrans-425
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  id: totrans-426
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'Finally, you can run `sudo python3 gyoithon.py` from the terminal. The software
    engine within the tool should be able to grab the banner using normal web access
    using the deep learning base and signature. *Figure 3.38* shows a successful reconnaissance
    output on the target:'
  id: totrans-427
  prefs: []
  type: TYPE_NORMAL
- en: '![Text  Description automatically generated](../Images/B17765_03_38.png)'
  id: totrans-428
  prefs: []
  type: TYPE_IMG
- en: 'Figure 3.38: Performing reconnaissance using GyoiThon'
  id: totrans-429
  prefs: []
  type: TYPE_NORMAL
- en: 'Other features you can leverage with this tool include:'
  id: totrans-430
  prefs: []
  type: TYPE_NORMAL
- en: Scanning for cloud services and exploring relevant (**Fully Qualified Domain
    Names (FQDNs**))
  id: totrans-431
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Performing custom Google searches and exploring the default paths based on the
    product version
  id: totrans-432
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Performing port scanning on targets
  id: totrans-433
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Executing the exploit module using Metasploit
  id: totrans-434
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: As it’s a supervised learning algorithm, you should be able to determine the
    input and output with the data fed into the algorithm. In this case, every time
    the scan is performed, the data will be labeled and the algorithm trained, which
    will reduce false positives significantly. For example, if the target has hundreds
    of domains, this can be very handy to automate the server banner grabbing and
    list all the vulnerabilities using the vulnerability detection engine to prepare
    for the exploitation.
  id: totrans-435
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  id: totrans-436
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Attackers might face a very real chance of their activities being identified,
    which puts them at risk of exposure to a target. However, we have now seen the
    different techniques that can be employed during active reconnaissance to mitigate
    such a risk. Attackers must ensure that there is a balance against the need to
    map a network, find open ports and services, and determine the operating system
    and applications that are installed.
  id: totrans-437
  prefs: []
  type: TYPE_NORMAL
- en: The real challenge for attackers is to adopt stealthy scanning techniques to
    reduce the risk of triggering an alert.
  id: totrans-438
  prefs: []
  type: TYPE_NORMAL
- en: Manual approaches are normally used to create slow scans; however, this approach
    may not always be effective. Therefore, attackers take advantage of tools such
    as the Tor network and various proxy applications to hide their identities.
  id: totrans-439
  prefs: []
  type: TYPE_NORMAL
- en: Additionally, we explored how to perform reconnaissance using machine learning
    using the GyoiThon tool, which can significantly reduce your manual efforts.
  id: totrans-440
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, we will explore more techniques and procedures that aid
    in vulnerability assessments, and how to utilize the scanners to identify the
    vulnerabilities that can be utilized as the potential candidates for the exploitation
    to move forward in achieving the objective.
  id: totrans-441
  prefs: []
  type: TYPE_NORMAL
