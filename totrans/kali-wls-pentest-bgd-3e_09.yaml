- en: Chapter 9. Attacking WPA-Enterprise and RADIUS
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '|   | "The bigger they are, the harder they Fall." |   |'
  prefs: []
  type: TYPE_TB
- en: '|   | --*Popular Saying* |'
  prefs: []
  type: TYPE_TB
- en: '*WPA-Enterprise has always had an aura of unbreakable ability around it. Most
    network administrators think of it as a panacea for all their wireless security
    problems. In this chapter, we will see that nothing could be further from the
    truth.*'
  prefs: []
  type: TYPE_NORMAL
- en: In this chapter, we will learn how to attack WPA-Enterprise using different
    tools and techniques available on Kali.
  prefs: []
  type: TYPE_NORMAL
- en: 'In this chapter, we will cover the following topics:'
  prefs: []
  type: TYPE_NORMAL
- en: Setting up FreeRADIUS-WPE
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Attacking PEAP on Windows clients
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Security best practices for enterprises
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Setting up FreeRADIUS-WPE
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: We will need a RADIUS server for orchestrating WPA-Enterprise attacks. The most
    widely used open source RADIUS server is FreeRADIUS. However, setting it up is
    difficult and configuring it for each attack can be tedious.
  prefs: []
  type: TYPE_NORMAL
- en: 'Joshua Wright, a well-known security researcher, created a patch for FreeRADIUS
    that makes it easier to set up and conduct attacks. This patch was released as
    the FreeRADIUS-WPE (**Wireless Pwnage Edition**). Kali doesn''t naturally come
    with FreeRADIUS-WPE, so you need to perform the following steps to set up FreeRADIUS-WPE:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Install FreeRADIUS-WPE with `apt-get install freeradius-wpe`. Now check your
    output to ensure it looks like the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Setting up FreeRADIUS-WPE](graphics/B09903_09_01.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Let's now quickly set up the RADIUS server on Kali.
  prefs: []
  type: TYPE_NORMAL
- en: Time for action – setting up the AP with FreeRADIUS-WPE
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Follow these instructions to get started:'
  prefs: []
  type: TYPE_NORMAL
- en: Connect one of the LAN ports of the access point to the Ethernet port on your
    machine running Kali. In our case, the interface is `eth0`. Bring up the interface
    and get an IP address by running DHCP, as shown in the following screenshot:![Time
    for action – setting up the AP with FreeRADIUS-WPE](graphics/B09903_09_02.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Log in to the access point and set the security mode to **WPA/WPA2-Enterprise**,
    set **Version** to **WPA2**, **Encryption** to **AES**. Then, under the EAP (802.1x)
    section, enter the **Radius Server IP** address as your Kali build's IP address.
    The **Radius Password** will be `test`, as shown in the following screenshot:![Time
    for action – setting up the AP with FreeRADIUS-WPE](graphics/B09903_09_03.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Let's now open a new terminal and go to the directory `/etc/freeradius-wpe/3.0`.
    This is where all the FreeRADIUS-WPE configuration files are.![Time for action
    – setting up the AP with FreeRADIUS-WPE](graphics/B09903_09_04.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Let's open `/mods-available/eap`. You will find that the `default_eap_type`
    command is set to `md5`.![Time for action – setting up the AP with FreeRADIUS-WPE](graphics/B09903_09_05.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Let's change this to `peap`:![Time for action – setting up the AP with FreeRADIUS-WPE](graphics/B09903_09_06.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Let's open `clients.conf`. This is where we define the allowed list of clients
    that can connect to our RADIUS server. Interestingly, if you browse right to the
    bottom, ignoring the example settings, the `secret` for clients defaults to `testing123`.
    We want to change this to `test` to match step 2:![Time for action – setting up
    the AP with FreeRADIUS-WPE](graphics/B09903_09_07.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: We are now all set to start the RADIUS server with the `freeradius-wpe –s –X`
    command:![Time for action – setting up the AP with FreeRADIUS-WPE](graphics/B09903_09_08.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Once you run this, you will see a lot of debug messages on the screen, but eventually
    the server will settle down to listen for requests. Awesome! We are all set now
    to start our lab sessions in this chapter.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '*What just happened?*'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: We have successfully set up FreeRADIUS-WPE. We will use this in the rest of
    the experiments that we will do in this chapter.
  prefs: []
  type: TYPE_NORMAL
- en: Have a go hero – playing with RADIUS
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: FreeRADIUS-WPE has tons of options. It may be a good idea to familiarize yourself
    with them. Most importantly, take time to check out the different configuration
    files and how they all work together.
  prefs: []
  type: TYPE_NORMAL
- en: Attacking PEAP
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '**Protected Extensible Authentication Protocol** (**PEAP**) is the most popular
    version of EAP in use. This is the EAP mechanism shipped natively with Windows.'
  prefs: []
  type: TYPE_NORMAL
- en: 'PEAP has two versions:'
  prefs: []
  type: TYPE_NORMAL
- en: PEAPv0 with EAP-MSCHAPv2 (the most popular as this has native support on Windows)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: PEAPv1 with EAP-GTC
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: PEAP uses server-side certificates for validation of the RADIUS server. Almost
    all attacks on PEAP leverage misconfigurations in certificate validation.
  prefs: []
  type: TYPE_NORMAL
- en: In the next lab, we will take a look at how to crack PEAP when certificate validation
    is turned off on the client.
  prefs: []
  type: TYPE_NORMAL
- en: Time for action – cracking PEAP
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Follow the given instructions to get started:'
  prefs: []
  type: TYPE_NORMAL
- en: We double-check the `eap.conf` file to ensure that PEAP is enabled:![Time for
    action – cracking PEAP](graphics/B09903_09_09.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: We then restart the RADIUS server with `freeradius-wpe –s –X`:![Time for action
    – cracking PEAP](graphics/B09903_09_10.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: We monitor the log file created by FreeRADIUS-WPE:![Time for action – cracking
    PEAP](graphics/B09903_09_11.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Windows has native support for PEAP. Let's ensure that certificate verification
    has been turned off:![Time for action – cracking PEAP](graphics/B09903_09_12.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: We need to click on the **Configure** tab that is next to **Secured password
    (EAP-MSCHAP v2)** and tell Windows not to automatically use our Windows logon
    name and password:![Time for action – cracking PEAP](graphics/B09903_09_13.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: We will also have to force it to select **User authentication** in the **Advanced
    Settings** dialog box:![Time for action – cracking PEAP](graphics/B09903_09_14.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Once the client connects to the access point, the client is prompted for a username
    and password. We use `Monster` as the username and `abcdefghi` as the password:![Time
    for action – cracking PEAP](graphics/B09903_09_15.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: As soon as we do this, you should be able to see the MSCHAP-v2 challenge response
    appear in the log file.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: We now use `asleap` to crack this using a password list file that contains the
    password `abcdefghi`, and we are able to crack the password!
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '*What just happened?*'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: We set up our Honeypot using FreeRADIUS-WPE. The enterprise client is misconfigured
    to not use certificate validation with PEAP. This allows us to present our own
    fake certificate to the client, which it gladly accepts. Once this happens, MSCHAP-v2,
    the inner authentication protocol, kicks in. As the client uses our fake certificate
    to encrypt the data, we are easily able to recover the username, challenge, and
    response tuples.
  prefs: []
  type: TYPE_NORMAL
- en: MSCHAP-v2 is prone to dictionary attacks. We use `asleap` to crack the challenge
    and response pair, as it seems to be based on a dictionary word.
  prefs: []
  type: TYPE_NORMAL
- en: Have a go hero – attack variations on PEAP
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: PEAP can be misconfigured in multiple ways. Even with certificate validation
    enabled, if the administrator does not mention the authentic servers in connect
    to these servers list, the attacker can obtain a real certificate for another
    domain from any of the listed certifying authorities. This will still be accepted
    by the client. Other variations of this attack are possible as well.
  prefs: []
  type: TYPE_NORMAL
- en: We will encourage you to explore the different possibilities in this section.
  prefs: []
  type: TYPE_NORMAL
- en: EAP-TTLS
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: We encourage you to try attacks similar to those we have suggested for PEAP
    against EAP-TTLS.
  prefs: []
  type: TYPE_NORMAL
- en: Security best practices for enterprises
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'We have seen a ton of attacks against WPA/WPA2, both Personal and Enterprise.
    Based on our experience, we recommend the following:'
  prefs: []
  type: TYPE_NORMAL
- en: For SOHOs and medium-sized businesses, use WPA2-PSK with a strong passphrase.
    You have up to 63 characters at your disposal. Make use of them.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: For large enterprises, use WPA2-Enterprise with EAP-TLS. This uses both the
    client- and server-side certificates for authentication, and currently is unbreakable.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If you have to use PEAP or EAP-TTLS with WPA2-Enterprise, then ensure that certificate
    validation is turned on, the right certifying authorities are chosen, RADIUS servers
    that are authorized are used, and finally, that any setting that allows users
    to accept new RADIUS servers, certificates, or certifying authorities is turned
    off.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Pop quiz – attacking WPA-Enterprise and RADIUS
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Q1\. Which of the following is FreeRADIUS-WPE?
  prefs: []
  type: TYPE_NORMAL
- en: A RADIUS server written from scratch
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: A patch to the FreeRADIUS server
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Ships by default on all Linuxes
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: None of the above
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Q2\. Which of the following can be used to attack PEAP?
  prefs: []
  type: TYPE_NORMAL
- en: Fake credentials
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Fake certificates
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Using WPA-PSK
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: All of the above
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Q3\. What does EAP-TLS use?
  prefs: []
  type: TYPE_NORMAL
- en: Client-side certificates
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Server-side certificates
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Either 1 or 2
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Both 1 and 2
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Q4\. What does EAP-TTLS use?
  prefs: []
  type: TYPE_NORMAL
- en: Client-side certificates only
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Server-side certificates
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Password-based authentication
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: LEAP
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, we saw how we could compromise the security of a WPA-Enterprise
    network running PEAP or EAP-TTLS, the two most common authentication mechanisms
    used in enterprises.
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, we will take a look at how to put all that we have learned
    into use during an actual penetration test.
  prefs: []
  type: TYPE_NORMAL
