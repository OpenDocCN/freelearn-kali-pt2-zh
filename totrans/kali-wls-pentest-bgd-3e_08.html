<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;KRACK Attacks"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. KRACK Attacks</h1></div></div></div><div class="blockquote"><table border="0" cellpadding="0" cellspacing="0" class="blockquote" summary="Block quote" width="100%"><tr><td valign="top"> </td><td valign="top"><p><span class="emphasis"><em>"Disregard mountains. Acquire empires"</em></span></p></td><td valign="top"> </td></tr><tr><td valign="top"> </td><td align="right" colspan="2" style="text-align: center" valign="top">--<span class="attribution"><span class="emphasis"><em>Hannibal (probably)</em></span></span></td></tr></table></div><p>
<span class="emphasis"><em>This chapter discusses the recently identified KRACK vulnerabilities and explores the current state of the tools that enable the identification of vulnerable devices. This chapter is a deep dive into the inner workings of the WPA2 handshake and is recommended for advanced readers.</em></span>
</p><div class="section" title="KRACK attack overview"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec81"/>KRACK attack overview</h1></div></div></div><p>
<span class="strong"><strong>KRACK</strong></span> stands<a class="indexterm" id="id261"/> for <span class="strong"><strong>Key Reinstallation AttaCKs</strong></span>. It's a tranche of vulnerabilities publicly disclosed in October 2017 by a team from KU Leuven. The attack is the exploitation of a fundamental flaw in the WPA2 handshake, allowing resending of a stage of the handshake in order to overwrite cryptographic data. This chapter will cover the attack at a theoretical level and provide some guidance on the successful identification and exploitation of this vulnerability.</p><p>Let's look at the WPA2 handshake, the standard for which can be found in the IEEE 802.11 standards, accessible here: <a class="ulink" href="http://ieeexplore.ieee.org/document/7792308/">http://ieeexplore.ieee.org/document/7792308/</a>. For this explanation we are starting post-association and authentication stage as the vulnerability is not affected by those.</p><p>The <span class="strong"><strong>Pairwise Transient Key</strong></span> (<span class="strong"><strong>PTK</strong></span>) used for <a class="indexterm" id="id262"/>encryption is made up of five attributes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A shared secret key known as the Pairwise Master Key (PMK)</li><li class="listitem" style="list-style-type: disc">A nonce value created by the access point (ANonce)</li><li class="listitem" style="list-style-type: disc">A nonce value created by the user station (SNonce)</li><li class="listitem" style="list-style-type: disc">The access point MAC address (APMAC)</li><li class="listitem" style="list-style-type: disc">The user station MAC address (STAMAC)</li></ul></div><p>Throughout the process, <span class="strong"><strong>Message Identification Codes</strong></span> (<span class="strong"><strong>MIC</strong></span>) are used to provide a level of integrity <a class="indexterm" id="id263"/>and security. While these are integral to the process, they are not used in the resulting cryptographic data. Here's a representation:</p><div class="mediaobject"><img alt="KRACK attack overview" src="graphics/B09903_08_01.jpg"/></div><p>At this time, as a result of the initial authentication and association process, both the user station and the access point have the PMK, the access point MAC address, and the user station MAC address. In addition, each stage will have a Key Replay Counter keeping track of the order of packets; this will come into play later:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"><span class="strong"><strong>Stage 1</strong></span>: The access point transmits the <span class="strong"><strong>ANonce</strong></span> value to the user station, which provides the user station with everything it needs to generate the PTK. The user station creates the PTK and now holds the key it will use for encryption.</li><li class="listitem"><span class="strong"><strong>Stage 2</strong></span>: The user station sends back its own nonce value along with a MIC. The access point now holds everything that it needs to create the PTK. The access point creates the PTK and is in the same state as the user station.</li><li class="listitem"><span class="strong"><strong>Stage 3</strong></span>: The access point creates and sends the <span class="strong"><strong>Group Temporal Key</strong></span> (<span class="strong"><strong>GTK</strong></span>) to the user, which <a class="indexterm" id="id264"/>enables the reading of non-directed traffic such as multicast/broadcast traffic.</li><li class="listitem"><span class="strong"><strong>Stage 4</strong></span>: The user station returns an acknowledged statement.</li></ol></div><p>Following the<a class="indexterm" id="id265"/> four-stage handshake, the user station can now send encrypted data to the access point and have it accepted. At this point, the negotiation phase is complete and the user station is free to use the network.</p><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec75"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We discussed the four-stage handshake in preparation for the explanation of the KRACK attacks. This should be a revisit at this stage, but it is important to cover the basics before launching into the technical nitty-gritty of the exploit.</p></div></div></div>
<div class="section" title="The four-way handshake KRACK attack"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec82"/>The four-way handshake KRACK attack</h1></div></div></div><p>Keeping in mind what we just discussed, you may now be surprised to find that this process is vulnerable to attack! However, the issue is not the core concept, but the practical implementation <a class="indexterm" id="id266"/>of the standard. As with most technical standards, sacrifices were made to the security of the solution in order to make it user-friendly. In specific, the sacrifice that was made to make the solution usable was making certain stages in the handshake replayable in the event of a missed message.</p><p>While this is not a huge issue for most of the<a class="indexterm" id="id267"/> process, Stage 3 is replayable and can have a dramatic effect on the security of the overall solution. By placing themselves in a <span class="strong"><strong>Man-in-the-Middle</strong></span> (<span class="strong"><strong>MITM</strong></span>) position during the authentication process, an attacker can block the correctly negotiated PTK and install their own in certain circumstances. The Key Replay Counter and associated nonce values are reset when a key is negotiated. So by blocking certain packets, an MITM attacker can predict what counter and nonce values are going to be by forcing a key reinstall. This will enable future attackers to perform malicious actions such as decryption, spoofing, and packet replay.</p><p>However, in deference to how<a class="indexterm" id="id268"/> the security industry operates, researchers have wisely only released <span class="strong"><strong>Proof of Concept</strong></span> (<span class="strong"><strong>PoC</strong></span>) scripts showing that the attack can be performed on client devices, and they have not released full-attack scripts to fully carry out the attacks against established networks. It should be noted, however, that they have announced that Android and Linux distributions are vulnerable to a key reinstall attack that forces the use of an all-zero key, effectively making traffic decryption trivial.</p></div>
<div class="section" title="Time for action &#x2013; getting KRACKing"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec83"/>Time for action – getting KRACKing</h1></div></div></div><p>We will now go<a class="indexterm" id="id269"/> through using the scripts as distributed through Mathy VanHoef's GitHub page.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, open a terminal in Kali and type the command as shown in the following screenshot:<div class="mediaobject"><img alt="Time for action – getting KRACKing" src="graphics/B09903_08_02.jpg"/></div></li><li class="listitem">We will have to install the dependencies that the project relies upon. This will be achieved with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>apt-get install libnl-3-dev libnl-genl-3-dev pkg-config libssl-dev net-tools git sysfsutils python-scapy python-pycryptodome</strong></span>
</pre></div></li><li class="listitem">Change into the created <code class="literal">krackattacks-scripts</code> directory and check the contents. It should look like the following:<div class="mediaobject"><img alt="Time for action – getting KRACKing" src="graphics/B09903_08_03.jpg"/></div><p>In this folder<a class="indexterm" id="id270"/> you can see the body of testing scripts and the solution Mathy and the team have put together. Before we can start playing with them, though, we need to compile <code class="literal">hostapd</code> in the format that they need.</p><p>The script itself provides these instructions on first use. However, I've written them here for clarity.</p></li><li class="listitem">Change into the <code class="literal">hostapd</code> directory using the commands shown in the following screenshot:<div class="mediaobject"><img alt="Time for action – getting KRACKing" src="graphics/B09903_08_04.jpg"/></div><p>This will have<a class="indexterm" id="id271"/> compiled <code class="literal">hostapd</code> for use in the KRACK attack PoC scripts. To verify that it's built correctly, the folder should look like the following:</p><div class="mediaobject"><img alt="Time for action – getting KRACKing" src="graphics/B09903_08_05.jpg"/></div></li><li class="listitem">Change into the <code class="literal">krackattack</code> directory in the project root directory. It should look like the following screenshot:<div class="mediaobject"><img alt="Time for action – getting KRACKing" src="graphics/B09903_08_06.jpg"/></div><p>The scripts <a class="indexterm" id="id272"/>will recommend executing the <code class="literal">disable-hwcrypto.sh</code> script upon first use. However, after using an Alfa AWUS051NH and a Kali Linux VM, I found that this script would only crash the VM and the scripts worked regardless. It is a user's choice whether to carry this step out, but discretion is advised.</p><p>There are three other important files in this directory. Firstly, <code class="literal">hostapd.conf</code> defines the Wi-Fi details of the network to be generated. The defaults are <code class="literal">testnetwork</code> as the SSID and <code class="literal">abcdefgh</code> as the passphrase. Feel free to change these to your satisfaction.</p><p>Second, the <code class="literal">krack-test-client.py</code> script is the script that we will be using to identify vulnerable devices. This is the main focus of this chapter.</p><p>Finally, there is the <code class="literal">krack-ft-test.py</code> which we will not cover the usage of in this chapter due to its application to niche wireless devices outside of the standard distribution.</p><p>Next, we actually get <span class="emphasis"><em>KRACKing</em></span>.</p></li><li class="listitem">We will need to disable network manager to avoid conflicts using the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>systemctl stop NetworkManager.service</strong></span>
<span class="strong"><strong>systemctl disable NetworkManager.service</strong></span>
</pre></div></li><li class="listitem">We can then execute the <code class="literal">krack-test-client.py</code> script with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>python krack-test-client.py</strong></span>
</pre></div><p>You will then see the following screenshot:</p><div class="mediaobject"><img alt="Time for action – getting KRACKing" src="graphics/B09903_08_07.jpg"/></div></li><li class="listitem">Now get hold <a class="indexterm" id="id273"/>of a test device, any Wi-Fi-enabled device, and connect to the created network with the credentials described earlier or whatever you've set it to.<p>The terminal will fill with text, but the script will helpfully mark any successful attacks in green as shown in the following screenshot:</p><div class="mediaobject"><img alt="Time for action – getting KRACKing" src="graphics/B09903_08_08.jpg"/></div></li></ol></div><p>The script will iterate<a class="indexterm" id="id274"/> through the potential attacks and inform the user whether the device tested is vulnerable.</p><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec76"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We successfully retrieved the PoC from Mathy VanHoef's GitHub page and tested a user device to see if it's vulnerable.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec84"/>Summary</h1></div></div></div><p>In this chapter, we've gone over the new KRACK attack, covered how the WPA2 handshake works, and saw how to perform a PoC check against a device. The KRACK attack will develop as time goes on and more scripts are released into the wild. Readers should keep up with the community and monitor for new and interesting applications of this research.</p><p>Readers should also visit the researcher's web page at <a class="ulink" href="https://www.krackattacks.com/">https://www.krackattacks.com/</a>.</p><p>Also, read the white paper for a greater understanding found at <a class="ulink" href="https://papers.mathyvanhoef.com/ccs2017.pdf">https://papers.mathyvanhoef.com/ccs2017.pdf</a>.</p></div></body></html>