<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;WLAN Encryption Flaws"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. WLAN Encryption Flaws</h1></div></div></div><div class="blockquote"><table border="0" cellpadding="0" cellspacing="0" class="blockquote" summary="Block quote" width="100%"><tr><td valign="top"> </td><td valign="top"><p><span class="emphasis"><em>"640K is more memory than anyone will ever need."</em></span></p></td><td valign="top"> </td></tr><tr><td valign="top"> </td><td align="right" colspan="2" style="text-align: center" valign="top">--<span class="attribution"><span class="emphasis"><em>Bill Gates, Founder, Microsoft</em></span></span></td></tr></table></div><p>
<span class="emphasis"><em>Even with the best of intentions, the future is always unpredictable. The WLAN committee designed WEP and then WPA to be foolproof encryption mechanisms but, over time, both these mechanisms had flaws that have been widely publicized and exploited in the real world.</em></span>
</p><p>
<span class="emphasis"><em>WLAN encryption mechanisms have had a long history of being vulnerable to cryptographic attacks. It started with WEP in early 2000, which eventually was completely broken. In recent times, WPA has been proven to contain multiple flaws that have been addressed and readdressed. Even though there is no public attack available currently to break WPA in all general conditions, there are attacks that are feasible under special circumstances.</em></span>
</p><p>In this chapter, we will take a look at the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Different encryption schemas in WLANs</li><li class="listitem" style="list-style-type: disc">Cracking WEP encryption</li><li class="listitem" style="list-style-type: disc">Cracking WPA encryption</li></ul></div><div class="section" title="WLAN encryption"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec39"/>WLAN encryption</h1></div></div></div><p>WLANs transmit data over the air and thus there is an inherent need to protect data confidentiality. This is best <a class="indexterm" id="id110"/>done using encryption. The WLAN committee (IEEE 802.11) formulated the following<a class="indexterm" id="id111"/> protocols for data encryption:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Wired Equivalent Privacy</strong></span> (<span class="strong"><strong>WEP</strong></span>)</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Wi-Fi Protected Access</strong></span> (<span class="strong"><strong>WPA</strong></span>)</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Wi-Fi Protected Access v2</strong></span> (<span class="strong"><strong>WPA2</strong></span>)</li></ul></div><p>In this chapter, we will take a look at <a class="indexterm" id="id112"/>each of these encryption protocols and demonstrate <a class="indexterm" id="id113"/>various attacks against them.</p></div></div>
<div class="section" title="WEP encryption"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec40"/>WEP encryption</h1></div></div></div><p>The WEP protocol was known to be<a class="indexterm" id="id114"/> flawed as early as 2000 but, surprisingly, it is still present in a lot of organizations and access points still ship with WEP enabled capabilities.</p><p>There are many cryptographic weaknesses in WEP and they were discovered by Walker, Arbaugh, Fluhrer, Martin, Shamir, KoreK, and many others. Evaluation of WEP from a cryptographic standpoint is not required for a basic understanding of how to break it. In this section, we will take a look at how to break WEP encryption using readily available tools on Kali Linux. This includes the entire <code class="literal">aircrack-ng</code> suite of tools: <code class="literal">airmon-ng</code>, <code class="literal">aireplay-ng</code>, <code class="literal">airodump-ng</code>, <code class="literal">aircrack-ng</code>, and others.</p><p>The fundamental weakness in WEP is its use of RC4 and a short IV value that is recycled every 224 frames. While this may appear to be a large number, there is a 50 percent chance of four IV reuses every 5,000 packets. To use this to our advantage, we generate a large amount of traffic so that we can increase the likelihood of IVs that have been reused and thus compare two cipher texts encrypted with the same IV and key.</p><p>Let's now first set up WEP in our test lab and see how we can break it.</p></div>
<div class="section" title="Time for action &#x2013; cracking WEP"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec41"/>Time for action – cracking WEP</h1></div></div></div><p>Follow the given<a class="indexterm" id="id115"/> instructions to get started:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's first connect to our access point Wireless Lab and go to the settings area that deals with wireless encryption mechanisms.</li><li class="listitem">On my access point, this can be done by setting the <span class="strong"><strong>Security Mode</strong></span> to <span class="strong"><strong>WEP</strong></span>. We will also need to set the WEP key length. As shown in the following screenshot, I have set WEP to use <span class="strong"><strong>128bit</strong></span> keys. I have set the default key to WEP <span class="strong"><strong>Key 1</strong></span> and the value in hex to <code class="literal">abcdefabcdefabcdefabcdef12</code> as the 128-bit WEP key. You can set this to whatever you choose:<div class="mediaobject"><img alt="Time for action – cracking WEP" src="graphics/B09903_04_01.jpg"/></div></li><li class="listitem">Once the settings <a class="indexterm" id="id116"/>are applied, the access point should now be offering WEP as the encryption mechanism of choice. Let's now set up the attacker machine.</li><li class="listitem">Let's bring up <code class="literal">wlan0</code> by issuing the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>ifconfig wlan0 up</strong></span>
</pre></div></li><li class="listitem">Then, we will run the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>airmon-ng start wlan0</strong></span>
</pre></div></li><li class="listitem">This is done to create <code class="literal">wlan0mon</code>, a monitor mode interface, as shown in the following screenshot. Verify that the <code class="literal">wlan0mon</code> interface has been created using the <code class="literal">ifconfig</code> command:<div class="mediaobject"><img alt="Time for action – cracking WEP" src="graphics/B09903_04_02.jpg"/></div></li><li class="listitem">Let's run <code class="literal">airodump-ng</code> to locate our lab access point using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>airodump-ng wlan0mon</strong></span>
</pre></div></li><li class="listitem">As you can see<a class="indexterm" id="id117"/> in the following screenshot, we are able to see the <code class="literal">Wireless Lab</code> access point running WEP:<div class="mediaobject"><img alt="Time for action – cracking WEP" src="graphics/B09903_04_03.jpg"/></div></li><li class="listitem">For this exercise, we<a class="indexterm" id="id118"/> are only interested in the <code class="literal">Wireless Lab</code> network, so we can fine-tune our command to only see packets for this network:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>airodump-ng --bssid &lt;Your AP MAC&gt; --channel &lt;whatever channel it's on&gt; --write WEPCrackingDemo wlan0mon</strong></span>
</pre></div><p>An example command line is shown in the following screenshot:</p><div class="mediaobject"><img alt="Time for action – cracking WEP" src="graphics/B09903_04_04.jpg"/></div></li><li class="listitem">We will request <code class="literal">airodump-ng</code> to save the packets into a <code class="literal">pcap</code> file using the <code class="literal">--write</code> flag:<div class="mediaobject"><img alt="Time for action – cracking WEP" src="graphics/B09903_04_05.jpg"/></div></li><li class="listitem">Now, let's connect our wireless client to the access point and use the WEP key as <code class="literal">abcdefabcdefabcdefabcdef12</code>. Once the client has successfully connected, <code class="literal">airodump-ng</code> should report it on the screen:<div class="mediaobject"><img alt="Time for action – cracking WEP" src="graphics/B09903_04_06.jpg"/></div></li><li class="listitem">If you execute <code class="literal">ls</code> in the same <a class="indexterm" id="id119"/>directory, you will be able to see files prefixed with <code class="literal">WEPCrackingDemo-*</code>, as shown in the following screenshot. These are traffic dump files created by <code class="literal">airodump-ng</code>:<div class="mediaobject"><img alt="Time for action – cracking WEP" src="graphics/B09903_04_07.jpg"/></div></li><li class="listitem">If you notice the <code class="literal">airodump-ng</code> screen, there are very few data packets listed under <code class="literal">#Data</code> (only <code class="literal">35</code>):<div class="mediaobject"><img alt="Time for action – cracking WEP" src="graphics/B09903_04_08.jpg"/></div></li><li class="listitem">In WEP cracking, we need a large number of data packets, encrypted with the same key to exploit weaknesses in the protocol. So, we will have to force the network to produce more data packets. To do this, we will use the <code class="literal">aireplay-ng</code> tool.</li><li class="listitem">We will capture ARP<a class="indexterm" id="id120"/> packets on the wireless network using <code class="literal">aireplay-ng</code> and inject them back into the network to simulate ARP responses. We will be starting <code class="literal">aireplay-ng</code> in a separate window, as shown in the next screenshot. Replaying these packets a few thousand times, we will generate a lot of data traffic on the network. Even though <code class="literal">aireplay-ng</code> does not know the WEP key, it is able to identify the ARP packets by looking at the size of the packets. ARP is a fixed header protocol; thus, the size of the ARP packets can be easily determined and can be used to identify them even within encrypted traffic. We will run <code class="literal">aireplay-ng</code> with the options that are discussed next. The <code class="literal">-3</code> option is for ARP replay, <code class="literal">-b</code> specifies the BSSID of our network, and <code class="literal">-h</code> specifies the client MAC address that we are spoofing. Don't forget to add the adapter to use. We need to do this, as replay attacks will only work for authenticated and associated client MAC addresses:<div class="mediaobject"><img alt="Time for action – cracking WEP" src="graphics/B09903_04_09.jpg"/></div></li><li class="listitem">Very soon you should see that <code class="literal">aireplay-ng</code> was able to sniff ARP packets and started replaying them into the network. If you encounter channel-related errors as I did, append <code class="literal">--ignore-negative-one</code> to your command, as shown in the following screenshot:<div class="mediaobject"><img alt="Time for action – cracking WEP" src="graphics/B09903_04_10.jpg"/></div></li><li class="listitem">At this point, <code class="literal">airodump-ng</code> will also start registering a lot of data packets. All these sniffed packets are being stored in the <code class="literal">WEPCrackingDemo-*</code> files that we saw previously:<div class="mediaobject"><img alt="Time for action – cracking WEP" src="graphics/B09903_04_11.jpg"/></div></li><li class="listitem">Now, let's start with<a class="indexterm" id="id121"/> the actual cracking part! Fire up <code class="literal">aircrack-ng</code> with the option <code class="literal">WEPCRackingDemo-0*.cap</code> in a new window. This will start the <code class="literal">aircrack-ng</code> software and it will begin working on cracking the WEP key using the data packets in the file. Note that it is a good idea to have <code class="literal">airodump-ng</code> collect the WEP packets, <code class="literal">aireplay-ng</code> do the replay attack, and <code class="literal">aircrack-ng</code> attempt to crack the WEP key based on the captured packets, all at the same time. In this experiment, all of them are open in separate windows:<div class="mediaobject"><img alt="Time for action – cracking WEP" src="graphics/B09903_04_12.jpg"/></div></li><li class="listitem">Your screen should <a class="indexterm" id="id122"/>look like the following screenshot when Aircrack-ng is working on the packets to crack the WEP key:<div class="mediaobject"><img alt="Time for action – cracking WEP" src="graphics/B09903_04_13.jpg"/></div></li><li class="listitem">The number of data packets required to crack the key is nondeterministic, but generally in the order of a hundred thousand or more. On a fast network (or using <code class="literal">aireplay-ng</code>), this should take 5-10 minutes at most. You may need to restart this process several times.</li><li class="listitem">Once enough data packets have been captured and processed, <code class="literal">aircrack-ng</code> should be able to break the key. Once it does, it proudly displays it in the terminal and exits, as shown in the following screenshot:<div class="mediaobject"><img alt="Time for action – cracking WEP" src="graphics/B09903_04_14.jpg"/></div></li><li class="listitem">It is important to <a class="indexterm" id="id123"/>note that WEP is totally flawed and any WEP key (no matter how complex) will be cracked by <code class="literal">aircrack-ng</code>. The only requirement is that a large enough number of data packets, encrypted with this key, are made available to <code class="literal">aircrack-ng</code>.</li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec38"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We set up WEP in our lab and successfully cracked the WEP key. In order to do this, we first waited for a legitimate client of the network to connect to the access point. After this, we used the <code class="literal">aireplay-ng</code> tool to replay ARP packets into the network. This caused the network to send ARP replay packets, thus greatly increasing the number of data packets sent over the air. We then used the <code class="literal">aircrack-ng</code> tool to crack the WEP key by analyzing cryptographic weaknesses in these data packets.</p><p>Note that we can also fake an authentication to<a class="indexterm" id="id124"/> the access point using the <span class="strong"><strong>Shared Key Authentication</strong></span> (<span class="strong"><strong>SKA</strong></span>) bypass technique we learned in the last chapter. This can come in handy if the legitimate client leaves the network. This will ensure that we can spoof an authentication and association and continue to send our replayed packets into the network.</p></div><div class="section" title="Have a go hero – fake authentication with WEP cracking"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec39"/>Have a go hero – fake authentication with WEP cracking</h2></div></div></div><p>In the previous exercise, if the legitimate<a class="indexterm" id="id125"/> client had suddenly logged off the network, we would not have been able to replay the packets as the access point will refuse to accept packets from unassociated clients.</p><p>Your challenge will be to fake an authentication and association using the SKA bypass we learnt in the last chapter, while WEP cracking is going on. Log off the legitimate client from the network and verify that you are still able to inject packets into the network and whether the access point accepts and responds to them.</p></div></div>
<div class="section" title="WPA/WPA2"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec42"/>WPA/WPA2</h1></div></div></div><p>WPA (or WPA v1 as it is<a class="indexterm" id="id126"/> referred to sometimes) primarily uses the <span class="strong"><strong>Temporal Key Integrity Protocol</strong></span> (<span class="strong"><strong>TKIP</strong></span>) encryption algorithm. TKIP was aimed at improving WEP, without requiring completely new hardware<a class="indexterm" id="id127"/> to run it. WPA2 in contrast mandatorily uses the AES-CCMP algorithm for encryption, which is much more powerful and robust than TKIP.</p><p>Both WPA and WPA2 allow either EAP-based <a class="indexterm" id="id128"/>authentication, using RADIUS servers (Enterprise) or a <span class="strong"><strong>Pre-Shared Key</strong></span> (<span class="strong"><strong>PSK</strong></span>) (personal)-based authentication schema.</p><p>WPA/WPA2 PSK is vulnerable to a dictionary attack. The inputs required for this attack are the four-way WPA handshake between client and access point, and a wordlist that contains common passphrases. Then, using tools such as <code class="literal">aircrack-ng</code>, we can try to crack the WPA/WPA2 PSK passphrase.</p><p>An illustration of the four-way handshake is shown in the following screenshot:</p><div class="mediaobject"><img alt="WPA/WPA2" src="graphics/B09903_04_15.jpg"/></div><p>The way WPA/WPA2 PSK works is that it <a class="indexterm" id="id129"/>derives the per-session key, called the <span class="strong"><strong>Pairwise Transient Key</strong></span> (<span class="strong"><strong>PTK</strong></span>), using the PSK and five other parameters—SSID of network, <span class="strong"><strong>Authenticator Nonce</strong></span> (<span class="strong"><strong>ANonce</strong></span>), <span class="strong"><strong>Supplicant Nonce</strong></span> (<span class="strong"><strong>SNonce</strong></span>), Authenticator <a class="indexterm" id="id130"/>MAC address (access point MAC), and Suppliant MAC address (Wi-Fi client MAC). This key is then used to encrypt all data between the access point and client.</p><p>An attacker who is eavesdropping on this entire conversation by sniffing the air can get all five parameters mentioned in the previous paragraph. The only thing he does not have is the PSK. So, how is the PSK created? It is derived by using the WPA-PSK passphrase supplied by the user, along with the SSID. The combination<a class="indexterm" id="id131"/> of both of these is sent through the <span class="strong"><strong>Password-Based Key Derivation Function</strong></span> (<span class="strong"><strong>PBKDF2</strong></span>), which outputs the 256-bit shared key.</p><p>In a typical WPA/WPA2<a class="indexterm" id="id132"/> PSK dictionary attack, the attacker would use a large dictionary of possible passphrases with the attack tool. The tool would derive the 256-bit PSK from each of the passphrases and use it with the other parameters, described earlier, to create the PTK. The PTK will be used to<a class="indexterm" id="id133"/> verify the <span class="strong"><strong>Message Integrity Check</strong></span> (<span class="strong"><strong>MIC</strong></span>) in one of the handshake packets. If it matches, then the guessed passphrase from the dictionary was correct; if not, it was incorrect.</p><p>Eventually, if the authorized network passphrase exists in the dictionary, it will be identified. This is exactly how WPA/WPA2 PSK cracking works! The following diagram illustrates the steps involved:</p><div class="mediaobject"><img alt="WPA/WPA2" src="graphics/B09903_04_16.jpg"/></div><p>In the next exercise, we <a class="indexterm" id="id134"/>will take a look at how to crack a WPA PSK wireless network. The exact same steps will be involved in cracking a WPA2-PSK network using CCMP (AES) as well.</p></div>
<div class="section" title="Time for action &#x2013; cracking WPA-PSK weak passphrase"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec43"/>Time for action – cracking WPA-PSK weak passphrase</h1></div></div></div><p>Follow the given instructions to <a class="indexterm" id="id135"/>get started:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's first connect to our access point <code class="literal">Wireless Lab</code> and set the access point to use WPA-PSK. We will set the WPA-PSK passphrase to <code class="literal">abcdefgh</code> so that it is vulnerable to a dictionary attack:<div class="mediaobject"><img alt="Time for action – cracking WPA-PSK weak passphrase" src="graphics/B09903_04_17.jpg"/></div></li><li class="listitem">We start <code class="literal">airodump-ng</code> with the following command so that it starts capturing and storing all packets<a class="indexterm" id="id136"/> for our network:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>airodump-ng --bssid 00:21:91:D2:8E:25 --channel 11 --write WPACrackingDemo wlan0mon</strong></span>
</pre></div><p>The following screenshot shows the output:</p><div class="mediaobject"><img alt="Time for action – cracking WPA-PSK weak passphrase" src="graphics/B09903_04_18.jpg"/></div></li><li class="listitem">Now, we can wait for a new client to connect to the access point so that we can capture the four-way WPA handshake, or we can send a broadcast deauthentication packet to force clients to reconnect. We do the latter to speed things up. The same thing can happen again with the unknown channel error. Again, use <code class="literal">--ignore-negative-one</code>. This can also require more than one attempt:<div class="mediaobject"><img alt="Time for action – cracking WPA-PSK weak passphrase" src="graphics/B09903_04_19.jpg"/></div></li><li class="listitem">As soon as we<a class="indexterm" id="id137"/> capture a WPA handshake, the <code class="literal">airodump-ng</code> tool will indicate it in the top-right corner of the screen with a WPA handshake followed by the access point's BSSID:<div class="mediaobject"><img alt="Time for action – cracking WPA-PSK weak passphrase" src="graphics/B09903_04_20.jpg"/></div></li><li class="listitem">If you are using <code class="literal">--ignore-negative-one</code>, the tool may replace the WPA handshake with a fixed channel message. Just keep an eye out for a quick flash of a WPA handshake. If we check our working directory, we should see that a <code class="literal">.cap</code> file has been generated:<div class="mediaobject"><img alt="Time for action – cracking WPA-PSK weak passphrase" src="graphics/B09903_04_21.jpg"/></div></li><li class="listitem">We can stop the <code class="literal">airodump-ng</code> utility now. Let's open up the capture file in Wireshark and view the four-way handshake. Your Wireshark terminal should look like the<a class="indexterm" id="id138"/> following screenshot. I have selected the first packet of the four-way handshake in the trace file in the screenshot. The handshake packets are the one whose protocol is <code class="literal">EAPOL</code>. You can filter this by typing <code class="literal">eapol</code> into the filter bar:<div class="mediaobject"><img alt="Time for action – cracking WPA-PSK weak passphrase" src="graphics/B09903_04_22.jpg"/></div></li><li class="listitem">Now, we will start the actual key cracking exercise! For this, we need a dictionary of common words. Kali ships with many dictionary files in the <code class="literal">metasploit</code> folder located as shown in the following screenshot. It is important to note that, in WPA cracking, you are just as good as your dictionary. Kali ships with some dictionaries, but these may be insufficient. Passwords that people choose depend on a lot of things. This includes things such as which country users live in, common names and phrases in that region, the security awareness of the users, and a host of other things. It may be a good idea to aggregate country- and region-specific wordlists, when undertaking a penetration test:<div class="mediaobject"><img alt="Time for action – cracking WPA-PSK weak passphrase" src="graphics/B09903_04_23.jpg"/></div></li><li class="listitem">We will now<a class="indexterm" id="id139"/> invoke the <code class="literal">aircrack-ng</code> utility with the <code class="literal">pcap</code> file as the input and a link to the dictionary file, as shown in the following screenshot. I have used <code class="literal">nmap.lst</code> which can be found in <code class="literal">/usr/share/wordlists/</code>, as shown in the terminal:<div class="mediaobject"><img alt="Time for action – cracking WPA-PSK weak passphrase" src="graphics/B09903_04_24.jpg"/></div></li><li class="listitem">The <code class="literal">aircrack-ng</code> utility uses the dictionary file to try various combinations of passphrases and tries to crack the key. If the passphrase is present in the dictionary file, it will eventually crack it and your screen will look similar to the one in the screenshot:<div class="mediaobject"><img alt="Time for action – cracking WPA-PSK weak passphrase" src="graphics/B09903_04_25.jpg"/></div></li><li class="listitem">Please note that, as this is<a class="indexterm" id="id140"/> a dictionary attack, the prerequisite is that the passphrase must be present in the dictionary file you are supplying to <code class="literal">aircrack-ng</code>. If the passphrase is not present in the dictionary, the attack will fail!</li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec40"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We set up WPA-PSK on our access point with a common passphrase: <code class="literal">abcdefgh</code>. We then use a deauthentication attack to have legitimate clients reconnect to the access point. When we reconnect, we capture the four-way WPA handshake between the access point and the client.</p><p>As WPA-PSK is vulnerable to a dictionary attack, we feed the capture file that contains the WPA four-way handshake and a list of common passphrases (in the form of a wordlist) to <code class="literal">aircrack-ng</code>. As the passphrase <code class="literal">abcdefgh</code> is present in the wordlist, <code class="literal">aircrack-ng</code> is able to crack the WPA-PSK shared passphrase. It is very important to note again that, in WPA dictionary-based cracking, you are just as good as the dictionary you have. Thus, it is important to compile a large and elaborate dictionary before you begin. Though Kali ships with its own dictionary, it may be insufficient at times and might need more words, especially taking into account the localization factor.</p></div><div class="section" title="Have a go hero – trying WPA-PSK cracking with Cowpatty"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec41"/>Have a go hero – trying WPA-PSK cracking with Cowpatty</h2></div></div></div><p>
<span class="strong"><strong>Cowpatty</strong></span> is a tool that can also<a class="indexterm" id="id141"/> crack a WPA-PSK passphrase using a dictionary attack. This tool is included with Kali. I leave it as an exercise for you to use Cowpatty to crack the WPA-PSK passphrase.</p><p>Also, set an uncommon passphrase<a class="indexterm" id="id142"/> that is not present in the dictionary and try the attack again. You will now be unsuccessful in cracking the passphrase with both Aircrack-ng and Cowpatty.</p><p>It is important to note that the<a class="indexterm" id="id143"/> same attack applies even to a WPA2 PSK network. I encourage you to verify this independently.</p></div></div>
<div class="section" title="Speeding up WPA/WPA2 PSK cracking"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec44"/>Speeding up WPA/WPA2 PSK cracking</h1></div></div></div><p>As we have already <a class="indexterm" id="id144"/>seen in the previous section, if we have the correct passphrase in our dictionary, cracking WPA-Personal will work every time like a charm. So, why don't we just create a large elaborate dictionary of millions of common passwords and phrases people use? This would help us a lot and most of the time, we would end up cracking the passphrase. It all sounds great but we are missing one key component here—the time taken. One of the more CPU and time-consuming calculations is that of the PSK using the PSK passphrase and the SSID through the PBKDF2. This function hashes the combination of both over 4,096 times before outputting the 256-bit PSK. The next step in cracking involves using this key along with parameters in the four-way handshake and verifying against the MIC in the handshake. This step is computationally inexpensive. Also, the parameters will vary in the handshake every time and hence, this step cannot be precomputed. Thus, to speed up the cracking process, we need to make the calculation of the PSK from the passphrase as fast as possible.</p><p>We can speed this up by precalculating the PSK, also called the <span class="strong"><strong>Pairwise Master Key</strong></span> (<span class="strong"><strong>PMK</strong></span>) in 802.11 standard parlance. It is important to note that, as the SSID is also used to calculate the PMK, with the same passphrase and with a different SSID, we will end up with a different PMK. Thus, the PMK depends on both the passphrase and the SSID.</p><p>In the next exercise, we will take a look at how to precalculate the PMK and use it for WPA/WPA2 PSK cracking.</p></div>
<div class="section" title="Time for action &#x2013; speeding up the cracking process"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec45"/>Time for action – speeding up the cracking process</h1></div></div></div><p>We can proceed with the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We can pre-calculate the PMK for a given SSID and wordlist using the <code class="literal">genpmk</code> tool with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>genpmk -f &lt;chosen wordlist&gt; -d PMK-Wireless-Lab -s "Wireless Lab"</strong></span>
</pre></div><p>This creates the <code class="literal">PMK-Wireless-Lab</code> file containing the pregenerated PMK:</p><div class="mediaobject"><img alt="Time for action – speeding up the cracking process" src="graphics/B09903_04_26.jpg"/></div></li><li class="listitem">We now create a <a class="indexterm" id="id145"/>WPA-PSK network with the passphrase <code class="literal">abcdefgh</code> (present in the dictionary we used) and capture a WPA-handshake for that network as we did with the previous exercise; alternatively, use the files we used previously. We now use Cowpatty to crack the WPA passphrase, as shown in the following screenshot:<div class="mediaobject"><img alt="Time for action – speeding up the cracking process" src="graphics/B09903_04_27.jpg"/></div><p>It takes approximately 7.18 seconds for Cowpatty to crack the key, using the precalculated PMKs.</p></li><li class="listitem">We now use <code class="literal">aircrack-ng</code> with the same dictionary file, and the cracking process takes over 22 minutes. This shows how much we are gaining because of the precalculation.</li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec42"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We looked at various different tools and techniques to speed up WPA/WPA2-PSK cracking. The whole idea is to<a class="indexterm" id="id146"/> precalculate the PMK for a given SSID and a list of passphrases in our dictionary.</p></div></div>
<div class="section" title="Decrypting WEP and WPA packets"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec46"/>Decrypting WEP and WPA packets</h1></div></div></div><p>In all the exercises we<a class="indexterm" id="id147"/> have done till now, we cracked the WEP and WPA keys using various techniques. What do we do with this information? The first step is to decrypt data packets we have captured using these keys.</p><p>In the next exercise, we will <a class="indexterm" id="id148"/>decrypt the WEP and WPA packets in the same trace file that we captured over the air, using the keys we cracked.</p></div>
<div class="section" title="Time for action &#x2013; decrypting WEP and WPA packets"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec47"/>Time for action – decrypting WEP and WPA packets</h1></div></div></div><p>We can proceed with the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We will decrypt packets from the WEP capture file we created earlier: <code class="literal">WEPCrackingDemo-01.cap</code>. For this, we will use another tool in the Aircrack-ng suite called <code class="literal">airdecap-ng</code>. We will run the following command, as shown in the following screenshot, using the WEP key we cracked previously:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>airdecap-ng -w abcdefabcdefabcdefabcdef12 WEPCrackingDemo-01.cap</strong></span>
</pre></div><div class="mediaobject"><img alt="Time for action – decrypting WEP and WPA packets" src="graphics/B09903_04_28.jpg"/></div></li><li class="listitem">The decrypted files are stored in a file named <code class="literal">WEPCrackingDemo-01-dec.cap</code>. We use the <code class="literal">tshark</code> utility to view the first ten packets in the file. Please note that you may see something different based on what you captured:<div class="mediaobject"><img alt="Time for action – decrypting WEP and WPA packets" src="graphics/B09903_04_29.jpg"/></div></li><li class="listitem">WPA/WPA2 PSK <a class="indexterm" id="id149"/>will work in exactly the same way as with WEP, using the <code class="literal">airdecap-ng</code> utility, as shown in the following screenshot, with the<a class="indexterm" id="id150"/> following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>airdecap-ng -p abcdefgh WPACrackingDemo-01.cap -e "Wireless Lab"</strong></span>
</pre></div><div class="mediaobject"><img alt="Time for action – decrypting WEP and WPA packets" src="graphics/B09903_04_30.jpg"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec43"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We just saw how we can decrypt WEP and WPA/WPA2-PSK encrypted packets using <code class="literal">airdecap-ng</code>. It is interesting to <a class="indexterm" id="id151"/>note that we can do the same using Wireshark. We would encourage you to<a class="indexterm" id="id152"/> explore how this can be done by consulting the Wireshark documentation.</p></div></div>
<div class="section" title="Connecting to WEP and WPA networks"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec48"/>Connecting to WEP and WPA networks</h1></div></div></div><p>We can also connect to the<a class="indexterm" id="id153"/> authorized network after we have cracked the network key. This can <a class="indexterm" id="id154"/>come in handy during penetration testing. Logging onto the authorized network with the cracked key is the ultimate proof you can provide to your client that his network is insecure.</p></div>
<div class="section" title="Time for action &#x2013; connecting to a WEP network"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec49"/>Time for action – connecting to a WEP network</h1></div></div></div><p>We can proceed with the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Use the <code class="literal">iwconfig</code> utility to connect to a WEP network, once you have the key. In a past exercise, we broke the WEP key—<code class="literal">abcdefabcdefabcdefabcdef12</code>:<div class="mediaobject"><img alt="Time for action – connecting to a WEP network" src="graphics/B09903_04_31.jpg"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec44"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We saw how to connect to a WEP network.</p></div></div>
<div class="section" title="Time for action &#x2013; connecting to a WPA network"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec50"/>Time for action – connecting to a WPA network</h1></div></div></div><p>We can proceed with the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the case of WPA, the matter is a bit more complicated. The <code class="literal">iwconfig</code> utility cannot be used with WPA/WPA2 Personal and Enterprise, as it does not support it. We will<a class="indexterm" id="id155"/> use a new tool called <code class="literal">wpa_supplicant</code> for this lab. To use <code class="literal">WPA_supplicant</code> for a network, we will need to create a configuration file, as shown in the following screenshot. We will name this file <code class="literal">wpa-supp.conf</code>:<div class="mediaobject"><img alt="Time for action – connecting to a WPA network" src="graphics/B09903_04_32.jpg"/></div></li><li class="listitem">We will then invoke the <code class="literal">wpa_supplicant</code> utility with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>wpa_supplicant -D wext -i wlan0 -c wpa-supp.conf</strong></span>
</pre></div></li><li class="listitem">This will connect the device to the WPA network we just cracked. Once the connection is successful, <code class="literal">wpa_supplicant</code> will give you the message: <span class="strong"><strong>Connection to XXXX completed</strong></span>.</li><li class="listitem">For both the WEP and WPA<a class="indexterm" id="id156"/> networks, once you are connected, you can use <code class="literal">dhclient</code> to grab a DHCP address from the network by typing <code class="literal">dhclient3 wlan0</code>.</li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec45"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>The default Wi-Fi utility <code class="literal">iwconfig</code> cannot be used to connect to WPA/WPA2 networks. The de-facto tool for this is <code class="literal">wpa_supplicant</code>. In this lab, we saw how we can use it to connect to a WPA network.</p></div><div class="section" title="Pop quiz – WLAN encryption flaws"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec46"/>Pop quiz – WLAN encryption flaws</h2></div></div></div><p>Q1. What packets are used for packet replay?</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Deauthentication packet</li><li class="listitem">Associated packet</li><li class="listitem">Encrypted ARP packet</li><li class="listitem">None of the above</li></ol></div><p>Q2. When can WEP be cracked?</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Always</li><li class="listitem">Only if a weak key/passphrase is chosen</li><li class="listitem">Under special circumstances only</li><li class="listitem">Only if the access point runs old software</li></ol></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec51"/>Summary</h1></div></div></div><p>In this chapter, we learnt about WLAN encryption. WEP is flawed and no matter what the WEP key is, with enough data packet samples: it is always possible to crack WEP. WPA/WPA2 is cryptographically un-crackable currently; however, under special circumstances, such as when a weak passphrase is chosen in WPA/WPA2-PSK, it is possible to retrieve the passphrase using dictionary attacks.</p><p>In the next chapter, we will take a look at different attacks on the WLAN infrastructure, such as rogue access points, evil twins, bit-flipping attacks, and so on.</p></div></body></html>