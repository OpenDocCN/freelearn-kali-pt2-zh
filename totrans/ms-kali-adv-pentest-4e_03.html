<html><head></head><body>
  <div id="_idContainer142" class="Basic-Text-Frame">
    <h1 class="chapterNumber">3</h1>
    <h1 id="_idParaDest-79" class="chapterTitle">Active Reconnaissance of External and Internal Networks</h1>
    <p class="normal">Active reconnaissance is the art of collecting information directly from a target. The purpose of this phase is to collect and weaponize information about the target to the greatest degree possible to facilitate the exploitation phase of the kill chain methodology. We saw in the last chapter how to perform passive reconnaissance using OSINT, which is almost undetectable and can yield a significant amount of information about the target organization and its users. This phase builds on the results obtained from OSINT and passive reconnaissance and emphasizes more focused probing to identify the path to, and the attack surface of, a target. In general, complex systems have a greater attack surface, and each surface may be exploited and then leveraged to support additional attacks.</p>
    <p class="normal">Although active reconnaissance produces more useful information, interactions with the target system may be logged, triggering alarms by protective devices, such as firewalls, <strong class="keyWord">Intrusion Detection Systems</strong> (<strong class="keyWord">IDSes</strong>), <strong class="keyWord">Intrusion Prevention Systems</strong> (<strong class="keyWord">IPSes</strong>), and <strong class="keyWord">Endpoint Detection Response</strong> (<strong class="keyWord">EDR</strong>) <strong class="keyWord">systems</strong>. As the usefulness of the data to the attacker increases, so does the risk of detection; this is shown in <em class="italic">Figure 3.1</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_01.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.1: Usefulness of data and risk of detection for attackers</p>
    <p class="normal">To improve the effectiveness of active reconnaissance in providing detailed information, our focus will be on using the stealthiest techniques, as these will be the most difficult to detect. In this chapter, you will learn about the following:</p>
    <ul>
      <li class="bulletList">Stealth scanning techniques</li>
      <li class="bulletList">External and internal infrastructure, host discovery, and enumeration</li>
      <li class="bulletList">Comprehensive reconnaissance of applications, especially recon-ng</li>
      <li class="bulletList">Enumeration of internal hosts using DHCP</li>
      <li class="bulletList">Enumerating services within the SaaS applications</li>
      <li class="bulletList">Useful Microsoft Windows commands during penetration testing</li>
      <li class="bulletList">Taking advantage of default configurations</li>
      <li class="bulletList">Enumeration of users using SNMP, SMB, and rpcclient</li>
    </ul>
    <h1 id="_idParaDest-80" class="heading-1">Stealth scanning techniques</h1>
    <p class="normal">The greatest risk of active reconnaissance is discovery by a target. Using the tester’s time and data stamps, the source IP address, and additional information, the target can identify the source <a id="_idIndexMarker306"/>of the incoming reconnaissance. </p>
    <p class="normal">Therefore, stealth techniques are employed to minimize the chances of detection. When employing stealth to support reconnaissance, a tester mimicking the actions of a hacker will do the following:</p>
    <ul>
      <li class="bulletList">Camouflage tool signatures to avoid detection and thereby trigger an alarm</li>
      <li class="bulletList">Hide the attack within legitimate traffic</li>
      <li class="bulletList">Modify the attack to hide the source and type of traffic</li>
      <li class="bulletList">Make the attack invisible using non-standard traffic types or encryption</li>
    </ul>
    <p class="normal">Stealth scanning techniques can include some or all of the following:</p>
    <ul>
      <li class="bulletList">Adjusting source IP stack and tool identification settings</li>
      <li class="bulletList">Modifying packet parameters (Nmap)</li>
      <li class="bulletList">Using proxies with anonymity networks (ProxyChains and the Tor network)</li>
    </ul>
    <h2 id="_idParaDest-81" class="heading-2">Adjusting source IP stack and tool identification settings</h2>
    <p class="normal">Before the penetration tester (or the attacker) begins testing, we must ensure that all unnecessary services <a id="_idIndexMarker307"/>on Kali are disabled <a id="_idIndexMarker308"/>or turned off. This is to prevent detection. Say that the local DHCP daemon is enabled but is not required. It is possible for the DHCP to interact with the target system, which could then be logged and send alarms to the target’s administrators. Other services that require updating might establish network communication to the licensing server or bug reporting services, so it is better to disable all those services that are not required during the course of testing and enable only what is required to perform a given task.</p>
    <p class="normal">Some commercial and open-source tools (for example, the Metasploit framework) tag their packets with an identifying sequence. Although this can be useful in a post-test analysis of a system’s event logs (where events initiated by a particular testing tool can be directly compared to a system’s event logs to determine how the network detected and responded to the attack), it can also trigger certain intrusion detection systems. Test your tools against a lab system to determine the packets that are tagged, and either change the tag or use the tool with caution.</p>
    <p class="normal">The easiest way to identify tagging is to apply the tool against a newly created virtual image as the target, and review system logs for the tool’s name. In addition, use Wireshark to <a id="_idIndexMarker309"/>capture traffic between the attacker and target virtual machines, and then search the <strong class="keyWord">packet capture</strong> (<strong class="keyWord">pcap</strong>) files for any keywords that can be attributed to the testing tool (name of the tool, vendor, license number, and so on).</p>
    <p class="normal"><code class="inlineCode">useragent</code> in the Metasploit framework can be changed by modifying the <code class="inlineCode">http_form_field</code> option. From the <code class="inlineCode">msfconsole</code> prompt, select the option to use <code class="inlineCode">auxiliary/fuzzers/http/http_form_field</code> and then set a new <code class="inlineCode">useragent</code> header, as shown in <em class="italic">Figure 3.2</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_02.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.2: Changing the User agent in the Metasploit auxiliary</p>
    <p class="normal">In this example, <code class="inlineCode">useragent</code> was set to be Google’s indexing spider, <code class="inlineCode">Googlebot-Image</code>. This is a <a id="_idIndexMarker310"/>common automated <a id="_idIndexMarker311"/>application that visits and indexes websites, and rarely attracts attention from the website’s owner.</p>
    <div class="note">
      <p class="normal">Pentesters can <a id="_idIndexMarker312"/>also choose to use plugins such as Firefox’s user agent switcher: <a href="https://addons.mozilla.org/en-GB/firefox/addon/uaswitcher/"><span class="url">https://addons.mozilla.org/en-GB/firefox/addon/uaswitcher/</span></a></p>
      <p class="normal">Another <a id="_idIndexMarker313"/>alternative is Chrome’s user agent switcher: </p>
      <p class="normal"><a href="https://chrome.google.com/webstore/detail/user-agent-switcher-for-c/djflhoibgkdhkhhcedjiklpkjnoahfmg"><span class="url">https://chrome.google.com/webstore/detail/user-agent-switcher-for-c/djflhoibgkdhkhhcedjiklpkjnoahfmg</span></a></p>
      <p class="normal">To identify <a id="_idIndexMarker314"/>legitimate <code class="inlineCode">useragent</code> headers, refer to the examples at:</p>
      <p class="normal"><a href="http://www.useragentstring.com/"><span class="url">http://www.useragentstring.com/</span></a></p>
    </div>
    <h2 id="_idParaDest-82" class="heading-2">Modifying packet parameters</h2>
    <p class="normal">The most common approach to active reconnaissance is to conduct a scan against the target, send <a id="_idIndexMarker315"/>defined packets to it, and <a id="_idIndexMarker316"/>then use the returned packets to gain information. The most popular tool of this type is <strong class="keyWord">Network Mapper</strong> (<strong class="keyWord">Nmap</strong>). To use Nmap effectively, it must be run with root-level privileges. This is typical of applications that manipulate packets, hence we will be using <code class="inlineCode">sudo</code> for all Nmap queries.</p>
    <p class="normal">When attempting to minimize detection, some stealth techniques include the following:</p>
    <ul>
      <li class="bulletList">Attackers approach the target with a goal in mind and send the minimum number of packets needed to determine the objective. For example, if you wish to confirm the presence of a web host, you first need to determine whether port <code class="inlineCode">80</code> or <code class="inlineCode">443</code>, the default ports for web-based services, are open.</li>
      <li class="bulletList">Avoid scans that <a id="_idIndexMarker317"/>may connect with the target system <a id="_idIndexMarker318"/>and leak data. Do not ping the target or use <strong class="keyWord">synchronize</strong> (<strong class="keyWord">SYN</strong>) and <a id="_idIndexMarker319"/>non-conventional <a id="_idIndexMarker320"/>packet scans, such as <strong class="keyWord">acknowledge</strong> (<strong class="keyWord">ACK</strong>), <strong class="keyWord">finished</strong> (<strong class="keyWord">FIN</strong>), and <strong class="keyWord">reset</strong> (<strong class="keyWord">RST</strong>).</li>
      <li class="bulletList">Randomize or spoof packet settings, such as the source IP and port address, and the MAC address.</li>
      <li class="bulletList">Adjust the timing to slow the arrival of packets at the target site.</li>
      <li class="bulletList">Change the packet size by fragmenting packets or appending random data to confuse packet inspection devices.</li>
    </ul>
    <p class="normal">As an example, if you want to conduct a stealthy scan and minimize detection, the following <code class="inlineCode">nmap</code> command could be used:</p>
    <pre class="programlisting con"><code class="hljs-con"># nmap --spoof-mac Cisco --data-length 24 -T paranoid --max-hostgroup 1 --max-parallelism 10 -Pn 10.10.10.100/24 -v -n -sS -sV -oA output -p T:1-1024 --randomize-hosts
</code></pre>
    <p class="normal"><em class="italic">Table 3.1</em> details the previous command in detail:</p>
    <table id="table001-2" class="table-container">
      <thead>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Command</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Rationale</strong></p>
          </td>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="table-cell">
            <figure class="mediaobject"><code class="inlineCode">--spoof-mac-Cisco</code></figure>
          </td>
          <td class="table-cell">
            <p class="normal">This spoofs the MAC address to match a Cisco product. Replacing Cisco with 0 will create a completely random MAC address.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <figure class="mediaobject"><code class="inlineCode">--data-length 24</code></figure>
          </td>
          <td class="table-cell">
            <p class="normal">This appends 24 random bytes to most packets that are sent.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <figure class="mediaobject"><code class="inlineCode">-T paranoid</code></figure>
          </td>
          <td class="table-cell">
            <p class="normal">This sets the time to the slowest setting: paranoid.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <figure class="mediaobject"><code class="inlineCode">--max-hostgroup</code></figure>
          </td>
          <td class="table-cell">
            <p class="normal">Limits the hosts that are scanned at any one time.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <figure class="mediaobject"><code class="inlineCode">--max-parallelism</code></figure>
          </td>
          <td class="table-cell">
            <p class="normal">Limits the number of outstanding probes that are sent out. You can also use the <code class="inlineCode">--scan-delay</code> option to set a pause between the probes; however, this option is not compatible with the <code class="inlineCode">--max_parallelism</code> option.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <figure class="mediaobject"><code class="inlineCode">-Pn</code></figure>
          </td>
          <td class="table-cell">
            <p class="normal">This does not send a ping to identify active systems (as this can leak data).</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <figure class="mediaobject"><code class="inlineCode">-n</code></figure>
          </td>
          <td class="table-cell">
            <p class="normal">No DNS resolution: internal or external DNS servers are not actively queried by Nmap for DNS information. Such queries are frequently logged, so the query function should be disabled.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <figure class="mediaobject"><code class="inlineCode">-sS</code></figure>
          </td>
          <td class="table-cell">
            <p class="normal">This conducts a stealth TCP SYN scan, which does not complete the TCP handshake. Other scan types (for example, null scans) can also be used; however, most of these will trigger detection devices.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <figure class="mediaobject"><code class="inlineCode">-sV</code></figure>
          </td>
          <td class="table-cell">
            <p class="normal">This enables version detection.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <figure class="mediaobject"><code class="inlineCode">-oA </code></figure>
          </td>
          <td class="table-cell">
            <p class="normal">This outputs the results to all formats (XML, gnmap, and nmap).</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <figure class="mediaobject"><code class="inlineCode">-p T:1-1024</code></figure>
          </td>
          <td class="table-cell">
            <p class="normal">This specifies the TCP ports to be scanned.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <figure class="mediaobject"><code class="inlineCode">--random-hosts</code></figure>
          </td>
          <td class="table-cell">
            <p class="normal">This randomizes the target host order.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 3.1: Breakdown of the previous Nmap command</p>
    <p class="normal">Together, these options will create a very slow scan that hides the true identity of the source. However, if the packets are too unusual, complex modification may actually attract the attention of the target; therefore, many testers and attackers use anonymity networks to minimize detection.</p>
    <p class="normal">Attackers can also utilize the decoy or zombie method by running the following commands: <code class="inlineCode">-D</code> is the switch, and the decoy can be any IP address; <code class="inlineCode">RND:10</code> is any set of 10 random <a id="_idIndexMarker321"/>IP addresses that purport to be the source of the attack. When we use the <code class="inlineCode">–sI</code> switch in Nmap, the target should receive the alerts from a zombie IP on the target:</p>
    <pre class="programlisting con"><code class="hljs-con">nmap -n –D Decoy1,decoy2,decoy3 targetIP 
nmap –D RND:10 targetIP
nmap -sI [Zombie IP] [Target IP]
</code></pre>
    <h2 id="_idParaDest-83" class="heading-2">Using proxies with anonymity networks</h2>
    <p class="normal">In this section, we <a id="_idIndexMarker322"/>will be exploring the two important tools that are utilized by attackers to maintain anonymity on the network. We will be focusing on Tor and Privoxy in this section.</p>
    <p class="normal">Tor (<a href="http://www.torproject.org"><span class="url">www.torproject.org</span></a>) is an open source implementation of the third-generation onion routing that provides free <a id="_idIndexMarker323"/>access to an anonymous proxy network. Onion routing enables online anonymity by encrypting user traffic and then transmitting it through a series of onion routers. At each router, a layer of encryption is removed to obtain routing information, and the message is then transmitted to the next node. It has been likened to the process of gradually peeling an onion, hence the name. It protects against traffic analysis attacks by guarding the source and destination of a user’s IP traffic.</p>
    <p class="normal">In this example, Tor will be used with Privoxy, a noncaching web proxy that sits in the middle of an application that communicates with the internet and uses advanced filtering to ensure privacy and the removal of adverts, along with any potentially hostile data being sent to the tester.</p>
    <p class="normal">To install Tor, perform the following steps:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Issue the <code class="inlineCode">apt-get update</code> and <code class="inlineCode">apt-get upgrade</code> commands, and then use the following command:
        <pre class="programlisting con"><code class="hljs-con">sudo apt install tor
</code></pre>
      </li>
      <li class="numberedList">Once Tor is installed, edit the <code class="inlineCode">proxychains4.conf</code> file located in the <code class="inlineCode">/etc</code> directory. This file dictates the number and order of proxies that the test system will use on the way to the Tor network. Proxy servers may be down, or they <a id="_idIndexMarker324"/>may be experiencing a heavy load (causing slow or latent connections); if this occurs, a defined or strict ProxyChain will fail due to an expected link being missing. Therefore, disable the use of <code class="inlineCode">strict_chain</code> and enable <code class="inlineCode">dynamic_chain</code>, which ensures that the connection will be routed, as shown in <em class="italic">Figure 3.3</em>:<figure class="mediaobject"><img src="../Images/B17765_03_03.png" alt=""/></figure>
        <p class="packt_figref">Figure 3.3: Enabling the dynamic chain in Proxychains4.conf</p>
      </li>
      <li class="numberedList">Edit the <code class="inlineCode">[ProxyList]</code> section to ensure that the <code class="inlineCode">socks5</code> proxy is present, as shown in <em class="italic">Figure 3.4</em>:<figure class="mediaobject"><img src="../Images/B17765_03_04.png" alt=""/></figure>
        <p class="packt_figref">Figure 3.4: Adding the proxy list to the proxychains4.conf</p>
        <p class="normal">Open proxies can easily be found online (an example would be <a href="https://www.proxynova.com/proxy-server-list/"><span class="url">https://www.proxynova.com/proxy-server-list/</span></a>) and added to the <code class="inlineCode">proxychains.conf</code> file. Testers can take advantage of this to further obfuscate their identity. For example, if there are reports that a certain country <a id="_idIndexMarker325"/>or block of IP addresses has been responsible for recent online attacks, look for open proxies from that location and add them to your list or a separate configuration file.</p>
      </li>
      <li class="numberedList">To start the Tor service from a terminal window, enter the following command:
        <pre class="programlisting con"><code class="hljs-con"># sudo service tor start
</code></pre>
      </li>
      <li class="numberedList">Verify that Tor has started by using the following command:
        <pre class="programlisting con"><code class="hljs-con"># sudo service tor status
</code></pre>
        <p class="normal">It is important to verify that the Tor network is working and providing anonymous connectivity.</p>
      </li>
      <li class="numberedList">Verify your source IP address first. From a terminal, enter the following command:
        <pre class="programlisting con"><code class="hljs-con"># firefox www.whatismyip.com
</code></pre>
        <p class="normal">This will start the Iceweasel browser and open it to a site that provides the source IP address connected with that web page.</p>
      </li>
      <li class="numberedList">Note the IP address, and then invoke Tor routing using the following ProxyChains command:
        <pre class="programlisting con"><code class="hljs-con"># proxychains firefox www.whatismyip.com
</code></pre>
        <p class="normal">In this <a id="_idIndexMarker326"/>particular instance, the IP address was identified as <code class="inlineCode">xx.xx.xx.xx</code>. A <code class="inlineCode">whois</code> lookup of that IP address from a terminal window indicates that the transmission is now exiting from a Tor exit node, as shown in <em class="italic">Figure 3.5</em>:</p>
        <figure class="mediaobject"><img src="../Images/B17765_03_05.png" alt=""/></figure>
        <p class="packt_figref">Figure 3.5: whois details of your randomly assigned IP address</p>
      </li>
    </ol>
    <div class="note">
      <p class="normal">You can also verify that Tor is functioning properly by accessing</p>
      <p class="normal"><a href="https://check.torproject.org"><span class="url">htt</span><span class="url">ps://check.torproject.org</span></a>.</p>
    </div>
    <p class="normal">Although communications are now protected using the Tor network, it is possible for a DNS leak to occur, which occurs when your system makes a DNS request to provide your identity to an ISP. You can <a id="_idIndexMarker327"/>check for DNS leaks at <a href="http://www.dnsleaktest.com"><span class="url">www.dnsleaktest.com</span></a>.</p>
    <p class="normal">Most command lines can be run from the console using <code class="inlineCode">proxychains</code> to access the Tor network. When using Tor, some considerations to be kept in mind are as follows:</p>
    <ul>
      <li class="bulletList">Tor provides an anonymizing service, but it does not guarantee privacy. Owners of the exit nodes are able to sniff traffic and may be able to access user credentials.</li>
      <li class="bulletList">Vulnerabilities in the Tor browser bundle have reportedly been used by law enforcement to <a id="_idIndexMarker328"/>exploit systems and acquire user information.</li>
      <li class="bulletList">ProxyChains do not handle <strong class="keyWord">User Datagram Protocol </strong>(<strong class="keyWord">UDP</strong>) traffic.</li>
      <li class="bulletList">Some applications and services cannot run over this environment—in particular, Metasploit and Nmap may break. The stealth SYN scan of Nmap breaks <a id="_idIndexMarker329"/>out of ProxyChains and the connect scan is invoked instead; this can leak information to the target.</li>
      <li class="bulletList">Some browser applications (Flash/ActiveX or HTML5) can be used to obtain your IP address.</li>
      <li class="bulletList">Attackers can also use random chaining. With this option, ProxyChains will randomly choose IP addresses from our list (local Ethernet IP, for example, <code class="inlineCode">127.0.0.1</code>, <code class="inlineCode">192.168.x.x</code> or <code class="inlineCode">172.16.x.x</code>) and use them to create our ProxyChain. This means that each time we use ProxyChains, the chain of proxies will look different to the target, making it harder to track our traffic from its source.</li>
      <li class="bulletList">To do so, in a similar fashion, edit the <code class="inlineCode">/etc/proxychains4.conf</code> file and comment out <code class="inlineCode">dynamic chains</code> and uncomment <code class="inlineCode">random_chain</code>, since we can only use one of these options at a time.</li>
      <li class="bulletList">In addition, attackers can uncomment the line with <code class="inlineCode">chain_len</code>, which will then determine the number of IP address in the chain while creating a random proxy chain.</li>
    </ul>
    <p class="normal">This technique can be engaged by attackers to establish a qualified anonymity and then remain anonymous over the network.</p>
    <h1 id="_idParaDest-84" class="heading-1">DNS reconnaissance and route mapping</h1>
    <p class="normal">Once a tester has identified the targets that have an online presence and contain items of interest, the <a id="_idIndexMarker330"/>next step is to identify the IP addresses and routes to <a id="_idIndexMarker331"/>the target. DNS reconnaissance is concerned with identifying who owns a particular domain or series of IP addresses (the sort of information gained with <code class="inlineCode">whois</code>, although this has been completely changed with the <strong class="keyWord">General Data Protection Regulation</strong> (<strong class="keyWord">GDPR</strong>) enforcement across Europe from May 2018). The DNS information <a id="_idIndexMarker332"/>defines the actual domain names and IP addresses assigned to the target, and the route between the penetration tester—or the attacker—and the final target.</p>
    <p class="normal">This information gathering is semi-active, as some of the information is available from freely available open sources such as <a href="http://dnsdumpster.com"><span class="url">dnsdumpster.com</span></a>, while other information is available from third <a id="_idIndexMarker333"/>parties such as DNS registrars. Although the registrar may collect IP <a id="_idIndexMarker334"/>addresses and data concerning requests made by the attacker, it is rarely provided to the end target. The information that could be directly monitored by the target, such as DNS server logs, is seldom reviewed or retained.</p>
    <p class="normal">Because the information needed can be queried using a defined systematic and methodical approach, its collection can be automated.</p>
    <div class="packt_tip">
      <p class="normal">Note that DNS information may contain stale or incorrect entries. To minimize inaccurate information, query different source servers and use different tools to cross-validate results. Review results and manually verify any suspect findings. </p>
    </div>
    <h2 id="_idParaDest-85" class="heading-2">The whois command (post GDPR)</h2>
    <p class="normal">The <code class="inlineCode">whois</code> command used to be the first step in identifying an IP address for many years until GDPR came into force. Formerly, the <code class="inlineCode">whois</code> command was used to query databases that store information <a id="_idIndexMarker335"/>on the registered users of an internet resource, such as a domain name or IP address. Depending on the database that is queried, the response to a <code class="inlineCode">whois</code> request will provide names, physical addresses, phone numbers, and email addresses (useful in facilitating social engineering attacks), as well as IP addresses and DNS server names. After May 25, 2018, there are no registrant details provided; however, attackers can understand which <code class="inlineCode">whois</code> server responds, and it retrieves domain data that includes availability, ownership, creation, expiration details, and name servers. <em class="italic">Figure 3.6</em> shows the <code class="inlineCode">whois</code> command run against the domain of <code class="inlineCode">facebook.com</code>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_06.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.6: whois details on the facebook.com domain that includes Name Server details</p>
    <h1 id="_idParaDest-86" class="heading-1">Employing comprehensive reconnaissance applications</h1>
    <p class="normal">Although Kali contains multiple tools to facilitate reconnaissance, many of the tools contain features <a id="_idIndexMarker336"/>that overlap, and importing data from one tool into another is usually a complex manual process. Most testers select a subset of tools and invoke them with a script.</p>
    <p class="normal">Comprehensive tools focused on reconnaissance were originally command-line tools with a <a id="_idIndexMarker337"/>defined set of functions; one of the most commonly used was the <strong class="keyWord">Deep Magic Information Gathering Tool</strong> (<strong class="keyWord">DMitry</strong>). DMitry could <a id="_idIndexMarker338"/>perform <code class="inlineCode">whois</code> lookups, retrieve <a href="http://netcraft.com"><span class="url">netcraft.com</span></a> information, search for sub-domains and email addresses, and perform TCP scans. Unfortunately, it wasn’t extensible beyond these functions.</p>
    <p class="normal"><em class="italic">Figure 3.7</em> provides details <a id="_idIndexMarker339"/>on running DMitry on <a href="http://www.cyberhia.com"><span class="url">www.cyberhia.com</span></a>. The following command can be used to enumerate the reverse DNS to IP lookup, Whois, subdomain, email address, and open port details:</p>
    <pre class="programlisting con"><code class="hljs-con">sudo dmitry -winsepo out.txt www.cyberhia.com
</code></pre>
    <figure class="mediaobject"><img src="../Images/B17765_03_07.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.7: Running DMitry to extract domain and whois information</p>
    <div class="note">
      <p class="normal">Note that some information produced here might belong to a hosting company that provides DNS <a id="_idIndexMarker340"/>protection. An example is if our target is hosting the name servers from Cloudflare or AWS <strong class="keyWord">Content Delivery Network </strong>(<strong class="keyWord">CDN</strong>).</p>
    </div>
    <p class="normal">Recent advances <a id="_idIndexMarker341"/>have created comprehensive framework applications that combine passive and active reconnaissance. In the following section, we will be looking more at recon-ng.</p>
    <h2 id="_idParaDest-87" class="heading-2">The recon-ng framework</h2>
    <p class="normal">The recon-ng framework is an open-source framework for conducting reconnaissance (passive and active) that has <a id="_idIndexMarker342"/>recently added a complete new marketplace for <a id="_idIndexMarker343"/>plugins. The framework is similar to Metasploit and the <strong class="keyWord">Social Engineer Toolkit</strong> (<strong class="keyWord">SET</strong>); recon-ng uses a very modular framework. Each module is a customized command interpreter, preconfigured to perform a specific task.</p>
    <p class="normal">The recon-ng framework and its modules are written in Python, allowing penetration testers to easily build or alter modules to facilitate testing. The recon-ng tool also leverages third-party APIs to conduct some assessments; this additional flexibility means that some activities undertaken by recon-ng may be tracked by those parties. Users can specify a custom <code class="inlineCode">useragent</code> string or proxy requests to minimize alerting the target network.</p>
    <p class="normal">recon-ng is installed by default in newer versions of Kali. All data collected by recon-ng is placed in a database, allowing you to create various reports against the stored data. The user can select one of the report modules to automatically create either a CVS report or an HTML report.</p>
    <p class="normal">To start the application, enter <code class="inlineCode">recon-ng</code> at the prompt; to view the available modules, type <code class="inlineCode">marketplace search</code> at the <code class="inlineCode">recon-ng&gt;</code> prompt, as shown in <em class="italic">Figure 3.8</em>: </p>
    <figure class="mediaobject"><img src="../Images/B17765_03_08.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.8: Marketplace search in recon-ng for all available modules</p>
    <p class="normal">To install any module, we will simply run <code class="inlineCode">marketplace install modulename</code>, and to load a specific <a id="_idIndexMarker344"/>module, type <code class="inlineCode">modules load</code> followed by the name of the module. Pressing the <em class="italic">Tab</em> key while typing will autocomplete the command. If the module has a unique name, you can type in the unique part of the name, and the module will be loaded without entering the full path.</p>
    <p class="normal">Entering <code class="inlineCode">info</code> will provide you with information on how the module works and where to obtain API keys if required. Once the module is loaded, use the <code class="inlineCode">options set</code> command to set the options, and then enter <code class="inlineCode">run</code> to execute, as shown in <em class="italic">Figure 3.9</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_09.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.9: Loading the hackertarget module and setting the source as www.packtpub.com </p>
    <p class="normal">In general, testers rely on recon-ng to do the following:</p>
    <ul>
      <li class="bulletList">Harvest hosts and contacts using multiple sources, such as haveibeenpwned, mangle, mailtester, censys, and shodan.</li>
      <li class="bulletList">Identify <a id="_idIndexMarker345"/>geographical locations of hosts and individuals using Flickr, Shodan, geocode, YouTube, and Twitter.</li>
      <li class="bulletList">Identify host information using <code class="inlineCode">netcraft</code> and related modules.</li>
      <li class="bulletList">Identify account and password information that has previously been compromised and leaked onto the internet (the <code class="inlineCode">pwnedlist</code> modules within the domains-credentials – <code class="inlineCode">domain_ispwned</code>, <code class="inlineCode">account_creds, domain_creds,</code> <code class="inlineCode">leak_lookup</code>, and <code class="inlineCode">leaks_dump</code>).</li>
    </ul>
    <h3 id="_idParaDest-88" class="heading-3">IPv4</h3>
    <p class="normal">The <strong class="keyWord">Internet Protocol</strong> (<strong class="keyWord">IP</strong>) address is a <a id="_idIndexMarker346"/>unique number used to identify devices that are connected to a private <a id="_idIndexMarker347"/>network or the public internet. Today, the internet is largely based on version 4, known as IPv4. Kali includes several tools to facilitate DNS reconnaissance, as given in <em class="italic">Table 3.2</em>:</p>
    <table id="table002-1" class="table-container">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Application</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">dnsenum</code>, <code class="inlineCode">dnsmap</code>, and <code class="inlineCode">dnsrecon</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">These are comprehensive DNS scanners—DNS record enumeration (A, MX, TXT, SOA, wildcard, and so on), subdomain brute-force attacks, Google lookup, reverse lookup, zone transfer, and zone walking. dsnrecon is usually the first choice—it is highly reliable, results are well parsed, and data can be directly imported into the Metasploit framework.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">dnswalk</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This DNS debugger checks specified domains for internal consistency and accuracy (this is not installed by default in the newer versions of Kali; hence, you have to run apt-get install dnswalk).</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">fierce</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This locates non-contiguous IP space and hostnames against specified domains by attempting zone transfers and then attempting brute-force attacks to gain DNS information.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 3.2: Tools in Kali to facilitate DNS reconnaissance</p>
    <p class="normal">During testing, most investigators run <code class="inlineCode">fierce</code> to confirm that all possible targets have been identified, and then run at least two comprehensive tools (for example, <code class="inlineCode">dnsenum</code> and <code class="inlineCode">dnsrecon</code>) to generate the maximum amount of data and provide a degree of cross-validation.</p>
    <p class="normal">In <em class="italic">Figure 3.10</em>, <code class="inlineCode">dnsrecon</code> has been used to generate a standard DNS record search, and a search that is specific for SRV records. An excerpt of the results is shown for each case:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_10.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.10: Running the dnsrecon tool on www.packtpub.com</p>
    <p class="normal"><code class="inlineCode">dnsrecon</code> allows the <a id="_idIndexMarker348"/>penetration tester to obtain the SOA <a id="_idIndexMarker349"/>record, <strong class="keyWord">Name Servers</strong> (<strong class="keyWord">NS</strong>), <strong class="keyWord">mail exchanger</strong> (<strong class="keyWord">MX</strong>) hosts, servers <a id="_idIndexMarker350"/>sending emails using <strong class="keyWord">Sender Policy Framework</strong> (<strong class="keyWord">SPF</strong>), and <a id="_idIndexMarker351"/>the IP address ranges in use.</p>
    <h3 id="_idParaDest-89" class="heading-3">IPv6</h3>
    <p class="normal">Although IPv4 seems to permit a large address space, freely available IP addresses were exhausted several <a id="_idIndexMarker352"/>years ago, forcing the employment of NAT to increase the number of available addresses. A more permanent solution has been found in the adoption of an improved IP addressing scheme, IPv6. Although it constitutes less than five percent of internet addresses, its usage is increasing, and penetration testers must be prepared to address the differences between IPv4 and IPv6.</p>
    <p class="normal">In IPv6, the source and destination addresses are 128-bits in length, yielding 2,128 possible addresses—that is 340 undecillion addresses!</p>
    <p class="normal">The increased size of the addressable address space presents some problems to penetration testers, particularly when using scanners that step through the available address space looking for live servers. However, some features of the IPv6 protocol have simplified discovery, especially the use of ICMPv6 to identify active link-local addresses.</p>
    <p class="normal">It is important to consider IPv6 when conducting initial scans for the following reasons:</p>
    <ul>
      <li class="bulletList">There is uneven support for IPv6 functionality in testing tools, so the tester must ensure that each tool is validated to determine its performance and accuracy <a id="_idIndexMarker353"/>in IPv4, IPv6, and mixed networks.</li>
      <li class="bulletList">Because IPv6 is a relatively new protocol, the target network may contain misconfigurations that leak important data; the tester must be prepared to recognize and use this information.</li>
      <li class="bulletList">Older network controls (firewalls, IDS, and IPS) may not detect IPv6. In such cases, penetration testers can use IPv6 tunnels to maintain covert communications with the network and exfiltrate the undetected data.</li>
    </ul>
    <h2 id="_idParaDest-90" class="heading-2">Using IPv6-specific tools</h2>
    <p class="normal">Kali includes several tools developed to take advantage of IPv6 (most comprehensive scanners, such <a id="_idIndexMarker354"/>as Nmap, now support IPv6), some of which are <a id="_idIndexMarker355"/>detailed here. Tools that are particular to IPv6 were largely derived from the <strong class="keyWord">THC-IPv6 Attack Toolkit</strong>. This tool can be installed by running the following:</p>
    <pre class="programlisting con"><code class="hljs-con">sudo apt install thc-ipv6
</code></pre>
    <p class="normal"><em class="italic">Table 3.3</em> provides a list of tools that are utilized for the reconnaissance of IPv6:</p>
    <table id="table003" class="table-container">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Application</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">atk6-dnsdict6</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Enumerates sub-domains to obtain IPv4 and IPv6 addresses (if present) using a brute-force search based on a supplied dictionary file or its own internal list</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">atk6-dnsrevenum6</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Performs reverse DNS enumeration given an IPv6 address</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">atk6-covert_send6</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Sends the content of a file covertly to the target</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">atk6-covert_send6d</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Writes covertly received content to a file</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">atk6-denial6</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Performs various denial-of-service attacks on a target</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">atk6-detect-new-ip6</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Detects new IPv6 addresses joining the local network</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">atk6-detect_sniffer6</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Tests whether systems on the local LAN are sniffing</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">atk6-exploit6</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Performs exploits of various CVE-known IPv6 vulnerabilities on the destination</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">atk6-fake_dhcps6</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Fake DHCPv6 server</p>
          </td>
        </tr>
      </tbody>
    </table>
    <figure class="mediaobject">Table 3.3: Tools used in Kali to assess IPv6</figure>
    <p class="normal">Metasploit can <a id="_idIndexMarker356"/>also be utilized for IPv6 host discovery. The <code class="inlineCode">auxiliary/scanner/discovery/ipv6_multicast_ping</code> module will discover all of the IPv6-enabled machines with the physical (MAC) address, as shown in <em class="italic">Figure 3.11</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_11.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.11: Discovery of IPv6 devices on the network using the Metasploit ipv6 scanner</p>
    <p class="normal">The <code class="inlineCode">sudo atk6-alive6</code> IPv6 suite <a id="_idIndexMarker357"/>will discover live addresses in the same segment, as shown in <em class="italic">Figure 3.12</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_12.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.12: Discovery of IPv6 live devices on the network using atk6-alive6</p>
    <h2 id="_idParaDest-91" class="heading-2">Mapping the route to the target</h2>
    <p class="normal">Route mapping was originally used as a diagnostic tool that allows you to view the route that an IP packet <a id="_idIndexMarker358"/>follows, from one host to the next. </p>
    <p class="normal">Using the <strong class="keyWord">Time To Live</strong> (<strong class="keyWord">TTL</strong>) field in <a id="_idIndexMarker359"/>an IP packet, each hop from one point to the next elicits an <code class="inlineCode">ICMPTIME_EXCEEDED</code> message from the receiving router, decrementing the value in the <code class="inlineCode">TTL</code> field by <code class="inlineCode">1</code>. </p>
    <p class="normal">The packets count the number of hops and the route taken. From an attacker’s or penetration tester’s perspective, the <code class="inlineCode">traceroute</code> data yields the following important data:</p>
    <ul>
      <li class="bulletList">The exact path between the attacker and the target</li>
      <li class="bulletList">Hints pertaining to the network’s external topology</li>
      <li class="bulletList">Identification of accessing control devices (firewalls and packet-filtering routers) that may be filtering attack traffic</li>
      <li class="bulletList">If the network is misconfigured, it may be possible to identify internal addressing</li>
    </ul>
    <div class="packt_tip">
      <p class="normal">Using a web-based traceroute (<a href="http://www.traceroute.org"><span class="url">www.traceroute.org</span></a>), it is possible to trace various geographic <a id="_idIndexMarker360"/>origin sites to the target network. These types of scans will frequently identify more than one different network connecting to the target, which is information that could be missed by conducting only a single traceroute command from a location close to the target. Web-based traceroute may also identify multi-homed hosts that connect two or more networks. These hosts are an important target for attackers because they drastically increase the attack surface leading to the target.</p>
    </div>
    <p class="normal">In Kali, <code class="inlineCode">traceroute</code> is a command-line program that uses ICMP packets to map the route; in Windows, the program is <code class="inlineCode">tracert</code>.</p>
    <p class="normal">If you launch <code class="inlineCode">traceroute</code> from Kali, you will likely see most hops filtered (the data is shown as: <code class="inlineCode">* * *</code>). For example, <code class="inlineCode">traceroute</code> from the author’s present location to <a href="http://www.packtpub.com"><span class="url">www.packtpub.com</span></a> would yield the output shown in <em class="italic">Figure 3.13</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_13.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.13: Traceroute on www.packtpub.com</p>
    <p class="normal">If the same <a id="_idIndexMarker361"/>request was run using <code class="inlineCode">tracert</code> from the Windows command line, however, we would see the output shown in <em class="italic">Figure 3.14</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_14.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.14: Traceroute to www.packtpub.com using Windows tracert utility</p>
    <p class="normal">Not only do we get the complete path, but we can also see that <a href="http://www.google.com"><span class="url">www.google.com</span></a> is resolving to a slightly different IP address, indicating that load balancers are in effect (you can confirm this by using Kali’s <code class="inlineCode">lbd</code> script; however, this activity may be logged by the target site).</p>
    <p class="normal">The reason for the different path data is that, by default, <code class="inlineCode">traceroute</code> uses UDP datagrams, while Windows <code class="inlineCode">tracert</code> utility uses ICMP echo request (ICMP type 8). Therefore, when completing <code class="inlineCode">traceroute</code> using Kali tools, it is important to use multiple protocols in order to obtain the most complete path, and to bypass packet-filtering devices. Kali provides a set of tools for completing route traces, as detailed in <em class="italic">Table 3.4</em>:</p>
    <table id="table004" class="table-container">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Application</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">hping3</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This is a TCP/IP packet assembler and analyzer. This supports TCP, UDP, ICMP, and raw-IP and uses a ping-like interface.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">intrace</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Newer versions of Kali do not have this tool pre-installed, so testers will have to run apt install intrace in the terminal to obtain it. This tool enables users to enumerate IP hops by exploiting existing TCP connections, both initiated from the local system or network, or from local hosts. This makes it very useful for bypassing external filters such as firewalls. intrace is a replacement for the less reliable 0trace program.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">atk6-trace6</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This is a traceroute program that uses ICMP6.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <figure class="mediaobject">Table 3.4: Kali tools that can be used for the completion of trace routes</figure>
    <p class="normal"><code class="inlineCode">hping3</code> is one of the most useful tools because of the control it gives over the packet type, source packet, and destination packet. For example, Google does not allow ping requests. However, it is possible to ping the server if you send the packet as a TCP SYN request.</p>
    <p class="normal">In the following example, the tester attempts to ping the target domain from the command line. No data <a id="_idIndexMarker362"/>is returned; the target domain is clearly blocking ICMP-based <code class="inlineCode">ping</code> commands. However, the next command invokes <code class="inlineCode">hping3</code>, instructing it to do the following:</p>
    <ul>
      <li class="bulletList">Send a ping-like command to the target domain using TCP with the SYN flag set (<code class="inlineCode">-S</code>)</li>
      <li class="bulletList">Direct the packet to port 80; legitimate requests of this type are rarely blocked (<code class="inlineCode">- p 80</code>)</li>
      <li class="bulletList">Set a count of sending three packets to the target (<code class="inlineCode">-c 3</code>)</li>
    </ul>
    <p class="normal">To execute the previous steps, use the commands shown in <em class="italic">Figure 3.15</em>:</p>
    <figure class="mediaobject"> <img src="../Images/B17765_03_15.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.15: Running hping3 on the target via port 80</p>
    <p class="normal">The <code class="inlineCode">hping3</code> command <a id="_idIndexMarker363"/>successfully identifies that the target is online and provides some basic routing information.</p>
    <h1 id="_idParaDest-92" class="heading-1">Identifying the external network infrastructure</h1>
    <p class="normal">Once the tester’s identity is protected, identifying the devices on the internet-accessible portion of the <a id="_idIndexMarker364"/>network is the next critical step in scanning a network. Attackers and penetration testers use this information to do the following:</p>
    <ul>
      <li class="bulletList">Identify devices that may confuse (load balancers) or eliminate (firewalls and packet inspection devices) test results</li>
      <li class="bulletList">Identify devices with known vulnerabilities</li>
      <li class="bulletList">Identify the requirement for continuing to implement stealthy scans</li>
      <li class="bulletList">Gain an understanding of the target’s focus on secure architecture and security in general</li>
    </ul>
    <p class="normal"><code class="inlineCode">traceroute</code> provides <a id="_idIndexMarker365"/>basic information on packet filtering abilities; some other applications on Kali include the following:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Lbd</strong>: Uses two DNS and <a id="_idIndexMarker366"/>HTTP-based techniques to detect load balancers (shown in <em class="italic">Figure 3.16</em>)</li>
      <li class="bulletList"><strong class="keyWord">Nmap</strong>: Detects devices <a id="_idIndexMarker367"/>and determines the operating systems and version</li>
      <li class="bulletList"><strong class="keyWord">Shodan</strong>: Web-based search <a id="_idIndexMarker368"/>engine that identifies devices connected to the internet, including those with default passwords, known misconfigurations, and vulnerabilities</li>
      <li class="bulletList"><strong class="keyWord">censys.io</strong> and <strong class="keyWord">spyze</strong>: Similar to the Shodan search that has already scanned the entire internet, with <a id="_idIndexMarker369"/>certificate details, technology information, misconfiguration, and <a id="_idIndexMarker370"/>known vulnerabilities.</li>
    </ul>
    <p class="normal"><em class="italic">Figure 3.16</em> shows the results obtained on running the <code class="inlineCode">lbd</code> script against a target domain; as you can see, the target uses both <code class="inlineCode">DNS-Loadbalancing</code> and <code class="inlineCode">HTTP-Loadbalancing</code> on its site. From a penetration tester’s perspective, this information could be used to explain why spurious results are obtained, as the load balancer shifts a particular tool’s activity from one server to another. <em class="italic">Figure 3.16</em> also displays the HTTP load balancing:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_16.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.16: Running lbd to detect the load balancers </p>
    <h1 id="_idParaDest-93" class="heading-1">Mapping beyond the firewall</h1>
    <p class="normal">Attackers normally start network debugging using the <code class="inlineCode">traceroute</code> utility, which attempts to <a id="_idIndexMarker371"/>map all of the hosts on a route to a specific destination host or system. Once the target is reached, the <code class="inlineCode">TTL</code> field will be <code class="inlineCode">0</code>, while the target will discard the datagram and generate an ICMP time exceeded packet back to its originator. A regular <code class="inlineCode">traceroute</code> will be similar to that shown in <em class="italic">Figure 3.17</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_17.png" alt=""/></figure>
    <figure class="mediaobject">Figure 3.17: Running traceroute to identify packet filtering devices</figure>
    <p class="normal">As you see from the preceding example, we cannot go beyond a particular IP, which most probably <a id="_idIndexMarker372"/>means that there is a packet filtering device at hop <code class="inlineCode">3</code>. Attackers would dig a little bit deeper to understand what is deployed on that IP.</p>
    <p class="normal">Deploying the default UDP datagram option will increase the port number every time it sends a UDP datagram. Hence, attackers will start pointing to a port number to reach the final target destination.</p>
    <h1 id="_idParaDest-94" class="heading-1">IDS/IPS identification</h1>
    <p class="normal">Penetration testers can <a id="_idIndexMarker373"/>utilize <code class="inlineCode">nmap</code> and <code class="inlineCode">WAFW00F</code> to identify whether <a id="_idIndexMarker374"/>there are any detection or prevention mechanisms <a id="_idIndexMarker375"/>put in place, such as an <strong class="keyWord">Intrusion Detection System</strong> (<strong class="keyWord">IDS</strong>), <strong class="keyWord">Intrusion Prevention System</strong> (<strong class="keyWord">IPS</strong>), or a <strong class="keyWord">Web Application Firewall</strong> (<strong class="keyWord">WAF</strong>).</p>
    <p class="normal">Another tool that attackers utilize during active reconnaissance is <code class="inlineCode">WAFW00F</code>; this tool is preinstalled in the latest version of Kali Linux. It is used to identify and fingerprint the WAF products. It also provides a list of well-known WAFs. The version of the WAF in use can be extracted by adding the <code class="inlineCode">-l</code> switch to the command (for example, <code class="inlineCode">wafw00f -l</code>). <em class="italic">Figure 3.18</em> shows the exact WAF running behind a web application:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_18.png" alt="Graphical user interface  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 3.18: Running wafw00f to fingerprint a web application firewall</p>
    <h1 id="_idParaDest-95" class="heading-1">Enumerating hosts</h1>
    <p class="normal">Host enumeration is the <a id="_idIndexMarker376"/>process of gaining specific particulars regarding a defined host. It is not enough to know that a server or wireless access point is present; instead, we need to expand the attack surface by identifying open ports, the base <a id="_idIndexMarker377"/>operating system, services that are running, and supporting applications. This is highly intrusive and, unless care is taken, such activity will be detected and logged by the target organization.</p>
    <h2 id="_idParaDest-96" class="heading-2">Live host discovery</h2>
    <p class="normal">The first step is to run network ping sweeps against a target address space and look for responses that indicate <a id="_idIndexMarker378"/>that a particular target is live and capable of responding. Historically, pinging is referred to as the use of ICMP; however, TCP, UDP, ICMP, and ARP traffic can also be used to identify live hosts.</p>
    <p class="normal">Various scanners can be run from remote locations across the internet to identify live hosts. Although the primary scanner is Nmap, Kali provides several other applications that are also useful, as shown in <em class="italic">Table 3.5</em>:</p>
    <table id="table005" class="table-container">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Application</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">atk6-alive6</code> and <code class="inlineCode">atk6-detect-new-ip6</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This is for IPv6 host detection. <code class="inlineCode">Atk6-detect-new-ip6</code> runs on a scripted basis and identifies new IPv6 devices when added.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">dnmap</code> and <code class="inlineCode">nmap</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">nmap</code> is the standard network enumeration tool. <code class="inlineCode">dnmap</code> is a distributed client-server implementation of the Nmap scanner. PBNJ (a suite of tools to monitor changes on a network over time) stores Nmap results in a database and then conducts historical analyses to identify new hosts.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">fping</code>, <code class="inlineCode">hping2</code>, <code class="inlineCode">hping3</code>, and <code class="inlineCode">nping</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">These are packet crafters that respond to targets in various ways to identify live hosts.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 3.5: Tools used to discover live hosts in Kali Linux</p>
    <p class="normal">To the penetration tester or attacker, the data returned from live host discovery will identify the targets for attack.</p>
    <div class="packt_tip">
      <p class="normal">It is good practice to run multiple host discovery scans while conducting a penetration test, as certain devices may be time-dependent. During one penetration test, it was discovered that the system administrator set up a server to play games after regular business hours. Because it was not an approved business system, the administrator didn’t follow the normal process for securing <a id="_idIndexMarker379"/>the server; multiple vulnerable services were present, and it hadn’t received the necessary security patches. Testers were able to compromise this server and gain access to the underlying corporate network using vulnerabilities in the administrator’s server that was used to play games.</p>
    </div>
    <h1 id="_idParaDest-97" class="heading-1">Port, operating system, and service discovery</h1>
    <p class="normal">Kali provides several different tools useful for identifying open ports, operating systems, and installed services on remote hosts. The majority of these functions can be completed using Nmap. Although we will focus on examples using Nmap, the underlying principles apply to the other tools as well.</p>
    <h2 id="_idParaDest-98" class="heading-2">Port scanning</h2>
    <p class="normal">Port scanning is the process of connecting to TCP and UDP ports to determine what services and applications <a id="_idIndexMarker380"/>are running on the target device. In TCP/IP, there are 65,535 ports each for both TCP and UDP on any computer. Some ports are known to be associated with <a id="_idIndexMarker381"/>particular services (for instance, TCP 20 and 21 are the usual ports for the <strong class="keyWord">File Transfer Protocol </strong>(<strong class="keyWord">FTP</strong>) service). </p>
    <p class="normal">The first 1,024 are the well-known ports, and most defined services run over ports in this range; accepted services and ports are maintained by IANA (<a href="http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml"><span class="url">http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml</span></a>).</p>
    <div class="note">
      <p class="normal">Although there are accepted ports for particular services, such as port <code class="inlineCode">80</code> for web-based traffic, services can be directed to use any port. This option is frequently used to hide particular services, especially if the service is known to be vulnerable to attack. However, if attackers complete a port scan and do not find an expected service, or find it using an unusual port, they will be prompted to investigate further.</p>
    </div>
    <p class="normal">The universal port mapping tool, Nmap, relies on active stack fingerprinting. Specially crafted packets are sent to the target system, and the response of the OS to those packets allows Nmap to identify the OS. In order for Nmap to work, at least one listening port must be open, and the operating system must be known and fingerprinted, with a copy of that fingerprint stored in the local database.</p>
    <p class="normal">Using Nmap for port discovery is very noisy; it will be detected and logged by network security devices. Some points to remember are the following:</p>
    <ul>
      <li class="bulletList">Attackers and penetration testers focused on stealth will only test the ports that impact the kill chain they are following to their specific target. If they are launching <a id="_idIndexMarker382"/>an attack that exploits vulnerabilities in a web server, they will search for targets with accessible ports <code class="inlineCode">80</code> and <code class="inlineCode">443</code> or ports <code class="inlineCode">8080</code> and <code class="inlineCode">8443</code>.</li>
      <li class="bulletList">Most port scanners have default lists of ports that are scanned to ensure that you know what is on that list and what has been omitted. Consider both TCP and UDP ports.</li>
      <li class="bulletList">Successful scanning requires a deep knowledge of TCP/IP and related protocols, networking, and how particular tools work. For example, SCTP is an increasingly common protocol on networks, but it is rarely tested on corporate networks.</li>
      <li class="bulletList">Port scanning, even when done slowly, can impact a network. Some older network equipment and equipment from specific vendors will lock when receiving or transmitting a port scan, hence turning a scan into a denial-of-service attack.</li>
      <li class="bulletList">Tools used to scan a port, particularly Nmap, are being extended with regard to functionalities. They can also be used to detect vulnerabilities and exploit simple security holes.</li>
    </ul>
    <h1 id="_idParaDest-99" class="heading-1">Writing your own port scanner using netcat</h1>
    <p class="normal">While attackers utilize the proxying application and Tor network, it is also possible to write their own <a id="_idIndexMarker383"/>custom network port scanner. The following <a id="_idIndexMarker384"/>one-line command can be utilized during penetration testing to identify the list of open ports just by using netcat, as shown in <em class="italic">Figure 3.19</em>:</p>
    <pre class="programlisting con"><code class="hljs-con">while read r; do nc -v -z $r 1-65535; done &lt; iplist
</code></pre>
    <figure class="mediaobject"><img src="../Images/B17765_03_19.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.19: Running a one-line Bash script to do port scanning</p>
    <p class="normal">The same script <a id="_idIndexMarker385"/>can be modified for more targeted <a id="_idIndexMarker386"/>attacks on a single IP, as follows:</p>
    <pre class="programlisting con"><code class="hljs-con">while read r; do nc -v -z target $r; done &lt; ports
</code></pre>
    <p class="normal">The chances of getting alerted in any intrusion detection system using custom port scanners are high compared to other port scanners.</p>
    <h2 id="_idParaDest-100" class="heading-2">Fingerprinting the operating system</h2>
    <p class="normal">Determining the OS of a <a id="_idIndexMarker387"/>remote system is conducted using two types of scans:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Active fingerprinting</strong>: The attacker sends normal and malformed packets to the target and <a id="_idIndexMarker388"/>records its response pattern, referred to as the fingerprint. By comparing the fingerprint to a local database, the operating system can be determined.</li>
      <li class="bulletList"><strong class="keyWord">Passive fingerprinting</strong>: The attacker sniffs—or records—and analyzes the packet stream to <a id="_idIndexMarker389"/>determine the characteristics of the packets.</li>
    </ul>
    <p class="normal">Active fingerprinting is faster and more accurate than passive fingerprinting; in Kali, the primary active tool is Nmap. The Nmap tool injects packets into the target network and analyzes the response that it receives. In <em class="italic">Figure 3.20</em>, the <code class="inlineCode">-O</code> flag commands Nmap to determine the operating system:</p>
    <pre class="programlisting con"><code class="hljs-con">nmap -sS -O target.com
</code></pre>
    <figure class="mediaobject"><img src="../Images/B17765_03_20.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.20: Nmap scan to identify the operating system of the target</p>
    <p class="normal">Note that it is simple for the target system to hide the true operating system. Since fingerprinting <a id="_idIndexMarker390"/>software relies on packet setting, such as time-to-live or the initial window’s size, changes to these values or other user-configurable settings can change the tool results. Some organizations actively change these values to make the final stages of reconnaissance more difficult.</p>
    <h2 id="_idParaDest-101" class="heading-2">Determining active services</h2>
    <p class="normal">The final goal of the enumeration portion of reconnaissance is to identify the services and applications that <a id="_idIndexMarker391"/>are operational on the target system. If possible, the attacker will want to know the service type, vendor, and version to facilitate the identification of any vulnerability. The following are some of the techniques used to determine active services:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Identify default ports and services</strong>: If the remote system is identified as having a Microsoft operating system with port <code class="inlineCode">80</code> open (the WWW service), an attacker may assume that a default installation of Microsoft IIS is installed. Additional testing will be used to verify this assumption (using Nmap).</li>
      <li class="bulletList"><strong class="keyWord">Banner grabbing</strong>: This is done using tools such as amap, netcat, Nmap, and Telnet.</li>
      <li class="bulletList"><strong class="keyWord">Review default web pages</strong>: Some applications install with default administration, error, or other pages. If attackers access these, they will provide guidance on installed applications that may be vulnerable to attack. In <em class="italic">Figure 3.21</em>, the attacker can easily identify the version of Microsoft IIS that has been installed on the target system.</li>
      <li class="bulletList"><strong class="keyWord">Review source code</strong>: Poorly configured web-based applications may respond to certain HTTP requests such as <code class="inlineCode">HEAD</code> or <code class="inlineCode">OPTIONS</code> with a response that includes the web server software version, and, possibly, the base operating <a id="_idIndexMarker392"/>system or the scripting environment in use. In <em class="italic">Figure 3.21</em>, <code class="inlineCode">netcat</code> is launched from the command line and is used to send raw <code class="inlineCode">HEAD</code> packets to a particular website. This request generates a success message (<code class="inlineCode">200 OK</code>); however, it also identifies that the server is running Microsoft IIS 7.5 and powered by ASP.NET:
        <pre class="programlisting con"><code class="hljs-con">nc -vv www.target.com port number and then enter HEAD / HTTP/1.0
</code></pre>
        <figure class="mediaobject"><img src="../Images/B17765_03_21.png" alt=""/></figure>
        <p class="packt_figref">Figure 3.21: Using netcat to grab the banner of a target</p>
      </li>
    </ul>
    <h1 id="_idParaDest-102" class="heading-1">Large-scale scanning</h1>
    <p class="normal">In the case of testing bigger organizations with multiple class B/C IP ranges, large-scale scanning is engaged. For <a id="_idIndexMarker393"/>example, with a global company, often, a number of IP blocks exist as part of external internet facing. As mentioned earlier in <em class="chapterRef">Chapter 2</em>, <em class="italic">Open-Source Intelligence and Passive Reconnaissance</em>, attackers do not have time limitations to scan, but penetration testers do. Pentesters can engage multiple tools to perform the activity; Masscan is one such tool that would be engaged to scan large-scale IP blocks to quickly analyze the live hosts in the target network. Masscan is installed in Kali by default. </p>
    <p class="normal">The biggest advantage of Masscan is the randomization of hosts, ports, speed, flexibility, and compatibility. <em class="italic">Figure 3.22</em> provides a Class C scanning network within a few seconds to complete and identify the available HTTP service on port <code class="inlineCode">80</code> and services running on the target hosts:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_22.png" alt=""/></figure>
    <figure class="mediaobject">Figure 3.22: Running masscan on the class-c IP range to discover TCP open port 80 </figure>
    <h2 id="_idParaDest-103" class="heading-2">DHCP information</h2>
    <p class="normal">The <strong class="keyWord">Dynamic Host Configuration Protocol</strong> (<strong class="keyWord">DHCP</strong>) is a service that dynamically assigns an IP address to the <a id="_idIndexMarker394"/>hosts on the network. This protocol operates at the MAC sub-layer of the Data Link layer of the TCP/IP protocol stack. Upon the selection of auto-configuration, a broadcast query will be sent to the DHCP servers and when a response is received from the DHCP server, a broadcast query is sent by the client to the DHCP server requesting required information. The server will now assign an IP address to the system, along with other configuration parameters such as the subnet mask, DNS, and the default gateway.</p>
    <p class="normal">Sniffing is a great way of collecting passive information once connected to a network. Attackers can start this by running the Wireshark utility and will be able to see a lot of broadcast traffic, as shown in <em class="italic">Figure 3.23</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_23.png" alt=""/></figure>
    <figure class="mediaobject">Figure 3.23: Broadcast network traffic in Wireshark </figure>
    <p class="normal">We will now see <a id="_idIndexMarker395"/>traffic on <strong class="keyWord">DNS</strong>, <strong class="keyWord">NBNS</strong>, <strong class="keyWord">BROWSER</strong>, and other protocols that might <a id="_idIndexMarker396"/>potentially <a id="_idIndexMarker397"/>reveal <a id="_idIndexMarker398"/>hostnames, <strong class="keyWord">VLAN</strong> information, domains, and active subnets in the network. We will be <a id="_idIndexMarker399"/>discussing more attacks specific to sniffing in <em class="chapterRef">Chapter 11</em>, <em class="italic">Action on the Objective and Lateral Movement</em>.</p>
    <h2 id="_idParaDest-104" class="heading-2">Identification and enumeration of internal network hosts</h2>
    <p class="normal">If the attacker’s system is already configured with the DHCP, it will provide some information that <a id="_idIndexMarker400"/>is very useful to map the internal network. The DHCP <a id="_idIndexMarker401"/>information can be obtained by typing <code class="inlineCode">ifconfig</code> in the Kali terminal, as shown in <em class="italic">Figure 3.24</em>; you should be able to see the information detailed:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_24.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.24: Ifconfig details on the Ethernet adapters</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">inet</code>: The IP information obtained by the DHCP server should provide us with at least one active subnet, which can be utilized to identify the list of live systems <a id="_idIndexMarker402"/>and services through <a id="_idIndexMarker403"/>different scanning techniques.</li>
      <li class="bulletList"><code class="inlineCode">netmask</code>: This information can be utilized to calculate the subnet ranges. From the previous screenshot, we have <code class="inlineCode">255.255.255.0</code>, which means <code class="inlineCode">CIDR</code> is <code class="inlineCode">/24</code>, and we can probably expect 255 hosts on the same subnet.</li>
      <li class="bulletList"><strong class="keyWord">Default gateway</strong>: The IP information of the gateway will provide the opportunity to ping other similar gateway IPs. For example, if your default gateway IP is 10.10.10.1, by using ping scans, attackers may be able to enumerate other similar IP addresses, such as 10.10.20.1 and 10.10.20.1.</li>
      <li class="bulletList"><strong class="keyWord">Other IP address</strong>: DNS information can be obtained by accessing the <code class="inlineCode">/etc/resolv.conf</code> file. The <a id="_idIndexMarker404"/>IP addresses in this file <a id="_idIndexMarker405"/>are commonly addressed in all of the subnets, and domain information will also be automatically added during the DHCP process, which will also be available in the same file.</li>
    </ul>
    <h2 id="_idParaDest-105" class="heading-2">Native MS Windows commands</h2>
    <p class="normal"><em class="italic">Table 3.6</em> provides a list of useful commands during a penetration test or Red Team exercise, even <a id="_idIndexMarker406"/>when only having physical access to the system or having a remote shell to communicate to the target. This is not an exhaustive list, however:</p>
    <table id="table006" class="table-container">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Command</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Sample</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">nslookup</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">nslookup</code></p>
            <p class="normal"><code class="inlineCode">Server nameserever.google.com</code></p>
            <p class="normal"><code class="inlineCode">Set type=any</code></p>
            <p class="normal"><code class="inlineCode">ls -d anydomain.com</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">nslookup</code> is used to query the DNS. The sample command does DNS zone transfer using <code class="inlineCode">nslookup</code>.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">net view</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">net view</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This displays a list of computers/domains and other shared resources.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">net share</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">net share list="c:"</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This manages the shared resources and displays all information about the shared resources on the local system.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">net use</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">net use \\[targetIP] [password] /u:[user]</code></p>
            <p class="normal"><code class="inlineCode">net use \\[targetIP]\[sharename] [password] /u:[user]</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This connects to any system on the same network; it can also be used to retrieve a list of network connections.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">net user</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">net user [UserName [Password | *] [options]] [/domain]</code></p>
            <p class="normal"><code class="inlineCode">net user [UserName {Password | *} /add [options] [/domain]]</code></p>
            <p class="normal"><code class="inlineCode">net user [UserName [/delete] [/domain]]</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This displays information regarding users and performs activities related to user accounts.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">arp</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">arp /a</code></p>
            <p class="normal"><code class="inlineCode">arp /a /n 10.0.0.99</code></p>
            <p class="normal"><code class="inlineCode">arp /s 10.0.0.80 00-AA-00-4F-2A-9C</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This displays and modifies any entries in the ARP cache.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">route</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">route print</code></p>
            <p class="normal"><code class="inlineCode">route print 10.*</code></p>
            <p class="normal"><code class="inlineCode">route add 0.0.0.0 mask 0.0.0.0 192.168.12.1</code></p>
            <p class="normal"><code class="inlineCode">route delete 10.*</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Similar to ARP, <code class="inlineCode">route</code> can be utilized to understand the local IP routing and modify this information.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">netstat</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">netstat -n -o</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This displays all active TCP connections and ports on the local system; that is to say, connections that are listening, established, and waiting on the network adapter IP address.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">nbtstat</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">nbtstat /R</code></p>
            <p class="normal"><code class="inlineCode">nbtstat /S 5</code></p>
            <p class="normal"><code class="inlineCode">nbtstat /a Ip</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This displays NETBIOS information, normally utilized to identify a particular MAC address of an IP, which can be utilized in MAC spoof attacks.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">wmic</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">wmic process get caption,executablepath,commandline</code></p>
            <p class="normal"><code class="inlineCode">netsh wlan show profile "profilename" key=clear</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">wmic</code> is utilized for all typical diagnostics an attacker can perform; for example, a system’s Wi-Fi password can be extracted in a single command.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">reg</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">reg save HKLM\Security sec.hive reg save HKLM\System sys.hive reg save HKLM\SAM sam.hive reg add [\\TargetIPaddr\] [RegDomain][ \Key ]</code></p>
            <p class="normal"><code class="inlineCode">reg export [RegDomain]\[Key] [FileName]reg import [FileName ]</code></p>
            <p class="normal"><code class="inlineCode">reg query [\\TargetIPaddr\] [RegDomain]\[ Key ] /v [Valuename!]</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">The <code class="inlineCode">reg</code> command is used by most attackers to save registry hives to perform offline password attacks.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">for</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">for /L %i in (1,1,10) do echo %ii &amp;&amp; ping -n 5 IP</code></p>
            <p class="normal"><code class="inlineCode">for /F %i in (password.lst) do @echo %i&amp; @net use \\[targetIP] %i /u:[Username] 2&gt;nul&amp;&amp; pause &amp;&amp; echo [Username] :%i&gt;&gt;done.txt</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">The <code class="inlineCode">for</code> loop can be utilized in Windows to create a port scanner or enumeration of accounts.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 3.6: Useful Windows commands during penetration testing activity</p>
    <h2 id="_idParaDest-106" class="heading-2">ARP broadcasting</h2>
    <p class="normal">During internal network <a id="_idIndexMarker407"/>active reconnaissance, the entire local network can be scanned using <code class="inlineCode">nmap</code> (<code class="inlineCode">nmap -v -sn IPrange</code>) to sniff the ARP broadcasts. In addition, Kali has <code class="inlineCode">arp-scan</code> (<code class="inlineCode">arp-scan IP range</code>) to identify a list of hosts that are alive on the same network.</p>
    <p class="normal"><em class="italic">Figure 3.25</em> is a screenshot of Wireshark that provides the traffic generated at the target when <code class="inlineCode">arp-scan</code> is run against the entire subnet. This is considered to be a non-stealthy scan:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_25.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.25: ARP scanning network traffic on Wireshark </p>
    <h2 id="_idParaDest-107" class="heading-2">Ping sweep</h2>
    <p class="normal">A ping sweep is the process of pinging an entire range of network IP addresses or individual IPs to find <a id="_idIndexMarker408"/>out whether they are alive and responding. An attacker’s first step in any large-scale scanning is to enumerate all of the hosts that are responding. Penetration testers can leverage <code class="inlineCode">fping</code> or <code class="inlineCode">nmap</code>, or even write custom Bash scripts to carry out the activity:</p>
    <pre class="programlisting con"><code class="hljs-con">fping -g IPrange
nmap -sP IPrange
for i in {1..254}; do ping -c 1 10.10.0.$i | grep 'from'; done
</code></pre>
    <p class="normal">Sometimes, attackers can encounter a roadblock during the ping sweep due to a firewall that blocks all of the ICMP traffic. In the case of an ICMP block, we can utilize the following command to identify alive hosts by specifying a list of port numbers during the ping sweep:</p>
    <pre class="programlisting con"><code class="hljs-con">nmap -sP -PT 80 IPrange
</code></pre>
    <p class="normal"><em class="italic">Figure 3.26</em> shows all of the live hosts that were discovered using the <code class="inlineCode">fping</code> tool:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_26.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.26: Output of gping on the class-c IP range</p>
    <h2 id="_idParaDest-108" class="heading-2">Using scripts to combine masscan and nmap scans</h2>
    <p class="normal">The speed and reliability of <code class="inlineCode">masscan</code> and <code class="inlineCode">nmap</code> to enumerate in detail is a great combination to use <a id="_idIndexMarker409"/>in our goal-based penetration <a id="_idIndexMarker410"/>testing strategy. In this section, we will write <a id="_idIndexMarker411"/>a piece of script that can save time and provide more <a id="_idIndexMarker412"/>accurate results than those that can be used during exploitation while identifying the right vulnerabilities:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-keyword">function</span> helptext { 
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"</span><span class="hljs-string">enter the massnmap with the file input with list of IP address ranges"</span> 
}
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"</span><span class="hljs-variable">$#</span><span class="hljs-string">"</span> -ne 1 ]; <span class="hljs-keyword">then</span> 
  <span class="hljs-built_in">echo</span>  <span class="hljs-string">"Sorry cannot understand the command"</span> 
  helptext&gt;&amp;2 
  <span class="hljs-built_in">exit</span> 1 
<span class="hljs-keyword">elif</span> [ ! -s <span class="hljs-variable">$1</span> ]; <span class="hljs-keyword">then</span> 
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"ooops it is empty"</span> 
  helptext&gt;&amp;2 
  <span class="hljs-built_in">exit</span> 1 
<span class="hljs-keyword">fi</span> 
 
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"</span><span class="hljs-subst">$(id -u)</span><span class="hljs-string">"</span> != <span class="hljs-string">"0"</span> ]; <span class="hljs-keyword">then</span> 
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"I assume you are running as root"</span> 
  helptext&gt;&amp;2 
  <span class="hljs-built_in">exit</span> 1 
<span class="hljs-keyword">fi</span>
<span class="hljs-keyword">for</span> range <span class="hljs-keyword">in</span> $(cat <span class="hljs-variable">$1</span>); <span class="hljs-keyword">do</span> 
  store=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$range</span> | sed -e <span class="hljs-string">'</span><span class="hljs-string">s/\//_/g'</span>) 
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"I am trying to create a store to dump now hangon"</span> 
  mkdir -p <span class="hljs-built_in">pwd</span>/<span class="hljs-variable">$store</span>; 
  iptables -A INPUT -p tcp --dport 60000 -j DROP; 
  <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n alright lets fire masscan ****"</span> 
  masscan --open --banners --source-port 60000 -p0-65535 --max-rate 15000 -oBpwd/<span class="hljs-variable">$store</span>/masscan.bin <span class="hljs-variable">$range</span>; masscan --<span class="hljs-built_in">read</span>$ 
  <span class="hljs-keyword">if</span> [ ! -s ./results/<span class="hljs-variable">$store</span>/masscan-output.txt ]; <span class="hljs-keyword">then</span> 
     <span class="hljs-built_in">echo</span> <span class="hljs-string">"Thank you for wasting time"</span> 
  <span class="hljs-keyword">else</span> 
    awk<span class="hljs-string">'/open/ {print $4,$3,$2,$1}'</span> ./results/<span class="hljs-variable">$store</span>/masscan-output.txt |  awk<span class="hljs-string">'</span>
<span class="hljs-string">/.+/{ </span>
<span class="hljs-string">  if (!($1 in Val)) { Key[++i] = $1; } </span>
<span class="hljs-string">  Val[$1] = Val[$1] $2 ","; </span>
<span class="hljs-string">  END{ </span>
<span class="hljs-string">  for (j = 1; j &lt;= i; j++) {</span>
<span class="hljs-string">    printf("%s:%s\n%s",  Key[j], Val[Key[j]], (j == i) ? "" : "\n");</span>
<span class="hljs-string">  } </span>
<span class="hljs-string">}'</span>&gt;}./results/<span class="hljs-variable">$store</span>/hostsalive.csv 
 
<span class="hljs-keyword">for</span> ipsfound <span class="hljs-keyword">in</span> $(cat ./results/<span class="hljs-variable">$store</span>/hostsalive.csv); <span class="hljs-keyword">do</span> 
  IP=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$TARGET</span> | awk -F: <span class="hljs-string">'{print $1}'</span>); 
  PORT=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$TARGET</span> | awk -F: <span class="hljs-string">'{print $2}'</span> | sed<span class="hljs-string">'</span><span class="hljs-string">s/,$//'</span>); 
  FILENAME=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$IP</span> | awk<span class="hljs-string">'{print "nmap_"$1}'</span>); 
  nmap -vv -sV --version-intensity 5 -sT -O --max-rate 5000 -Pn -T3 -p <span class="hljs-variable">$PORT</span> -oA ./results/<span class="hljs-variable">$store</span>/<span class="hljs-variable">$FILENAME</span> <span class="hljs-variable">$IP</span>; 
   <span class="hljs-keyword">done</span> 
<span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span>
</code></pre>
    <p class="normal">Now, save the <a id="_idIndexMarker413"/>file into <code class="inlineCode">anyname.sh</code> and then <code class="inlineCode">chmod +x anyname.sh</code>. Next, run <code class="inlineCode">./anyname.sh fileincludesipranges</code>.</p>
    <p class="normal">Upon <a id="_idIndexMarker414"/>executing the preceding script, you should <a id="_idIndexMarker415"/>be able <a id="_idIndexMarker416"/>to see the following, as shown in <em class="italic">Figure 3.27</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_27.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.27: Running our custom script in Kali to scan the network</p>
    <h2 id="_idParaDest-109" class="heading-2">Taking advantage of SNMP</h2>
    <p class="normal"><strong class="keyWord">SNMP</strong>, <strong class="keyWord">Simple Network Management Protocol</strong>, is traditionally used to collect information about <a id="_idIndexMarker417"/>the configuration of network devices such as printers, hubs, switches, routers on internet protocol, and servers. Attackers can potentially take advantage of SNMP that runs on UDP port <code class="inlineCode">161</code> (by default) when it is poorly configured or left out, with the default configuration having a default community string. </p>
    <p class="normal">SNMP was first introduced in 1987: version 1 had plain text passwords in transit; version 2c had improved performance, but still plain text passwords; and now the latest version 3 encrypts all of the traffic with message integrity. There are two types of community strings utilized in all versions of SNMP:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Public</strong>: Community <a id="_idIndexMarker418"/>string is used for read-only access</li>
      <li class="bulletList"><strong class="keyWord">Private</strong>: Community string <a id="_idIndexMarker419"/>is used for both read and write access</li>
    </ul>
    <p class="normal">The thing that attackers would look for is any identified network device on the internet and find out whether a public community string is enabled so that they can pull out all of the information specific to the network and draw a topology around it to create more focused attacks. These issues arise since, most of the time, IP-based <strong class="keyWord">Access Control Lists</strong> (<strong class="keyWord">ACLs</strong>) are often <a id="_idIndexMarker420"/>not implemented, or not used at all.</p>
    <p class="normal">Kali Linux provides multiple tools to perform the SNMP enumeration; attackers can utilize snmpwalk <a id="_idIndexMarker421"/>or onesixtyone to understand the complete information SNMP steps, as shown in <em class="italic">Figure 3.28</em>:</p>
    <pre class="programlisting con"><code class="hljs-con">snmpwalk -c public ipaddress –v1
</code></pre>
    <figure class="mediaobject"><img src="../Images/B17765_03_28.png" alt="A picture containing text  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 3.28: snmpwalk output on a device with a public community string</p>
    <p class="normal">Attackers can also utilize Metasploit to perform SNMP enumeration, by using the <code class="inlineCode">/auxiliary/scanner/snmp/snmpenum</code> module as shown in <em class="italic">Figure 3.29</em>. </p>
    <p class="normal">Some systems have SNMP installed, but that is completely ignored by the system administrators:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_29.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.29: SNMP enumeration using Metasploit through the SNMP protocol</p>
    <p class="normal">Attackers will <a id="_idIndexMarker422"/>also be able to extract all of the user accounts by using account enumeration modules within Metasploit, as shown in <em class="italic">Figure 3.30</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_30.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.30: Account enumeration using Metasploit through the SNMP protocol</p>
    <h2 id="_idParaDest-110" class="heading-2">Windows account information via SMB sessions</h2>
    <p class="normal">Traditionally, during internal network scanning, it is very likely that attackers exploit the internal <strong class="keyWord">Server Message Block</strong> (<strong class="keyWord">SMB</strong>) sessions that are most commonly used. In the case of external<a id="_idIndexMarker423"/> exploitation, attackers can engage <code class="inlineCode">nmap</code> to perform the enumeration, but this scenario is very rare. The following <code class="inlineCode">nmap</code> command will enumerate all of the remote users on the Windows machine. This information normally creates lots of entry points, much like brute force and password guessing attacks in later stages:</p>
    <pre class="programlisting con"><code class="hljs-con">nmap --script smb-enum-users.nse -p445 &lt;host&gt;
</code></pre>
    <p class="normal">Attackers may also utilize the Metasploit module, <code class="inlineCode">auxiliary/scanner/smb/smb_enumusers</code>, to perform the activity. <em class="italic">Figure 3.31</em> shows the successful enumeration of users on a Windows system running <code class="inlineCode">Metasploitable3</code>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_31.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.31: Enumeration of users in Metasploit using the SMB protocol</p>
    <p class="normal">This can be <a id="_idIndexMarker424"/>achieved either by having a valid password guess to the system or by brute-forcing the SMB logins.</p>
    <h2 id="_idParaDest-111" class="heading-2">Locating network shares</h2>
    <p class="normal">One of the oldest <a id="_idIndexMarker425"/>attacks that penetration testers these days forget about is the NETBIOS null session, which will allow them to enumerate all of the network shares:</p>
    <pre class="programlisting con"><code class="hljs-con">smbclient -I TargetIP -L administrator -N -U ""
</code></pre>
    <p class="normal"><code class="inlineCode">enum4linux</code> can also be utilized in a similar way to <code class="inlineCode">enum.exe</code>, formerly from BindView, which has now been taken over by Symantec; this tool is normally used for enumerating information from Windows and Samba systems:</p>
    <pre class="programlisting con"><code class="hljs-con">enum4linux.pl [options] targetip
</code></pre>
    <p class="normal">The options are the following (such as <code class="inlineCode">enum</code>):</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">-U</code>: Get user list</li>
      <li class="bulletList"><code class="inlineCode">-M</code>: Get machine list</li>
      <li class="bulletList"><code class="inlineCode">-S</code>: Get share list</li>
      <li class="bulletList"><code class="inlineCode">-P</code>: Get password policy information</li>
      <li class="bulletList"><code class="inlineCode">-G</code>: Get group and member list</li>
      <li class="bulletList"><code class="inlineCode">-d</code>: Be detailed; applies to <code class="inlineCode">-U</code> and <code class="inlineCode">-S</code></li>
      <li class="bulletList"><code class="inlineCode">-u user</code>: Specify the username to use (default <code class="inlineCode">""</code>)</li>
      <li class="bulletList"><code class="inlineCode">-p pass</code>: Specify the password to use (default <code class="inlineCode">""</code>)</li>
    </ul>
    <p class="normal">This tool is more <a id="_idIndexMarker426"/>aggressive in scanning and identifying the list of domains along with the domain SID, as shown in <em class="italic">Figure 3.32</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_32.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.32: Enumerating the domain controller using enum4linux</p>
    <h2 id="_idParaDest-112" class="heading-2">Reconnaissance of active directory domain servers</h2>
    <p class="normal">Often during an internal penetration testing activity, penetration testers will be provided with a <a id="_idIndexMarker427"/>username and password. In real-world scenarios, the attackers are inside the network, and an attack scenario would be what they could do with normal user access and how they elevate the privileges to compromise the enterprise domain.</p>
    <p class="normal">Kali Linux provides <code class="inlineCode">rpcclient</code> installed by default, which can be utilized to perform more active reconnaissance on an active directory environment. This tool provides multiple options to extract all of the details about the domain and other networking services, which we will be exploring in <em class="chapterRef">Chapter 10</em>, <em class="italic">Exploitation</em>. One of the system internal tools, ADExplorer, can also be utilized to perform the AD enumeration. <em class="italic">Figure 3.33</em> shows the enumeration of lists of domains, users, and groups:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_33.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.33: Enumeration of domain and account details using rpcclient with valid credentials </p>
    <h2 id="_idParaDest-113" class="heading-2">Enumerating the Microsoft Azure environment </h2>
    <p class="normal">During the pandemic, many organizations transformed themselves to be better integrated with <a id="_idIndexMarker428"/>cloud platforms, especially when there was a critical vulnerability on Microsoft Exchange Server that was released. In this section, we will discuss the various techniques utilized to perform information gathering from the Azure environment using Kali Linux.</p>
    <p class="normal">To interact with the Azure services, we will first need the client to be downloaded. This can be achieved by running the following commands in the terminal:</p>
    <pre class="programlisting con"><code class="hljs-con">curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
sudo apt-get install ca-certificates curl apt-transport-https lsb-release gnupg
sudo apt-get install azure-cli
</code></pre>
    <p class="normal">Upon successful installation of <code class="inlineCode">azure-cli</code>, we should be able to log in using the <code class="inlineCode">az</code> client from our Kali <a id="_idIndexMarker429"/>Linux by running <code class="inlineCode">az login</code>; if there are no subscriptions, attackers can choose to log in without any subscription by adding <code class="inlineCode">--no-subscriptions</code>, as shown in <em class="italic">Figure 3.34</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_34.png" alt=""/></figure>
    <p class="packt_figref">Figure 3.34: Logging in to a Microsoft 365 Azure account</p>
    <p class="normal">Once logged in with a Microsoft 365 account, you should be able to successfully receive the cloud details; if the account has subscriptions, they will be displayed as shown in <em class="italic">Figure 3.35</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_35.png" alt="A screenshot of a computer  Description automatically generated with medium confidence"/></figure>
    <p class="packt_figref">Figure 3.35: Portal details of the Azure that the user is authorized to view</p>
    <p class="normal"><em class="italic">Table 3.7</em> provides <a id="_idIndexMarker430"/>some of the useful commands that come in handy during the enumeration of Microsoft Azure cloud services: </p>
    <table id="table007" class="table-container">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Command</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Example</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">az ad user list </code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">az ad user list --output=table --query='[].{Created:createdDateTime,UPN:userPrincipalName,Name:displayName,Title:jobTitle,Department:department,Email:mail,UserId:mailNickname,Phone:telephoneNumber,Mobile:mobile,Enabled:accountEnabled}'</code></p>
            <p class="normal"><code class="inlineCode">az ad user list --output=json --query='[].{Created:createdDateTime,UPN:userPrincipalName,Name:displayName,Title:jobTitle,Department:department,Email:mail,UserId:mailNickname,Phone:telephoneNumber,Mobile:mobile,Enabled:accountEnabled}' --upn='&lt;upn&gt;'</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This command will provide a list of all users who are connected to this Azure AD</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">az ad group list</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">az ad group list --output=json --query='[].{Group:displayName,Description:description}'</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This will provide a full list of groups associated with the tenant</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">az ad group member list</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">az ad group member list --output=json --query='[].{Created:createdDateTime,UPN:userPrincipalName,Name:displayName,Title:jobTitle,Department:department,Email:mail,UserId:mailNickname,Phone:telephoneNumber,Mobile:mobile,Enabled:accountEnabled}' --group='&lt;group name&gt;'</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This will provide a full list of members in a given group</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">az ad app list</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">az ad app list --output=table --query='[].{Name:displayName,URL:homepage}'</code></p>
            <p class="normal"><code class="inlineCode">az ad app list --output=json --identifier-uri='&lt;uri&gt;'</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This will provide us with a list of applications that are available within the Azure AD</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">az ad sp list</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">az ad sp list --output=table --query='[].{Name:displayName,Enabled:accountEnabled,URL:homepage,Publisher:publisherName,MetadataURL:samlMetadataUrl}'</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This will provide us with the service principal account details</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 3.7: Commands to be used in the enumeration of Microsoft Azure cloud services</p>
    <h2 id="_idParaDest-114" class="heading-2">Using comprehensive tools (Legion)</h2>
    <p class="normal">The former security tool Sparta is no longer available in the latest version of Kali, but it has been <a id="_idIndexMarker431"/>complemented by another comprehensive tool called Legion, which is the same fork as Sparta. This tool can help to speed up the penetration tester’s goal of compromising a system that combines multiple tools, such as Nmap, and several other scripts and tools. This is a semi-automated tool that can be very handy when attackers wish to perform focused information gathering, based on the ports and services: </p>
    <ul>
      <li class="bulletList"><code class="inlineCode">Hosts</code>: This will list down all the targets that are set by the pentesters</li>
      <li class="bulletList"><code class="inlineCode">Services</code>: This is a list of services that need to be run during the automatic run; for example, if you configure to run Nmap and when port <code class="inlineCode">80</code> is identified, it will automatically take the screenshot</li>
      <li class="bulletList"><code class="inlineCode">Tools</code>: This will include all the tools that were run on a specific port, along with its relevant output</li>
    </ul>
    <p class="normal"><em class="italic">Figure 3.36</em> shows Legion in action against a local subnet. By default, Legion performs an <code class="inlineCode">nmap</code> full port scan, and also runs the respective Nmap scripts based on the services identified on the port and takes a screenshot, where possible:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_36.png" alt="Graphical user interface, text  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 3.36: Port scanning output in Legion</p>
    <h1 id="_idParaDest-115" class="heading-1">Using machine learning for reconnaissance</h1>
    <p class="normal">Machine learning has become a vital technology in cybersecurity. It is the art of using data and algorithms to imitate the way we learn as humans. Machine learning is a branch of artificial intelligence. In this section, we will explore the GyoiThon tool, which you can leverage during large-scale pentesting or red team activities.</p>
    <p class="normal">There are four types of machine learning algorithms:</p>
    <ul>
      <li class="bulletList">Supervised: These learning algorithms are provided with a set of known data (labeled) that includes the desired output. The goal of this type of learning is for the algorithm to achieve a high level of accuracy by learning from patterns in the data to make predictions.</li>
      <li class="bulletList">Unsupervised: These learning algorithms are trained with unlabeled data or datasets that do not include the desired output. The algorithm tries to interpret and organize the datasets.</li>
      <li class="bulletList">Semi-supervised: This is a mix of the preceding types.</li>
      <li class="bulletList">Reinforcement learning: These algorithms are based on regimented learning processes, where the algorithm is provided with a clear set of actions, factors, and desired outcomes. Most of the time, it is a trial-and-error method to explore different possibilities and options to determine which is best.</li>
    </ul>
    <p class="normal">GyoiThon by gyoisamurai is a pentest tool based on the Naïve Bayes (supervised) deep learning method (deep learning is a subset of machine learning) and is written in Python 3. It includes a software analysis engine, vulnerability identification engine, and report generation engine. To install the GyoiThon on our Kali Linux machine, run the following commands in the terminal:</p>
    <pre class="programlisting con"><code class="hljs-con">$ sudo git clone https://github.com/gyoisamurai/GyoiThon
cd GyoiThon
sudo pip3 install -r requirements.txt
sudo apt --fix-broken install
sudo apt install python3-tk
</code></pre>
    <p class="normal">Once the requirements are installed, run <code class="inlineCode">sudo python3 gyoithon.py -h</code> from the terminal, you should see all the options, as seen in <em class="italic">Figure 3.37</em>:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_37.png" alt="Text  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 3.37: Successfully running the GyoiThon tool</p>
    <p class="normal">Before beginning the reconnaissance activity, you can edit the configuration file <code class="inlineCode">config.ini</code> and enter the proxy details (if any), such as Censys and DomainTools API details. All the target information can be entered in the <code class="inlineCode">host.txt</code> file, which is located in the same folder where the tool was cloned. The format to enter the target details is protocol (<code class="inlineCode">http</code> or <code class="inlineCode">https</code>), domain (<code class="inlineCode">cyberhia.com</code>), port (<code class="inlineCode">80</code> or <code class="inlineCode">443</code>), and the root (<code class="inlineCode">/</code> or <code class="inlineCode">/admin/</code>). An example of using <code class="inlineCode">host.txt</code> to perform reconnaissance on <code class="inlineCode">cyberhia.com</code> is:</p>
    <pre class="programlisting code"><code class="hljs-code">http cyberhia.com 80 /
https cyberhia.com 443 /admin/
</code></pre>
    <p class="normal">Finally, you can run <code class="inlineCode">sudo python3 gyoithon.py</code> from the terminal. The software engine within the tool should be able to grab the banner using normal web access using the deep learning base and signature. <em class="italic">Figure 3.38</em> shows a successful reconnaissance output on the target:</p>
    <figure class="mediaobject"><img src="../Images/B17765_03_38.png" alt="Text  Description automatically generated"/></figure>
    <p class="packt_figref">Figure 3.38: Performing reconnaissance using GyoiThon</p>
    <p class="normal">Other features you can leverage with this tool include:</p>
    <ul>
      <li class="bulletList">Scanning for cloud services and exploring relevant (<strong class="keyWord">Fully Qualified Domain Names (FQDNs</strong>))</li>
      <li class="bulletList">Performing custom Google searches and exploring the default paths based on the product version</li>
      <li class="bulletList">Performing port scanning on targets</li>
      <li class="bulletList">Executing the exploit module using Metasploit</li>
    </ul>
    <p class="normal">As it’s a supervised learning algorithm, you should be able to determine the input and output with the data fed into the algorithm. In this case, every time the scan is performed, the data will be labeled and the algorithm trained, which will reduce false positives significantly. For example, if the target has hundreds of domains, this can be very handy to automate the server banner grabbing and list all the vulnerabilities using the vulnerability detection engine to prepare for the exploitation.</p>
    <h1 id="_idParaDest-116" class="heading-1">Summary</h1>
    <p class="normal">Attackers might face a very real chance of their activities being identified, which puts them at risk of exposure to a target. However, we have now seen the different techniques that can be employed during active reconnaissance to mitigate such a risk. Attackers must ensure that there is a balance against the need to map a network, find open ports and services, and determine the operating system and applications that are installed. </p>
    <p class="normal">The real challenge for attackers is to adopt stealthy scanning techniques to reduce the risk of triggering an alert.</p>
    <p class="normal">Manual approaches are normally used to create slow scans; however, this approach may not always be effective. Therefore, attackers take advantage of tools such as the Tor network and various proxy applications to hide their identities.</p>
    <p class="normal">Additionally, we explored how to perform reconnaissance using machine learning using the GyoiThon tool, which can significantly reduce your manual efforts.</p>
    <p class="normal">In the next chapter, we will explore more techniques and procedures that aid in vulnerability assessments, and how to utilize the scanners to identify the vulnerabilities that can be utilized as the potential candidates for the exploitation to move forward in achieving the objective.</p>
  </div>
</body></html>