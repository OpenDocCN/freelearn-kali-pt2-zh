<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="en" lang="en">
<head>
<title>The Ultimate Kali Linux Book - Third Edition</title>
<link rel="stylesheet" type="text/css" href="../styles/stylesheet1.css"/>
<link rel="stylesheet" type="text/css" href="../styles/stylesheet2.css"/>
</head>
<body>
<div id="book-content">
<div id="sbo-rt-content"><section id="setting-up-for-advanced-penetration-testing-techniques" class="level1 pkt" data-number="4">
<h1 data-number="4">3 Setting up for Advanced Penetration Testing Techniques</h1>
<section id="join-our-book-community-on-discord-2" class="level2" data-number="4.1">
<h2 data-number="4.1">Join our book community on Discord</h2>
<p><a href="https://packt.link/SecNet">https://packt.link/SecNet</a><img src="../media/file73.png" alt="Qr code Description automatically generated" width="150" height="150"/>Learning the methodology and techniques of performing penetration testing is always exciting. While many professionals may focus on specific types of penetration testing, such as internal or external network penetration testing, social engineering penetration testing, or even web application security testing, it's always beneficial to understand how to perform wireless penetration testing and how to compromise a Microsoft Windows domain in an enterprise environment.In this chapter, you will learn how to setup an Active Directory domain environment that will enable you perform advanced penetration testing exercises such as red teaming techniques to discover security vulnerabilities and compromise the Domain Controller, taking over the domain of the organization. In addition, you will setup a RADIUS access server to provide <strong>Authentication, Authorization and Accounting</strong> (<strong>AAA</strong>) services to our enterprise wireless network. In this chapter, we will cover the following topics:</p>
<ul>
<li>Building an Active Directory red team lab</li>
<li>Setting up a wireless penetration testing lab</li>
</ul>
<p>Let’s dive in!</p>
</section>
<section id="technical-requirements-1" class="level2" data-number="4.2">
<h2 data-number="4.2">Technical Requirements</h2>
<p>To follow along with the exercises in this chapter, please ensure that you have met the following hardware and software requirements:</p>
<ul>
<li>Oracle VM VirtualBox - <a href="https://www.virtualbox.org/">https://www.virtualbox.org/</a></li>
<li>Windows 10 Enterprise - <a href="https://www.microsoft.com/en-us/evalcenter/evaluate-windows-10-enterprise">https://www.microsoft.com/en-us/evalcenter/evaluate-windows-10-enterprise</a></li>
<li>Windows Server 2019 - <a href="https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2019">https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2019</a></li>
<li>Ubuntu Server 22.04 LTS - <a href="https://releases.ubuntu.com/jammy/">https://releases.ubuntu.com/jammy/</a></li>
</ul>
</section>
<section id="building-an-active-directory-red-team-lab" class="level2" data-number="4.3">
<h2 data-number="4.3">Building an Active Directory red team lab</h2>
<p><strong>Active Directory</strong> is a role within the Microsoft Windows Server operating system that enables IT administrators to centrally manage all users, devices, and policies within a Windows environment. Active Directory ensures that centralized management is available for user accounts across an entire Windows domain, as well as that policies can be created and assigned to various user groups to ensure people have the necessary access rights to perform actions that are related to their job duties.Active Directory is commonly found within many organizations around the world. As an aspiring ethical hacker and penetration tester, it's important to understand how to discover various security vulnerabilities within a Microsoft Windows domain and leverage those security flaws to compromise an organization's <strong>Domain Controller</strong> and its systems, services, and shared resources.</p>
<blockquote>
<p>To learn more about the role and importance of a Domain Controller, please see: <a href="https://www.techtarget.com/searchwindowsserver/definition/domain-controller">https://www.techtarget.com/searchwindowsserver/definition/domain-controller</a>.</p>
</blockquote>
<p>This section will teach you how to create a Microsoft Windows lab environment with a Microsoft Windows Server 2019 and 2 Windows 10 Enterprise clients as virtual machines. This lab environment will allow you to practice advanced penetration testing techniques such as red teaming exercises on a Windows domain and exploit security flaws in Active Directory environments.The following diagram shows the RedTeamLab environment:</p>
<img src="../media/file74.png" width="776" height="513"/>
<p>As we can see, our Kali Linux virtual machine is directly connected to the systems within the <em>RedTeamLab</em> environment. In later sections of this book, you will learn how to perform exploitation and post-exploitation techniques on targets, so when you're exploiting the systems within the Windows domain, we will assume you have already broken into the network and have compromised at least one system that’s connected to Active Directory. For now, we will focus on setting up our environment for security testing later.The following table shows the user accounts that we will be setting up in the <em>RedTeamLab</em> environment:</p>
<img src="../media/file75.png" width="975" height="412"/>
<p>As shown in the preceding table, we will create 2 domain users (<em>gambit</em> ad <em>rogue</em>), an additional domain administrator (<em>wolverine</em>) and a service account which domain administrative privileges (<em>sqladmin</em>).To get started setting up the red team section of our lab, please use the following instructions:</p>
<section id="part-1-setting-up-windows-server" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1">Part 1 – Setting up Windows Server</h3>
<p>In this section, you will learn how to setup Microsoft Windows Server 2019 as a virtual machine. To get started with this exercise, please use the following instructions:</p>
<ol>
<li>On your host computer, go to <a href="https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2019">https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2019</a>, and click on <strong>Download the VHD</strong>, ensure you complete the registration form to access the download links for the <strong>Virtual Hard Disk</strong> (<strong>VHD</strong>) <strong>64-bit edition</strong> file as shown below:</li>
</ol>
<img src="../media/file76.png" width="869" height="336"/>
<blockquote>
<p>Rather than downloading an ISO image, using a pre-built VHD for Windows Server 2019 will reduce the time needed to install the Windows Server 2019 operating system as a virtual machine.</p>
</blockquote>
<ol>
<li>Once the Windows Server 2019 VHD file is downloaded on your host computer, open <strong>Oracle VM VirtualBox Manager</strong> and click on <strong>New</strong> to create a new virtual machine environment.</li>
<li>When the <strong>Create Virtual Machine</strong> window appears, click on <strong>Expert Mode</strong> and use the following configurations:
<ul>
<li>Name: Windows Server 2019</li>
<li>Type: Microsoft Windows</li>
<li>Version: Windows 2019 (64-bit)</li>
<li>Hard Disk: Use an Existing Virtual Hard Disk File (Click on the folder icon &gt; Add &gt; select the Windows Server 2019 VHD file).</li>
<li>Click on <strong>Finish</strong> to save the virtual machine</li>
</ul></li>
<li>Once the <strong>Windows Server 2019 virtual machine</strong> is created and saved on <strong>Oracle VM VirtualBox Manager</strong>, select it and click on <strong>Settings</strong>.</li>
<li>On the <strong>Settings</strong> window, select the <strong>Network</strong> category and use the following settings for <strong>Adapter 1</strong>:
<ul>
<li>Adapter 1: Enable network Adapter</li>
<li>Attached to: Internal Network</li>
<li>Name: <em>RedTeamLab</em> (manually type it in the field)</li>
<li>Promiscuous Mode: Allow All</li>
</ul></li>
</ol>
<p>The following screenshot shows the preceding configurations for Adapter 1:</p>
<img src="../media/file77.png" width="683" height="496"/>
<ol>
<li>Next, select the <strong>Windows Server 2019 virtual machine</strong> and click on <strong>Start</strong> to power-on.</li>
<li>Once the virtual machine is running, you will prompted to select your home country/region, preferred app language and keyboard layout, click on <strong>Next</strong>.</li>
<li>Next, you will need to read the <strong>License terms</strong> and click on <strong>Accept</strong>.</li>
<li>Next, create a password for the built-in <code>Administrator</code> account, use <code>P@ssword1</code> as the password and click on <strong>Finish</strong>.</li>
<li>Next, log-in to Windows Server 2019 virtual machine. On the virtual machine menu bar, select <strong>Input</strong> &gt; <strong>Keyboard</strong> &gt; <strong>Insert Ctrl-Alt-Del</strong> to view the login window:</li>
</ol>
<img src="../media/file78.png" width="545" height="230"/>
<ol>
<li>Login using username: <code>Administrator</code> and password: <code>P@ssword1</code>.</li>
</ol>
</section>
<section id="part-2-configuring-virtual-machine-additional-features" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2">Part 2 – Configuring virtual machine additional features</h3>
<ol>
<li>Ensure the Windows Server 2019 virtual machine is running and you’re logged-in.</li>
<li>To scale the virtual machine’s desktop resolution to fit your host computer’s monitor, on the virtual machine menu bar, select <strong>Devices</strong> &gt; <strong>Insert Guest Additions CD image</strong> as shown below:</li>
</ol>
<img src="../media/file79.png" width="429" height="280"/>
<ol>
<li>Next, open <strong>Windows Explorer</strong> within Windows Server 2019 and navigate to <strong>This PC</strong> and double-click on the <strong>VirtualBox Guest Additions</strong> virtual disk as shown below:</li>
</ol>
<img src="../media/file80.png" width="1040" height="784"/>
<ol>
<li>When the installation window appears, click on <strong>Next</strong> and ensure that you use the default settings during the installation process. When it's complete, do not reboot.</li>
<li>Next, within the Windows Server 2019, click on the <strong>Start</strong> button (bottom-left corner) and open <strong>Windows PowerShell</strong>. Use the following commands to static assign an IP address and subnet mask to the Ethernet network adapter:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>PS C:\Users\Administrator&gt; netsh interface ipv4 set address name="Ethernet" static 192.168.42.40 255.255.255.0</code></pre>
</div>
<ol>
<li>Next, change the default hostname to <code>DC1</code> and reboot the server with the following commands:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>PS C:\Users\Administrator&gt; Rename-Computer -NewName "DC1" -Restart</code></pre>
</div>
<p>The following screenshot shows the execution of the preceding commands:</p>
<img src="../media/file81.png" width="802" height="150"/>
<ol>
<li>Next, after the server reboots, login using the Administrator credentials. The Windows Server desktop interface will automatically scale to fit your monitor's resolution. If it doesn't, simply toggle this with the <strong>VirtualBox menu bar</strong> &gt; <strong>View</strong> &gt; <strong>Auto-resize Guest Display</strong> option as shown below:</li>
</ol>
<img src="../media/file82.png" width="348" height="316"/>
</section>
<section id="part-3-setting-active-directory-domain-services" class="level3" data-number="4.3.3">
<h3 data-number="4.3.3">Part 3 – Setting Active Directory Domain Services</h3>
<p>Active Directory is a very important and popular role within Microsoft Windows Server as it allows IT professionals to centrally manage all users, devices, and policies within a Windows environment. To set up Active Directory within our lab, please use the following instructions:</p>
<ol>
<li>Open the <strong>Windows PowerShell</strong> application within the Windows Server 2019 virtual machine.</li>
<li>Install the <strong>Active Directory Domain Service</strong> and it’s management tools using the following commands:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>PS C:\Users\Administrator&gt; Install-WindowsFeature -name AD-Domain-Services -IncludeManagementTools</code></pre>
</div>
<ol>
<li>Next, configure a new Active Directory forest and domain with the name <code>redteamlab.local</code> using the following commands:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>PS C:\Users\Administrator&gt; Install-ADDSForest -DomainName redteamlab.local -skipprechecks</code></pre>
</div>
<p>You’ll be prompted to enter a <strong>Safe Mode Administrator Password</strong>, use <code>P@ssword1</code>. When prompted to continue the operation, type <code>Y</code> and hit <strong>Enter</strong> to continue as shown in the following screenshot:</p>
<img src="../media/file83.png" width="1005" height="207"/>
<p>The setup process takes a few minutes to complete, then the Windows Server will automatically reboot.</p>
<ol>
<li>After the server reboots, login using the Administrator credentials. This time, you’ll be logging-in as a domain administrator on the server.</li>
</ol>
</section>
<section id="part-4-creating-domain-users-and-administrator-accounts" class="level3" data-number="4.3.4">
<h3 data-number="4.3.4">Part 4 – Creating domain users and administrator accounts</h3>
<p>The following steps will carefully guide you through the process of creating domain users and domain administrators, and assigning the user to various security groups. To ensure these steps are simple and concise, we will be using the Windows PowerShell on Windows Server:</p>
<ol>
<li>On the Windows Server 2019 virtual machine, open the <strong>Windows PowerShell</strong> application and use the following commands to create 4 domain user accounts:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>PS C:\Users\Administrator&gt; net user gambit Password1 /add /domain
PS C:\Users\Administrator&gt; net user rogue Password1 /add /domain
PS C:\Users\Administrator&gt; net user wolverine Password123 /add /domain
PS C:\Users\Administrator&gt; net user sqladmin Password45 /add /domain</code></pre>
</div>
<p>The following screenshot shows the execution of the preceding commands:</p>
<img src="../media/file84.png" width="691" height="264"/>
<ol>
<li>Next, let's make the <code>wolverine</code> account a high-privilege user account that has the same privileges as the administrator by using the following commands</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>PS C:\Users\Administrator&gt; net localgroup "Administrators" wolverine /add
PS C:\Users\Administrator&gt; net group "Domain Admins" wolverine /add /domain
PS C:\Users\Administrator&gt; net group "Enterprise Admins" wolverine /add /domain
PS C:\Users\Administrator&gt; net group "Group Policy Creator Owners" wolverine /add /domain
PS C:\Users\Administrator&gt; net group "Schema Admins" wolverine /add /domain</code></pre>
</div>
<p>The following screenshot shows the execution of the preceding commands:</p>
<img src="../media/file85.png" width="838" height="325"/>
<ol>
<li>Next, we will do the same for the <code>sqladmin</code> account</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>PS C:\Users\Administrator&gt; net localgroup "Administrators" sqladmin /add
PS C:\Users\Administrator&gt; net group "Domain Admins" sqladmin /add /domain
PS C:\Users\Administrator&gt; net group "Enterprise Admins" sqladmin /add /domain
PS C:\Users\Administrator&gt; net group "Group Policy Creator Owners" sqladmin /add /domain
PS C:\Users\Administrator&gt; net group "Schema Admins" sqladmin /add /domain</code></pre>
</div>
<p>The following screenshot shows the execution of the preceding commands:</p>
<img src="../media/file86.png" width="827" height="321"/>
</section>
<section id="part-5---disabling-antimalware-protection-and-the-domain-firewall" class="level3" data-number="4.3.5">
<h3 data-number="4.3.5">Part 5 - Disabling antimalware protection and the domain firewall</h3>
<p>Within our lab, we need to ensure the Windows Defender antimalware protection is disabled on client that are connected to the Windows domain. Some techniques are be used to bypass antiviruses that will work today and tomorrow, and it will not afterwards due to the continuous advancement of malware protection and solutions. The following steps will guide you through the process of ensuring Windows Defender and the host-based firewall is disabled on all systems by leveraging <strong>Group Policy Objects</strong> (<strong>GPOs</strong>):</p>
<ol>
<li>On the Windows Server 2019 virtual machine, open the <strong>Windows PowerShell</strong> application and use the following commands to create a new GPO called <code>DisableAVGPO</code>:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>PS C:\Users\Administrator&gt; New-GPO -Name DisableAVGPO -Comment "This GPO disables AV on the entire domain"</code></pre>
</div>
<p>The following screenshot shows the expected results when executing the preceding commands:</p>
<img src="../media/file87.png" width="986" height="322"/>
<ol>
<li>Next, use the following commands to disable the antimalware service from always running:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>PS C:\Users\Administrator&gt; Set-GPRegistryValue -Name 'DisableAVGPO' -Key "HKLM\Software\Policies\Microsoft\Windows Defender" -ValueName "ServiceKeepAlive" -Type DWORD -Value 0</code></pre>
</div>
<p>As shown below, the preceding commands successfully updated the <code>DisableAVGPO</code> policy:</p>
<img src="../media/file88.png" width="1144" height="341"/>
<ol>
<li>Next, turn-off the antimalware real-time protection using the following commands</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>PS C:\Users\Administrator&gt; Set-GPRegistryValue -Name 'DisableAVGPO' -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Real-Time Protection" -ValueName "DisableRealtimeMonitoring" -Type DWORD -Value 1</code></pre>
</div>
<p>The following screenshot shows the preceding commands updated the policy:</p>
<img src="../media/file89.png" width="956" height="343"/>
<ol>
<li>Next, turn-off Windows Defender Antivirus by using the following commands</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>PS C:\Users\Administrator&gt; Set-GPRegistryValue -Name DisableAVGPO -Key "HKLM\Software\Policies\Microsoft\Windows Defender" -ValueName "DisableAntiSpyware" -Type DWORD -Value 1</code></pre>
</div>
<p>The following screenshot shows execution of the preceding commands:</p>
<img src="../media/file90.png" width="957" height="345"/>
<ol>
<li>Next, turn-off Windows Defender Firewalls with the following commands:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>PS C:\Users\Administrator&gt; Set-GPRegistryValue -Name DisableAVGPO -Key "HKLM\Software\Policies\Microsoft\WindowsFirewall\StandardProfile" -ValueName "EnableFirewall" -Type DWORD -Value 0
PS C:\Users\Administrator&gt; Set-GPRegistryValue -Name DisableAVGPO -Key "HKLM\Software\Policies\Microsoft\WindowsFirewall\DomainProfile" -ValueName "EnableFirewall" -Type DWORD -Value 0
PS C:\Users\Administrator&gt; Set-GPRegistryValue -Name DisableAVGPO -Key "HKLM\Software\Policies\Microsoft\WindowsFirewall\PublicProfile" -ValueName "EnableFirewall" -Type DWORD -Value 0</code></pre>
</div>
<p>As shown in the following screenshot, the preceding commands executed successfully:</p>
<img src="../media/file91.png" width="957" height="888"/>
</section>
<section id="part-6-setting-up-for-service-authentication-attacks" class="level3" data-number="4.3.6">
<h3 data-number="4.3.6">Part 6 – Setting up for service authentication attacks</h3>
<p>During our red teaming section, you will learn how to discover file and network sharing resources on a Windows environment. This section demonstrates how to create a network file share on Windows Server 2019 to simulate a vulnerable service that can be exploited by a threat actor.To get started with this exercise, please use the following instructions:</p>
<ol>
<li>On Windows Server 2019, open the <strong>Windows PowerShell</strong> application with administrative privileges and execute the following commands to create a shared folder on the <code>C:</code> drive:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>PS C:\Users\Administrator&gt; cd\
PS C:\&gt; mkdir CorporateFileShare
PS C:\&gt; net share DataShare=c:\CorporateFileShare</code></pre>
</div>
<p>The following screenshots the execution of the preceding commands:</p>
<img src="../media/file92.png" width="832" height="398"/>
<ol>
<li>Next, we can verify the shared folder by opening <strong>Server Manager</strong> application and selecting <strong>File and Storage Services</strong> &gt; <strong>Shares</strong>, as shown here:</li>
</ol>
<img src="../media/file93.png" width="1096" height="426"/>
<ol>
<li>Next, to ensure we can simulate a cyber-attack to compromise the Kerberos feature on a Windows Server environment, we need to create a <strong>Service Principal Name</strong> (<strong>SPN</strong>) on our Domain Controller, which is our Windows Server. Open the <strong>Windows PowerShell</strong> application with administrative privileges and execute the following commands:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>PS C:\&gt; setspn -a DC1/sqladmin.REDTEAMLAB.local:64123 REDTEAMLAB\sqladmin</code></pre>
</div>
<p>The following screenshot shows the execution of the preceding command to assign the <code>sqladmin</code> account as an SPN:</p>
<img src="../media/file94.png" width="1005" height="207"/>
<blockquote>
<p>To learn more about service principle names on Windows Server, please see: <a href="https://learn.microsoft.com/en-us/windows/win32/ad/service-principal-names">https://learn.microsoft.com/en-us/windows/win32/ad/service-principal-names</a>.</p>
</blockquote>
<ol>
<li>Lastly, use the <code>slmgr /rearm</code> command on the Windows Server 2019 virtual machine to prevent it from automatically powering-off as it’s a trial version. Reboot the system to ensure the changes take effect, then power-off the virtual machine until it’s needed later.</li>
</ol>
</section>
<section id="part-7-installing-windows-10-enterprise" class="level3" data-number="4.3.7">
<h3 data-number="4.3.7">Part 7 – Installing Windows 10 Enterprise</h3>
<p>In this section, you will learn how to set up two Microsoft Windows 10 client systems within the Red Team lab topology. One virtual machine will be logged on as Bob, while the other user will be logged on as Alice. To get started with this exercise, please use the following instructions:</p>
<ol>
<li>On your host computer, to download Microsoft Windows 10 Enterprise ISO file, go to <a href="https://www.microsoft.com/en-us/evalcenter/evaluate-windows-10-enterprise">https://www.microsoft.com/en-us/evalcenter/evaluate-windows-10-enterprise</a> and click on <strong>Download the ISO – Enterprise</strong>.</li>
<li>Next, complete the registration form and click on the <strong>Download</strong> button, then select <strong>ISO - Enterprise 64-bit edition</strong> as shown below:</li>
</ol>
<img src="../media/file95.png" width="968" height="459"/>
<ol>
<li>Once the Windows 10 Enterprise ISO file downloaded onto your host computer, open <strong>Oracle VM VirtualBox Manager</strong> and click on <strong>New</strong> to create a new virtual machine.</li>
<li>The <strong>Create Virtual Machine</strong> window will appear, use the following configurations:
<ul>
<li>Name: Bob-PC</li>
<li>ISO Image: Use the drop-down menu, select <strong>Other</strong> &gt; then select the Windows 10 Enterprise ISO file and click on Open to attach it.</li>
<li>Type: Microsoft Windows</li>
<li>Version: Windows 10 (64-bit)</li>
<li>Skip Unattended Installation: Yes (check the box)</li>
</ul></li>
</ol>
<p>The following screenshot shows the preceding configurations:</p>
<img src="../media/file96.png" width="785" height="487"/>
<p>Once you’re all set, click on <strong>Finish</strong> to save the virtual environment.</p>
<ol>
<li>Next, select the Bob-PC virtual machine and click on <strong>Settings</strong> as shown below:</li>
</ol>
<img src="../media/file97.png" width="975" height="393"/>
<ol>
<li>Click on the <strong>Network</strong> category and apply the following settings to Adapter 1:
<ul>
<li>Adapter 1: Enable network Adapter</li>
<li>Attached to: Internal Network</li>
<li>Name: <em>RedTeamLab</em> (manually type it in the field)</li>
<li>Promiscuous Mode: Allow All</li>
</ul></li>
</ol>
<p>The following screenshot shows the preceding configurations for Adapter 1:</p>
<img src="../media/file98.png" width="683" height="499"/>
<ol>
<li>Next, select the newly created virtual machine and click on <strong>Start</strong> to power-on the system.</li>
<li>On the <strong>Windows Setup</strong> window, click on <strong>Next</strong>, then click on <strong>Install now</strong>.</li>
<li>Accept the <strong>Applicable notices and license terms</strong>, and click on <strong>Next</strong>.</li>
<li>For the installation type, click on <strong>Custom: Install Windows only (advanced)</strong> option.</li>
<li>Then, select <strong>Dive 0: Unallocated Space</strong> and click on <strong>Next</strong> to start the installation. After the installation is completed, the virtual machine will automatically reboot twice.</li>
<li>After the second reboot, you’ll be prompted to select your region, and click on <strong>Yes</strong>.</li>
<li>Next, select your keyboard layout, and click on <strong>Yes</strong>. You can skip the option for adding a second keyboard layout.</li>
<li>During the setup process of Windows 10, you'll be asked to connect to a network. Select the <strong>I don't have internet</strong> option to continue as shown below:</li>
</ol>
<img src="../media/file99.png" width="736" height="453"/>
<ol>
<li>Next, click on <strong>Continue with limited setup</strong>.</li>
<li>Next, create the username: <code>bob</code> with the password: <code>P@ssword2</code>.</li>
<li>Disable any unnecessary services on the privacy window and disable Cortana. Afterwards, the setup process continues and will log you in automatically to the Windows 10 desktop.</li>
<li>Install the <strong>VirtualBox Guest Additions</strong> on the Windows 10 virtual machine. Please see <em>Part 2, steps 2 – 4</em>.</li>
<li>On Bob-PC, open the <strong>Command Prompt</strong> with administrative privileges and turn on network discovery and file sharing using the following commands:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>C:\Windows\system32&gt; netsh advfirewall firewall set rule group="Network Discovery" new enable=Yes
C:\Windows\system32&gt; netsh advfirewall firewall set rule group="File and Printer Sharing" new enable=Yes</code></pre>
</div>
<p>The following screenshot shows the execution of the preceding commands:</p>
<img src="../media/file100.png" width="863" height="224"/>
<ol>
<li>Next, use the following commands to change the default hostname to Bob-PC:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>C:\Windows\system32&gt; powershell
PS C:\Windows\system32&gt; Rename-Computer -NewName Bob-PC
PS C:\Windows\system32&gt; Restart-Computer</code></pre>
</div>
<p>Once this virtual machine is rebooted, the hostname will now be Bob-PC, the Windows network and file sharing will be enabled. Power-off Bob-PC for now.</p>
<ol>
<li>Next, let’s create another Windows 10 virtual machine and call it <strong>Alice-PC</strong>. Repeat <em>steps 3 – 20</em> and ensure you set <strong>Alice-PC</strong> as both the name of the new virtual machine (<em>step 4</em>) and the hostname (<em>step 20</em>). Create the username: <code>alice</code> with the password: <code>P@ssword2</code> as the local user during the setup process.</li>
</ol>
</section>
<section id="part-8-adding-the-clients-to-the-domain" class="level3" data-number="4.3.8">
<h3 data-number="4.3.8">Part 8 – Adding the clients to the domain</h3>
<p>Use the following instructions to joining each Windows 10 virtual machine, Bob-PC and Alice-PC to the Domain Controller:</p>
<ol>
<li>Power-on the <strong>Windows Server 2019</strong> virtual machine, <strong>Bob-PC</strong> and <strong>Alice-PC</strong>.</li>
<li>On <strong>Bob-PC</strong> and <strong>Alice-PC</strong>, open the <strong>Command Prompt</strong> with administrative privileges (<strong>Run As Administrator</strong>) and use the <code>ping 192.168.42.40</code> command to test network connectivity between each Windows 10 system and the Windows Server 2019 machine as shown below:</li>
</ol>
<img src="../media/file101.png" width="525" height="248"/>
<p>As shown in the preceding screenshot, <strong>Bob-PC</strong> was able to communicate with the <strong>Windows Server 2019</strong> virtual machine successfully.</p>
<ol>
<li>Next, use the following commands on <strong>Bob-PC</strong> and <strong>Alice-PC</strong> to join the <code>redteamlab.local</code> domain:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>C:\Windows\system32&gt; powershell
PS C:\Windows\system32&gt; Add-Computer -DomainName RedTeamLab.local -Restart</code></pre>
</div>
<ol>
<li>Next, the <strong>Windows PowerShell credentials request</strong> window will appear, simply enter the domain administrator account (<code>Administrator</code>/<code>P@ssword1</code>) to authenticate the request and click as shown below:</li>
</ol>
<img src="../media/file102.png" width="675" height="494"/>
<ol>
<li>Once the system has rebooted, click on <strong>Other user</strong> at the bottom-left corner of the login window. Then, log in using a domain user account, such as username: <code>gambit</code> or <code>rogue</code> with the password: <code>Password1</code> as shown below:</li>
</ol>
<img src="../media/file103.png" width="1040" height="784"/>
</section>
<section id="part-9-setting-up-for-account-takeover-and-file-sharing-attacks" class="level3" data-number="4.3.9">
<h3 data-number="4.3.9">Part 9 – Setting up for account takeover and file sharing attacks</h3>
<p>To ensure we can exploit file-sharing services and perform account takeover attacks on Windows clients that are connected to the domain, please use the following instruction:</p>
<ol>
<li>Login to <strong>Bob-PC</strong> and <strong>Alice-PC</strong> using a domain administrator account, such as username: <code>redteamlab\Administrator</code> and password: <code>P@ssword1</code> as shown below:</li>
</ol>
<img src="../media/file104.png" width="1040" height="439"/>
<ol>
<li>Open the <strong>Command Prompt</strong> with administrative privileges and use the following commands to make the domain user accounts, <code>gambit</code> and <code>rogue</code>, local administrators on <strong>Bob-PC</strong> and <strong>Alice-PC</strong>:</li>
</ol>
<div class="C1-CodePACKT">
<pre><code>C:\Users\Administrator&gt; net localgroup "Administrators" redteamlab\gambit /ADD</code></pre>
</div>
<div class="C1-ConsolePACKT">
<pre><code>C:\Users\Administrator&gt; net localgroup "Administrators" redteamlab\rogue /ADD</code></pre>
</div>
<p>The following screenshot shows the execution of the preceding commands:</p>
<img src="../media/file105.png" width="659" height="140"/>
<ol>
<li>Next, using the same <strong>Command Prompt</strong> window, use the following commands to create a local shared folder on each Windows 10 machine, <strong>Bob-PC</strong> and <strong>Alice-PC</strong>:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>C:\Users\Administrator&gt; cd\
C:\&gt; mkdir SharedData
C:\&gt; net share DataShare=c:\SharedData</code></pre>
</div>
<p>The following screenshot shows the execution of the preceding commands:</p>
<img src="../media/file106.png" width="356" height="149"/>
<ol>
<li>Lastly, power-down your Windows 10 and Windows Server 2019 virtual machines until they are needed later on.</li>
</ol>
<p>Having completed this section, you have built a Microsoft Windows lab environment containing the most common type of services and configurations found in many organizations. This environment will enable you to perform advanced exploitation techniques on Active Directory in later sections of this book, which focuses on red team exercises. In the next section, you will learn how to set up a wireless penetration testing lab to practice wireless exploitation.</p>
</section>
</section>
<section id="setting-up-a-wireless-penetration-testing-lab" class="level2" data-number="4.4">
<h2 data-number="4.4">Setting up a wireless penetration testing lab</h2>
<p>Understanding how to perform wireless penetration testing helps organizations to determine how a real threat actor is able to discover and exploit security vulnerabilities on their company’s wireless network infrastructure.Within many organizations, you will commonly find wireless networks that are implemented to support the wireless mobility for their employees. Employees can connect their smartphones, Internet of Things (IoT) devices, tablets, and laptops to the corporate Wi-Fi network and access the resources on the wired network, such as printers and servers. In small and large organizations, the wireless router or access point is usually configured using one of the following wireless security standards:</p>
<ul>
<li><strong>Wired Equivalent Privacy</strong> (<strong>WEP</strong>)</li>
<li><strong>Wi-Fi Protected Access</strong> (<strong>WPA</strong>)</li>
<li><strong>Wi-Fi Protected Access 2</strong> (<strong>WPA2</strong>)</li>
<li><strong>Wi-Fi Protected Access 3</strong> (<strong>WPA3</strong>)</li>
</ul>
<p>Most modern wireless networks are usually configured with WPA2 and WPA3 standards. The preceding list of security standards are also designed for small networks and the regular consumer as they are simple to configure using a single shared password, known as a <strong>Pre-Shared Key</strong> (<strong>PSK</strong>). Therefore, anyone who wants to access the wireless network will need the same PSK.In large environments, there is a need to improve the security and centralized management of users on the corporate wireless network. Security professionals typically implement an <strong>Authentication, Authorization, and Accounting</strong> (<strong>AAA</strong>) server such as <strong>Remote Authentication Dial-In User Service</strong> (<strong>RADIUS</strong>) on the network, which handles the centralized management of network users, accounts, and policies. The following are the access methods for wireless networks:</p>
<ul>
<li><strong>Pre-Shared Key</strong> (<strong>PSK</strong>) – This methods enables you to configure a password or passphrase on the wireless router or access point. Anyone with the PSK can access the network.</li>
<li>Enterprise – This method leverages a centralized access server running RADIUS to handle AAA. Each user on the wireless network will require a unique user account to be created on the access server, with policies assigned to the account and logs are generated for accountability.</li>
<li><strong>Wi-Fi Protected Setup</strong> (<strong>WPS</strong>) – This access method removes the need for using passwords and passphrases on the wireless network. It provides an easy method to authenticate to the wireless network using an 8-digit pin. However, there are known security vulnerabilities and attacks on retrieving the WPS pin.</li>
</ul>
<p>Therefore, in this section, you will learn how to setup a wireless penetration testing lab environment that supports security testing for both personal and enterprise wireless networks. You will need a wireless router or access point that supports WEP to learn how to perform security testing on older security standards, WPA2-Personal for security testing on newer security standards, and WPA2-Enterprise for security testing of enterprise wireless networks. In addition, having a wireless router which supports WPA3 will be beneficial for learning how to compromise WPA3 targeted networks.The following diagram shows the wireless penetration testing lab environment:</p>
<img src="../media/file107.png" width="895" height="271"/>
<p>As shown in the preceding diagram, the RADIUS server (access server) and wireless router/access point is connected to an organization internal network. Therefore, if an attacker is able to compromise the wireless network, the adversary will gain unauthorized access to the corporate network and perform lateral movement.The next section will demonstrate how to set up RADIUS on top a Ubuntu server as a virtual machine on your computer and associate it with a wireless router or access point.</p>
<section id="setting-up-a-radius-server" class="level3" data-number="4.4.1">
<h3 data-number="4.4.1">Setting up a RADIUS server</h3>
<p>In this section, we will be leveraging the power of virtualization to set up a RADIUS server, such as FreeRadius, on our network to handle the AAA processes of the wireless router for testing WPA2-Enterprise.To get started with this exercise, please use the following instructions:</p>
<section id="part-1-install-a-ubuntu-server" class="level4" data-number="4.4.1.1">
<h4 data-number="4.4.1.1">Part 1 – Install a Ubuntu server</h4>
<ol>
<li>Firstly, you’ll need to download and setup Ubuntu Server as a virtual machine. On your host machine, go to <a href="https://ubuntu.com/download/server">https://ubuntu.com/download/server</a> to download the <strong>Ubuntu Server 22.04 LTS</strong> ISO image.</li>
<li>Next, open <strong>Oracle VM VirtualBox Manager</strong> and click on <strong>New</strong> to create a new virtual machine.</li>
<li>On the Create Virtual Machine window, ensure you use the following configurations:
<ul>
<li>Name: Radius Server</li>
<li>ISO Image: Use the drop-down menu, select Other, then select the Ubuntu Server ISO file.</li>
<li>Type: Linux</li>
<li>Version: Ubuntu (64-bit)</li>
<li>Skip Unattended Installation: Check the box</li>
</ul></li>
</ol>
<p>The following screenshot shows the preceding configurations:</p>
<img src="../media/file108.png" width="822" height="488"/>
<ol>
<li>After clicking on <strong>Finish</strong> to save the new virtual machine, select the <strong>Radius Server</strong> virtual machine and click on <strong>Settings</strong>.</li>
<li>On the <strong>Settings</strong> windows, select the Network category and use the following configurations for Adapter 1:
<ul>
<li>Enable the network adapter</li>
<li>Attached to: Bridged Adapter</li>
<li>Name: Use the drop-down menu to select your physical network adapter on your host machine that’s connected to your physical network.</li>
</ul></li>
<li>Next, power-on the <strong>Radius Server</strong> virtual machine to start the installation process of Ubuntu Server.</li>
<li>On the installation window, select <strong>Try or Install Ubuntu Server</strong> option to start the installation process.</li>
<li>Next, select your preferred language and hit <strong>Enter</strong>.</li>
<li>Next, select your preferred keyboard configuration and select <strong>Done</strong>.</li>
<li>On the <strong>Choose type of install</strong>, select Ubuntu Server and select <strong>Done</strong>.</li>
<li>Next, on the <strong>Network connection</strong> menu, an IP address will automatically be assigned to this Ubuntu Server from your network, ensure you take note of the address and select <strong>Done</strong>.</li>
<li>On the <strong>Configure proxy</strong> menu, leave as default and select <strong>Done</strong>.</li>
<li>On the <strong>Configure Ubuntu archive mirror</strong> menu, leave as default and select <strong>Done</strong>.</li>
<li>On the <strong>Guided storage configuration</strong> menu, leave as default and select <strong>Done</strong>.</li>
<li>On the <strong>Storage configuration</strong> menu, leave as default and select <strong>Done</strong>.</li>
<li>When the <strong>Confirm destructive action</strong> window appears, select <strong>Continue</strong>.</li>
<li>On the <strong>Profile setup</strong> menu, create a user account for yourself and select <strong>Done</strong>.</li>
<li>On the <strong>Upgrade to Ubuntu Pro</strong> menu, leave as default and select <strong>Continue</strong>.</li>
<li>On the <strong>SSH Setup</strong> menu, use the spacebar on your keyboard to select <strong>Install OpenSSH server</strong> option, then select <strong>Done</strong>.</li>
<li>Next, the <strong>Featured Server Snaps</strong> menu will appear, leave as default and select <strong>Done</strong>.</li>
<li>The installation process will take some time to complete as it will attempt to automatically download and install updates. After this process is completed, select <strong>Reboot Now</strong>.</li>
</ol>
<blockquote>
<p>After the reboot, if there’s an error on automatically ejecting the ISO file from the cd-rom drive, simply hit Enter on the console screen to continue.</p>
</blockquote>
</section>
<section id="part-2-setting-up-freeradius" class="level4" data-number="4.4.1.2">
<h4 data-number="4.4.1.2">Part 2 – Setting up FreeRadius</h4>
<p>In this section, you will learn how to setup FreeRadius on the Ubuntu server, create user accounts for users on the wireless network.Please use the following instruction to get started with this exercise:</p>
<ol>
<li>Ensure the <strong>Radius Server</strong> virtual machine is running in <strong>Oracle VM VirtualBox Manager</strong>.</li>
<li>Next, on your Windows host machine, open the Windows <strong>Command Prompt</strong> application and use the following commands to remotely connect to the virtual machine:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>C:\Users\Glen&gt; ssh &lt;yourname&gt;@&lt;server-ip-address&gt;</code></pre>
</div>
<p>The following screenshots the expected output when executing the preceding commands:</p>
<img src="../media/file109.png" width="752" height="165"/>
<blockquote>
<p>Keep in mind, passwords are invisible when you’re entering them on a terminal interface for security reasons.</p>
</blockquote>
<ol>
<li>Next, use the following commands to update the local package repository list and install FreeRadius:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>glen@radius:~$ sudo apt update
glen@radius:~$ sudo apt install freeradius</code></pre>
</div>
<p>The following screenshot shows the execution of the preceding commands:</p>
<img src="../media/file110.png" width="1159" height="582"/>
<ol>
<li>Next, use the following commands to verify the sub-directories of FreeRadius:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>glen@radius:~$ sudo ls -l /etc/freeradius/3.0/</code></pre>
</div>
<p>The following screenshot shows the list of files and directories within the 3.0 folder:</p>
<img src="../media/file111.png" width="892" height="450"/>
<blockquote>
<p>The <code>users</code> file contains the user credentials, while the <code>clients.conf</code> file contains the AAA client accounts, such as the wireless router within our lab topology.</p>
</blockquote>
<ol>
<li>Next, let’s use the Nano command-line text editor to modify the <code>users</code> file and create a user account:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>glen@radius:~$ sudo nano /etc/freeradius/3.0/users</code></pre>
</div>
<ol>
<li>Using the directional keys on your keyboard, to the following line:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>#bob    Cleartext-Password := "hello"</code></pre>
</div>
<p>Then uncomment the line by removing the <code>#</code> symbol and change the password from <code>hello</code> to <code>password123</code> as shown below:</p>
<img src="../media/file112.png" width="569" height="254"/>
<ol>
<li>Next, save the file by pressing <code>CTRL + X</code>, then <code>Y</code> and Enter.</li>
<li>Next, let’s create a client account for the wireless router, use the following commands to edit the <code>clients.conf</code> file:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>glen@radius:~$ sudo nano /etc/freeradius/3.0/clients.conf</code></pre>
</div>
<ol>
<li>Using the directional keys, go to the <strong>Defines a RADIUS client</strong> section and insert the following code:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>client 172.16.17.123 {
        secret = radiusclientpassword1
        shortname = corporate-ap
}</code></pre>
</div>
<p>The following screenshots shows the preceding code within the <code>clients.conf</code> file:</p>
<img src="../media/file113.png" width="706" height="338"/>
<p>The client IP address (<code>172.16.17.123</code>) is the IP address of the wireless router, please sure you check the IP address of your wireless router and substitute with the one in the preceding code. If the client IP address is not the same as your wireless router, the user (bob) will not be able to authenticate to the RADIUS server.</p>
<ol>
<li>Press <code>CTRL + X</code>, then <code>Y</code> and Enter to save the file.</li>
<li>Next, use the following commands to restart the FreeRadius service and verify it’s status:</li>
</ol>
<div class="C1-ConsolePACKT">
<pre><code>glen@radius:~$ sudo systemctl restart freeradius
glen@radius:~$ sudo systemtctl status freeradius</code></pre>
</div>
<p>The following screenshot shows the <code>freeradius</code> service is active and running:</p>
<img src="../media/file114.png" width="1001" height="348"/>
<ol>
<li>Additionally, use the <code>sudo lsof -i -P -n | grep freerad</code> command to verify ports <code>1812</code> and <code>1813</code> are open for the FreeRadius services as shown below:</li>
</ol>
<img src="../media/file115.png" width="742" height="176"/>
</section>
<section id="part-3-setting-the-wireless-router-with-radius" class="level4" data-number="4.4.1.3">
<h4 data-number="4.4.1.3">Part 3 – Setting the wireless router with RADIUS</h4>
<p>This section will show you how to configure a wireless router to operate query a RADIUS server on the network. For this section, you will need a physical wireless router that supports the WPA2-Personal, and WPA-Enterprise security modes. The following diagram shows the IP addresses of the RADIUS server and wireless router, keep in mind the IP addresses may be different on your personal network:</p>
<img src="../media/file116.png" width="907" height="242"/>
<p>To get started configuring the wireless router with RADIUS, please use the following guidelines:</p>
<ol>
<li>Power-on the wireless router and login to the management dashboard.</li>
<li>Next, go to the <strong>Wireless</strong> tab and change the <strong>Network Name</strong> (<strong>SSID</strong>) to <code>Target_Net</code>, as shown below:</li>
</ol>
<img src="../media/file117.png" width="701" height="379"/>
<ol>
<li>Next, on the Wireless Security menu, use the following configuration to enable the wireless router to query the RADIUS server on the network:
<ul>
<li>Security Mode: WPA2-Enterprise</li>
<li>Encryption: AES</li>
<li>RADIUS Server: Enter the IP address of the RADIUS server virtual machine</li>
<li>RADIUS Port: 1812</li>
<li>Shared Secret: radiusclientpassword1</li>
</ul></li>
</ol>
<p>The following screenshot shows the preceding configurations when applied to the wireless router:</p>
<img src="../media/file118.png" width="699" height="411"/>
<p>Keep in mind, you need to ensure the IP address on your wireless router matches the IP address within the <code>clients.conf</code> file on the RADIUS server, as well as the IP address of the RADIUS server matches the IP address on the wireless security configuration on the wireless router.Having completed this section, you have learned how to set up a wireless penetration testing lab environment to perform advanced penetration testing techniques.</p>
</section>
</section>
</section>
<section id="summary-2" class="level2" data-number="4.5">
<h2 data-number="4.5">Summary</h2>
<p>During this chapter, you have gained the hands-on skills to build a Windows environment that simulates a typical enterprise organization with domain users, various service accounts, administrators, and shared network resources. Additionally, you have learnt how to create a wireless network lab that contains a RADIUS server to provide AAA services, which help replicate an enterprise wireless network within a large organization. These lab environments will be utilized later in this book when you learn about advanced penetration testing techniques such as red team exercises.I trust that the knowledge presented in this chapter has provided you with valuable insights, supporting your path towards becoming an ethical hacker and penetration tester in the dynamic field of cybersecurity. May this newfound understanding empower you in your journey, allowing you to navigate the industry with confidence and make a significant impact. In the next chapter, <em>Reconnaissance and Network Penetration Testing</em>, you will learn how to perform <strong>Open Source Intelligence</strong> (<strong>OSINT</strong>) to passively collect sensitive information on a target.</p>
</section>
<section id="further-reading-2" class="level2" data-number="4.6">
<h2 data-number="4.6">Further Reading</h2>
<ul>
<li>Active Directory Domain Services - <a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/deploy/install-active-directory-domain-services--level-100-">https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/deploy/install-active-directory-domain-services--level-100-</a></li>
<li>Wireless security standards - <a href="https://www.techtarget.com/searchnetworking/feature/Wireless-encryption-basics-Understanding-WEP-WPA-and-WPA2">https://www.techtarget.com/searchnetworking/feature/Wireless-encryption-basics-Understanding-WEP-WPA-and-WPA2</a></li>
<li>Understanding FreeRadius - <a href="https://www.techtarget.com/searchsecurity/definition/RADIUS">https://www.techtarget.com/searchsecurity/definition/RADIUS</a></li>
</ul>
</section>
</section>
</div>
</div>
</body>
</html>